#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name   : XL-FileTools
# Website     : http://le-tools.com/
# GitHub		  : https://github.com/arioux/XL-FileTools
# Description : Part of the XL-Toolkit, XL-FileTools provides a bunch of functions
#               for files like filtering, listing, copying, moving and renaming.
# Creation    : 2016-05-14
# Modified    : 2016-07-10
my $VERSION   = "2.0";
# Author      : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2016  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#

#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use Digest::MD5::File qw(file_md5_hex);
use Digest::SHA1 qw(sha1_hex);
use Text::Roman qw(:all);
use File::Copy;
use File::Copy::Recursive qw(fcopy fmove);
use Time::Local;
use Win32::API();
use Win32::DriveInfo;
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::Process;
use threads;
use threads::shared;
require "XL-FileToolsGraph.pl";
require "XL-FileToolsLang.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#

my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-FileTools") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-FileTools"; }
else                                                { $USERDIR = $PROGDIR;                                    }
my $LANG_FILE    = "$USERDIR\\Lang.ini";                                       # Langage file
my $CONFIG_FILE  = "$USERDIR\\XL-FileTools.ini";                               # Configuration file
my $URL_DOC      = "http://le-tools.com/XL-FileToolsDoc.html";                 # Online documentation
my $URL_TOOL     = 'http://le-tools.com/XL-FileTools.html#Download';           # Url of the tool
my $URL_VER      = 'http://www.le-tools.com/download/XL-FileToolsVer.txt';     # Url of the version file
my %CONFIG       :shared;                                                      # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW        :shared;                                                      # Arrow pointer
my $HOURGLASS    :shared;                                                      # Hourglass pointer
my $THR_PROCESS;                                                               # Thread for process
my $THR_UPDATE;                                                                # Thread for update
my $START = 0;                                                                 # Indicate when program is started

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#

my ($winICO, $logoBmp, $logo128Bmp, $openDirBmp, $openFileBmp, $processBmp,
    $stopBmp, $previewBmp, $config32Bmp, $helpBmp, $aboutBmp, $config128Bmp,
    $browseBmp, $folderClosedBmp, $folderOpenedBmp, $fileBmp, $delFileBmp,
    $warnFileBmp) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#

&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings


#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#

my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 800;
my $winHeight = 550;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;

# Main Window
my $win = Win32::GUI::Window->new( -name        => 'winMain'               ,
                                   -text        => 'XL-FileTools'          ,
                                   -background  => [255, 255, 255]         ,
                                   -size        => [$winWidth, $winHeight] ,
                                   -pos         => [$winPosX , $winPosY]   ,
                                   -minheight   => $winHeight              ,
                                   -minwidth    => $winWidth               , );
$win->SetIcon($winICO);

# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGB2;
my $font10;
my $font10u;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      , );
  $fontGB2 = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 12     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font10  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      , );
  $font10u = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 12     ,
                                  -bold      => 1      , );
  $fontGB2 = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 14     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font10  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     , );
  $font10u = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
}

# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);

# Header
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [300, 60]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $logoBmp                , );
$win->AddLabel(       -name        => 'lblHeader'             ,
                      -size        => [400, 60]               ,
                      -pos         => [300,  0]               ,
                      -background  => [250, 250, 250]         , );

# Input section
$win->AddLabel(       -name        => 'lblInputT'             ,
                      -size        => [$winWidth, 24]         ,
                      -pos         => [  0, 60]               ,
                      -text        => ' '.$STR{'lblInputT'}   ,
                      -font        => $fontGB                 ,
                      -foreground  => [255, 255, 255]         ,
                      -background  => [255, 210,  84]         , );
$win->AddRadioButton( -name        => 'rbInputDir'            ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5, 95]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbInputDir'}.':'  ,
                      -font        => $font10                 ,
                      -checked     => 1                       ,
                      -group       => 1                       ,
                      -tabstop     => 1                       , );
$win->AddTextfield(   -name        => 'tfInputDir'            ,
                      -size        => [465, 22]               ,
                      -pos         => [ 90, 95]               ,
                      -tabstop     => 1                       , );
$win->AddButton(      -name        => 'btnInputDir'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [557, 95]               ,
                      -bitmap      => $openDirBmp             ,
                      -tabstop     => 1                       , );
$win->AddCheckbox(    -name        => 'chInputDirRecurse'     ,
                      -size        => [135, 22]               ,
                      -pos         => [582, 95]               ,
                      -text        => $STR{'chInputDirRecurse'},
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 ,
                      -tabstop     => 1                       ,
                      -checked     => 1                       , );
$win->AddRadioButton( -name        => 'rbInputFiles'          ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5,120]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbInputFiles'}.':',
                      -font        => $font10                 ,
                      -tabstop     => 1                       , );
$win->AddTextfield(   -name        => 'tfInputFiles'          ,
                      -size        => [465, 22]               ,
                      -pos         => [ 90,120]               ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                       , );
$win->AddButton(      -name        => 'btnInputFiles'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [557,120]               ,
                      -bitmap      => $openFileBmp            ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                       , );

# Filters
$win->AddLabel(       -name        => 'lblFiltersT'          ,
                      -size        => [$winWidth, 24]        ,
                      -pos         => [  0,150]              ,
                      -text        => ' '.$STR{'lblFiltersT'},
                      -font        => $fontGB                ,
                      -foreground  => [255, 255, 255]        ,
                      -background  => [255, 210,  84]        , );
$win->AddRadioButton( -name        => 'rbFiltersNone'        ,
                      -size        => [110, 22]              ,
                      -pos         => [  5,180]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'rbFiltersNone'}  ,
                      -font        => $font10                ,
                      -checked     => 1                      ,
                      -group       => 1                      ,
                      -tabstop     => 1                      , );
$win->AddRadioButton( -name        => 'rbFiltersDirOnly'     ,
                      -size        => [200, 22]              ,
                      -pos         => [130,180]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'rbFiltersDirOnly'},
                      -font        => $font10                ,
                      -tabstop     => 1                      , );
$win->AddRadioButton( -name        => 'rbFiltersSize'        ,
                      -size        => [115, 22]              ,
                      -pos         => [260,182]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'rbFiltersSize'}.':',
                      -font        => $font10                ,
                      -tabstop     => 1                      , );
$win->AddCombobox(    -name        => 'cbFiltersSizeOp'      ,
                      -size        => [110, 22]              ,
                      -pos         => [355,180]              ,
                      -font        => $font10                ,
                      -dropdownlist => 1                     ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                      , );
$win->cbFiltersSizeOp->Add($STR{'Smaller'}, $STR{'Equal'}, $STR{'Bigger'}, );
$win->cbFiltersSizeOp->SetCurSel(0);
$win->AddTextfield(   -name        => 'tfFiltersSize'        ,
                      -size        => [ 80, 24]              ,
                      -pos         => [470,180]              ,
                      -number      => 1                      ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                      , );
$win->AddCombobox(    -name        => 'cbFiltersSizeUnit'    ,
                      -size        => [ 70, 22]              ,
                      -pos         => [555,180]              ,
                      -font        => $font10                ,
                      -dropdownlist => 1                     ,
                      -vscroll     => 1                      ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                      , );
$win->cbFiltersSizeUnit->Add($STR{'b'}, $STR{'Kb'}, $STR{'Mb'},$STR{'Gb'});
$win->cbFiltersSizeUnit->SetCurSel(0);
$win->AddRadioButton( -name        => 'rbFiltersContains'    ,
                      -size        => [100, 22]              ,
                      -pos         => [  5,211]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'rbFiltersContains'}.':',
                      -font        => $font10                ,
                      -tabstop     => 1                      , );
$win->AddLabel(       -name        => 'lblFiltersContainOk'  ,
                      -size        => [477, 24]              ,
                      -pos         => [129,210]              ,
                      -background  => [  0, 255,   0]        ,
                      -visible     => 0                      , );
$win->AddLabel(       -name        => 'lblFiltersContainErr' ,
                      -size        => [477, 24]              ,
                      -pos         => [129,210]              ,
                      -background  => [255,   0,   0]        ,
                      -visible     => 0                      , );
$win->AddLabel(       -name        => 'lblFiltersContainWarn',
                      -size        => [477, 24]              ,
                      -pos         => [129,210]              ,
                      -background  => [255, 255,   0]        ,
                      -visible     => 0                      , );
$win->AddTextfield(   -name        => 'tfFiltersContains'    ,
                      -size        => [475, 22]              ,
                      -pos         => [130,211]              ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                      , );
$win->AddCheckbox(    -name        => 'chFiltersContainsCase',
                      -size        => [125, 22]               ,
                      -pos         => [130,237]               ,
                      -text        => $STR{'chFiltersContainsCase'},
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                       , );
$win->AddCheckbox(    -name        => 'chFiltersContainsRegex',
                      -size        => [ 60, 22]               ,
                      -pos         => [260,237]               ,
                      -text        => $STR{'chFiltersContainsRegex'},
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 ,
                      -disabled    => 1                       ,
                      -tabstop     => 1                       , );
$win->AddCheckbox(    -name        => 'chFiltersContainsFileOnly',
                      -size        => [200, 22]               ,
                      -pos         => [355,237]               ,
                      -text        => $STR{'chFiltersContainsFileOnly'},
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 ,
                      -disabled    => 1                       ,
                      -tabstop     => 1                       , );
$win->AddRadioButton( -name        => 'rbFiltersLastAccess'   ,
                      -size        => [120, 22]               ,
                      -pos         => [  5,267]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbFiltersLastAccess'}.':',
                      -font        => $font10                 ,
                      -tabstop     => 1                       , );
$win->AddCombobox(    -name        => 'cbFiltersLastAccess'   ,
                      -size        => [ 80, 22]               ,
                      -pos         => [130,265]               ,
                      -font        => $font10                 ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                      , );
$win->cbFiltersLastAccess->Add($STR{'Before'}, $STR{'Equal'}  ,
                               $STR{'After'}                  , );
$win->cbFiltersLastAccess->SetCurSel(0);
$win->AddDateTime(    -name        => 'dtFiltersLastAccess'   ,
                      -size        => [110, 24]               ,
                      -pos         => [220,265]               ,
                      -font        => $font10                 ,
                      -background  => [255, 255, 255]         ,
                      -format      => "shortdate"             ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                       , );
$win->AddRadioButton( -name        => 'rbFiltersLastModif'    ,
                      -size        => [115, 22]               ,
                      -pos         => [355,267]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbFiltersLastModif'}.':',
                      -font        => $font10                 ,
                      -tabstop     => 1                       , );
$win->AddCombobox(    -name        => 'cbFiltersLastModif'    ,
                      -size        => [ 80, 22]               ,
                      -pos         => [475,265]               ,
                      -font        => $font10                 ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                      , );
$win->cbFiltersLastModif->Add($STR{'Before'}, $STR{'Equal'}  ,
                              $STR{'After'}                  , );
$win->cbFiltersLastModif->SetCurSel(0);
$win->AddDateTime(    -name        => 'dtFiltersLastModif'    ,
                      -size        => [110, 24]               ,
                      -pos         => [565,265]               ,
                      -font        => $font10                 ,
                      -background  => [255, 255, 255]         ,
                      -format      => "shortdate"             ,
                      -disabled    => 1                      ,
                      -tabstop     => 1                       , );

# Functions
$win->AddLabel(         -name         => 'lblFunctionsT'        ,
                        -size         => [$winWidth, 24]        ,
                        -pos          => [  0,298]              ,
                        -text         => ' '.$STR{'lblFunctionsT'},
                        -font         => $fontGB                ,
                        -foreground   => [255, 255, 255]        ,
                        -background   => [255, 210,  84]        , );
$win->AddTabStrip(      -name         => 'TabFunctions'         ,
                        -size         => [$winWidth-4,120]      ,
                        -pos          => [  0,327]              ,
                        -font         => $font10                ,
                        -fixedwidth   => 1                      ,
                        -tabstop      => 1                      ,
                        -background   => [255, 255, 255]        , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions1T'} , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions2T'} , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions3T'} , );
# Lists
$win->AddRadioButton(   -name         => 'rbListFiles'          ,
                        -size         => [160, 22]              ,
                        -pos          => [  5,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbListFiles'}.':',
                        -font         => $font10                ,
                        -group        => 1                      ,
                        -checked      => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt1'      , # Full path
                        -size         => [130, 22]              ,
                        -pos          => [180,360]              ,
                        -text         => $STR{'chListFilesOpt1'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt2'      , # Filename
                        -size         => [130, 22]              ,
                        -pos          => [180,385]              ,
                        -text         => $STR{'chListFilesOpt2'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt3'      , # MD5
                        -size         => [ 80, 22]              ,
                        -pos          => [315,360]              ,
                        -text         => $STR{'chListFilesOpt3'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt4'      , # SHA1
                        -size         => [ 80, 22]              ,
                        -pos          => [315,385]              ,
                        -text         => $STR{'chListFilesOpt4'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt5'      , # File details
                        -size         => [145, 22]              ,
                        -pos          => [430,360]              ,
                        -text         => $STR{'chListFilesOpt5'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt6'      , # Number of lines
                        -size         => [145, 22]              ,
                        -pos          => [430,385]              ,
                        -text         => $STR{'chListFilesOpt6'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt7'      , # No header
                        -size         => [130, 22]              ,
                        -pos          => [580,360]              ,
                        -text         => $STR{'chListFilesOpt7'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOpt8'      , # No folder
                        -size         => [130, 22]              ,
                        -pos          => [580,385]              ,
                        -text         => $STR{'chListFilesOpt8'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddRadioButton(   -name         => 'rbListExt'            ,
                        -size         => [160, 22]              ,
                        -pos          => [  5,385]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbListExt'}      ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblReportDir'         ,
                        -size         => [ 80, 22]              ,
                        -pos          => [  5,428]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblReportDir'}.':',
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddTextfield(     -name         => 'tfReportDir'          ,
                        -size         => [405, 22]              ,
                        -pos          => [ 90,425]              ,
                        -tabstop      => 1                      , );
$win->AddButton(        -name         => 'btnReportDir'         ,
                        -size         => [ 22, 22]              ,
                        -pos          => [497,425]              ,
                        -bitmap       => $openDirBmp            ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chOpenReport'         ,
                        -size         => [185, 22]              ,
                        -pos          => [522,425]              ,
                        -text         => $STR{'chOpenReport'}   ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      ,
                        -checked      => 1                      , );
# Copy or move
$win->AddRadioButton(   -name         => 'rbCopy'               ,
                        -size         => [120, 22]              ,
                        -pos          => [  5,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbCopy'}         ,
                        -font         => $font10                ,
                        -group        => 1                      ,
                        -checked      => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddRadioButton(   -name         => 'rbMove'               ,
                        -size         => [120, 22]              ,
                        -pos          => [  5,385]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbMove'}         ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chCopyTree'           ,
                        -size         => [250, 22]              ,
                        -pos          => [130,360]              ,
                        -text         => $STR{'chCopyTree'}     ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chCopyRemDouble'      ,
                        -size         => [250, 22]              ,
                        -pos          => [130,385]              ,
                        -text         => $STR{'chCopyRemDouble'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblDestination'       ,
                        -size         => [ 80, 22]              ,
                        -pos          => [  5,428]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblDestination'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddTextfield(     -name         => 'tfDestinationDir'     ,
                        -size         => [405, 22]              ,
                        -pos          => [ 90,425]              ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddButton(        -name         => 'btnDestinationDir'    ,
                        -size         => [ 22, 22]              ,
                        -pos          => [497,425]              ,
                        -bitmap       => $openDirBmp            ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chOpenDstDir'         ,
                        -size         => [185, 22]              ,
                        -pos          => [522,425]              ,
                        -text         => $STR{'chOpenDstDir'}   ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      ,
                        -checked      => 1                      , );
# Rename
$win->AddRadioButton(   -name         => 'rbRenByHash'          ,
                        -size         => [110, 22]              ,
                        -pos          => [  5,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbRenByHash'}.':',
                        -font         => $font10                ,
                        -group        => 1                      ,
                        -checked      => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCombobox(      -name         => 'cbRenByHash'          ,
                        -size         => [ 60, 22]              ,
                        -pos          => [120,360]              ,
                        -font         => $font10                ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->cbRenByHash->Add( 'MD5', 'SHA1'                           , );
$win->cbRenByHash->SetCurSel(0);
$win->AddRadioButton(   -name         => 'rbRenSort'            ,
                        -size         => [110, 22]              ,
                        -pos          => [325,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbRenSort'}.':'  ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddButton(        -name         => 'btnRenSort'           ,
                        -size         => [100, 24]              ,
                        -pos          => [440,360]              ,
                        -text         => $STR{'Options'}.'...'  ,
                        -font         => $font10                ,
                        -disabled     => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddRadioButton(   -name         => 'rbRenReplace'         ,
                        -size         => [110, 22]              ,
                        -pos          => [  5,390]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbRenReplace'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblRenReplaceOk'      ,
                        -size         => [152, 24]              ,
                        -pos          => [119,389]              ,
                        -background   => [  0, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceErr'     ,
                        -size         => [152, 24]              ,
                        -pos          => [119,389]              ,
                        -background   => [255,   0,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceWarn'    ,
                        -size         => [152, 24]              ,
                        -pos          => [119,389]              ,
                        -background   => [255, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfRenReplace'         ,
                        -size         => [150, 22]              ,
                        -pos          => [120,390]              ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceRegex'    ,
                        -size         => [ 85, 22]              ,
                        -pos          => [120,415]              ,
                        -text         => $STR{'chFiltersContainsRegex'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceCase'     ,
                        -size         => [120, 22]              ,
                        -pos          => [210,415]              ,
                        -text         => $STR{'chFiltersContainsCase'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceFolder'   ,
                        -size         => [120, 22]              ,
                        -pos          => [335,415]              ,
                        -text         => $STR{'chRenReplaceFolder'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblRenReplaceBy'      ,
                        -size         => [ 40, 22]              ,
                        -pos          => [325,393]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblRenReplaceBy'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByOk'    ,
                        -size         => [152, 24]              ,
                        -pos          => [369,389]              ,
                        -background   => [  0, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByErr'   ,
                        -size         => [152, 24]              ,
                        -pos          => [369,389]              ,
                        -background   => [255,   0,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByWarn'  ,
                        -size         => [152, 24]              ,
                        -pos          => [369,389]              ,
                        -background   => [255, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfRenReplaceBy'       ,
                        -size         => [150, 22]              ,
                        -pos          => [370,390]              ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceByEval'  ,
                        -size         => [ 60, 22]              ,
                        -pos          => [370,415]              ,
                        -text         => $STR{'chRenReplaceByEval'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );

# Footer
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [$winWidth, 80]         ,
                      -pos         => [  2,$winHeight-82]     ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10, $winHeight-65]    ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddLabel(       -name        => 'lblPbCurr'             ,
                      -size        => [495, 20]               ,
                      -pos         => [ 10, $winHeight-75]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddProgressBar( -name        => 'pb'                    ,
                      -size        => [410, 20]               ,
                      -pos         => [ 10, $winHeight-55]    ,
                      -smooth      => 1                       ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblPbCount'            ,
                      -size        => [ 85, 20]               ,
                      -pos         => [425, $winHeight-53]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnProcess'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [465,$winHeight-75]     ,
                      -bitmap      => $processBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Process'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnStop'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [465,$winHeight-75]     ,
                      -bitmap      => $stopBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'StopProcess'}     ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnPreview'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [510,$winHeight-75]     ,
                      -bitmap      => $previewBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Preview'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [555,$winHeight-75]     ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Configuration'}   , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [600,$winHeight-75]     ,
                      -bitmap      => $helpBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [645,$winHeight-75]     ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'about'}           , );

#------------------------------------------------------------------------------#
# Rename - BySort Options window
#------------------------------------------------------------------------------#

my $winRenBySortOpt = Win32::GUI::Window->new(-name        => 'winRenBySortOpt'     ,
                                              -background  => [255, 255, 255]       ,
                                              -parent      => $win                  ,
                                              -text        => $STR{'Options'}       ,
                                              -pos         => [$winPosX, $winPosY]  ,
                                              -size        => [630, 310]            ,
                                              -hasmaximize => 0                     ,
                                              -hasminimize => 0                     ,
                                              -resizable   => 0                     ,
                                              -dialogui    => 1                     , );
$winRenBySortOpt->SetIcon($winICO);

$winRenBySortOpt->AddLabel(   -name         => 'lblLogo'             ,
                              -size         => [128,128]             ,
                              -pos          => [  0,  5]             ,
                              -bitmap       => $logo128Bmp           ,
                              -background   => [255, 255, 255]       , );
# Sort section
$winRenBySortOpt->AddLabel(   -name        => 'lblSortShadowT'       ,
                              -size        => [150, 25]              ,
                              -pos         => [151,  6]              ,
                              -foreground  => [180, 180, 180]        ,
                              -background  => [255, 255, 255]        ,
                              -text        => $STR{'sortOpt'}.':'    ,
                              -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(   -name        => 'lblSortT'             ,
                              -size        => [150, 25]              ,
                              -pos         => [150,  5]              ,
                              -addstyle    => 11                     , # Transparent
                              -foreground  => [250, 195,  27]        ,
                              -text        => $STR{'sortOpt'}.':'    ,
                              -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(   -name        => 'lblSortBy'            ,
                              -size        => [ 80, 20]              ,
                              -pos         => [150, 43]              ,
                              -font        => $font10                ,
                              -background  => [255, 255, 255]        , 
                              -text        => $STR{'sortBy'}.':'     , );
$winRenBySortOpt->AddCombobox(-name        => 'cbSortByType'         ,
                              -size        => [130,100]              ,
                              -pos         => [235, 40]              ,
                              -font        => $font10                ,
                              -dropdownlist => 1                     ,
                              -vscroll      => 1                     ,
                              -tabstop      => 1                     , );
$winRenBySortOpt->cbSortByType->Add($STR{'cbSortByAlpha'}            ,
                                    $STR{'rbFiltersSize'}            ,
                                    $STR{'rbFiltersLastAccess'}      ,
                                    $STR{'rbFiltersLastModif'}       ,);
$winRenBySortOpt->cbSortByType->SetCurSel(0);
$winRenBySortOpt->AddRadioButton( -name       => 'rbAsc'                  ,
                                  -size       => [100, 22]                ,
                                  -pos        => [390, 40]                ,
                                  -background => [255, 255, 255]          ,
                                  -text       => $STR{'Ascending'}        ,
                                  -font       => $font10                  ,
                                  -checked    => 1                        ,
                                  -group      => 1                        ,
                                  -tabstop    => 1                        , );
$winRenBySortOpt->AddRadioButton( -name       => 'rbDsc'                  ,
                                  -size       => [120, 22]                ,
                                  -pos        => [495, 40]                ,
                                  -background => [255, 255, 255]          ,
                                  -text       => $STR{'Descending'}       ,
                                  -font       => $font10                  ,
                                  -tabstop    => 1                        , );
# Rename section
$winRenBySortOpt->AddLabel(       -name        => 'lblRenameShadowT'     ,
                                  -size        => [200, 25]              ,
                                  -pos         => [151, 81]              ,
                                  -foreground  => [180, 180, 180]        ,
                                  -background  => [255, 255, 255]        ,
                                  -text        => $STR{'renameOpt'}.':'  ,
                                  -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(       -name        => 'lblRenameT'           ,
                                  -size        => [200, 25]              ,
                                  -pos         => [150, 80]              ,
                                  -addstyle    => 11                     , # Transparent
                                  -foreground  => [250, 195,  27]        ,
                                  -text        => $STR{'renameOpt'}.':'  ,
                                  -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(       -name        => 'lblIncrValType'       ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,118]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblIncrValType'}.':', );
$winRenBySortOpt->AddCombobox(    -name        => 'cbIncrValType'        ,
                                  -size        => [100, 40]              ,
                                  -pos         => [270,115]              ,
                                  -font        => $font10                ,
                                  -dropdownlist => 1                     ,
                                  -vscroll      => 1                     ,
                                  -tabstop      => 1                     , );
$winRenBySortOpt->cbIncrValType->Add('1,2,3,...'    , 'a-z,aa-zz,...'    ,
                                     'A-Z,AA-ZZ,...', '0-f,00-ff,...'    ,
                                     '0-F,00-FF,...', 'I,II,III IV,...'  , );
$winRenBySortOpt->cbIncrValType->SetCurSel(0);
$winRenBySortOpt->AddLabel(       -name        => 'lblLength'            ,
                                  -size        => [115, 20]              ,
                                  -pos         => [390,118]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblLength'}.':'  , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfLength'             ,
                                  -size        => [ 60, 24]              ,
                                  -pos         => [510,115]              ,
                                  -number      => 1                      ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddUpDown(      -name        => 'upDownLength'         ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->upDownLength->SetRange(1,32);
$winRenBySortOpt->upDownLength->SetPos(0);
$winRenBySortOpt->AddLabel(       -name        => 'lblInitVal'           ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,148]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblInitVal'}.':' , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfInitVal'            ,
                                  -size        => [ 60, 24]              ,
                                  -pos         => [270,145]              ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddUpDown(      -name        => 'upDownInitVal'        ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->upDownInitVal->SetRange(0,100);
$winRenBySortOpt->upDownInitVal->SetPos(1);
$winRenBySortOpt->AddLabel(       -name        => 'lblStepVal'           ,
                                  -size        => [115, 20]              ,
                                  -pos         => [390,148]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblStepVal'}.':' , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfStepVal'            ,
                                  -size        => [ 60, 24]              ,
                                  -pos         => [510,145]              ,
                                  -number      => 1                      ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddUpDown(      -name        => 'upDownStepVal'        ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->upDownStepVal->SetRange(1,100);
$winRenBySortOpt->upDownStepVal->SetPos(0);
$winRenBySortOpt->AddLabel(       -name        => 'lblPrefix'            ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,178]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblPrefix'}.':'  , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfPrefix'             ,
                                  -size        => [100, 24]              ,
                                  -pos         => [270,175]              ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddLabel(       -name        => 'lblSuffix'            ,
                                  -size        => [115, 20]              ,
                                  -pos         => [390,178]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblSuffix'}.':'  , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfSuffix'             ,
                                  -size        => [100, 24]              ,
                                  -pos         => [510,175]              ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddLabel(       -name        => 'lblExample'           ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,213]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblExample'}.':' , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfExample'            ,
                                  -size        => [275, 24]              ,
                                  -pos         => [270,210]              ,
                                  -readonly    => 1                      , );
$winRenBySortOpt->AddButton(      -name        => 'btnWinRenBySortOptOk' ,
                                  -pos         => [340,245]              ,
                                  -size        => [ 50, 30]              ,
                                  -text        => $STR{'Ok'}             ,
                                  -font        => $font10                ,
                                  -disabled    => 1                      ,
                                  -tabstop     => 1                      ,  
                                  -ok          => 1                      ,
                                  -default     => 1                      , );

#------------------------------------------------------------------------------#
# Preview window
#------------------------------------------------------------------------------#

my $winPreview = Win32::GUI::Window->new( -name        => 'winPreview'           ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'winPreview'}     ,
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [$winWidth, $winHeight],
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      ,
                                          -dialogui    => 1                      , );
$winPreview->SetIcon($winICO);

my $imageList = new Win32::GUI::ImageList(16, 16, 1|0x0010, 5, 5);
$imageList->Add($folderClosedBmp, 0);
$imageList->Add($folderOpenedBmp, 0);
$imageList->Add($fileBmp        , 0);
$imageList->Add($delFileBmp     , 0);
$imageList->Add($warnFileBmp    , 0);

$winPreview->AddLabel(                    -name        => 'lblBeforeShadowT',
                                          -size        => [100, 22]         ,
                                          -pos         => [  6,  6]         ,
                                          -font        => $fontGB2          ,
                                          -foreground  => [180, 180, 180]   ,
                                          -background  => [255, 255, 255]   ,
                                          -text        => $STR{'Before'}.':', );
$winPreview->AddLabel(                    -name        => 'lblBeforeT'      ,
                                          -size        => [100, 22]         ,
                                          -pos         => [  5,  5]         ,
                                          -font        => $fontGB2          ,
                                          -addstyle    => 11                , # Transparent
                                          -foreground  => [250, 195,  27]   ,
                                          -text        => $STR{'Before'}.':', );
$winPreview->AddLabel(                    -name        => 'lblRootBefore'   ,
                                          -size        => [ 55, 20]         ,
                                          -pos         => [ 10, 38]         ,
                                          -font        => $font10           ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'Root'}.':'  , );
$winPreview->AddTextfield(                -name        => 'tfRootBefore'    ,
                                          -size        => [240, 22]         ,
                                          -pos         => [ 70, 35]         ,
                                          -readonly    => 1                 , );
$winPreview->AddTreeView(                 -name        => 'tvBefore'        ,
                                          -size        => [305,330]         ,
                                          -pos         => [  5, 60]         ,
                                          -background  => [255, 255, 255]   ,
                                          -rootlines   => 1                 ,
                                          -lines       => 1                 ,
                                          -buttons     => 1                 ,
                                          -imagelist   => $imageList        , );
$winPreview->AddLabel(                    -name        => 'lblAfterShadowT' ,
                                          -size        => [100, 22]         ,
                                          -pos         => [316,  6]         ,
                                          -font        => $fontGB2          ,
                                          -foreground  => [180, 180, 180]   ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'After'}.':' , );
$winPreview->AddLabel(                    -name        => 'lblAfterT'       ,
                                          -size        => [100, 22]         ,
                                          -pos         => [315,  5]         ,
                                          -font        => $fontGB2          ,
                                          -addstyle    => 11                , # Transparent
                                          -foreground  => [250, 195,  27]   ,
                                          -text        => $STR{'After'}.':' , );
$winPreview->AddLabel(                    -name        => 'lblRootAfter'    ,
                                          -size        => [ 55, 20]         ,
                                          -pos         => [315, 38]         ,
                                          -font        => $font10           ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'Root'}.':'  , );
$winPreview->AddTextfield(                -name        => 'tfRootAfter'     ,
                                          -size        => [240, 22]         ,
                                          -pos         => [380, 35]         ,
                                          -readonly    => 1                 , );
$winPreview->AddTreeView(                 -name        => 'tvAfter'         ,
                                          -size        => [305,330]         ,
                                          -pos         => [315, 60]         ,
                                          -background  => [255, 255, 255]   ,
                                          -rootlines   => 1                 ,
                                          -lines       => 1                 ,
                                          -buttons     => 1                 ,
                                          -imagelist   => $imageList        , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -parent      => $win                    ,
                                            -text        => $STR{'winConfig'}       ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [600, 270]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);

$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $config128Bmp         ,
                          -background   => [255, 255, 255]       , );

# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'      ,
                                    -size         => [455,235]        ,
                                    -pos          => [140,  5]        ,
                                    -fixedwidth   => 1                ,
                                    -tabstop      => 1                ,
                                    -background   => [255, 255, 255]  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'general'}  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'logging'}  , );

# General tab

# Tool Section
$winConfig->AddLabel(       -name        => 'lblToolShadowT'        ,
                            -size        => [ 80, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB2                , );
$winConfig->AddLabel(       -name        => 'lblToolT'              ,
                            -size        => [ 80, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [250, 195,  27]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB2                , );
$winConfig->AddButton(      -name        => 'btnExportLang'         ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 68]               ,
                            -text        => $STR{'Export'}.'Lang.ini',
                            -font        => $font10                 , );
$winConfig->AddButton(      -name        => 'btnCheckUpdate'        ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 98]               ,
                            -text        => $STR{'checkUpdate'}     ,
                            -font        => $font10                 , );
$winConfig->AddCheckbox(    -name        => 'chAutoUpdate'          ,
                            -size        => [250, 20]               ,
                            -pos         => [285,100]               ,
                            -text        => $STR{'AutoUpdateTip'}   ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font10                 ,
                            -tabstop     => 1                       ,
                            -checked     => 1                       , );
# Functions section
$winConfig->AddLabel(       -name        => 'lblFuncShadowT'        ,
                            -size        => [350, 22]               ,
                            -pos         => [151,136]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblFuncT'}.':'    ,
                            -font        => $fontGB2                , );
$winConfig->AddLabel(       -name        => 'lblFuncT'              ,
                            -size        => [350, 22]               ,
                            -pos         => [150,135]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [250, 195,  27]         ,
                            -text        => $STR{'lblFuncT'}.':'    ,
                            -font        => $fontGB2                , );
$winConfig->AddCheckbox(    -name        => 'chHashLowercase'       ,
                            -size        => [350, 20]               ,
                            -pos         => [150,170]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chHashLowercase'} ,
                            -font        => $font10                 ,
                            -tabstop     => 1                       , );

# Logging tab
$winConfig->AddCheckbox(    -name        => 'chEnableLogging'       ,
                            -size        => [350, 20]               ,
                            -pos         => [150, 40]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chEnableLogging'} ,
                            -font        => $font10                 ,
                            -checked     => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbUseDefaultDir'       ,
                            -size        => [150, 20]               ,
                            -pos         => [150, 70]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'rbUseDefaultDir'} ,
                            -font        => $font10                 ,
                            -group       => 1                       ,
                            -checked     => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbLoggingDir'          ,
                            -size        => [245, 20]               ,
                            -pos         => [150, 95]               ,
                            -font        => $font10                 ,
                            -background  => [255, 255, 255]         , 
                            -text        => $STR{'rbLoggingDir'}.':',
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfLoggingDir'          ,
                            -size        => [400, 22]               ,
                            -pos         => [150,120]               ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddButton(      -name        => 'btnLoggingDir'         ,
                            -size        => [ 22, 22]               ,
                            -pos         => [552,120]               ,
                            -bitmap      => $openDirBmp             ,
                            -disabled    => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddCheckbox(    -name        => 'chUseDestDirCM'        ,
                            -size        => [300, 20]               ,
                            -pos         => [150,150]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chUseDestDirCM'}  ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'                   ,
                                        -parent      => $winPreview               ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]      ,
                                        -size        => [600, 170]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);

$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [460, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#

if (-T $CONFIG_FILE) {
  &loadConfig(\%CONFIG);
  
  if ($CONFIG{'TOOL_AUTO_UPDATE'}) {
    $THR_UPDATE = threads->create(sub { &updateTool(0); });
  }
}

$START = 1;
$win->Show();
Win32::GUI::Dialog();


#--------------------------#
sub winMain_Resize
#--------------------------#
{
  # Header
  $win->lblHeader->Width($win->ScaleWidth()-300);
  # Input section
  $win->lblInputT->Width($win->ScaleWidth());
  $win->tfInputDir->Width($win->ScaleWidth()-259);
  $win->btnInputDir->Left($win->ScaleWidth()-167);
  $win->chInputDirRecurse->Left($win->ScaleWidth()-142);
  $win->tfInputFiles->Width($win->ScaleWidth()-259);
  $win->btnInputFiles->Left($win->ScaleWidth()-167);
  # Filters section
  $win->lblFiltersT->Width($win->ScaleWidth());
  $win->rbFiltersSize->Left($win->ScaleWidth()/2-20);
  $win->cbFiltersSizeOp->Left($win->ScaleWidth()/2+100);
  $win->tfFiltersSize->Left($win->ScaleWidth()/2+215);
  $win->cbFiltersSizeUnit->Left($win->ScaleWidth()/2+300);
  $win->lblFiltersContainOk->Width($win->ScaleWidth()-148);
  $win->lblFiltersContainErr->Width($win->ScaleWidth()-148);
  $win->lblFiltersContainWarn->Width($win->ScaleWidth()-148);
  $win->tfFiltersContains->Width($win->ScaleWidth()-150);
  $win->rbFiltersLastModif->Left($win->ScaleWidth()/2-20);
  $win->cbFiltersLastModif->Left($win->ScaleWidth()/2+100);
  $win->dtFiltersLastModif->Left($win->ScaleWidth()/2+190);  
  # Functions section
  $win->lblFunctionsT->Width($win->ScaleWidth());
  $win->TabFunctions->Width($win->ScaleWidth()+2);
  $win->TabFunctions->Height($win->ScaleHeight()-381);
  $win->tfReportDir->Width($win->ScaleWidth()-309);
  $win->btnReportDir->Left($win->ScaleWidth()-217);
  $win->chOpenReport->Left($win->ScaleWidth()-190);
  $win->tfDestinationDir->Width($win->ScaleWidth()-309);
  $win->btnDestinationDir->Left($win->ScaleWidth()-217);
  $win->chOpenDstDir->Left($win->ScaleWidth()-190);
  $win->rbRenSort->Left($win->ScaleWidth()/2);
  $win->btnRenSort->Left($win->ScaleWidth()/2+115);
  $win->lblRenReplaceOk->Width($win->ScaleWidth()/2-73);
  $win->lblRenReplaceErr->Width($win->ScaleWidth()/2-73);
  $win->lblRenReplaceWarn->Width($win->ScaleWidth()/2-73);
  $win->tfRenReplace->Width($win->ScaleWidth()/2-75);
  $win->lblRenReplaceBy->Left($win->ScaleWidth()/2+70);
  $win->tfRenReplaceBy->Left($win->ScaleWidth()/2+115);
  $win->tfRenReplaceBy->Width($win->ScaleWidth()/2-135);
  $win->lblRenReplaceByOk->Width($win->ScaleWidth()/2-133);
  $win->lblRenReplaceByErr->Width($win->ScaleWidth()/2-133);
  $win->lblRenReplaceByWarn->Width($win->ScaleWidth()/2-133);
  $win->lblRenReplaceByOk->Left($win->ScaleWidth()/2+114);
  $win->lblRenReplaceByErr->Left($win->ScaleWidth()/2+114);
  $win->lblRenReplaceByWarn->Left($win->ScaleWidth()/2+114);
  $win->chRenReplaceByEval->Left($win->ScaleWidth()/2+115);
  # Footer
  $win->lblFooter->Top($win->ScaleHeight()-55);
  $win->lblFooter->Width($win->ScaleWidth());
  $win->lblNotReady->Top($win->ScaleHeight()-40);
  $win->lblPbCurr->Top($win->ScaleHeight()-48);
  $win->lblPbCurr->Width($win->ScaleWidth()-240);
  $win->pb->Top($win->ScaleHeight()-27);
  $win->pb->Width($win->ScaleWidth()-330);
  $win->lblPbCount->Top($win->ScaleHeight()-25);
  $win->lblPbCount->Left($win->ScaleWidth()-315);
  $win->btnProcess->Move($win->ScaleWidth()-225, $win->ScaleHeight()-45);
  $win->btnStop->Move($win->ScaleWidth()-225, $win->ScaleHeight()-45);
  $win->btnPreview->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnWinConfig->Move($win->ScaleWidth()-135, $win->ScaleHeight()-45);
  $win->btnHelp->Move($win->ScaleWidth()-90, $win->ScaleHeight()-45);
  $win->btnAbout->Move($win->ScaleWidth()-45, $win->ScaleHeight()-45);
  
}  #--- End winMain_Resize

#--------------------------#
sub rbInputDir_Click
#--------------------------#
{
  # Enable InputDir options
  $win->tfInputDir->Enable();
  $win->btnInputDir->Enable();
  $win->chInputDirRecurse->Enable();
  
  # Disable InputFiles options
  $win->tfInputFiles->Disable();
  $win->tfInputFiles->Text('');
  $win->btnInputFiles->Disable();
  
  # Enable filters
  $win->rbFiltersDirOnly->Enable;
  $win->rbFiltersSize->Enable;
  $win->rbFiltersContains->Enable;
  $win->rbFiltersLastAccess->Enable;
  $win->rbFiltersLastModif->Enable;

}  #--- End rbInputDir_Click

#--------------------------#
sub btnInputDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfInputDir->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -directory  => $lastDir          ,);
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $win->tfInputDir->Text($dir);
  }
  
  &isProcessReady(0);
  
}  #--- End btnInputDir_Click

#--------------------------#
sub rbInputFiles_Click
#--------------------------#
{
  # Enable InputFiles options
  $win->tfInputFiles->Enable();
  $win->btnInputFiles->Enable();
  
  # Enable InputDir options
  $win->tfInputDir->Disable();
  $win->tfInputDir->Text('');
  $win->btnInputDir->Disable();
  $win->chInputDirRecurse->Disable();
  
  # Disable filters
  $win->rbFiltersNone->Checked(1);
  $win->rbFiltersDirOnly->Checked(0);
  $win->rbFiltersDirOnly->Disable;
  $win->rbFiltersSize->Checked(0);
  $win->rbFiltersSize->Disable;
  $win->rbFiltersContains->Checked(0);
  $win->rbFiltersContains->Disable;
  $win->rbFiltersLastAccess->Checked(0);
  $win->rbFiltersLastAccess->Disable;
  $win->rbFiltersLastModif->Checked(0);
  $win->rbFiltersLastModif->Disable;
  &selectFilter();

}  #--- End rbInputFiles_Click

#--------------------------#
sub btnInputFiles_Click
#--------------------------#
{
  # Local variables
  my $lastFiles = $win->tfInputFiles->Text();
  my $lastDir   = $win->tfInputDir->Text();
  my @filesStr;

  # Show OpenFile dialog window
  if ($lastFiles) {
    # Multiple files
    if ($lastFiles =~ /" "/) { $lastDir = (split(/" "/, $lastFiles))[0]; }
    # Single file
    else { $lastDir = $lastFiles; }
    my @parts = split(/ /, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                              -title         => $STR{'selFiles'}.':' ,
                                              -defaultfilter => 0                    ,
                                              -filemustexist => 1                    ,
                                              -multisel      => 1                    ,
                                              -directory     => $lastDir             ,
                                              -explorer      => 1                    , );
  } elsif ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                              -title         => $STR{'selFiles'}.':' ,
                                              -defaultfilter => 0                    ,
                                              -filemustexist => 1                    ,
                                              -multisel      => 1                    ,
                                              -directory     => $lastDir             ,
                                              -explorer      => 1                    , );
  } else {
    @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                              -title         => $STR{'selFiles'}.':' ,
                                              -defaultfilter => 0                    ,
                                              -filemustexist => 1                    ,
                                              -multisel      => 1                    ,
                                              -explorer      => 1                    , );
  }

  # Selected file
  if (scalar(@filesStr) > 0) {
    # Single file
    if (scalar(@filesStr) == 1) { $win->tfInputFiles->Text($filesStr[0]); }
    # Multiple files
    else {
      my $filesStr;
      foreach my $file (@filesStr) { $filesStr .= "\"$file\" "; }
      chop($filesStr);
      $win->tfInputFiles->Text($filesStr);
    }
  }
  
  &isProcessReady(0);

}  #--- End btnInputFiles_Click

#--------------------------#
sub rbFiltersNone_Click
#--------------------------#
{
  &selectFilter();

}  #--- End rbFiltersNone_Click

#--------------------------#
sub rbFiltersDirOnly_Click
#--------------------------#
{
  &selectFilter();

}  #--- End rbFiltersDirOnly_Click

#--------------------------#
sub rbFiltersSize_Click
#--------------------------#
{
  &selectFilter();

}  #--- End rbFiltersSize_Click

#--------------------------#
sub tfFiltersSize_Change
#--------------------------#
{
  &isProcessReady(0);

}  #--- End tfFiltersSize_Change

#--------------------------#
sub rbFiltersContains_Click
#--------------------------#
{
  &selectFilter();

}  #--- End rbFiltersContains_Click

#--------------------------#
sub tfFiltersContains_Change
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chFiltersContainsRegex->Checked()) {
    &showContainsRegexStatus;
  }

  &isProcessReady(0);

}  #--- End tfFiltersContains_Change

#--------------------------#
sub chFiltersContainsRegex_Click
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chFiltersContainsRegex->Checked()) {
    &showContainsRegexStatus;
  } else {
    $win->lblFiltersContainOk->Hide();
    $win->lblFiltersContainErr->Hide();
    $win->lblFiltersContainWarn->Hide();
  }

  &isProcessReady(0);

}  #--- End chFiltersContainsRegex_Click

#--------------------------#
sub showContainsRegexStatus
#--------------------------#
{
  # Local variables
  my $regex = $win->tfFiltersContains->Text();
  if ($regex) {
    my ($statusRegex, $msg) = &validRegex($regex);
    
    # Warning
    if      ($statusRegex == 2) {
      $win->lblFiltersContainWarn->Show();
      $win->lblFiltersContainOk->Hide();
      $win->lblFiltersContainErr->Hide();
    # Error
    } elsif ($statusRegex == 1) {
      $win->lblFiltersContainErr->Show();
      $win->lblFiltersContainOk->Hide();
      $win->lblFiltersContainWarn->Hide();
    # Ok
    } else {
      $win->lblFiltersContainOk->Show();
      $win->lblFiltersContainErr->Hide();
      $win->lblFiltersContainWarn->Hide();
    }
  } else {
    $win->lblFiltersContainOk->Hide();
    $win->lblFiltersContainErr->Hide();
    $win->lblFiltersContainWarn->Hide();
  }

}  #--- End showContainsRegexStatus

#--------------------------#
sub rbFiltersLastAccess_Click
#--------------------------#
{
  &selectFilter();

}  #--- End rbFiltersLastAccess_Click

#--------------------------#
sub rbFiltersLastModif_Click
#--------------------------#
{
  &selectFilter();

}  #--- End rbFiltersLastModif_Click

#--------------------------#
sub selectFilter
#--------------------------#
{
  # None
  if      ($win->rbFiltersNone->Checked()) {    # Filter: None
    # Disable all other options
    $win->cbFiltersSizeOp->Disable();
    $win->tfFiltersSize->Text('');
    $win->tfFiltersSize->Disable();
    $win->cbFiltersSizeUnit->Disable();
    $win->tfFiltersContains->Text('');
    $win->tfFiltersContains->Disable();
    $win->chFiltersContainsCase->Disable();
    $win->chFiltersContainsRegex->Disable();
    $win->chFiltersContainsFileOnly->Disable();
    $win->cbFiltersLastAccess->Disable();
    $win->dtFiltersLastAccess->Disable();
    $win->cbFiltersLastModif->Disable();
    $win->dtFiltersLastModif->Disable();
    # Reactivate Functions and options
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt2->Enable();
    $win->chListFilesOpt3->Enable();
    $win->chListFilesOpt4->Enable();
    $win->chListFilesOpt5->Enable();
    $win->chListFilesOpt6->Enable();
    $win->chListFilesOpt8->Enable();
    $win->chCopyRemDouble->Enable();
    $win->rbRenByHash->Checked(1);
    $win->rbRenSort->Checked(0);
    $win->rbRenReplace->Checked(0);
    $win->rbRenByHash->Enable();
    $win->cbRenByHash->Enable();
    $win->rbRenSort->Enable();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Enable();
    $win->tfRenReplace->Disable();
    $win->lblRenReplaceBy->Disable();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceFolder->Disable();

  } elsif ($win->rbFiltersDirOnly->Checked()) {   # Filter: Only folders
    # Disable all other options
    $win->cbFiltersSizeOp->Disable();
    $win->tfFiltersSize->Text('');
    $win->tfFiltersSize->Disable();
    $win->cbFiltersSizeUnit->Disable();
    $win->tfFiltersContains->Text('');
    $win->tfFiltersContains->Disable();
    $win->chFiltersContainsCase->Disable();
    $win->chFiltersContainsRegex->Disable();
    $win->chFiltersContainsFileOnly->Disable();
    $win->cbFiltersLastAccess->Disable();
    $win->dtFiltersLastAccess->Disable();
    $win->cbFiltersLastModif->Disable();
    $win->dtFiltersLastModif->Disable();
    # Functions
    # Lot of options and functions don't apply to folders, disable it
    # List full path only
    $win->chListFilesOpt2->Checked(0);
    $win->chListFilesOpt2->Disable();
    $win->chListFilesOpt3->Checked(0);
    $win->chListFilesOpt3->Disable();
    $win->chListFilesOpt4->Checked(0);
    $win->chListFilesOpt4->Disable();
    $win->chListFilesOpt5->Checked(0);
    $win->chListFilesOpt5->Disable();
    $win->chListFilesOpt6->Checked(0);
    $win->chListFilesOpt6->Disable();
    $win->chListFilesOpt8->Checked(0);
    $win->chListFilesOpt8->Disable();
    # Copy or move : Can't remove duplicate
    $win->chCopyRemDouble->Checked(0);
    $win->chCopyRemDouble->Disable;
    # Rename : Disable all
    $win->rbRenByHash->Checked(0);
    $win->rbRenByHash->Disable();
    $win->cbRenByHash->Disable();
    $win->rbRenSort->Checked(0);
    $win->rbRenSort->Disable();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Checked(0);
    $win->rbRenReplace->Disable();
    $win->tfRenReplace->Disable();
    $win->lblRenReplaceBy->Disable();
    $win->tfRenReplaceBy->Disable();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceByEval->Disable();
    $win->chRenReplaceFolder->Disable();
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    
  } elsif ($win->rbFiltersSize->Checked()) {    # Filter: File size
    # Enable options
    $win->cbFiltersSizeOp->Enable();
    $win->tfFiltersSize->Enable();
    $win->cbFiltersSizeUnit->Enable();
    # Disable all other options
    $win->tfFiltersContains->Text('');
    $win->tfFiltersContains->Disable();
    $win->chFiltersContainsCase->Disable();
    $win->chFiltersContainsRegex->Disable();
    $win->chFiltersContainsFileOnly->Disable();
    $win->cbFiltersLastAccess->Disable();
    $win->dtFiltersLastAccess->Disable();
    $win->cbFiltersLastModif->Disable();
    $win->dtFiltersLastModif->Disable();
    # Reactivate Functions and options
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt2->Enable();
    $win->chListFilesOpt3->Enable();
    $win->chListFilesOpt4->Enable();
    $win->chListFilesOpt5->Enable();
    $win->chListFilesOpt6->Enable();
    $win->chListFilesOpt8->Enable();
    $win->chCopyRemDouble->Enable();
    $win->rbRenByHash->Checked(1);
    $win->rbRenSort->Checked(0);
    $win->rbRenReplace->Checked(0);
    $win->rbRenByHash->Enable();
    $win->cbRenByHash->Enable();
    $win->rbRenSort->Enable();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Enable();
    $win->tfRenReplace->Disable();
    $win->lblRenReplaceBy->Disable();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceFolder->Disable();
    
  } elsif ($win->rbFiltersContains->Checked()) {    # Filter: Contains
    # Enable options
    $win->tfFiltersContains->Enable();
    $win->chFiltersContainsCase->Enable();
    $win->chFiltersContainsRegex->Enable();
    $win->chFiltersContainsFileOnly->Enable();
    # Disable all other options
    $win->cbFiltersSizeOp->Disable();
    $win->tfFiltersSize->Text('');
    $win->tfFiltersSize->Disable();
    $win->cbFiltersSizeUnit->Disable();
    $win->cbFiltersLastAccess->Disable();
    $win->dtFiltersLastAccess->Disable();
    $win->cbFiltersLastModif->Disable();
    $win->dtFiltersLastModif->Disable();
    # Reactivate Functions and options
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt2->Enable();
    $win->chListFilesOpt3->Enable();
    $win->chListFilesOpt4->Enable();
    $win->chListFilesOpt5->Enable();
    $win->chListFilesOpt6->Enable();
    $win->chListFilesOpt8->Enable();
    $win->chCopyRemDouble->Enable();
    $win->rbRenByHash->Checked(1);
    $win->rbRenSort->Checked(0);
    $win->rbRenReplace->Checked(0);
    $win->rbRenByHash->Enable();
    $win->cbRenByHash->Enable();
    $win->rbRenSort->Enable();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Enable();
    $win->tfRenReplace->Disable();
    $win->lblRenReplaceBy->Disable();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceFolder->Disable();
    
  } elsif ($win->rbFiltersLastAccess->Checked()) {    # Filter: Last accessed
    # Enable options
    $win->cbFiltersLastAccess->Enable();
    $win->dtFiltersLastAccess->Enable();
    # Disable all other options
    $win->cbFiltersSizeOp->Disable();
    $win->tfFiltersSize->Text('');
    $win->tfFiltersSize->Disable();
    $win->cbFiltersSizeUnit->Disable();
    $win->tfFiltersContains->Text('');
    $win->tfFiltersContains->Disable();
    $win->chFiltersContainsCase->Disable();
    $win->chFiltersContainsRegex->Disable();
    $win->chFiltersContainsFileOnly->Disable();
    $win->cbFiltersLastModif->Disable();
    $win->dtFiltersLastModif->Disable();
    # Reactivate Functions and options
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt2->Enable();
    $win->chListFilesOpt3->Enable();
    $win->chListFilesOpt4->Enable();
    $win->chListFilesOpt5->Enable();
    $win->chListFilesOpt6->Enable();
    $win->chListFilesOpt8->Enable();
    $win->chCopyRemDouble->Enable();
    $win->rbRenByHash->Checked(1);
    $win->rbRenSort->Checked(0);
    $win->rbRenReplace->Checked(0);
    $win->rbRenByHash->Enable();
    $win->cbRenByHash->Enable();
    $win->rbRenSort->Enable();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Enable();
    $win->tfRenReplace->Disable();
    $win->lblRenReplaceBy->Disable();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceFolder->Disable();
    
  } elsif ($win->rbFiltersLastModif->Checked()) {   # Filter: Last modified
    # Enable options
    $win->cbFiltersLastModif->Enable();
    $win->dtFiltersLastModif->Enable();
    # Disable all other options
    $win->cbFiltersSizeOp->Disable();
    $win->tfFiltersSize->Text('');
    $win->tfFiltersSize->Disable();
    $win->cbFiltersSizeUnit->Disable();
    $win->tfFiltersContains->Text('');
    $win->tfFiltersContains->Disable();
    $win->chFiltersContainsCase->Disable();
    $win->chFiltersContainsRegex->Disable();
    $win->chFiltersContainsFileOnly->Disable();
    $win->cbFiltersLastAccess->Disable();
    $win->dtFiltersLastAccess->Disable();
    # Reactivate Functions and options
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt2->Enable();
    $win->chListFilesOpt3->Enable();
    $win->chListFilesOpt4->Enable();
    $win->chListFilesOpt5->Enable();
    $win->chListFilesOpt6->Enable();
    $win->chListFilesOpt8->Enable();
    $win->chCopyRemDouble->Enable();
    $win->rbRenByHash->Checked(1);
    $win->rbRenSort->Checked(0);
    $win->rbRenReplace->Checked(0);
    $win->rbRenByHash->Enable();
    $win->cbRenByHash->Enable();
    $win->rbRenSort->Enable();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Enable();
    $win->tfRenReplace->Disable();
    $win->lblRenReplaceBy->Disable();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceFolder->Disable();
  }
  
  &isProcessReady(0);
  
}  #--- End selectFilter

#--------------------------#
sub TabFunctions_Click
#--------------------------#
{
  # Show List Function tab
  if (!$win->TabFunctions->SelectedItem()) {
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->rbListFiles->Show();
    $win->chListFilesOpt1->Show();
    $win->chListFilesOpt2->Show();
    $win->chListFilesOpt3->Show();
    $win->chListFilesOpt4->Show();
    $win->chListFilesOpt5->Show();
    $win->chListFilesOpt6->Show();
    $win->chListFilesOpt7->Show();
    $win->chListFilesOpt8->Show();
    $win->rbListExt->Show();
    $win->lblReportDir->Show();
    $win->tfReportDir->Show();
    $win->btnReportDir->Show();
    $win->chOpenReport->Show();
    # Hide Copy or move Function tab
    $win->rbCopy->Checked(1);
    $win->rbCopy->Hide();
    $win->rbMove->Checked(0);
    $win->rbMove->Hide();
    $win->chCopyTree->Checked(0);
    $win->chCopyTree->Hide();
    $win->chCopyRemDouble->Checked(0);
    $win->chCopyRemDouble->Hide();
    $win->lblDestination->Hide();
    $win->tfDestinationDir->Text('');
    $win->tfDestinationDir->Hide();
    $win->btnDestinationDir->Hide();
    $win->chOpenDstDir->Hide();
    # Hide Rename Function tab
    $win->rbRenByHash->Checked(1);
    $win->rbRenByHash->Hide();
    $win->cbRenByHash->Hide();
    $win->rbRenSort->Checked(0);
    $win->rbRenSort->Hide();
    $win->btnRenSort->Hide();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Checked(0);
    $win->rbRenReplace->Hide();
    $win->tfRenReplace->Disable();
    $win->tfRenReplace->Hide();
    $win->tfRenReplace->Text('');
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Disable();
    $win->chRenReplaceFolder->Hide();
    $win->lblRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Disable();
    $win->tfRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Text('');
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->chRenReplaceByEval->Disable();
    $win->chRenReplaceByEval->Hide();
    
  # Show Copy or move Function tab
  } elsif ($win->TabFunctions->SelectedItem() == 1) {
    $win->rbCopy->Show();
    $win->rbMove->Show();
    $win->chCopyTree->Show();
    $win->chCopyRemDouble->Show();
    $win->lblDestination->Show();
    $win->tfDestinationDir->Show();
    $win->btnDestinationDir->Show();
    $win->chOpenDstDir->Show();
    # Hide List Function tab
    $win->rbListFiles->Hide();
    $win->chListFilesOpt1->Hide();
    $win->chListFilesOpt2->Hide();
    $win->chListFilesOpt3->Hide();
    $win->chListFilesOpt4->Hide();
    $win->chListFilesOpt5->Hide();
    $win->chListFilesOpt6->Hide();
    $win->chListFilesOpt7->Hide();
    $win->chListFilesOpt8->Hide();
    $win->rbListExt->Hide();
    $win->lblReportDir->Hide();
    $win->tfReportDir->Hide();
    $win->btnReportDir->Hide();
    $win->chOpenReport->Hide();
    # Hide Rename Function tab
    $win->rbRenByHash->Checked(1);
    $win->rbRenByHash->Hide();
    $win->cbRenByHash->Hide();
    $win->rbRenSort->Checked(0);
    $win->rbRenSort->Hide();
    $win->btnRenSort->Hide();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Checked(0);
    $win->rbRenReplace->Hide();
    $win->tfRenReplace->Disable();
    $win->tfRenReplace->Hide();
    $win->tfRenReplace->Text('');
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Disable();
    $win->chRenReplaceFolder->Hide();
    $win->lblRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Disable();
    $win->tfRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Text('');
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->chRenReplaceByEval->Disable();
    $win->chRenReplaceByEval->Hide();
    
  # Show Rename Function tab
  } elsif ($win->TabFunctions->SelectedItem() == 2) {
    $win->rbRenReplace->Show();
    $win->tfRenReplace->Show();
    $win->chRenReplaceCase->Show();
    $win->chRenReplaceRegex->Show();
    $win->chRenReplaceFolder->Show();
    $win->lblRenReplaceBy->Show();
    $win->tfRenReplaceBy->Show();
    $win->chRenReplaceByEval->Show();
    $win->rbRenByHash->Show();
    $win->cbRenByHash->Show();
    $win->rbRenSort->Show();
    $win->btnRenSort->Show();
    # Hide List Function tab
    $win->rbListFiles->Hide();
    $win->chListFilesOpt1->Hide();
    $win->chListFilesOpt2->Hide();
    $win->chListFilesOpt3->Hide();
    $win->chListFilesOpt4->Hide();
    $win->chListFilesOpt5->Hide();
    $win->chListFilesOpt6->Hide();
    $win->chListFilesOpt7->Hide();
    $win->chListFilesOpt8->Hide();
    $win->rbListExt->Hide();
    $win->lblReportDir->Hide();
    $win->tfReportDir->Hide();
    $win->btnReportDir->Hide();
    $win->chOpenReport->Hide();
    # Hide Copy or move Function tab
    $win->rbCopy->Hide();
    $win->rbMove->Hide();
    $win->chCopyTree->Hide();
    $win->chCopyRemDouble->Hide();
    $win->lblDestination->Hide();
    $win->tfDestinationDir->Hide();
    $win->btnDestinationDir->Hide();
    $win->chOpenDstDir->Hide();
  }
  
  &isProcessReady(0);
  
}  #--- End TabFunctions_Click

#--------------------------#
sub rbListFiles_Click
#--------------------------#
{
  if ($win->rbFiltersDirOnly->Checked()) {   # Filter: Only folders
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt7->Enable();
  } else {
    $win->chListFilesOpt1->Enable();
    $win->chListFilesOpt2->Enable();
    $win->chListFilesOpt3->Enable();
    $win->chListFilesOpt4->Enable();
    $win->chListFilesOpt5->Enable();
    $win->chListFilesOpt6->Enable();
    $win->chListFilesOpt7->Enable();
    $win->chListFilesOpt8->Enable();
  }
  
  &isProcessReady(0);

}  #--- End crbListFiles_Click

#--------------------------#
sub chListFilesOpt1_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOpt1_Click

#--------------------------#
sub chListFilesOpt2_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOpt2_Click

#--------------------------#
sub chListFilesOpt3_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOpt3_Click

#--------------------------#
sub chListFilesOpt4_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOpt4_Click

#--------------------------#
sub chListFilesOpt5_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOpt5_Click

#--------------------------#
sub chListFilesOpt6_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOpt6_Click

#--------------------------#
sub rbListExt_Click
#--------------------------#
{
  $win->chListFilesOpt1->Disable();
  $win->chListFilesOpt2->Disable();
  $win->chListFilesOpt3->Disable();
  $win->chListFilesOpt4->Disable();
  $win->chListFilesOpt5->Disable();
  $win->chListFilesOpt6->Disable();
  $win->chListFilesOpt7->Disable();
  $win->chListFilesOpt8->Disable();
  
  &isProcessReady(0);

}  #--- End rbListExt_Click

#--------------------------#
sub tfReportDir_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $win->tfReportDir->Text();
  
  # Remember
  if ($saveDir and -d $saveDir) {
    $CONFIG{'DIR_REPORT'} = $saveDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'DIR_REPORT'});
    &saveConfig(\%CONFIG);
    if ($saveDir) {
      $win->tfReportDir->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($win, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010); }
    }
  }

}  #--- End tfReportDir_Change

#--------------------------#
sub btnReportDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfReportDir->Text();
  my $dir;

  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -directory  => $lastDir          ,
                                        -newui      => 1                 , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -newui      => 1                 , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $win->tfReportDir->Text($dir);
  }
  
}  #--- End btnReportDir_Click

#--------------------------#
sub btnOpenDir_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $win->tfReportDir->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }

}  #--- End btnOpenDir_Click

#--------------------------#
sub chOpenReport_Click
#--------------------------#
{
  # Save the choice
  if ($win->chOpenReport->Checked()) {
    $CONFIG{'AUTO_OPEN_REPORT'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_OPEN_REPORT'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOpenReport_Click

#--------------------------#
sub rbCopy_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End rbCopy_Click

#--------------------------#
sub rbMove_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End rbMove_Click

#--------------------------#
sub tfDestinationDir_Change
#--------------------------#
{
  &isProcessReady(0);

}  #--- End tfReportDir_Change

#--------------------------#
sub btnDestinationDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfDestinationDir->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win                 ,
                                        -title      => $STR{'selDirDst'}.':',
                                        -folderonly => 1                    ,
                                        -directory  => $lastDir             ,);
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win                 ,
                                        -title      => $STR{'selDirDst'}.':',
                                        -folderonly => 1                    , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $win->tfDestinationDir->Text($dir);
  }
  
  &isProcessReady(0);
  
}  #--- End btnDestinationDir_Click

#--------------------------#
sub rbRenByHash_Click
#--------------------------#
{
  # Enable options
  $win->cbRenByHash->Enable();
  # Disable other option controls
  $win->btnRenSort->Disable();
  $win->tfRenReplace->Disable();
  $win->tfRenReplaceBy->Disable();
  $win->chRenReplaceCase->Disable();
  $win->chRenReplaceRegex->Disable();
  $win->chRenReplaceFolder->Disable();
  $win->chRenReplaceByEval->Disable();
  
  &isProcessReady(0);

}  #--- End rbRenByHash_Click

#--------------------------#
sub rbRenSort_Click
#--------------------------#
{
  # Enable options
  $win->btnRenSort->Enable();
  # Disable other option controls
  $win->cbRenByHash->Disable();
  $win->tfRenReplace->Disable();
  $win->tfRenReplaceBy->Disable();
  $win->chRenReplaceCase->Disable();
  $win->chRenReplaceRegex->Disable();
  $win->chRenReplaceFolder->Disable();
  $win->chRenReplaceByEval->Disable();
  
  &isProcessReady(0);

}  #--- End rbRenSort_Click

#--------------------------#
sub btnRenSort_Click
#--------------------------#
{
  &winRenBySortOptExample();
  $winRenBySortOpt->Center($win);
  $winRenBySortOpt->DoModal();

}  #--- End btnRenSort_Click

#--------------------------#
sub cbIncrValType_Change
#--------------------------#
{
  if ($START == 1) {
    $winRenBySortOpt->upDownInitVal->SetPos(1);
    my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
    if    (!$incrValType)     { $winRenBySortOpt->tfInitVal->Text(1);   $winRenBySortOpt->upDownInitVal->SetBase(10); } # '1,2,3,...'
    elsif ($incrValType == 1) { $winRenBySortOpt->upDownInitVal->SetBase(10); $winRenBySortOpt->tfInitVal->Text('a'); } # 'a-z,aa-zz,...'
    elsif ($incrValType == 2) { $winRenBySortOpt->upDownInitVal->SetBase(10); $winRenBySortOpt->tfInitVal->Text('A'); } # 'A-Z,AA-ZZ,...'
    elsif ($incrValType == 3) { $winRenBySortOpt->tfInitVal->Text(1);   $winRenBySortOpt->upDownInitVal->SetBase(16); } # '0-f,00-ff,...'
    elsif ($incrValType == 4) { $winRenBySortOpt->tfInitVal->Text(1);   $winRenBySortOpt->upDownInitVal->SetBase(16); } # '0-F,00-FF,...'
    elsif ($incrValType == 5) { $winRenBySortOpt->upDownInitVal->SetBase(10); $winRenBySortOpt->tfInitVal->Text('I'); } # 'I,II,III IV,...'
    &winRenBySortOptExample();
  }

}  #--- End cbIncrValType_Change

#--------------------------#
sub tfLength_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfLength_Change

#--------------------------#
sub upDownInitVal_Scroll
#--------------------------#
{
  my ($buf1, $bu2, $pos) = @_;
  my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
  my $formatedVal = &formatVal($incrValType, $pos, 1);
  $winRenBySortOpt->tfInitVal->Text($formatedVal);

}  #--- End upDownInitVal_Scroll

#--------------------------#
sub tfInitVal_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfInitVal_Change

#--------------------------#
sub tfStepVal_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfStepVal_Change

#--------------------------#
sub tfPrefix_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfPrefix_Change

#--------------------------#
sub tfSuffix_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfSuffix_Change

#--------------------------#
sub winRenBySortOptExample
#--------------------------#
{
  # Local variables
  my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
  my $length      = $winRenBySortOpt->tfLength->Text();
  my $initVal     = $winRenBySortOpt->tfInitVal->Text();
  my $stepVal     = $winRenBySortOpt->tfStepVal->Text();
  my $prefix      = $winRenBySortOpt->tfPrefix->Text();
  my $suffix      = $winRenBySortOpt->tfSuffix->Text();
  my $isValid     = 0;
  
  # Illegal characters in prefix or suffix
  if ($prefix =~ /[\<\>\:\"\/\\\|\?\*]/ or $suffix =~ /[\<\>\:\"\/\\\|\?\*]/) {
    $winRenBySortOpt->tfExample->Text($STR{'errChars'});
    
  } else {
    # Initial value
    if ($length and $initVal) {
      if    (!$incrValType     and $initVal =~ /^[0-9]+$/)      { $isValid = 1; } # '1,2,3,...'
      elsif ($incrValType == 1 and $initVal =~ /^[a-z]+$/)      { $isValid = 1; } # 'a-z,aa-zz,...'
      elsif ($incrValType == 2 and $initVal =~ /^[A-Z]+$/)      { $isValid = 1; } # 'A-Z,AA-ZZ,...'
      elsif ($incrValType == 3 and $initVal =~ /^[0-9a-f]+$/)   { $isValid = 1; } # '0-f,00-ff,...'
      elsif ($incrValType == 4 and $initVal =~ /^[0-9A-F]+$/)   { $isValid = 1; } # '0-F,00-FF,...'
      elsif ($incrValType == 5 and $initVal =~ /^[IVXLCDM_]+$/) { $isValid = 1; } # 'I,II,III IV,...'
    } else { $isValid = 0; }
    
    # Create example
    if ($isValid == 1) {
      $winRenBySortOpt->btnWinRenBySortOptOk->Enable();
      my $example = '';
      for (my $i = 0; $i < 3; $i++) { # Generate three values with selected options
        if ($prefix) { $example .= $prefix;  }
        my $currVal = ($i * $stepVal);
        my $initValDec = &convertInitVal($incrValType, $initVal);
        $currVal += $initValDec;
        my $formatedVal = &formatVal($incrValType, $currVal, $length);
        $example       .= $formatedVal;
        if ($suffix) { $example .= $suffix;  }
        $example .= '.ext, ';
      }
      $example .= '...';
      $winRenBySortOpt->tfExample->Text($example);
    } else {
      $winRenBySortOpt->tfExample->Text('');
      $winRenBySortOpt->btnWinRenBySortOptOk->Disable();
    }
  }
  
}  #--- End winRenBySortOptExample

#--------------------------#
sub convertInitVal
#--------------------------#
{
  # Local variables
  my ($incrValType, $initVal) = @_;
  my $decimal;

  # Decimal already
  if    (!$incrValType) { return($initVal); }
  # Alphabet
  elsif ($incrValType == 1 or $incrValType == 2) { # 'a-z,aa-zz,...' or 'A-Z,AA-ZZ,...'
    my @values = split('', $initVal);
    my $multi = 0;
    foreach (reverse @values) {
      if ($_ =~ /[a-zA-Z]/) {
        my $val2add = (ord(lc($_)) - 96);
        for (my $i = 0; $i < $multi; $i++) { $val2add = $val2add * 26; }
        $decimal += $val2add;
      }
      $multi++;
    }
  # Hexadecimal
  } elsif ($incrValType == 3 or $incrValType == 4) { # '0-f,00-ff,...' or '0-F,00-FF,...'
    $decimal = hex($initVal);
  # Roman
  } elsif ($incrValType == 5) { # 'I,II,III IV,...'
    $decimal = roman2int($initVal);
  }

  return($decimal);
  
}  #--- End convertInitVal

#--------------------------#
sub formatVal
#--------------------------#
{
  # Local variables
  my ($incrValType, $val, $length) = @_;
  my $convertedVal;
  my $nullChar;
  
  # Decimal
  if (!$incrValType) {
    $nullChar     = 0;
    $convertedVal = $val;
  # Alphabet
  } elsif ($incrValType == 1 or $incrValType == 2) { # 'a-z,aa-zz,...' or 'A-Z,AA-ZZ,...'
    $nullChar = '_';
    my @values;
    my $offset = $val;
    while ($offset > 26) {
      my $currOffset = int($offset / 26);
      push(@values, $offset - ($currOffset*26));
      $offset = $currOffset;
    }
    push(@values, $offset);
    foreach my $value (reverse @values) {
      if    ($incrValType == 1) { $value += 96; } # 'a-z,aa-zz,...'
      elsif ($incrValType == 2) { $value += 64; } # 'A-Z,AA-ZZ,...'
      $convertedVal .= chr($value);
    }
  # Hexadecimal
  } elsif ($incrValType == 3 or $incrValType == 4) { # '0-f,00-ff,...' or '0-F,00-FF,...'
    $nullChar = '0';
    $convertedVal .= sprintf("%x", $val);
    if    ($incrValType == 3) { $convertedVal = lc($convertedVal); }
    elsif ($incrValType == 4) { $convertedVal = uc($convertedVal); }
  # Roman
  } elsif ($incrValType == 5) { # 'I,II,III IV,...'
    $nullChar = '_';
    $convertedVal = int2roman($val);
  }
  
  # Fill with null
  while (length($convertedVal) < $length) { $convertedVal = $nullChar . $convertedVal; }

  return($convertedVal);
  
}  #--- End formatVal

#--------------------------#
sub btnWinRenBySortOptOk_Click
#--------------------------#
{
  &isProcessReady(0);
  return(-1);
  
}  #--- End btnWinRenBySortOptOk_Click

#--------------------------#
sub rbRenReplace_Click
#--------------------------#
{
  # Enable options
  $win->tfRenReplace->Enable();
  $win->chRenReplaceCase->Enable();
  $win->chRenReplaceRegex->Enable();
  $win->chRenReplaceFolder->Enable();
  # Disable other option controls
  $win->cbRenByHash->Disable();
  $win->btnRenSort->Disable();
  
  &isProcessReady(0);

}  #--- End rbRenReplace_Click

#--------------------------#
sub tfRenReplace_Change
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceRegexStatus;
  }
  
  # Enable By textfield
  if ($win->tfRenReplace->Text) {
    $win->tfRenReplaceBy->Enable();
    if ($win->chRenReplaceRegex->Checked()) { $win->chRenReplaceByEval->Enable(); }
  } else {
    $win->tfRenReplaceBy->Text('');
    $win->tfRenReplaceBy->Disable();
    $win->chRenReplaceByEval->Disable();
  }
  
  &isProcessReady(0);

}  #--- End tfRenReplace_Change

#--------------------------#
sub chRenReplaceRegex_Click
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceRegexStatus;
    $win->chRenReplaceByEval->Enable();
  } else {
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceByEval->Disable();
  }
  
  # Revaluate Replacement expression
  if ($win->tfRenReplaceBy->Text()) { &showRenReplaceByStatus; }
  
  &isProcessReady(0);

}  #--- End chRenReplaceRegex_Click

#--------------------------#
sub showRenReplaceRegexStatus
#--------------------------#
{
  # Local variables
  my $regex = $win->tfRenReplace->Text();
  if ($regex) {
    my ($statusRegex, $msg) = &validRegex($regex);
    
    # Warning
    if      ($statusRegex == 2) {
      $win->lblRenReplaceWarn->Show();
      $win->lblRenReplaceOk->Hide();
      $win->lblRenReplaceErr->Hide();
    # Error
    } elsif ($statusRegex) {
      $win->lblRenReplaceErr->Show();
      $win->lblRenReplaceOk->Hide();
      $win->lblRenReplaceWarn->Hide();
    # Ok
    } else {
      $win->lblRenReplaceOk->Show();
      $win->lblRenReplaceErr->Hide();
      $win->lblRenReplaceWarn->Hide();
    }
  } else {
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
  }

}  #--- End showRenReplaceRegexStatus

#--------------------------#
sub tfRenReplaceBy_Change
#--------------------------#
{
  &showRenReplaceByStatus;

  &isProcessReady(0);

}  #--- End tfRenReplace_Change

#--------------------------#
sub chRenReplaceByEval_Click
#--------------------------#
{
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceByStatus;
  } else {
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
  }
  &isProcessReady(0);

}  #--- End chRenReplaceByEval_Click

#--------------------------#
sub showRenReplaceByStatus
#--------------------------#
{
  # Local variables
  my $expr = $win->tfRenReplaceBy->Text();
  if ($expr) {
    my ($status, $msg) = &validReplacement;
    
    # Warning
    if      ($status and $status == 2) {
      $win->lblRenReplaceByWarn->Show();
      $win->lblRenReplaceByOk->Hide();
      $win->lblRenReplaceByErr->Hide();
    # Error
    } elsif ($status) {
      $win->lblRenReplaceByErr->Show();
      $win->lblRenReplaceByOk->Hide();
      $win->lblRenReplaceByWarn->Hide();
    # Ok
    } else {
      $win->lblRenReplaceByOk->Show();
      $win->lblRenReplaceByErr->Hide();
      $win->lblRenReplaceByWarn->Hide();
    }
  } else {
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
  }

}  #--- End showRenReplaceByStatus

#--------------------------#
sub btnProcess_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'Error'}, 0x40010);
  } else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        threads->exit();
      };
      
      # Local variables
      my %listFiles;
      
      # Show progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Show();
      $win->pb->Show();
      $win->lblPbCount->Show();
      $win->btnProcess->Hide();
      $win->btnStop->Show();
      $win->ChangeCursor($HOURGLASS);
      
      # List of file paths
      &getListFiles(\%listFiles, 1);
      
      # List Files or Extensions
      if (!$win->TabFunctions->SelectedItem()) {
        # List Files
        if    ($win->rbListFiles->Checked()) { &listFilesReport(\%listFiles); }
        # List Extensions
        elsif ($win->rbListExt->Checked())   { &listExtReport(\%listFiles);   }
      # Copy or move
      } elsif ($win->TabFunctions->SelectedItem() == 1) {
        &copyMove(\%listFiles, 1);
      # Rename
      } elsif ($win->TabFunctions->SelectedItem() == 2) {
        &renameFiles(\%listFiles, 1);
      }
      
      # Progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Hide();
      $win->pb->Hide();
      $win->lblPbCount->Hide();
      $win->btnProcess->Show();
      $win->btnStop->Hide();      
      $win->ChangeCursor($ARROW);
    });
  }
  
}  #--- End btnProcess_Click

#--------------------------#
sub btnStop_Click
#--------------------------#
{
  # Stop requests
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { $THR_PROCESS->kill('KILL')->detach(); }
  return(1);

}  #--- End btnStop_Click

#--------------------------#
sub btnPreview_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'Error'}, 0x40010);
  } else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        threads->exit();
      };
      
      # Show progress window
      $winPb->Center($winPreview);
      $winPb->Show();
      
      # Local variables
      my %listFiles;
      
      # List of file paths
      &getListFiles(\%listFiles, 0);
      
      # Reset trees
      $winPreview->tvBefore->DeleteAllItems();
      $winPreview->tvAfter->DeleteAllItems();
      
      # Fill the Before tree
      my $baseDir;
      if ($win->tfInputDir->Text()) { $baseDir = $win->tfInputDir->Text(); }
      else {
        my $filesStr = $win->tfInputFiles->Text();
        # Set base dir
        if ($filesStr) {
          # Multiple files
          if ($filesStr =~ /" "/) {
            $baseDir = (split(/" "/, $filesStr))[0];
            $baseDir =~ s/\"//g;
          }
          # Single file
          else {
            my @pathParts = split(/\\/, $filesStr);
            pop(@pathParts);
            $baseDir = join("\\", @pathParts);
          }
        }
      }
      $winPreview->tfRootBefore->Text($baseDir);
      &createTree($winPreview->tvBefore, \%listFiles, undef, $baseDir);
      
      # Fill the After tree
      if (!(&isFunctionsReady()) and $win->TabFunctions->SelectedItem()) {
        my $refResListFiles;
        my $refResListSubFolders;
        my $dstDir;
        if      ($win->TabFunctions->SelectedItem() == 1) { # Copy or move
          $dstDir = $win->tfDestinationDir->Text();
          ($refResListFiles, $refResListSubFolders) = &copyMove(\%listFiles, 0);
        } elsif ($win->TabFunctions->SelectedItem() == 2) { # Rename
          $dstDir = $baseDir;
          ($refResListFiles, $refResListSubFolders) = &renameFiles(\%listFiles, 0);
        }
        $winPreview->tfRootAfter->Text($dstDir);
        if ($refResListSubFolders) { &createTree($winPreview->tvAfter, $refResListFiles, $refResListSubFolders, $dstDir); }
        else                       { &createTree($winPreview->tvAfter, $refResListFiles, undef, $dstDir);                 }
      }
      
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
    });
    
    # Show Window
    $winPreview->Center($win);
    $winPreview->DoModal();
    return(1);
  }

}  #--- End btnPreview_Click

#--------------------------#
sub createTree
#--------------------------#
{
  # Local variables
  my ($refTree, $refListFiles, $refResListSubFolders, $baseDir) = @_;
  # $refResListSubFolders is used to identify empty folders
  my %createdFolders;
  
  # Browse file and create nodes
  foreach my $file (keys %{$refListFiles}) {
    my $relPath   = $file =~ s/\Q$baseDir\E\\//r;
    my @pathParts = split(/\\/, $relPath);
    my $filename;
    if (!-d $file) { $filename = pop(@pathParts); }
    
    # Create folders that doesn't exists
    my $parent;
    my $folder;
    foreach my $part (@pathParts) {
      if ($parent) {
        $folder .= "\\" . $part;
        if (!exists($createdFolders{$folder})) {
          if ($part =~ /[\<\>\:\"\/\\\|\?\*]/) { # Illegal characters
            $parent = $refTree->InsertItem(-parent => $parent    ,
                                           -text   => $part . " ($STR{'Error'})",
                                           -bold   => 1          ,
                                           -image  => 0          ,
                                           -item   => 0xFFFF0003 , );
          } else {
            $parent = $refTree->InsertItem(-parent => $parent    ,
                                           -text   => $part      ,
                                           -image  => 0          ,
                                           -item   => 0xFFFF0003 , );
          }
          $createdFolders{$folder} = $parent;
          if ($refResListSubFolders and exists($$refResListSubFolders{$baseDir."\\".$folder})) {
            delete($$refResListSubFolders{$baseDir."\\".$folder}); # Folder has been created
          }
        } else { $parent = $createdFolders{$folder}; }
      } else       {
        $folder = $part;
        if (!exists($createdFolders{$folder})) {
          if ($part =~ /[\<\>\:\"\/\\\|\?\*]/) { # Illegal characters
            $parent = $refTree->InsertItem(-text  => $part . " ($STR{'Error'})",
                                           -bold  => 1          ,
                                           -image => 0          ,
                                           -item  => 0xFFFF0003 , );
          } else {
            $parent = $refTree->InsertItem(-text  => $part      ,
                                           -image => 0          ,
                                           -item  => 0xFFFF0003 , );
          }
          $createdFolders{$folder} = $parent;
          if ($refResListSubFolders and exists($$refResListSubFolders{$baseDir."\\".$folder})) {
            delete($$refResListSubFolders{$baseDir."\\".$folder}); # Folder has been created
          }
        } else { $parent = $createdFolders{$folder}; }
      }
    }
    
    # If filename
    if ($filename) {
      # File is marked as error
      if ($$refListFiles{$file} == 2) {
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename . " ($STR{'Error'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename . " ($STR{'Error'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        }
      # File is masked as removed
      } elsif ($$refListFiles{$file} == 3) {
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename . " ($STR{'Duplicate'} $STR{'Removed'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename . " ($STR{'Duplicate'} $STR{'Removed'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        }
      # File is masked as renamed
      } elsif ($$refListFiles{$file} == 4) {
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename . " ($STR{'Renamed'})",
                                -bold   => 0          ,
                                -image  => 4          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename . " ($STR{'Renamed'})",
                                -bold   => 0          ,
                                -image  => 4          ,
                                -item   => 0xFFFF0003 , );
        }
      } else {
        # Normal file
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename  , 
                                -image  => 2          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename  ,  
                                -image  => 2          ,
                                -item   => 0xFFFF0003 , );
        }
      }
    }
  }
  
  # Create empty folder nodes
  if ($refResListSubFolders) {
    foreach my $folder (keys %{$refResListSubFolders}) {
      my $relPath   = $folder =~ s/\Q$baseDir\E\\//r;
      if ($relPath) {
        my @pathParts = split(/\\/, $relPath);
        
        # Create folders that doesn't exists
        my $parent;
        my $folder;
        foreach my $part (@pathParts) {
          if ($parent) {
            $folder .= "\\" . $part;
            if (!exists($createdFolders{$folder})) {
              $parent = $refTree->InsertItem(-parent        => $parent    ,
                                             -text          => $part      ,
                                             -image         => 0          ,
                                             -item          => 0xFFFF0003 , );
              $createdFolders{$folder} = $parent;
            } else { $parent = $createdFolders{$folder}; }
          } else       {
            $folder = $part;
            if (!exists($createdFolders{$folder})) {
              $parent = $refTree->InsertItem(-text          => $part      ,
                                             -image         => 0          ,
                                             -item          => 0xFFFF0003 , );
              $createdFolders{$folder} = $parent;
            } else { $parent = $createdFolders{$folder}; }
          }
        }
      }
    }
  }

}  #--- End createTree

#--------------------------#
sub tvBefore_Expand
#--------------------------#
{
  my $node = shift;
  $winPreview->tvBefore->SetItem($node, -image => 1);
  
}  #--- End tvBefore_Expand

#--------------------------#
sub tvBefore_Collapse
#--------------------------#
{
  my $node = shift;
  $winPreview->tvBefore->SetItem($node, -image => 0);
  
}  #--- End tvBefore_Collapse

#--------------------------#
sub tvAfter_Expand
#--------------------------#
{
  my $node = shift;
  $winPreview->tvAfter->SetItem($node, -image => 1);
  
}  #--- End tvAfter_Expand

#--------------------------#
sub tvAfter_Collapse
#--------------------------#
{
  my $node = shift;
  $winPreview->tvAfter->SetItem($node, -image => 0);
  
}  #--- End tvAfter_Collapse

#--------------------------#
sub winPreview_Resize
#--------------------------#
{
  $winPreview->tvBefore->Width($winPreview->ScaleWidth()/2-7);
  $winPreview->tvBefore->Height($winPreview->ScaleHeight()-65); 
  $winPreview->tfRootBefore->Width($winPreview->ScaleWidth()/2-72);
  $winPreview->lblAfterShadowT->Left($winPreview->ScaleWidth()/2+1); 
  $winPreview->lblAfterT->Left($winPreview->ScaleWidth()/2);
  $winPreview->lblRootAfter->Left($winPreview->ScaleWidth()/2+5);
  $winPreview->tfRootAfter->Left($winPreview->ScaleWidth()/2+65);
  $winPreview->tfRootAfter->Width($winPreview->ScaleWidth()/2-71);
  $winPreview->tvAfter->Left($winPreview->ScaleWidth()/2);
  $winPreview->tvAfter->Width($winPreview->ScaleWidth()/2-6);
  $winPreview->tvAfter->Height($winPreview->ScaleHeight()-65);
  
}  #--- End winPreview_Resize

#--------------------------#
sub winPreview_Terminate
#--------------------------#
{
  return(-1);
  
}  #--- End winPreview_Terminate

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { $THR_PROCESS->kill('KILL')->detach(); }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub getListFiles
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift;
  my $dir          = $win->tfInputDir->Text();
  my $filesStr     = $win->tfInputFiles->Text();
  
  # List of files (No filter)
  if ($filesStr) {
    # Multiple files
    if ($filesStr =~ /" "/) {
      my @items = split(/" "/, $filesStr);
      my $baseDir = shift(@items);
      $baseDir =~ s/^\"//;
      foreach my $item (@items) {
        $item =~ s/\"$//;
        $$refListFiles{$baseDir."\\".$item} = 1;
      }
      
    # Single file
    } else { $$refListFiles{$filesStr} = 1; }
    
  # Directory (List files and apply filters)
  } else {
    # Local variables
    my $filter;
    my $selSize;
    my $sizeOp;
    my $regex;
    my $selDateUT;
    my $dateOp;
    my @subFolders;
    my $nbrSubFolders = 1; # The base dir count as one
    my $count         = 0;
    
    # Filter: Only folders
    if    ($win->rbFiltersDirOnly->Checked()) { $filter = 1; }
    # Filter: File size
    elsif ($win->rbFiltersSize->Checked()) {
      $selSize = $win->tfFiltersSize->Text();
      if ($selSize) {
        $filter = 2;
        $sizeOp = $win->cbFiltersSizeOp->Text();
      }
    }
    # Filter: Contains
    elsif ($win->rbFiltersContains->Checked()) {
      $regex  = $win->tfFiltersContains->Text();
      $filter = 3;
    }
    # Filter: Last accessed date
    elsif ($win->rbFiltersLastAccess->Checked()) {
      my ($d, $m, $y) = $win->dtFiltersLastAccess->GetDate();
      $selDateUT      = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
      $dateOp         = $win->cbFiltersLastAccess->Text();
      $filter         = 4;
    }
    # Filter: Last modified date
    elsif ($win->rbFiltersLastModif->Checked() == 1) {
      my ($d, $m, $y) = $win->dtFiltersLastModif->GetDate();
      $selDateUT      = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
      $dateOp         = $win->cbFiltersLastModif->Text();
      $filter         = 5;
    }
  
    # Open base directory
    if ($execute) { $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir);   }
    else          { $winPb->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir); }
    $$refListFiles{"$dir\\"} = 0;
    if (opendir(DIR,"$dir\\")) {
      while (my $file = readdir(DIR)) {
        my $filePath = "$dir\\$file";
        if ((-d $filePath) and ($file !~ /^\.\.?$/) and ($file ne 'System Volume Information')) { # It's a directory
          if ($win->chInputDirRecurse->Checked()) { # Subfolders option
            push(@subFolders, $filePath);
            $nbrSubFolders++;
            if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
            else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
          } else { $nbrSubFolders++; }
          # No filter or Only Folders
          if (!$filter or $filter == 1) { $$refListFiles{$filePath} = 0; }
          # Filter: Regex
          elsif ($filter == 3) {
            # Regex option is checked
            if (!$win->chFiltersContainsRegex->Checked()) { $regex = quotemeta($regex); }
            if (!$win->chFiltersContainsFileOnly->Checked()) {
              # Test Regex
              if (($win->chFiltersContainsCase->Checked()  and $file =~ /$regex/) or
                  (!$win->chFiltersContainsCase->Checked() and $file =~ /$regex/i)) {
                $$refListFiles{$filePath} = 0;
              }
            }
          }
        } elsif (!-d $filePath and -e $filePath) {                                                # It's a file
          # No filter
          if    (!$filter) { $$refListFiles{$filePath} = 0; }
          # Filter: Only Folders, continue
          elsif ($filter == 1) { next; }
          # Filter: Regex
          elsif ($filter == 3) {
            # Regex option is checked
            if (!$win->chFiltersContainsRegex->Checked()) { $regex = quotemeta($regex); }
            # Test Regex
            if (($win->chFiltersContainsCase->Checked()  and $file =~ /$regex/) or
                (!$win->chFiltersContainsCase->Checked() and $file =~ /$regex/i)) {
              $$refListFiles{$filePath} = 0;
            }
          }
          # Filter: Last accessed or Last modified
          elsif ($filter == 4 or $filter == 5) {
            my $cmpDateUT;
            if ($filter == 4) { $cmpDateUT = (stat($filePath))[8]; }
            else              { $cmpDateUT = (stat($filePath))[9]; }
            if (&cmpDates($filePath, $selDateUT, $cmpDateUT, $dateOp)) {
              $$refListFiles{$filePath} = 0;
            }
          }
          # Filter: File size
          elsif ($filter == 2) {
            if (&cmpFileSize($filePath, $selSize, $sizeOp)) {
              $$refListFiles{$filePath} = 0;
            }
          }
        }
      }
      closedir(DIR);
    }
    $count++;
    if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
    else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
  
    # List folders and files in subfolders
    if ($win->chInputDirRecurse->Checked() and scalar(@subFolders) > 0) {
      foreach my $subFolder (@subFolders) {
        $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$subFolder);
        if (opendir(DIR,"$subFolder\\")) {
          while (my $file = readdir(DIR)) {
            my $filePath = "$subFolder\\$file";
            if ((-d $filePath) and ($file !~ /^\.\.?$/)) {                                      # It's a directory
              push(@subFolders, $filePath);
              $nbrSubFolders++;
              if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
              else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
              # No filter or Only Folders
              if (!$filter or $filter == 1) { $$refListFiles{$filePath} = 0; }
              # Filter: Regex
              elsif ($filter == 3) {
                # Regex option is checked
                if (!$win->chFiltersContainsRegex->Checked()) { $regex = quotemeta($regex); }
                my $relPath = $filePath =~ s/\Q$dir\E\\//r;
                if (!$win->chFiltersContainsFileOnly->Checked()) {
                  # Test Regex
                  if (($win->chFiltersContainsCase->Checked()  and $relPath =~ /$regex/) or
                      (!$win->chFiltersContainsCase->Checked() and $relPath =~ /$regex/i)) {
                    $$refListFiles{$filePath} = 0;
                  }
                }
              }
            } elsif (!-d $filePath and -e $filePath) {                                          # It's a file
              # No filter
              if    (!$filter) { $$refListFiles{$filePath} = 0; }
              # Filter: Only Folders, continue
              elsif ($filter == 1) { next; }
              # Filter: Regex
              elsif ($filter == 3) {
                # Regex option is checked
                if (!$win->chFiltersContainsRegex->Checked()) { $regex = quotemeta($regex); }
                my $relPath = $filePath =~ s/\Q$dir\E\\//r;
                if ($win->chFiltersContainsFileOnly->Checked()) { $relPath = $file; }
                # Test Regex
                if (($win->chFiltersContainsCase->Checked()  and $relPath =~ /$regex/) or
                    (!$win->chFiltersContainsCase->Checked() and $relPath =~ /$regex/i)) {
                  $$refListFiles{$filePath} = 0;
                }
              }
              # Filter: Last accessed or Last modified
              elsif ($filter == 4 or $filter == 5) {
                my $cmpDateUT;
                if ($filter == 4) { $cmpDateUT = (stat($filePath))[8]; }
                else              { $cmpDateUT = (stat($filePath))[9]; }
                if (&cmpDates($filePath, $selDateUT, $cmpDateUT, $dateOp)) {
                  $$refListFiles{$filePath} = 0;
                }
              }
              # Filter: File size
              elsif ($filter == 2) {
                if (&cmpFileSize($filePath, $selSize, $sizeOp)) {
                  $$refListFiles{$filePath} = 0;
                }
              }
            }
          }
          closedir(DIR);
        }
        $count++;
        if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
        else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
      }
    }
    if ($execute) { 
      $win->lblPbCurr->Text('');
      $win->lblPbCount->Text('');
    } else { # Preview mode
      $win->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
    }
  }

}  #--- End getListFiles

#--------------------------#
sub cmpDates
#--------------------------#
{
  # Local variables
  my ($filePath, $selDateUT, $cmpDateUT, $dateOp) = @_;
  
  # For $cmpDateUT, Keep only date
  my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = localtime($cmpDateUT);
  my $cmpDateUTR = timelocal(0,0,0,$mday,$mon,$year); # Store in Unixtime format
  
  if ($dateOp eq $STR{'Before'} and $cmpDateUTR  < $selDateUT) { return(1); }
  if ($dateOp eq $STR{'Equal'}  and $cmpDateUTR == $selDateUT) { return(1); }
  if ($dateOp eq $STR{'After'}  and $cmpDateUTR  > $selDateUT) { return(1); }
  
  return(0);

}  #--- End cmpDates

#--------------------------#
sub cmpFileSize
#--------------------------#
{
  # Local variables
  my ($filePath, $selSize, $sizeOp) = @_;
  my $fileSize = (stat($filePath))[7];
  my $sizeUnit = $win->cbFiltersSizeUnit->GetString($win->cbFiltersSizeUnit->GetCurSel());

  # Round down file size
  if    ($sizeUnit eq $STR{'b'} ) { $fileSize = $fileSize; }
  elsif ($sizeUnit eq $STR{'Kb'}) { $fileSize = $fileSize / 1024; }
  elsif ($sizeUnit eq $STR{'Mb'}) { $fileSize = $fileSize / 1024 / 1024; }
  elsif ($sizeUnit eq $STR{'Gb'}) { $fileSize = $fileSize / 1024 / 1024 / 1024; }
  $fileSize = sprintf("%.0f", $fileSize);

  if ($sizeOp eq $STR{'Smaller'} and $fileSize  < $selSize) { return(1); }
  if ($sizeOp eq $STR{'Equal'}   and $fileSize == $selSize) { return(1); }
  if ($sizeOp eq $STR{'Bigger'}  and $fileSize  > $selSize) { return(1); }
  
  return(0);

}  #--- End cmpFileSize

#--------------------------#
sub listFilesReport
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $nbrFiles     = scalar(keys %{$refListFiles});
  my $dirReport    = $win->tfReportDir->Text();
  my $logging      = 0;
  my $curr         = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  
  if ($dirReport) {
    # Show progress
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
      
    # Options
    my $chListFilesOpt1 = $win->chListFilesOpt1->Checked(); # Full path
    my $chListFilesOpt2 = $win->chListFilesOpt2->Checked(); # Filename
    my $chListFilesOpt3 = $win->chListFilesOpt3->Checked(); # MD5
    my $chListFilesOpt4 = $win->chListFilesOpt4->Checked(); # SHA1
    my $chListFilesOpt5 = $win->chListFilesOpt5->Checked(); # File details
    my $chListFilesOpt6 = $win->chListFilesOpt6->Checked(); # Number of lines
    
    # File Header
    my $header;
    if (!$win->chListFilesOpt7->Checked()) {
      if ($chListFilesOpt1) { $header .= $STR{'chListFilesOpt1'} . "\t"; } # Full path
      if ($chListFilesOpt2) { $header .= $STR{'chListFilesOpt2'} . "\t"; } # Filename
      if ($chListFilesOpt3) { $header .= $STR{'chListFilesOpt3'} . "\t"; } # MD5
      if ($chListFilesOpt4) { $header .= $STR{'chListFilesOpt4'} . "\t"; } # SHA1
      if ($chListFilesOpt5) {                                              # File details
        $header .= $STR{'rbFiltersSize'}       . "\t";
        $header .= $STR{'rbFiltersLastAccess'} . "\t";
        $header .= $STR{'rbFiltersLastModif'}  . "\t";
      }
      if ($chListFilesOpt6) { $header .= $STR{'chListFilesOpt6'} . "\t"; } # Number of lines
      chop($header);
    }
    
    # Write the report
    my ($s,$min,$h,$d,$m,$y) = (&date(time))[0,1,2,3,4,5];
    my $reportFilename = $dirReport."\\"."XL-FileTools ".$STR{'report'}.'-'."$y$m$d\_$h$min$s".'.txt'; # Ex.: XL-FileTools report-20160520_082215.txt
    if (open(my $fhReport, '>', $reportFilename)) {
      flock($fhReport, 2);
      if (!$win->chListFilesOpt7->Checked()) { print $fhReport "$header\n"; }
      foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
        if (-d $file and $win->chListFilesOpt8->Checked()) { } # No folder
        else {
          $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
          my $newLine;
          # Full path
          if ($chListFilesOpt1) { $newLine .= "$file\t"; }
          # Filename
          if ($chListFilesOpt2) {
            if (!-d $file) { # For file only
              my @parts = split(/\\/, $file);
              my $filename = pop(@parts);
              $newLine .= "$filename\t";
            } else { $newLine .= "\t"; }
          }
          # MD5
          if ($chListFilesOpt3) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
              if (my $digestMD5 = file_md5_hex($file)) {
                if ($CONFIG{'HASH_LOWERCASE'}) { $newLine .= lc($digestMD5) ."\t"; }
                else                           { $newLine .= uc($digestMD5) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n"; }
              }
            } else { $newLine .= "\t"; }
          }
          # SHA1
          if ($chListFilesOpt4) {
            if (!-d $file) { # For file only
              my $digestSHA1;
              if (open(my $fh, $file)) {
                if (my $sha1 = Digest::SHA1->new()) {
                  $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
                  $sha1->addfile($fh);
                  if ($sha1->hexdigest) { $digestSHA1 = $sha1->hexdigest; }
                }
                close($fh);
              }
              if ($digestSHA1) {
                if ($CONFIG{'HASH_LOWERCASE'}) { $newLine .= lc($digestSHA1) ."\t"; }
                else                           { $newLine .= uc($digestSHA1) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n"; }
              }
            } else { $newLine .= "\t"; }
          }
          # File details
          if ($chListFilesOpt5) {
            if (!-d $file) { # For file only
              my (@stats) = stat($file);
              # File size
              if ($stats[7]) { $newLine .= "$stats[7]\t"; }
              else           { $newLine .= "\t";          }
              # Last accessed
              if ($stats[8]) {
                my ($s,$min,$h,$d,$m,$y)  = (&date($stats[8]))[0,1,2,3,4,5];
                $newLine .= "$y-$m-$d $h:$min:$s\t";
              } else { $newLine .= "\t"; }
              # Last modified
              if ($stats[9]) {
                my ($s,$min,$h,$d,$m,$y)  = (&date($stats[9]))[0,1,2,3,4,5];
                $newLine .= "$y-$m-$d $h:$min:$s\t";
              } else { $newLine .= "\t"; }
            }
          }
          # Number of lines
          if ($chListFilesOpt6) {
            if (-T $file) { # For text file only
              $win->lblPbCurr->Text($STR{'NumberLines'}.': '.$file.'...');
              my $nbrLines = 0;
              if (open my $fh, '<', $file) {
                while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                close($fh);
              } else {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n"; }
              }
              if ($nbrLines) { $newLine .= uc($nbrLines) ."\t"; }
              else { $newLine .= "0\t"; }
            } else { $newLine .= "\t"; }
          }
          
          # Print line
          chop($newLine);
          print $fhReport "$newLine\n";
        }
        
        # Progress
        $curr++;
        $win->lblPbCount->Text("$curr / $nbrFiles");
        $win->pb->StepIt();
      }
      
      close($fhReport);
     
      # Open report
      if ($win->chOpenReport->Checked()) { $win->ShellExecute('open', $reportFilename,'','',1); }
      
      # Logging
      if ($logging) {
        close($fhLog);
        if ($nbrError) {
          my $answer = Win32::GUI::MessageBox($win, $STR{'EndProcess1'}.' '.$nbrError." $STR{'EndProcess2'} $STR{'EndProcess3'}", $STR{'Process'}, 0x40024);
          # Open the log
          if ($answer == 6) { $win->ShellExecute('open', $logFile,'','',1); }
        }
      }
    }
  }

}  #--- End listFilesReport

#--------------------------#
sub listExtReport
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $nbrFiles     = scalar(keys %{$refListFiles});
  my $dirReport    = $win->tfReportDir->Text();
  my $count        = 0;
  my %listExtensions;
  
  if ($dirReport) {
    # Show progress
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
    $win->lblPbCurr->Text($STR{'ListingExtensions'}.'...');
    
    # List extensions
    foreach my $file (keys %{$refListFiles}) {
      if (!-d $file) { # Not a directory
        my $filename = (split(/\\/, $file))[-1];
        if ($filename =~ /\./) { # There is an extension
          my $extension   = (split(/\./, $file))[-1];
          my $extensionUC = uc($extension);
          if (exists($listExtensions{$extensionUC})) { $listExtensions{$extensionUC}++;   }
          else                                       { $listExtensions{$extensionUC} = 1; }
        } else { # No extension
          if (exists($listExtensions{'*No extension'})) { $listExtensions{'*No extension'}++;   }
          else                                          { $listExtensions{'*No extension'} = 1; }
        }
      }
      $count++;
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    }
      
    # Write the report
    $win->lblPbCurr->Text($STR{'WritingReport'}.'...');
    my ($s,$min,$h,$d,$m,$y) = (&date(time))[0,1,2,3,4,5];
    my $reportFilename = $dirReport."\\"."XL-FileTools ".$STR{'report'}.'-'."$y$m$d\_$h$min$s".'.txt'; # Ex.: XL-FileTools report-20160520_082215.txt
    if (open(my $fhReport, '>', $reportFilename)) {
      flock($fhReport, 2);
      print $fhReport "$STR{'Extension'}\t$STR{'Count'}\n";
      foreach my $ext (reverse sort { $listExtensions{$a} <=> $listExtensions{$b} } keys %listExtensions) {
        print $fhReport "$ext\t".$listExtensions{$ext}."\n" ;
      }
      close($fhReport);
    
      # Open report
      if ($win->chOpenReport->Checked()) { $win->ShellExecute('open', $reportFilename,'','',1); }
    }
  }
  
}  #--- End listExtReport

#--------------------------#
sub copyMove
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift; # If 0, preview mode
  my $dstFolder    = $win->tfDestinationDir->Text();
  my $logging      = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->chUseDestDirCM->Checked() and -d $dstFolder) {
      $logFile = $dstFolder;
    } else {
      if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
        $logFile = $winConfig->tfLoggingDir->Text();
      } else { $logFile = $USERDIR; }
    }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  
  if ($dstFolder) {
    # Local variales
    my $nbrFiles     = scalar(keys %{$refListFiles});
    my $optCopyTree  = $win->chCopyTree->Checked();
    my $optDuplicate = $win->chCopyRemDouble->Checked();
    my $selFunctCopy = $win->rbCopy->Checked();
    my $dir          = $win->tfInputDir->Text();
    my $nbrCopyMove  = 0;
    my $count        = 0;
    my $srcDriveLetter;
    my $sameVolume   = 1;
    my $totalSize;
    my %listMD5;
    my %resListFiles;
    my %listSubFolders;
    my %movedDirs;
    
    # Show progress
    if ($execute) {
      $win->pb->SetRange(0, $nbrFiles);
      $win->pb->SetPos(0);
      $win->pb->SetStep(1);
      $win->lblPbCount->Text("0 / $nbrFiles");
      $win->lblPbCurr->Text($STR{'PreProcessing'}.'...');
    } else { # Preview mode
      $winPb->pbWinPb->SetRange(0, $nbrFiles);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->lblCount->Text("0 / $nbrFiles");
      $winPb->lblPbCurr->Text($STR{'PreProcessing'}.'...');
    }
  
    # Pre-process list of files
    #   - Remove folders from the list (folders)
    #   - If Exclude duplicates option is checked, calculate MD5 hash for each file and remove duplicate
    #   - Calculate total size to be copied or moved
    #   - Set destination path
    #   - Note source drive letter
    foreach my $file (keys %{$refListFiles}) {
      # It's a directory, remove it
      if (-d $file) {
        my $dstPath;
        if ($optCopyTree) { # If we duplicate tree structure
          $dstPath = $file =~ s/\Q$dir//r;
          $dstPath = $dstFolder . $dstPath;
          $listSubFolders{$dstPath} = 1;
        }
        delete($$refListFiles{$file});
        # If moving, remember moved dir
        if (!$selFunctCopy and $file ne "$dir\\" and !exists($movedDirs{$file})) { $movedDirs{$file} = 1; }
        next;
      } else {
        # It's a file and we must exclude duplicates
        if ($optDuplicate and my $digestMD5 = file_md5_hex($file)) {
          if (exists($listMD5{$digestMD5})) { # Duplicate, remove it
            delete($$refListFiles{$file});
            if ($execute) { if ($logging) { print $fhLog "$STR{'Duplicate'} $STR{'Removed'}: $file\n"; } }
            else { # For preview, mark this file as removed-duplicate
              if ($optCopyTree and $dir) { # Duplicate tree structure
                my $dstPath = $file =~ s/\Q$dir//r;
                $dstPath = $dstFolder . $dstPath;
                $resListFiles{$dstPath} = 3;
              } else {                     # Files only
                my $filename = (split(/\\/, $file))[-1];
                my $dstPath  = $dstFolder . "\\" . $filename;
                $resListFiles{$dstPath} = 3;
              }
            }
            next;
          } else { $listMD5{$digestMD5} = 1; }
        }
        # Calculate size
        $totalSize += (stat($file))[7];
        # Set destination path
        if ($optCopyTree and $dir) {              # Duplicate tree structure
          my $dstPath = $file =~ s/\Q$dir//r;
          $dstPath = $dstFolder . $dstPath;
          $$refListFiles{$file} = $dstPath;
        } else {                                  # Files only
          my $filename = (split(/\\/, $file))[-1];
          my $dstPath  = $dstFolder . "\\" . $filename;
          $$refListFiles{$file} = $dstPath;
        }
        
        # Note source drive letter
        if (!$srcDriveLetter and $file =~ /^([a-zA-Z])\:/i) { $srcDriveLetter = $1; }
      }
      $count++;
      if ($execute) {
        $win->lblPbCount->Text("$count / $nbrFiles");
        $win->pb->StepIt();
      } else { # Preview mode
        $winPb->lblCount->Text("$count / $nbrFiles");
        $winPb->pbWinPb->StepIt();
      }
    }
    
    # Check if there is enough space on destination volume
    # Not important if we move file on the same volume
    if ($dstFolder =~ /^([a-zA-Z])\:/i) {
      my $dstDriveLetter = $1;
      if ($selFunctCopy or (!$selFunctCopy and $dstDriveLetter ne $srcDriveLetter)) {
        $sameVolume = 0; # Destination is on another volume
        my $freeSpace = (Win32::DriveInfo::DriveSpace("$dstDriveLetter:"))[6];
        # Not enough space
        if ($totalSize and $totalSize >= $freeSpace) {
          # Show an error message and quit
          Win32::GUI::MessageBox($win, $STR{'errSpace'}, $STR{'Error'}, 0x40010);
          if ($execute and $logging) {
            print $fhLog "$STR{'Error'}: $STR{'errSpace'}\n";
            close($fhLog);
          }
          return;
        }
      }
      
      # Enough space, we continue
      $nbrFiles = scalar(keys %{$refListFiles});
      
      # Show progress
      if ($execute) {
        $win->pb->SetRange(0, $nbrFiles);
        $win->pb->SetPos(0);
        $win->pb->SetStep(1);
        $win->lblPbCount->Text("0 / $nbrFiles");
        $win->lblPbCurr->Text($STR{'Processing'}.'...');
      } else { # Preview mode
        $winPb->pbWinPb->SetRange(0, $nbrFiles);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->lblCount->Text("0 / $nbrFiles");
        $winPb->lblPbCurr->Text($STR{'Processing'}.'...');
      }
      $count = 0;
      
      # Copy or move file
      foreach my $file (keys %{$refListFiles}) {
        # Copy file
        if ($selFunctCopy) {
          if ($execute) {
            $win->lblPbCurr->Text($STR{'rbCopy'}.': '.$file.'...');
            if (fcopy($file, $$refListFiles{$file})) {
              $nbrCopyMove++;
              if ($logging) { print $fhLog "$STR{'Copied'} $file -> $$refListFiles{$file}\n"; }
            } else {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'Copying'} $file\n"; }
            }
          } else { # Preview mode
            $winPb->lblPbCurr->Text($STR{'rbCopy'}.': '.$file.'...');
            $resListFiles{$$refListFiles{$file}} = 1;
          }
        # Move file
        } else {
          if ($execute) {
            $win->lblPbCurr->Text($STR{'rbMove'}.': '.$file.'...');
            if ($optCopyTree) {
              # Create destination directory if doesn't exist
              my @pathParts = split(/\\/, $$refListFiles{$file});
              pop(@pathParts);
              my $dstPath   = join("\\", @pathParts);
              if (-d $dstPath or (!-d $dstPath and File::Copy::Recursive::pathmk($dstPath))) {
                if ($sameVolume and rename($file, $$refListFiles{$file})) { # Rename if same volume
                  $nbrCopyMove++;
                  if ($logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
                } elsif (!$sameVolume and fmove($file, $$refListFiles{$file})) { # Use Move if different volume
                  $nbrCopyMove++;
                  if ($logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
                } elsif ($execute) {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"; }
                }
              } else {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"; }
              }
            } else {
              if ($sameVolume and rename($file, $$refListFiles{$file})) {
                $nbrCopyMove++;
                if ($execute and $logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
              } elsif (!$sameVolume and fmove($file, $$refListFiles{$file})) { # Use Move if different volume
                $nbrCopyMove++;
                if ($logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
              } elsif ($execute) {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"; }
              }
            }
          } else { # Preview mode
            $winPb->lblPbCurr->Text($STR{'rbMove'}.': '.$file.'...');
            $resListFiles{$$refListFiles{$file}} = 1;
          }
        }
        $count++;
        if ($execute) {
          $win->lblPbCount->Text("$count / $nbrFiles");
          $win->pb->StepIt();
        } else { # Preview mode
          $winPb->lblCount->Text("$count / $nbrFiles");
          $winPb->pbWinPb->StepIt();
        }
      }
      
      # Create empty folders if we duplicate tree structure
      if ($optCopyTree) {
        foreach my $subfolder (sort keys %listSubFolders) {
          if ($execute and !-d $subfolder) { # Folder doesn't exist, create it
            if (File::Copy::Recursive::pathmk($subfolder)) {
              $nbrCopyMove++;
            } else {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'Creating'} $subfolder\n"; }
            }
          }
        }
      }
      
      # Delete moved dir (if empty)
      foreach my $movedDir (reverse sort keys %movedDirs) { rmdir($movedDir); }
    }
    if ($execute) {
      # Open destination folder
      if ($win->chOpenDstDir->Checked() and -d $dstFolder) {
        # Open Window Explorer
        Win32::Process::Create(my $ProcessObj                 ,
                               "$ENV{'WINDIR'}\\explorer.exe" ,
                               "explorer $dstFolder"          ,
                               0                              ,
                               NORMAL_PRIORITY_CLASS          ,
                               ".");
      }
      
      # Final popup
      my $endMsg  = "$STR{'Renaming'} $STR{'Finished'}!\n";
      if ($selFunctCopy) { $endMsg .= "$nbrCopyMove $STR{'Copied2'}\n"; }
      else               { $endMsg .= "$nbrCopyMove $STR{'Moved2'}\n";  }
      $endMsg    .= "$nbrError $STR{'EndErrors'}\n";
      if ($logging) {
        close($fhLog);
        if ($nbrCopyMove or $nbrError) { # If copied/moved files or errors, open the log ?
          $endMsg .= "\n$STR{'EndLogging'}";
          my $answer = Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40024);
          # Open the log
          if ($answer == 6) { $win->ShellExecute('open', $logFile,'','',1); }
        } else {
          Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
        }
      } else {
        Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
      }
    } else { return(\%resListFiles, \%listSubFolders); } # Preview
  }

}  #--- End copyMove

#--------------------------#
sub renameFiles
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift; # If 0, preview mode
  my $dirReport    = $win->tfReportDir->Text();
  my $logging      = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    $logging = 1;
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  
  if ($dirReport) {
    # Local variales
    my $nbrFiles   = scalar(keys %{$refListFiles});
    my $dir        = $win->tfInputDir->Text();
    my $nbrRenamed = 0;
    my $refResListFiles;
    my $refListSubFolders;
    
    # Show progress
    $win->ChangeCursor($HOURGLASS);
    if ($execute) { $win->lblPbCurr->Text($STR{'PreProcessing'}.'...');   }
    else          { $winPb->lblPbCurr->Text($STR{'PreProcessing'}.'...'); } # Preview mode
  
    # Call the right rename function
    if      ($win->rbRenByHash->Checked() ) {
      ($nbrRenamed, $refResListFiles, $nbrError)                     = &renameByHash(   $refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    } elsif ($win->rbRenSort->Checked()   ) {
      ($nbrRenamed, $refResListFiles, $nbrError)                     = &renameBySort(   $refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    } elsif ($win->rbRenReplace->Checked()) {
      ($nbrRenamed, $refResListFiles, $refListSubFolders, $nbrError) = &renameReplaceBy($refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    }
    
    if ($execute) {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $win->lblPbCurr->Text('');
      $win->lblPbCurr->Hide();
      $win->lblPbCount->Text('');
      $win->lblPbCount->Hide();
      $win->pb->SetPos(0);
      $win->pb->Hide();
      $win->btnStop->Hide();
      $win->btnProcess->Show();
      
      # Final popup
      my $endMsg  = "$STR{'Renaming'} $STR{'Finished'}!\n";
      $endMsg    .= "$nbrRenamed $STR{'Renamed2'}\n";
      $endMsg    .= "$nbrError $STR{'EndErrors'}\n";
      if ($logging) {
        close($fhLog);
        if ($nbrRenamed or $nbrError) { # If renamed files or errors, open the log ?
          $endMsg .= "\n$STR{'EndLogging'}";
          my $answer = Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40024);
          # Open the log
          if ($answer == 6) { $win->ShellExecute('open', $logFile,'','',1); }
        } else {
          Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
        }
      } else {
        Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
      }
    } else { return($refResListFiles, $refListSubFolders); } # Preview mode
  }

}  #--- End renameFiles

#--------------------------#
sub renameByHash
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $hashAlgo   = $win->cbRenByHash->SelectedItem();
  my $nbrRenamed = 0;
  my $count      = 0;
  my $nbrError   = 0;
  my %resListFiles;
  
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  
  # Browse list of files, calculate hash and rename
  foreach my $file (keys %{$refListFiles}) {
    my $renamed = 0;
    
    # It's a directory, remove it
    if     (-d $file) { delete($$refListFiles{$file}); }
    else {
      # Split path and filename
      my @pathParts = split(/\\/, $file);
      my $filename  = pop(@pathParts);
      my $dstPath = join("\\", @pathParts);
      my $extension;
      if ($filename) { $extension = (split(/\./, $filename))[-1]; }
      
      # Calculate hash
      if (!$win->cbRenByHash->SelectedItem()) {
        if ($execute) { $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');   }
        else          { $winPb->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...'); }
        if (my $digestMD5 = file_md5_hex($file)) { # MD5
          if ($CONFIG{'HASH_LOWERCASE'}) { $digestMD5 = lc($digestMD5); }
          else                           { $digestMD5 = uc($digestMD5); }
          my $dstFilename = "$dstPath\\$digestMD5";
          if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
          # File already exists
          if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
            my $i;
            while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
              $i++;
              $dstFilename = "$dstPath\\$digestMD5".'_'.$i;
              if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
            }
            $renamed = 1;
          }
          # Rename
          if ($execute) {
            if (rename($file, $dstFilename)) {
              $nbrRenamed++;
              if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n"; }
            } else {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
            }
          }
          elsif ($renamed) { $resListFiles{$dstFilename} = 4; }
          else             { $resListFiles{$dstFilename} = 1; }
        } elsif ($execute) {
          $nbrError++;
          if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingMD5'} $file\n"; }
        }
      } elsif ($win->cbRenByHash->SelectedItem()) { # SHA1
        if ($execute) { $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...'); }
        else          { $winPb->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...'); }
        if (open(my $fh, $file)) {
          if (my $sha1 = Digest::SHA1->new()) {
            $sha1->addfile($fh);
            close($fh);
            if ($sha1->hexdigest) {
              my $digestSHA1;
              if ($CONFIG{'HASH_LOWERCASE'}) { $digestSHA1 = lc($sha1->hexdigest); }
              else                           { $digestSHA1 = uc($sha1->hexdigest); }
              my $dstFilename = "$dstPath\\$digestSHA1";
              if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
              # File already exists
              if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
                my $i;
                while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
                  $i++;
                  $dstFilename = "$dstPath\\$digestSHA1".'_'.$i;
                  if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
                }
                $renamed = 1;
              }
              # Rename
              if ($execute) {
                if (rename($file, $dstFilename)) {
                  $nbrRenamed++;
                  if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n"; }
                } else {
                  $nbrError++;
                  if ($logging) {  print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
                }
              }
              elsif ($renamed) { $resListFiles{$dstFilename} = 4; } # Renamed file existed, renamed
              else             { $resListFiles{$dstFilename} = 1; }
            } elsif ($execute) {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'} $file\n"; }
            }
          } elsif ($execute) {
            $nbrError++;
            if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'} $file\n"; }
          }
          close($fh);
        } elsif ($execute) {
          $nbrError++;
          if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'} $file\n"; }
        }
      }
    }
    
    $count++;
    if ($execute) {
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  
  return($nbrRenamed, \%resListFiles, $nbrError);

}  #--- End renameByHash

#--------------------------#
sub renameBySort
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
  my $length      = $winRenBySortOpt->tfLength->Text();
  my $initVal     = $winRenBySortOpt->tfInitVal->Text();
  my $stepVal     = $winRenBySortOpt->tfStepVal->Text();
  my $prefix      = $winRenBySortOpt->tfPrefix->Text();
  my $suffix      = $winRenBySortOpt->tfSuffix->Text();
  my $nbrRenamed  = 0;
  my $count       = 0;
  my $nbrError    = 0;
  my %resListFiles;
  
  # Sort list of files
  if ($execute) { $win->lblPbCurr->Text($STR{'SortFiles'}.'...');   }
  else          { $winPb->lblPbCurr->Text($STR{'SortFiles'}.'...'); }
  my $sortType = $winRenBySortOpt->cbSortByType->GetCurSel();
  my $order    = $winRenBySortOpt->rbAsc->Checked();
  # Divide by subfolders
  my %subFolders;
  foreach my $file (keys %{$refListFiles}) {
    if (!-d $file) {
      my @pathParts = split(/\\/, $file);
      pop(@pathParts);
      my $subFolder = join("\\", @pathParts);
      push(@{$subFolders{$subFolder}}, $file);
    } else { delete($$refListFiles{$file}); } # Remove folder from the list
  }
  # Sort by folder
  foreach my $subFolder (keys %subFolders) {
    my @sortedFiles;
    if      (!$sortType     and  $order) { @sortedFiles = sort {uc($a) cmp uc($b)} @{$subFolders{$subFolder}};               } # Ascending
    elsif   (!$sortType     and !$order) { @sortedFiles = sort {uc($b) cmp uc($a)} @{$subFolders{$subFolder}};               } # Descending
    # File Size
    elsif   ($sortType == 1 and  $order) { @sortedFiles = sort {(stat($a))[7] <=> (stat($b))[7]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 1 and !$order) { @sortedFiles = sort {(stat($b))[7] <=> (stat($a))[7]} @{$subFolders{$subFolder}}; } # Descending
    # Last accessed
    elsif   ($sortType == 2 and  $order) { @sortedFiles = sort {(stat($a))[8] <=> (stat($b))[8]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 2 and !$order) { @sortedFiles = sort {(stat($b))[8] <=> (stat($a))[8]} @{$subFolders{$subFolder}}; } # Descending
    # Last modified
    elsif   ($sortType == 3 and  $order) { @sortedFiles = sort {(stat($a))[9] <=> (stat($b))[9]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 3 and !$order) { @sortedFiles = sort {(stat($b))[9] <=> (stat($a))[9]} @{$subFolders{$subFolder}}; } # Descending
    my $i = &convertInitVal($incrValType, $initVal);
    # Store position of each file
    foreach my $file (@sortedFiles) { $$refListFiles{$file} = $i; $i++; }
  }
  
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }

  # Rename file
  if ($execute) { $win->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  else          { $winPb->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  foreach my $file (sort {$$refListFiles{$a} <=> $$refListFiles{$b}} keys %{$refListFiles}) {
    my $renamed = 0;
    # Set the destination filename
    my $posVal = $$refListFiles{$file};
    my $dstFilename;
    if ($prefix) { $dstFilename .= $prefix; }
    my $formatedVal = &formatVal($incrValType, $posVal, $length);
    $dstFilename .= $formatedVal;            
    if ($suffix) { $dstFilename .= $suffix; }
    my @pathParts   = split(/\\/, $file);
    my $srcFilename = pop(@pathParts);
    my $extension   = (split(/\./, $srcFilename))[-1];
    my $dstFile     = join("\\", @pathParts);
    $dstFile       .= "\\$dstFilename";
    if ($extension) { $dstFile .= "\.$extension"; }
    
    # File already exists
    if (-e $dstFile or exists($resListFiles{$dstFile})) {
      my $i;
      while (-e $dstFile or exists($resListFiles{$dstFile})) {
        $i++;
        $dstFile        = join("\\", @pathParts);
        $dstFile       .= "\\$dstFilename".'_'.$i;
        if ($extension) { $dstFile .= '.'.$extension; } # Add extension
      }
      $renamed = 1;
    }
    
    # Rename
    if ($execute) {
      if (rename($file, $dstFile)) {
        $nbrRenamed++;
        if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFile\n"; }
      } else {
        $nbrError++;
        if ($logging) { print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
      }
    }
    elsif ($renamed) { $resListFiles{$dstFile} = 4; } # Renamed file existed, renamed
    else             { $resListFiles{$dstFile} = 1; }
    
    $count++;
    if ($execute) { 
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  
  return($nbrRenamed, \%resListFiles, $nbrError);

}  #--- End renameBySort

#--------------------------#
sub renameReplaceBy
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $srcExpr       = $win->tfRenReplace->Text();
  my $srcExprCase   = $win->chRenReplaceCase->Checked();
  my $srcExprRegex  = $win->chRenReplaceRegex->Checked();
  my $srcExprFolder = $win->chRenReplaceFolder->Checked();
  my $dstExpr       = $win->tfRenReplaceBy->Text();
  my $dstExprEval   = $win->chRenReplaceByEval->Checked();
  my $nbrRenamed    = 0;
  my $count         = 0;
  my $nbrError      = 0;
  my %renamedDirs;
  my %resListFiles;
  my %listSubFolders;
  
  # Escape replace expresion if not regex
  if    (!$srcExprRegex)                      { $srcExpr = quotemeta($srcExpr);  }
  elsif ($dstExpr =~ /\$1/ and !$dstExprEval) { $dstExpr = '"' . $dstExpr . '"'; }
  
  # Base dir
  my $dir = $win->tfInputDir->Text();
  my $inputIsNotDir = 0;
  if (!$dir) { # Input is not a dir
    my $filesStr = $win->tfInputFiles->Text();
    if ($filesStr) {
      $inputIsNotDir = 1;
      # Multiple files
      if ($filesStr =~ /" "/) {
        $dir = (split(/" "/, $filesStr))[0];
        $dir =~ s/\"//g;
      }
      # Single file
      else {
        my @pathParts = split(/\\/, $filesStr);
        pop(@pathParts);
        $dir = join("\\", @pathParts);
      }
    }
  }
  
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  
  # Browse list of files and rename file that contains expression
  if ($execute) { $win->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  else          { $winPb->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  foreach my $file (sort keys %{$refListFiles}) {
    my $relPath;
    my $dstFile;
    my $isDir;
    my $invalidDir;
    my $noMatch;
    my $renamed = 0;
    
    # Remove basedir from filename if input is dir
    if ($dir) { $relPath = $file =~ s/\Q$dir//r; }
    
    # If input is not dir, only filename can be renamed
    if ($inputIsNotDir) { $relPath = (split(/\\/, $file))[-1]; }
    
    # If $file is a subfolder
    if (-d $file) {
      $isDir = 1;
      # If $file is basedir or if we only rename filenames, step to next file
      if (!$srcExprFolder or $relPath eq "\\") {
        $count++;
        if ($execute) {
          $win->lblPbCount->Text("$count / $nbrFiles");
          $win->pb->StepIt();
        } else { # Preview mode
          $winPb->lblCount->Text("$count / $nbrFiles");
          $winPb->pbWinPb->StepIt();
        }
        next;
      }
    }
    
    # If source file contains expression
    if ($relPath and ($srcExprCase and $relPath =~ /$srcExpr/) or (!$srcExprCase and $relPath =~ /$srcExpr/i)) {
      my @pathParts  = split(/\\/, $relPath);
      my $filename;
      if (!$isDir) { $filename = pop(@pathParts); }
      my $relDstPath = join("\\", @pathParts);
      
      # Expression match a directory
      if ($srcExprFolder and $relDstPath and (($srcExprCase and $relDstPath =~ /$srcExpr/) or (!$srcExprCase and $relDstPath =~ /$srcExpr/i))) {
        my $relSrcPath = join("\\", @pathParts);
        # Create the destination dir
        if ($srcExprCase) {
          if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
            $relDstPath =~ s/$srcExpr/$dstExpr/eeg;
          } else { $relDstPath =~ s/$srcExpr/$dstExpr/g; } # Keyword
        } else {
          if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
            $relDstPath =~ s/$srcExpr/$dstExpr/eegi;
          } else { $relDstPath =~ s/$srcExpr/$dstExpr/gi; } # Keyword
        }
        if ($@) { $invalidDir = 1; } # Error with replace
        # Valid destination folder name
        if (!$invalidDir and $relDstPath =~ /\\(.+)/ and &validName($1)) {
          my $newDir = $dir . $relDstPath;
          if ($execute) {
            if    (!File::Copy::Recursive::pathmk($newDir)) { $relPath = ''; } # Error renaming dir
            elsif (!exists($renamedDirs{$relSrcPath})     ) { $renamedDirs{$relSrcPath} = 1; }
          }
        } else { $invalidDir = 1; }
      }
      
      # Expression match filename
      elsif (!$srcExprFolder and !$isDir) {
        if ($filename and ($srcExprCase and $filename =~ /$srcExpr/) or (!$srcExprCase and $filename =~ /$srcExpr/i)) {
          # Rename file
          if ($srcExprCase) {
            if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
              $filename =~ s/$srcExpr/$dstExpr/eeg;
            } else { $filename =~ s/$srcExpr/$dstExpr/g; } # Keyword
          } else {
            if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
              $filename =~ s/$srcExpr/$dstExpr/eegi;
            } else { $filename =~ s/$srcExpr/$dstExpr/gi; } # Keyword
          }
          if ($@) { $filename = ''; } # Error with replace
        }
        # Valid destination filename
        if (!&validName($filename)) { $filename = ''; }
      }
      
      # No match
      else { $noMatch = 1; }
      
      # Set the new filename
      if (!$noMatch) {
        if    ($relDstPath and $filename) { $dstFile = $dir . $relDstPath . "\\" . $filename; }
        elsif ($filename)                 { $dstFile = $dir               . "\\" . $filename; }
        elsif ($isDir) { # Subfolder
          $dstFile = $dir . $relDstPath;
          $listSubFolders{$dstFile} = 1;
          # If directory has the same name, but case are different, rename
          # Otherwise, remove from list
          if ($file ne $dstFile and uc($file) ne uc($dstFile)) { $dstFile = ''; }
        }
      }
      
      # Rename the file
      if ($dstFile) {
        # File or directory already exists
        if (-e $dstFile or exists($resListFiles{$dstFile})) {
          my @filenameParts = split(/\./, $filename);
          my $extension;
          my $dstFilename;
          if (scalar(@filenameParts) > 1) { $extension = pop(@filenameParts); }
          $dstFilename = join('.', @filenameParts);
          my $i;
          while (-e $dstFile or exists($resListFiles{$dstFile})) {
            $i++;
            $dstFile = $dir . "$relDstPath\\$dstFilename".'_'.$i;
            if ($extension) { $dstFile .= '.'.$extension; } # Add extension
          }
          $renamed = 1;
        }
        
        if ($execute) {
          if (rename($file, $dstFile)) {
            $nbrRenamed++;
            if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFile\n"; }
          } else {
            $nbrError++;
            if ($logging) { print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
          }
        } else {
          # Illegal characters
          if ($filename and $filename =~ /[\<\>\:\"\/\\\|\?\*]/ or $invalidDir) {
            $resListFiles{$dstFile} = 2;
          }
          elsif ($renamed) { $resListFiles{$dstFile} = 4; } # Renamed file existed, renamed
          else             { $resListFiles{$dstFile} = 1; }
        }
      }
    }
    
    $count++;
    if ($execute) { 
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  
  # Delete renamed dir (if empty)
  foreach my $renamedDir (reverse sort keys %renamedDirs) {
    my $renamedDirPath = $dir . $renamedDir;
    rmdir($renamedDirPath);
  }
  
  return($nbrRenamed, \%resListFiles, \%listSubFolders, $nbrError);

}  #--- End renameReplaceBy

#--------------------------#
sub lblNotReady_Click
#--------------------------#
{
  &isProcessReady(1);

}  #--- End lblNotReady_Click

#--------------------------#
sub isProcessReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  
  # Check Input
  if (!$win->tfInputDir->Text() and !$win->tfInputFiles->Text()) {
    $nextStep = $STR{'selectInput'};
  } else {
    
    # Filters

    # File Size
    if ($win->rbFiltersSize->Checked() and !$win->tfFiltersSize->Text()) {
      $nextStep = $STR{'setFileSize'};
      $win->btnPreview->Disable();
    # Contains
    } elsif ($win->rbFiltersContains->Checked() and !$win->tfFiltersContains->Text()) {
      $nextStep = $STR{'setContains'};
      $win->btnPreview->Disable();
    } elsif ($win->chFiltersContainsRegex->Checked() and $win->rbFiltersContains->Checked()) {
      my ($status, $msg) = &validRegex($win->tfFiltersContains->Text());
      if ($status) {
        $nextStep = $STR{'errRegex'} . ' ' . $STR{'errRegexFilter'} . ":\n\n";
        if ($msg) { $nextStep .= $msg; }
        $win->btnPreview->Disable();
      } else {
        $win->btnPreview->Enable();
        # Functions
        $nextStep = &isFunctionsReady();
      }
    } else {
      $win->btnPreview->Enable();
      # Functions
      $nextStep = &isFunctionsReady();
    }
  }

  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnProcess->Disable();
    $win->lblNotReady->Show();
    if ($confirm) { Win32::GUI::MessageBox($win, "$STR{'notReady'} ?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040); }
  } else {
    $win->btnProcess->Enable();
    $win->lblNotReady->Hide();
  }

}  #--- End isProcessReady

#--------------------------#
sub isFunctionsReady
#--------------------------#
{
  # Local variables
  my $nextStep;
  
  # Lists
  if (!$win->TabFunctions->SelectedItem() and  $win->rbListFiles->Checked()     and
      !$win->chListFilesOpt1->Checked()   and !$win->chListFilesOpt2->Checked() and
      !$win->chListFilesOpt3->Checked()   and !$win->chListFilesOpt4->Checked() and
      !$win->chListFilesOpt5->Checked()   and !$win->chListFilesOpt6->Checked()) {
    $nextStep = $STR{'setListFilesOpt'};
  }
  # Copy or move
  if ($win->TabFunctions->SelectedItem() == 1 and !$win->tfDestinationDir->Text()) {
    $nextStep = $STR{'selectDstDir'};
  }
  # Rename By Sort
  if ($win->TabFunctions->SelectedItem() == 2 and $win->rbRenSort->Checked()) {
    my $length      = $winRenBySortOpt->tfLength->Text();
    my $initVal     = $winRenBySortOpt->tfInitVal->Text();
    my $stepVal     = $winRenBySortOpt->tfStepVal->Text();
    if (!$length and !$initVal and !$stepVal) {
      $nextStep = $STR{'setRenReplaceBy'};
    }
  }
  # Rename Replace
  if ($win->TabFunctions->SelectedItem() == 2 and $win->rbRenReplace->Checked() and !$win->tfRenReplace->Text()) {
    $nextStep = $STR{'setRenBySortOpt'};
  } elsif ($win->TabFunctions->SelectedItem() == 2 and $win->rbRenReplace->Checked() and
           ($win->chRenReplaceRegex->Checked() or $win->chRenReplaceByEval->Checked())) { # Valid regex
    # Regex is valid ?
    if ($win->chRenReplaceRegex->Checked()) {
      if ($win->tfRenReplace->Text()) {
        my ($status, $msg) = &validRegex($win->tfRenReplace->Text());
        if ($status and $status == 1) {
          $nextStep = $STR{'errRegex'} . ' ' . $STR{'errRegexReplace'} . ":\n\n";
          if ($msg) { $nextStep .= $msg; }
        }
      }
      # Replacement expression is valid ?
      if ($win->tfRenReplaceBy->Text()) {
        my ($status, $msg) = &validReplacement;
        if ($status and $status == 1) {
          $nextStep = $STR{'errBy'} . ' ' . $STR{'errRegexReplaceBy'} . ":\n\n";
          if ($msg) { $nextStep .= $msg; }
        }
      }
    }
  }
  
  return($nextStep);
  
}  #--- End isFunctionsReady
  
#--------------------------#
sub validRegex
#--------------------------#
{
  # Local variables
  my $regex = shift;
  
  if ($regex) {
    eval { if ('test' =~ /$regex/) { } };
    if ($@) {
      my $errRegex = (split(/ at /,$@))[0];
      return(1, $errRegex);
    } else {
      # Valid but senseless regex
      if ($regex =~ /^\||\|\||(?:[^\\]\|$)/ or $regex =~ /^\(\.\*\)$/) { return(2, undef); }
      else { return(0, undef); }
    }
  }
  
}  #--- End validRegex

#--------------------------#
sub validName
#--------------------------#
{
  # Local variables
  my $name = shift;
  
  # Contains illegal characters (in a window filename or folder) ?
  if ($name =~ /[\<\>\:\"\/\\\|\?\*]/) { return(0); }
  else                                 { return(1); }
  
}  #--- End validName

#--------------------------#
sub validReplacement
#--------------------------#
{
  # Local variables
  my $expr = $win->tfRenReplaceBy->Text();
  my $test = 'test';
  
  if ($expr =~ /\$1/ and !$win->chRenReplaceByEval->Checked()) { $expr = '"' . $expr . '"';  } # Capture with Eval not checked
  if ($win->chRenReplaceByEval->Checked() or $expr =~ /\$1/)   { $test =~ s/(.+)/$expr/eegi; } # Regex
  else                                                         { $test =~ s/(.+)/$expr/gi;   } # Keyword
  if ($@) {
    # Error
    my $err = (split(/ at /,$@))[0];
    return(1, $err);
  } else {
    # Warning for illegal characters
    if ($expr =~ /[\<\>\:\"\/\\\|\?\*]/) { return(2, undef); }
    
    # Replacement ok
    return(0, undef);
  }  
  
}  #--- End validReplacement

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  
  $winConfig->Center($win);
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if (!$winConfig->configTab->SelectedItem()) {
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->lblFuncShadowT->Show();
    $winConfig->lblFuncT->Show();
    $winConfig->chHashLowercase->Show();
    # Hide logging tab
    $winConfig->chEnableLogging->Hide();
    $winConfig->rbUseDefaultDir->Hide();
    $winConfig->rbLoggingDir->Hide();
    $winConfig->tfLoggingDir->Hide();
    $winConfig->btnLoggingDir->Hide();
    $winConfig->chUseDestDirCM->Hide();
    
  # Show Logging tab
  } else {
    $winConfig->chEnableLogging->Show();
    # Show options
    $winConfig->rbUseDefaultDir->Show();
    $winConfig->rbLoggingDir->Show();
    $winConfig->tfLoggingDir->Show();
    $winConfig->btnLoggingDir->Show();
    $winConfig->chUseDestDirCM->Show();
    if ($winConfig->chEnableLogging->Checked()) {
      # Enable options
      $winConfig->rbUseDefaultDir->Enable();
      $winConfig->rbLoggingDir->Enable();
      $winConfig->chUseDestDirCM->Enable();
      if ($winConfig->rbUseDefaultDir->Checked()) {
        $winConfig->tfLoggingDir->Disable();
        $winConfig->btnLoggingDir->Disable();
      } else {
        $winConfig->tfLoggingDir->Enable();
        $winConfig->btnLoggingDir->Enable();
      }
    } else {
      # Disable options
      $winConfig->rbUseDefaultDir->Disable();
      $winConfig->rbLoggingDir->Disable();
      $winConfig->tfLoggingDir->Disable();
      $winConfig->btnLoggingDir->Disable();
      $winConfig->chUseDestDirCM->Disable();
    }
    # Hide general tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->lblFuncShadowT->Hide();
    $winConfig->lblFuncT->Hide();
    $winConfig->chHashLowercase->Hide();
  }

}  #--- End configTab_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnCheckUpdate_Click
#--------------------------#
{
  &updateTool(1);

}  #--- End btnCheckUpdate_Click

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub updateTool
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent('XL-FileTools Update $VERSION');
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'update4'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open Firefox to XL-FileTools page
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
          Win32::GUI::MessageBox($winConfig, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-FileTools",0x40010);
      }
    }
  }
  # Error 
  else {
    if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'errorConnection'}.': '.$res->status_line, "$STR{'update3'} XL-FileTools",0x40010); }
  }

}  #--- End updateTool

#--------------------------#
sub chHashLowercase_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chHashLowercase->Checked()) {
    $CONFIG{'HASH_LOWERCASE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'HASH_LOWERCASE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chHashLowercase_Click

#--------------------------#
sub chEnableLogging_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chEnableLogging->Checked()) {
    $CONFIG{'ENABLE_LOGGING'} = 1;
    &saveConfig(\%CONFIG);
    
    # Enable options
    $winConfig->rbUseDefaultDir->Enable();
    $winConfig->rbLoggingDir->Enable();
    $winConfig->tfLoggingDir->Enable();
    $winConfig->btnLoggingDir->Enable();
    $winConfig->chUseDestDirCM->Enable();
    
  } else {
    $CONFIG{'ENABLE_LOGGING'} = 0;
    &saveConfig(\%CONFIG);
    
    # Disable options
    $winConfig->rbUseDefaultDir->Disable();
    $winConfig->rbLoggingDir->Disable();
    $winConfig->tfLoggingDir->Disable();
    $winConfig->btnLoggingDir->Disable();
    $winConfig->chUseDestDirCM->Disable();
  }

}  #--- End chEnableLogging_Click

#--------------------------#
sub rbUseDefaultDir_Click
#--------------------------#
{
  # Save the choice
  $CONFIG{'LOG_USE_DEFAULT_DIR'} = 1;
  &saveConfig(\%CONFIG);
  
  $winConfig->tfLoggingDir->Disable();
  $winConfig->btnLoggingDir->Disable();

}  #--- End rbUseDefaultDir_Click

#--------------------------#
sub rbLoggingDir_Click
#--------------------------#
{
  # Save the choice
  $CONFIG{'LOG_USE_DEFAULT_DIR'} = 0;
  &saveConfig(\%CONFIG);

  $winConfig->tfLoggingDir->Enable();
  $winConfig->btnLoggingDir->Enable();

}  #--- End rbLoggingDir_Click

#--------------------------#
sub tfLoggingDir_Change
#--------------------------#
{
  # Local variables
  my $loggingDir = $winConfig->tfLoggingDir->Text();
  
  # Remember
  if ($loggingDir and -d $loggingDir) {
    $CONFIG{'LOGGING_DIR'} = $loggingDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'LOGGING_DIR'});
    &saveConfig(\%CONFIG);
    if ($loggingDir) {
      $win->tfLoggingDir->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010); }
    }
  }

}  #--- End tfLoggingDir_Change

#--------------------------#
sub btnLoggingDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLoggingDir->Text();
  my $dir;

  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig        ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -directory  => $lastDir          ,
                                        -newui      => 1                 , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig        ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -newui      => 1                 , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winConfig->tfLoggingDir->Text($dir);
  }
  
}  #--- End btnLoggingDir_Click

#--------------------------#
sub chUseDestDirCM_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chUseDestDirCM->Checked()) {
    $CONFIG{'LOG_USE_DST_DIR'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'LOG_USE_DST_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chUseDestDirCM_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  # Open Firefox to XL-FileTools page
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-FileTools",0x40010);

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                    ,
                                              -parent      => $win                          ,
                                              -text        => $STR{'about'}.' XL-FileTools' ,
                                              -pos         => [$winPosX, $winPosY]          ,
                                              -size        => [520, 170]                    ,
                                              -background  => [255, 255, 255]               ,
                                              -hasmaximize => 0                             ,
                                              -hasminimize => 1                             ,
                                              -helpbutton  => 0                             ,
                                              -resizable   => 0                             ,
                                              -dialogui    => 1                             , );
  $winAbout->SetIcon($winICO);
  
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -foreground  => [0  , 0  , 102]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'version'}:\n$STR{'website'}:\n$STR{'author'}:\n$STR{'translatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10                 ,
                        -foreground  => [185, 154,   0]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -foreground  => [0  , 0  , 102]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2016 Alain Rioux', );
  
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Open and load config values
  open(CONFIG, $CONFIG_FILE);
  my @tab = <CONFIG>;
  close(CONFIG);
  
  foreach (@tab) {
    chomp($_);
    my ($key, $value) = split(/ = /, $_);
    if ($key) { $$refConfig{$key}  = $value; }
  }
  
  # General tab
  if (exists($$refConfig{'TOOL_AUTO_UPDATE'}))      { $winConfig->chAutoUpdate->Checked($$refConfig{'TOOL_AUTO_UPDATE'});           }
  else                                              { $winConfig->chAutoUpdate->Checked(1);                                         } # Default is checked
  if (exists($$refConfig{'HASH_LOWERCASE'}))        { $winConfig->chHashLowercase->Checked($$refConfig{'HASH_LOWERCASE'});          }
  else                                              { $winConfig->chHashLowercase->Checked(1);                                      } # Default is checked
  # Logging
  if (exists($$refConfig{'ENABLE_LOGGING'}))        { $winConfig->chEnableLogging->Checked($$refConfig{'ENABLE_LOGGING'});          }
  else                                              { $winConfig->chEnableLogging->Checked(1);                                      } # Default is checked
  if (exists($$refConfig{'LOGGING_DIR'}) and -d $$refConfig{'LOGGING_DIR'}) { # Use defined logging dir
    $winConfig->tfLoggingDir->Text($$refConfig{'LOGGING_DIR'});
    $winConfig->rbLoggingDir->Checked(1);
    $winConfig->rbUseDefaultDir->Checked(0);
    $winConfig->tfLoggingDir->Enable();
    $winConfig->btnLoggingDir->Enable();
  } else {                                                                    # Use default dir
    $winConfig->rbUseDefaultDir->Checked(1);
    $winConfig->rbLoggingDir->Checked(0);
    $winConfig->tfLoggingDir->Disable();
    $winConfig->btnLoggingDir->Disable();
  }
  if (exists($$refConfig{'LOG_USE_DST_DIR'}))       { $winConfig->chUseDestDirCM->Checked($$refConfig{'LOG_USE_DST_DIR'});          }
  else                                              { $winConfig->chUseDestDirCM->Checked(0);                                       } # Default is not checked
  
  # Folder for report
  if (exists($$refConfig{'DIR_REPORT'}) and
      -d $$refConfig{'DIR_REPORT'})                 { $win->tfReportDir->Text($$refConfig{'DIR_REPORT'});                           }
  else                                              { $win->tfReportDir->Text($USERDIR);                                            } # Default dir
  if (exists($$refConfig{'AUTO_OPEN_REPORT'}))      { $win->chOpenReport->Checked($$refConfig{'AUTO_OPEN_REPORT'});                 }
  else                                              { $win->chOpenReport->Checked(1);                                               } # Default is checked

}  #--- End loadConfig

#--------------------------#
sub date
#--------------------------#
{
  # Local variables
  my ($time) = @_;
  
  # Conversion
  if (!$time or $time == 0) { $time = time; }
  my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($time);

  # Format
  $y += 1900;
  $m++;
  $m   = $m   < 10 ? $m   = "0".$m   : $m;
  $d   = $d   < 10 ? $d   = "0".$d   : $d;
  $h   = $h   < 10 ? $h   = "0".$h   : $h;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  
  return($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST);

}  #--- End date

