#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name   : XL-FileTools
# Website     : http://le-tools.com/
# GitHub		  : https://github.com/arioux/XL-FileTools
# Description : Part of the XL-Toolkit, XL-FileTools provides a bunch of functions
#               for files like filtering, listing, copying, moving and renaming.
# Creation    : 2016-05-14
# Modified    : 2016-07-22
my $VERSION   = "3.0";
# Author      : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2016  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#

#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use Digest::MD5::File qw(file_md5_hex);
use Digest::SHA qw(sha1_hex sha256_hex sha512_hex);
use Text::Roman qw(:all);
use Excel::Writer::XLSX;
use File::Copy;
use File::Copy::Recursive qw(fcopy fmove);
use Time::Local;
use Win32::API();
use Win32::DriveInfo;
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI::Grid;
use Win32::Process;
use threads;
use threads::shared;
require "XL-FileToolsGraph.pl";
require "XL-FileToolsLang.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#

my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $REF_ARG      = \@ARGV;                                                     # If objects passed (using SendTo)
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-FileTools") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-FileTools"; }
else                                                { $USERDIR = $PROGDIR;                                    }
my $LANG_FILE    = "$USERDIR\\Lang.ini";                                       # Langage file
my $CONFIG_FILE  = "$USERDIR\\XL-FileTools.ini";                               # Configuration file
my $URL_DOC      = "http://le-tools.com/XL-FileToolsDoc.html";                 # Online documentation
my $URL_TOOL     = 'http://le-tools.com/XL-FileTools.html#Download';           # Url of the tool
my $URL_VER      = 'http://www.le-tools.com/download/XL-FileToolsVer.txt';     # Url of the version file
my %CONFIG       :shared;                                                      # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW        :shared;                                                      # Arrow pointer
my $HOURGLASS    :shared;                                                      # Hourglass pointer
my $THR_PROCESS;                                                               # Thread for process
my $THR_UPDATE;                                                                # Thread for update
my $START = 0;                                                                 # Indicate when program is started

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#

my ($winICO, $logoBmp, $logo128Bmp, $openDirBmp, $openFileBmp, $processBmp,
    $stopBmp, $previewBmp, $config32Bmp, $helpBmp, $aboutBmp, $config128Bmp,
    $browseBmp, $folderClosedBmp, $folderOpenedBmp, $fileBmp, $delFileBmp,
    $warnFileBmp, $filterSet, $filterAdd, $filterDel) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#

&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings


#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#

my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 800;
my $winHeight = 510;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;

# Main Window
my $win = Win32::GUI::Window->new( -name        => 'winMain'               ,
                                   -text        => 'XL-FileTools'          ,
                                   -background  => [255, 255, 255]         ,
                                   -size        => [$winWidth, $winHeight] ,
                                   -pos         => [$winPosX , $winPosY]   ,
                                   -minheight   => $winHeight              ,
                                   -minwidth    => $winWidth               , );
$win->SetIcon($winICO);

# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGB2;
my $font10;
my $font10u;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      , );
  $fontGB2 = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 12     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font10  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      , );
  $font10u = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 12     ,
                                  -bold      => 1      , );
  $fontGB2 = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 14     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font10  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     , );
  $font10u = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
}

# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);

# Header
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [300, 60]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $logoBmp                , );
$win->AddLabel(       -name        => 'lblHeader'             ,
                      -size        => [400, 60]               ,
                      -pos         => [300,  0]               ,
                      -background  => [250, 250, 250]         , );

# Input section
$win->AddLabel(       -name        => 'lblInputT'             ,
                      -size        => [$winWidth, 24]         ,
                      -pos         => [  0, 60]               ,
                      -text        => ' '.$STR{'lblInputT'}   ,
                      -font        => $fontGB                 ,
                      -foreground  => [255, 255, 255]         ,
                      -background  => [255, 210,  84]         , );
$win->AddRadioButton( -name        => 'rbInputDir'            ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5, 90]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbInputDir'}      ,
                      -font        => $font10                 ,
                      -checked     => 1                       ,
                      -group       => 1                       ,
                      -tabstop     => 1                       , );
$win->AddRadioButton( -name        => 'rbInputFiles'          ,
                      -size        => [ 80, 22]               ,
                      -pos         => [ 90, 90]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbInputFiles'}    ,
                      -font        => $font10                 ,
                      -tabstop     => 1                       , );
$win->AddCheckbox(    -name        => 'chInputDirRecurse'     ,
                      -size        => [135, 22]               ,
                      -pos         => [ 90,115]               ,
                      -text        => $STR{'chInputDirRecurse'},
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 ,
                      -tabstop     => 1                       ,
                      -checked     => 1                       , );

$win->AddTextfield(   -name        => 'tfInput'               ,
                      -size        => [465, 22]               ,
                      -pos         => [  5,115]               ,
                      -tabstop     => 1                       , );
$win->AddButton(      -name        => 'btnInput'              ,
                      -size        => [ 22, 22]               ,
                      -pos         => [557,115]               ,
                      -bitmap      => $openDirBmp             ,
                      -tabstop     => 1                       , );

# Filters
$win->AddLabel(       -name        => 'lblFiltersT'           ,
                      -size        => [$winWidth, 24]         ,
                      -pos         => [  0,150]               ,
                      -text        => ' '.$STR{'lblFiltersT'} ,
                      -font        => $fontGB                 ,
                      -foreground  => [255, 255, 255]         ,
                      -background  => [255, 210,  84]         , );
$win->AddGrid(        -name         => 'gridFilter'           ,
                      -size         => [580, 70]              ,
                      -pos          => [  5,185]              ,
                      -background   => [255, 255, 255]        ,
                      -columns      => 5                      ,
                      -fixedrows    => 1                      ,
                      -fixedcolumns => 0                      ,
                      -editable     => 1                      , );
$win->AddButton(      -name        => 'btnFilterSet'          ,
                      -size        => [ 22, 22]               ,
                      -pos         => [580,185]               ,
                      -bitmap      => $filterSet              ,
                      -tip         => $STR{'filterSetTip'}    ,
                      -tabstop     => 1                       , );
$win->AddButton(      -name        => 'btnFilterAdd'          ,
                      -size        => [ 22, 22]               ,
                      -pos         => [580,185]               ,
                      -bitmap      => $filterAdd              ,
                      -tip         => $STR{'filterAddTip'}    ,
                      -disabled    => 1                       ,
                      -tabstop     => 1                       , );
$win->AddButton(      -name        => 'btnFilterDel'          ,
                      -size        => [ 22, 22]               ,
                      -pos         => [580,185]               ,
                      -bitmap      => $filterDel              ,
                      -tip         => $STR{'filterDelTip'}    ,
                      -disabled    => 1                       ,
                      -tabstop     => 1                       , );

# Functions
$win->AddLabel(         -name         => 'lblFunctionsT'        ,
                        -size         => [$winWidth, 24]        ,
                        -pos          => [  0,298]              ,
                        -text         => ' '.$STR{'lblFunctionsT'},
                        -font         => $fontGB                ,
                        -foreground   => [255, 255, 255]        ,
                        -background   => [255, 210,  84]        , );
$win->AddTabStrip(      -name         => 'TabFunctions'         ,
                        -size         => [$winWidth-4,120]      ,
                        -pos          => [  0,327]              ,
                        -font         => $font10                ,
                        -fixedwidth   => 1                      ,
                        -tabstop      => 1                      ,
                        -background   => [255, 255, 255]        , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions1T'} , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions2T'} , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions3T'} , );
# Lists
$win->AddRadioButton(   -name         => 'rbListFiles'          ,
                        -size         => [160, 22]              ,
                        -pos          => [  5,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbListFiles'}.':',
                        -font         => $font10                ,
                        -group        => 1                      ,
                        -checked      => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptFP'     , # Full path
                        -size         => [130, 22]              ,
                        -pos          => [180,360]              ,
                        -text         => $STR{'chListFilesOptFP'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptFN'     , # Filename
                        -size         => [130, 22]              ,
                        -pos          => [180,385]              ,
                        -text         => $STR{'chListFilesOptFN'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptHV'     , # Hash values
                        -size         => [140, 22]              ,
                        -pos          => [315,360]              ,
                        -text         => $STR{'chListFilesOptHV'}.'...',
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptFD'     , # File details
                        -size         => [140, 22]              ,
                        -pos          => [315,385]              ,
                        -text         => $STR{'chListFilesOptFD'}.'...',
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptNbrL'   , # Number of lines
                        -size         => [165, 22]              ,
                        -pos          => [460,360]              ,
                        -text         => $STR{'chListFilesOptNbrL'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptNH'     , # No header
                        -size         => [150, 22]              ,
                        -pos          => [630,360]              ,
                        -text         => $STR{'chListFilesOptNH'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chListFilesOptNF'     , # No folder
                        -size         => [150, 22]              ,
                        -pos          => [630,385]              ,
                        -text         => $STR{'chListFilesOptNF'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddRadioButton(   -name         => 'rbListExt'            ,
                        -size         => [160, 22]              ,
                        -pos          => [  5,385]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbListExt'}      ,
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblReportDir'         ,
                        -size         => [ 80, 22]              ,
                        -pos          => [  5,428]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblReportDir'}.':',
                        -font         => $font10                ,
                        -tabstop      => 1                      , );
$win->AddTextfield(     -name         => 'tfReportDir'          ,
                        -size         => [315, 22]              ,
                        -pos          => [ 90,425]              ,
                        -tabstop      => 1                      , );
$win->AddCombobox(      -name         => 'cbReportFormat'       ,
                        -size         => [ 60, 22]              ,
                        -pos          => [410,425]              ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      ,
                        -tabstop      => 1                      , );
$win->cbReportFormat->Add('TXT', 'HTML', 'XLSX'                 , );
$win->AddButton(        -name         => 'btnReportDir'         ,
                        -size         => [ 22, 22]              ,
                        -pos          => [477,425]              ,
                        -bitmap       => $openDirBmp            ,
                        -tip          => $STR{'selDirReport'}   ,
                        -tabstop      => 1                      , );
$win->AddButton(        -name         => 'btnOpenReportDir'     ,
                        -size         => [ 22, 22]              ,
                        -pos          => [499,425]              ,
                        -bitmap       => $browseBmp             ,
                        -tip          => $STR{'browseDirReport'},
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chOpenReport'         ,
                        -size         => [185, 22]              ,
                        -pos          => [522,425]              ,
                        -text         => $STR{'chOpenReport'}   ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tabstop      => 1                      ,
                        -checked      => 1                      , );
# Copy or move
$win->AddRadioButton(   -name         => 'rbCopy'               ,
                        -size         => [120, 22]              ,
                        -pos          => [  5,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbCopy'}         ,
                        -font         => $font10                ,
                        -group        => 1                      ,
                        -checked      => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddRadioButton(   -name         => 'rbMove'               ,
                        -size         => [120, 22]              ,
                        -pos          => [  5,385]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbMove'}         ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chCopyTree'           ,
                        -size         => [250, 22]              ,
                        -pos          => [130,360]              ,
                        -text         => $STR{'chCopyTree'}     ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chCopyRemDouble'      ,
                        -size         => [250, 22]              ,
                        -pos          => [130,385]              ,
                        -text         => $STR{'chCopyRemDouble'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblDestination'       ,
                        -size         => [ 80, 22]              ,
                        -pos          => [  5,428]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblDestination'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddTextfield(     -name         => 'tfDestinationDir'     ,
                        -size         => [405, 22]              ,
                        -pos          => [ 90,425]              ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddButton(        -name         => 'btnDestinationDir'    ,
                        -size         => [ 22, 22]              ,
                        -pos          => [497,425]              ,
                        -bitmap       => $openDirBmp            ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chOpenDstDir'         ,
                        -size         => [185, 22]              ,
                        -pos          => [522,425]              ,
                        -text         => $STR{'chOpenDstDir'}   ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      ,
                        -checked      => 1                      , );
# Rename
$win->AddRadioButton(   -name         => 'rbRenByHash'          ,
                        -size         => [110, 22]              ,
                        -pos          => [  5,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbRenByHash'}.':',
                        -font         => $font10                ,
                        -group        => 1                      ,
                        -checked      => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddCombobox(      -name         => 'cbRenByHash'          ,
                        -size         => [ 80, 22]              ,
                        -pos          => [120,360]              ,
                        -font         => $font10                ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->cbRenByHash->Add( 'MD5', 'SHA1', 'SHA256', 'SHA512',      , );
$win->cbRenByHash->SetCurSel(0);
$win->AddRadioButton(   -name         => 'rbRenSort'            ,
                        -size         => [110, 22]              ,
                        -pos          => [325,360]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbRenSort'}.':'  ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddButton(        -name         => 'btnRenSort'           ,
                        -size         => [100, 24]              ,
                        -pos          => [440,360]              ,
                        -text         => $STR{'Options'}.'...'  ,
                        -font         => $font10                ,
                        -disabled     => 1                      ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddRadioButton(   -name         => 'rbRenReplace'         ,
                        -size         => [110, 22]              ,
                        -pos          => [  5,390]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'rbRenReplace'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblRenReplaceOk'      ,
                        -size         => [152, 24]              ,
                        -pos          => [119,389]              ,
                        -background   => [  0, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceErr'     ,
                        -size         => [152, 24]              ,
                        -pos          => [119,389]              ,
                        -background   => [255,   0,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceWarn'    ,
                        -size         => [152, 24]              ,
                        -pos          => [119,389]              ,
                        -background   => [255, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfRenReplace'         ,
                        -size         => [150, 22]              ,
                        -pos          => [120,390]              ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceRegex'    ,
                        -size         => [ 85, 22]              ,
                        -pos          => [120,415]              ,
                        -text         => $STR{'chFiltersContainsRegex'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceCase'     ,
                        -size         => [120, 22]              ,
                        -pos          => [210,415]              ,
                        -text         => $STR{'chFiltersContainsCase'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceFolder'   ,
                        -size         => [120, 22]              ,
                        -pos          => [335,415]              ,
                        -text         => $STR{'chRenReplaceFolder'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddLabel(         -name         => 'lblRenReplaceBy'      ,
                        -size         => [ 40, 22]              ,
                        -pos          => [325,393]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblRenReplaceBy'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByOk'    ,
                        -size         => [152, 24]              ,
                        -pos          => [369,389]              ,
                        -background   => [  0, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByErr'   ,
                        -size         => [152, 24]              ,
                        -pos          => [369,389]              ,
                        -background   => [255,   0,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByWarn'  ,
                        -size         => [152, 24]              ,
                        -pos          => [369,389]              ,
                        -background   => [255, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfRenReplaceBy'       ,
                        -size         => [150, 22]              ,
                        -pos          => [370,390]              ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceByEval'  ,
                        -size         => [ 60, 22]              ,
                        -pos          => [370,415]              ,
                        -text         => $STR{'chRenReplaceByEval'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -disabled     => 1                      ,
                        -tabstop      => 1                      , );

# Footer
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [$winWidth, 80]         ,
                      -pos         => [  2,$winHeight-82]     ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10, $winHeight-65]    ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddLabel(       -name        => 'lblPbCurr'             ,
                      -size        => [495, 20]               ,
                      -pos         => [ 10, $winHeight-75]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddProgressBar( -name        => 'pb'                    ,
                      -size        => [410, 20]               ,
                      -pos         => [ 10, $winHeight-55]    ,
                      -smooth      => 1                       ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblPbCount'            ,
                      -size        => [ 85, 20]               ,
                      -pos         => [425, $winHeight-53]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnProcess'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [465,$winHeight-75]     ,
                      -bitmap      => $processBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Process'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnStop'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [465,$winHeight-75]     ,
                      -bitmap      => $stopBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'StopProcess'}     ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnPreview'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [510,$winHeight-75]     ,
                      -bitmap      => $previewBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Preview'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [555,$winHeight-75]     ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Configuration'}   , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [600,$winHeight-75]     ,
                      -bitmap      => $helpBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [645,$winHeight-75]     ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'about'}           , );

#------------------------------------------------------------------------------#
# Filters window
#------------------------------------------------------------------------------#

my $winFilters = Win32::GUI::Window->new( -name        => 'winFilters'           ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'lblFiltersT'}    ,
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [450, 250]             ,
                                          -hasmaximize => 0                      ,
                                          -hasminimize => 0                      ,
                                          -resizable   => 0                      ,
                                          -dialogui    => 1                      , );
$winFilters->SetIcon($winICO);

$winFilters->AddLabel(        -name         => 'lblFiltersOp'          ,
                              -size         => [100, 22]               ,
                              -pos          => [  5,  8]               ,
                              -text         => $STR{'Operator'}.':'    ,
                              -font         => $font10                 ,
                              -background   => [255, 255, 255]         ,
                              -disabled     => 1                       , );
$winFilters->AddCombobox(     -name         => 'cbFiltersOp'           ,
                              -size         => [ 60, 22]               ,
                              -pos          => [110,  5]               ,
                              -font         => $font10                 ,
                              -dropdownlist => 1                       ,
                              -disabled     => 1                       ,
                              -tabstop      => 1                       , );
$winFilters->cbFiltersOp->Add($STR{'OR'}, $STR{'AND'}, );
$winFilters->cbFiltersOp->SetCurSel(0);
$winFilters->AddLabel(        -name         => 'lblFiltersType'        ,
                              -size         => [100, 22]               ,
                              -pos          => [  5, 38]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => $STR{'Type'}.':'        ,
                              -font         => $font10                 , );
$winFilters->AddCombobox(     -name         => 'cbFiltersType'         ,
                              -size         => [110, 22]               ,
                              -pos          => [110, 35]               ,
                              -font         => $font10                 ,
                              -dropdownlist => 1                       ,
                              -tabstop      => 1                       , );
$winFilters->cbFiltersType->Add($STR{'rbFiltersContains'}  ,
                                $STR{'rbFiltersSize'   }   , $STR{'rbFiltersLastAccess'},
                                $STR{'rbFiltersLastModif'} , $STR{'rbFiltersDirOnly'}   ,);
$winFilters->cbFiltersType->SetCurSel(0);

# Filter: Contains
$winFilters->AddCheckbox(     -name         => 'chFiltersContainsCase' ,
                              -size         => [125, 22]               ,
                              -pos          => [  5, 70]               ,
                              -text         => $STR{'chFiltersContainsCase'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winFilters->AddCheckbox(     -name         => 'chFiltersContainsRegex',
                              -size         => [ 60, 22]               ,
                              -pos          => [135, 70]               ,
                              -text         => $STR{'chFiltersContainsRegex'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winFilters->AddCheckbox(     -name         => 'chFiltersContainsFileOnly',
                              -size         => [200, 22]               ,
                              -pos          => [230, 70]               ,
                              -text         => $STR{'chFiltersContainsFileOnly'},
                              -background   => [255, 255, 255]         ,
                              -font         => $font10                 ,
                              -tabstop      => 1                       , );
$winFilters->AddLabel(        -name         => 'lblFiltersContainOk'   ,
                              -size         => [432, 72]               ,
                              -pos          => [  4, 94]               ,
                              -background   => [  0, 255,   0]         ,
                              -visible      => 0                       , );
$winFilters->AddLabel(        -name         => 'lblFiltersContainErr'  ,
                              -size         => [432, 72]               ,
                              -pos          => [  4, 94]               ,
                              -background   => [255,   0,   0]         ,
                              -visible      => 0                       , );
$winFilters->AddLabel(        -name         => 'lblFiltersContainWarn' ,
                              -size         => [432, 72]               ,
                              -pos          => [  4, 94]               ,
                              -background   => [255, 255,   0]         ,
                              -visible      => 0                       , );
$winFilters->AddTextfield(    -name         => 'tfFiltersContains'     ,
                              -size         => [430, 70]               ,
                              -pos          => [  5, 95]               ,
                              -multiline    => 1                       ,
                              -wantreturn   => 1                       ,
                              -vscroll      => 1                       ,
                              -autohscroll  => 1                       ,
                              -tabstop      => 1                       , );
$winFilters->tfFiltersContains->MaxLength(5000000);

# Filter: File size
$winFilters->AddCombobox(     -name         => 'cbFiltersSizeOp'       ,
                              -size         => [110, 22]               ,
                              -pos          => [110, 65]               ,
                              -font         => $font10                 ,
                              -dropdownlist => 1                       ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );
$winFilters->cbFiltersSizeOp->Add($STR{'Smaller'}, $STR{'Equal'}, $STR{'Bigger'}, );
$winFilters->cbFiltersSizeOp->SetCurSel(0);
$winFilters->AddTextfield(    -name         => 'tfFiltersSize'         ,
                              -size         => [ 80, 24]               ,
                              -pos          => [225, 65]               ,
                              -number       => 1                       ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );
$winFilters->AddCombobox(     -name         => 'cbFiltersSizeUnit'     ,
                              -size         => [ 80, 22]               ,
                              -pos          => [310, 65]               ,
                              -font         => $font10                 ,
                              -dropdownlist => 1                       ,
                              -vscroll      => 1                       ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );
$winFilters->cbFiltersSizeUnit->Add($STR{'b'}, $STR{'Kb'}, $STR{'Mb'},$STR{'Gb'});
$winFilters->cbFiltersSizeUnit->SetCurSel(0);
$winFilters->AddLabel(        -name         => 'lblFilterItemList'     ,
                              -size         => [ 60, 22]               ,
                              -pos          => [  5, 95]               ,
                              -background   => [255, 255, 255]         ,
                              -text         => 'List:'                 ,
                              -font         => $font10                 ,
                              -visible      => 0                       ,
                              -disabled     => 1                       , );
$winFilters->AddTextfield(    -name         => 'tfFilterItemList'      ,
                              -size         => [280, 70]               ,
                              -pos          => [110, 95]               ,
                              -multiline    => 1                       ,
                              -wantreturn   => 1                       ,
                              -vscroll      => 1                       ,
                              -autohscroll  => 1                       ,
                              -visible      => 0                       ,
                              -disabled     => 1                       ,
                              -tabstop      => 1                       , );
$winFilters->tfFilterItemList->MaxLength(5000000);

# Filter: Last accessed
$winFilters->AddCombobox(     -name         => 'cbFiltersLastAccess'   ,
                              -size         => [110, 22]               ,
                              -pos          => [110, 65]               ,
                              -font         => $font10                 ,
                              -dropdownlist => 1                       ,
                              -vscroll      => 1                       ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );
$winFilters->cbFiltersLastAccess->Add($STR{'Before'}, $STR{'Equal'}    ,
                                      $STR{'After'}                    , );
$winFilters->cbFiltersLastAccess->SetCurSel(0);
$winFilters->AddDateTime(     -name         => 'dtFiltersLastAccess'   ,
                              -size         => [110, 24]               ,
                              -pos          => [225, 65]               ,
                              -font         => $font10                 ,
                              -background   => [255, 255, 255]         ,
                              -format       => "shortdate"             ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );

# Filter: Last modified
$winFilters->AddCombobox(     -name         => 'cbFiltersLastModif'    ,
                              -size         => [110, 22]               ,
                              -pos          => [110, 65]               ,
                              -font         => $font10                 ,
                              -dropdownlist => 1                       ,
                              -vscroll      => 1                       ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );
$winFilters->cbFiltersLastModif->Add($STR{'Before'}, $STR{'Equal'}     ,
                                     $STR{'After'}                     , );
$winFilters->cbFiltersLastModif->SetCurSel(0);
$winFilters->AddDateTime(     -name         => 'dtFiltersLastModif'    ,
                              -size         => [110, 24]               ,
                              -pos          => [225, 65]               ,
                              -font         => $font10                 ,
                              -background   => [255, 255, 255]         ,
                              -format       => "shortdate"             ,
                              -visible      => 0                       ,
                              -tabstop      => 1                       , );

$winFilters->AddButton(       -name         => 'btnFilterNotReady'     ,
                              -size         => [ 30, 30]               ,
                              -pos          => [ 85,180]               ,
                              -text         => '?'                     ,
                              -font         => $font10                 , );
$winFilters->AddButton(       -name         => 'btnFilterOk'           ,
                              -size         => [100, 30]               ,
                              -pos          => [130,180]               ,
                              -text         => $STR{'SetAddFilter'}    ,
                              -font         => $font10                 ,
                              -disabled     => 1                       , );
$winFilters->AddButton(       -name         => 'btnFilterCancel'       ,
                              -size         => [100, 30]               ,
                              -pos          => [245,180]               ,
                              -text         => $STR{'cancel'}          ,
                              -font         => $font10                 , );

#------------------------------------------------------------------------------#
# Rename - BySort Options window
#------------------------------------------------------------------------------#

my $winRenBySortOpt = Win32::GUI::Window->new(-name        => 'winRenBySortOpt'     ,
                                              -background  => [255, 255, 255]       ,
                                              -parent      => $win                  ,
                                              -text        => $STR{'Options'}       ,
                                              -pos         => [$winPosX, $winPosY]  ,
                                              -size        => [630, 310]            ,
                                              -hasmaximize => 0                     ,
                                              -hasminimize => 0                     ,
                                              -resizable   => 0                     ,
                                              -dialogui    => 1                     , );
$winRenBySortOpt->SetIcon($winICO);

$winRenBySortOpt->AddLabel(   -name         => 'lblLogo'             ,
                              -size         => [128,128]             ,
                              -pos          => [  0,  5]             ,
                              -bitmap       => $logo128Bmp           ,
                              -background   => [255, 255, 255]       , );
# Sort section
$winRenBySortOpt->AddLabel(   -name        => 'lblSortShadowT'       ,
                              -size        => [150, 25]              ,
                              -pos         => [151,  6]              ,
                              -foreground  => [180, 180, 180]        ,
                              -background  => [255, 255, 255]        ,
                              -text        => $STR{'sortOpt'}.':'    ,
                              -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(   -name        => 'lblSortT'             ,
                              -size        => [150, 25]              ,
                              -pos         => [150,  5]              ,
                              -addstyle    => 11                     , # Transparent
                              -foreground  => [250, 195,  27]        ,
                              -text        => $STR{'sortOpt'}.':'    ,
                              -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(   -name        => 'lblSortBy'            ,
                              -size        => [ 80, 20]              ,
                              -pos         => [150, 43]              ,
                              -font        => $font10                ,
                              -background  => [255, 255, 255]        , 
                              -text        => $STR{'sortBy'}.':'     , );
$winRenBySortOpt->AddCombobox(-name        => 'cbSortByType'         ,
                              -size        => [130,100]              ,
                              -pos         => [235, 40]              ,
                              -font        => $font10                ,
                              -dropdownlist => 1                     ,
                              -vscroll      => 1                     ,
                              -tabstop      => 1                     , );
$winRenBySortOpt->cbSortByType->Add($STR{'cbSortByAlpha'}            ,
                                    $STR{'rbFiltersSize'}            ,
                                    $STR{'rbFiltersLastAccess'}      ,
                                    $STR{'rbFiltersLastModif'}       ,);
$winRenBySortOpt->cbSortByType->SetCurSel(0);
$winRenBySortOpt->AddRadioButton( -name       => 'rbAsc'                  ,
                                  -size       => [100, 22]                ,
                                  -pos        => [390, 40]                ,
                                  -background => [255, 255, 255]          ,
                                  -text       => $STR{'Ascending'}        ,
                                  -font       => $font10                  ,
                                  -checked    => 1                        ,
                                  -group      => 1                        ,
                                  -tabstop    => 1                        , );
$winRenBySortOpt->AddRadioButton( -name       => 'rbDsc'                  ,
                                  -size       => [120, 22]                ,
                                  -pos        => [495, 40]                ,
                                  -background => [255, 255, 255]          ,
                                  -text       => $STR{'Descending'}       ,
                                  -font       => $font10                  ,
                                  -tabstop    => 1                        , );
# Rename section
$winRenBySortOpt->AddLabel(       -name        => 'lblRenameShadowT'     ,
                                  -size        => [200, 25]              ,
                                  -pos         => [151, 81]              ,
                                  -foreground  => [180, 180, 180]        ,
                                  -background  => [255, 255, 255]        ,
                                  -text        => $STR{'renameOpt'}.':'  ,
                                  -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(       -name        => 'lblRenameT'           ,
                                  -size        => [200, 25]              ,
                                  -pos         => [150, 80]              ,
                                  -addstyle    => 11                     , # Transparent
                                  -foreground  => [250, 195,  27]        ,
                                  -text        => $STR{'renameOpt'}.':'  ,
                                  -font        => $fontGB2               , );
$winRenBySortOpt->AddLabel(       -name        => 'lblIncrValType'       ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,118]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblIncrValType'}.':', );
$winRenBySortOpt->AddCombobox(    -name        => 'cbIncrValType'        ,
                                  -size        => [100, 40]              ,
                                  -pos         => [270,115]              ,
                                  -font        => $font10                ,
                                  -dropdownlist => 1                     ,
                                  -vscroll      => 1                     ,
                                  -tabstop      => 1                     , );
$winRenBySortOpt->cbIncrValType->Add('1,2,3,...'    , 'a-z,aa-zz,...'    ,
                                     'A-Z,AA-ZZ,...', '0-f,00-ff,...'    ,
                                     '0-F,00-FF,...', 'I,II,III IV,...'  , );
$winRenBySortOpt->cbIncrValType->SetCurSel(0);
$winRenBySortOpt->AddLabel(       -name        => 'lblLength'            ,
                                  -size        => [115, 20]              ,
                                  -pos         => [390,118]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblLength'}.':'  , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfLength'             ,
                                  -size        => [ 60, 24]              ,
                                  -pos         => [510,115]              ,
                                  -number      => 1                      ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddUpDown(      -name        => 'upDownLength'         ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->upDownLength->SetRange(1,32);
$winRenBySortOpt->upDownLength->SetPos(0);
$winRenBySortOpt->AddLabel(       -name        => 'lblInitVal'           ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,148]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblInitVal'}.':' , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfInitVal'            ,
                                  -size        => [ 60, 24]              ,
                                  -pos         => [270,145]              ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddUpDown(      -name        => 'upDownInitVal'        ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->upDownInitVal->SetRange(0,100);
$winRenBySortOpt->upDownInitVal->SetPos(1);
$winRenBySortOpt->AddLabel(       -name        => 'lblStepVal'           ,
                                  -size        => [115, 20]              ,
                                  -pos         => [390,148]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblStepVal'}.':' , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfStepVal'            ,
                                  -size        => [ 60, 24]              ,
                                  -pos         => [510,145]              ,
                                  -number      => 1                      ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddUpDown(      -name        => 'upDownStepVal'        ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->upDownStepVal->SetRange(1,100);
$winRenBySortOpt->upDownStepVal->SetPos(0);
$winRenBySortOpt->AddLabel(       -name        => 'lblPrefix'            ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,178]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblPrefix'}.':'  , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfPrefix'             ,
                                  -size        => [100, 24]              ,
                                  -pos         => [270,175]              ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddLabel(       -name        => 'lblSuffix'            ,
                                  -size        => [115, 20]              ,
                                  -pos         => [390,178]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblSuffix'}.':'  , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfSuffix'             ,
                                  -size        => [100, 24]              ,
                                  -pos         => [510,175]              ,
                                  -tabstop     => 1                      , );
$winRenBySortOpt->AddLabel(       -name        => 'lblExample'           ,
                                  -size        => [115, 20]              ,
                                  -pos         => [150,213]              ,
                                  -font        => $font10                ,
                                  -background  => [255, 255, 255]        , 
                                  -text        => $STR{'lblExample'}.':' , );
$winRenBySortOpt->AddTextfield(   -name        => 'tfExample'            ,
                                  -size        => [275, 24]              ,
                                  -pos         => [270,210]              ,
                                  -readonly    => 1                      , );
$winRenBySortOpt->AddButton(      -name        => 'btnWinRenBySortOptOk' ,
                                  -pos         => [340,245]              ,
                                  -size        => [ 50, 30]              ,
                                  -text        => $STR{'Ok'}             ,
                                  -font        => $font10                ,
                                  -disabled    => 1                      ,
                                  -tabstop     => 1                      ,  
                                  -ok          => 1                      ,
                                  -default     => 1                      , );

#------------------------------------------------------------------------------#
# Hash values options window
#------------------------------------------------------------------------------#

my $winHashVal = Win32::GUI::Window->new( -name        => 'winHashVal'           ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'chListFilesOptHV'},
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [220, 120]             ,
                                          -hasmaximize => 0                      ,
                                          -hasminimize => 0                      ,
                                          -resizable   => 0                      ,
                                          -dialogui    => 1                      , );
$winHashVal->SetIcon($winICO);

$winHashVal->AddCheckbox( -name         => 'chListFilesHV1'       , # MD5
                          -size         => [ 90, 22]              ,
                          -pos          => [  5,  5]              ,
                          -text         => $STR{'chListFilesHV1'} ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddCheckbox( -name         => 'chListFilesHV2'       , # SHA1
                          -size         => [ 90, 22]              ,
                          -pos          => [  5, 30]              ,
                          -text         => $STR{'chListFilesHV2'},
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddCheckbox( -name         => 'chListFilesHV3'       , # SHA256
                          -size         => [100, 22]              ,
                          -pos          => [100,  5]              ,
                          -text         => $STR{'chListFilesHV3'} ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddCheckbox( -name         => 'chListFilesHV4'       , # SHA512
                          -size         => [100, 22]              ,
                          -pos          => [100, 30]              ,
                          -text         => $STR{'chListFilesHV4'} ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddButton(   -name         => 'btnHashValuesOk'      ,
                          -text         => $STR{'Ok'}             ,
                          -size         => [ 60, 25]              ,
                          -pos          => [ 80, 60]              ,
                          -ok           => 1                      ,
                          -default      => 1                      , );

#------------------------------------------------------------------------------#
# File details options window
#------------------------------------------------------------------------------#

my $winFileDetails = Win32::GUI::Window->new( -name        => 'winFileDetails'       ,
                                              -background  => [255, 255, 255]        ,
                                              -parent      => $win                   ,
                                              -text        => $STR{'chListFilesOptFD'},
                                              -pos         => [$winPosX, $winPosY]   ,
                                              -size        => [200, 145]             ,
                                              -hasmaximize => 0                      ,
                                              -hasminimize => 0                      ,
                                              -resizable   => 0                      ,
                                              -dialogui    => 1                      , );
$winFileDetails->SetIcon($winICO);

$winFileDetails->AddCheckbox( -name         => 'chListFilesFD1'       , # File size
                              -size         => [180, 22]              ,
                              -pos          => [  5,  5]              ,
                              -text         => $STR{'rbFiltersSize'}  ,
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winFileDetails->AddCheckbox( -name         => 'chListFilesFD2'       , # Last accessed
                              -size         => [180, 22]              ,
                              -pos          => [  5, 30]              ,
                              -text         => $STR{'rbFiltersLastAccess'},
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winFileDetails->AddCheckbox( -name         => 'chListFilesFD3'       , # Last modified
                              -size         => [180, 22]              ,
                              -pos          => [  5, 55]              ,
                              -text         => $STR{'rbFiltersLastModif'},
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winFileDetails->AddButton(   -name         => 'btnFileDetailsOk'     ,
                              -text         => $STR{'Ok'}             ,
                              -size         => [ 60, 25]              ,
                              -pos          => [ 70, 85]              ,
                              -ok           => 1                      ,
                              -default      => 1                      , );

#------------------------------------------------------------------------------#
# Preview window
#------------------------------------------------------------------------------#

my $winPreview = Win32::GUI::Window->new( -name        => 'winPreview'           ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'winPreview'}     ,
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [$winWidth, $winHeight],
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      ,
                                          -dialogui    => 1                      , );
$winPreview->SetIcon($winICO);

my $imageList = new Win32::GUI::ImageList(16, 16, 1|0x0010, 5, 5);
$imageList->Add($folderClosedBmp, 0);
$imageList->Add($folderOpenedBmp, 0);
$imageList->Add($fileBmp        , 0);
$imageList->Add($delFileBmp     , 0);
$imageList->Add($warnFileBmp    , 0);

$winPreview->AddLabel(                    -name        => 'lblBeforeShadowT',
                                          -size        => [100, 22]         ,
                                          -pos         => [  6,  6]         ,
                                          -font        => $fontGB2          ,
                                          -foreground  => [180, 180, 180]   ,
                                          -background  => [255, 255, 255]   ,
                                          -text        => $STR{'Before'}.':', );
$winPreview->AddLabel(                    -name        => 'lblBeforeT'      ,
                                          -size        => [100, 22]         ,
                                          -pos         => [  5,  5]         ,
                                          -font        => $fontGB2          ,
                                          -addstyle    => 11                , # Transparent
                                          -foreground  => [250, 195,  27]   ,
                                          -text        => $STR{'Before'}.':', );
$winPreview->AddLabel(                    -name        => 'lblRootBefore'   ,
                                          -size        => [ 55, 20]         ,
                                          -pos         => [ 10, 38]         ,
                                          -font        => $font10           ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'Root'}.':'  , );
$winPreview->AddTextfield(                -name        => 'tfRootBefore'    ,
                                          -size        => [240, 22]         ,
                                          -pos         => [ 70, 35]         ,
                                          -readonly    => 1                 , );
$winPreview->AddTreeView(                 -name        => 'tvBefore'        ,
                                          -size        => [305,330]         ,
                                          -pos         => [  5, 60]         ,
                                          -background  => [255, 255, 255]   ,
                                          -rootlines   => 1                 ,
                                          -lines       => 1                 ,
                                          -buttons     => 1                 ,
                                          -imagelist   => $imageList        , );
$winPreview->AddLabel(                    -name        => 'lblAfterShadowT' ,
                                          -size        => [100, 22]         ,
                                          -pos         => [316,  6]         ,
                                          -font        => $fontGB2          ,
                                          -foreground  => [180, 180, 180]   ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'After'}.':' , );
$winPreview->AddLabel(                    -name        => 'lblAfterT'       ,
                                          -size        => [100, 22]         ,
                                          -pos         => [315,  5]         ,
                                          -font        => $fontGB2          ,
                                          -addstyle    => 11                , # Transparent
                                          -foreground  => [250, 195,  27]   ,
                                          -text        => $STR{'After'}.':' , );
$winPreview->AddLabel(                    -name        => 'lblRootAfter'    ,
                                          -size        => [ 55, 20]         ,
                                          -pos         => [315, 38]         ,
                                          -font        => $font10           ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'Root'}.':'  , );
$winPreview->AddTextfield(                -name        => 'tfRootAfter'     ,
                                          -size        => [240, 22]         ,
                                          -pos         => [380, 35]         ,
                                          -readonly    => 1                 , );
$winPreview->AddTreeView(                 -name        => 'tvAfter'         ,
                                          -size        => [305,330]         ,
                                          -pos         => [315, 60]         ,
                                          -background  => [255, 255, 255]   ,
                                          -rootlines   => 1                 ,
                                          -lines       => 1                 ,
                                          -buttons     => 1                 ,
                                          -imagelist   => $imageList        , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -parent      => $win                    ,
                                            -text        => $STR{'winConfig'}       ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [600, 270]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);

$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $config128Bmp         ,
                          -background   => [255, 255, 255]       , );

# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'      ,
                                    -size         => [455,235]        ,
                                    -pos          => [140,  5]        ,
                                    -fixedwidth   => 1                ,
                                    -tabstop      => 1                ,
                                    -background   => [255, 255, 255]  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'general'}  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'logging'}  , );

# General tab

# Tool Section
$winConfig->AddLabel(       -name        => 'lblToolShadowT'        ,
                            -size        => [ 80, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB2                , );
$winConfig->AddLabel(       -name        => 'lblToolT'              ,
                            -size        => [ 80, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [250, 195,  27]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB2                , );
$winConfig->AddButton(      -name        => 'btnExportLang'         ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 68]               ,
                            -text        => $STR{'Export'}.'Lang.ini',
                            -font        => $font10                 , );
$winConfig->AddButton(      -name        => 'btnCheckUpdate'        ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 98]               ,
                            -text        => $STR{'checkUpdate'}     ,
                            -font        => $font10                 , );
$winConfig->AddCheckbox(    -name        => 'chAutoUpdate'          ,
                            -size        => [250, 20]               ,
                            -pos         => [285,100]               ,
                            -text        => $STR{'AutoUpdateTip'}   ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font10                 ,
                            -tabstop     => 1                       ,
                            -checked     => 1                       , );
# Functions section
$winConfig->AddLabel(       -name        => 'lblFuncShadowT'        ,
                            -size        => [350, 22]               ,
                            -pos         => [151,136]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'lblFuncT'}.':'    ,
                            -font        => $fontGB2                , );
$winConfig->AddLabel(       -name        => 'lblFuncT'              ,
                            -size        => [350, 22]               ,
                            -pos         => [150,135]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [250, 195,  27]         ,
                            -text        => $STR{'lblFuncT'}.':'    ,
                            -font        => $fontGB2                , );
$winConfig->AddCheckbox(    -name        => 'chHashLowercase'       ,
                            -size        => [350, 20]               ,
                            -pos         => [150,170]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chHashLowercase'} ,
                            -font        => $font10                 ,
                            -tabstop     => 1                       , );

# Logging tab
$winConfig->AddCheckbox(    -name        => 'chEnableLogging'       ,
                            -size        => [200, 20]               ,
                            -pos         => [150, 40]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chEnableLogging'} ,
                            -font        => $font10                 ,
                            -checked     => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddButton(      -name        => 'btnOpenLog'            ,
                            -size        => [150, 24]               ,
                            -pos         => [400, 38]               ,
                            -text        => $STR{'OpenLog'}         ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbUseDefaultDir'       ,
                            -size        => [150, 20]               ,
                            -pos         => [150, 70]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'rbUseDefaultDir'} ,
                            -font        => $font10                 ,
                            -group       => 1                       ,
                            -checked     => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbLoggingDir'          ,
                            -size        => [245, 20]               ,
                            -pos         => [150, 95]               ,
                            -font        => $font10                 ,
                            -background  => [255, 255, 255]         , 
                            -text        => $STR{'rbLoggingDir'}.':',
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfLoggingDir'          ,
                            -size        => [400, 22]               ,
                            -pos         => [150,120]               ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddButton(      -name        => 'btnLoggingDir'         ,
                            -size        => [ 22, 22]               ,
                            -pos         => [552,120]               ,
                            -bitmap      => $openDirBmp             ,
                            -disabled    => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddCheckbox(    -name        => 'chUseDestDirCM'        ,
                            -size        => [300, 20]               ,
                            -pos         => [150,150]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chUseDestDirCM'}  ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'                   ,
                                        -parent      => $winPreview               ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]      ,
                                        -size        => [600, 170]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);

$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [460, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#

if (-T $CONFIG_FILE) {
  &loadConfig(\%CONFIG);
  
  if ($CONFIG{'TOOL_AUTO_UPDATE'}) { $THR_UPDATE = threads->create(sub { &updateTool(0); }); }
  
  # Set input (objects sent)
  if ($$REF_ARG[0]) {
    if (!$$REF_ARG[1]) {
      if    (-d $$REF_ARG[0]) {             # A folder
        $win->tfInput->Text($$REF_ARG[0]);
        $win->rbInputDir->Checked(1);
        $win->rbInputFiles->Checked(0);
        &rbInputDir_Click();
      } else {                              # Single file
        $win->tfInput->Text($$REF_ARG[0]);
        $win->rbInputDir->Checked(0);
        $win->rbInputFiles->Checked(1);
        &rbInputFiles_Click();
      }
    } else {                                # Multiple files
      my $argStr;
      my @path = split(/\\/, $$REF_ARG[1]);
      pop(@path);
      $argStr = '"'.join("\\", @path).'" ';
      foreach my $file (@$REF_ARG) { $argStr .= '"'.(split(/\\/, $file))[-1].'" '; }
      chop($argStr);
      $win->tfInput->Text($argStr);
      $win->rbInputDir->Checked(0);
      $win->rbInputFiles->Checked(1);
      &rbInputFiles_Click();
    }
  }
  
  # Set Filter grid header
  $win->gridFilter->SetCellText(0, 0, $STR{'Operator'} );
  $win->gridFilter->SetCellText(0, 1, $STR{'Type'}     );
  $win->gridFilter->SetCellText(0, 2, $STR{'TypeOp'}   );
  $win->gridFilter->SetCellText(0, 3, $STR{'flags'}    );
  $win->gridFilter->SetCellText(0, 4, $STR{'searchStr'});
}

$START = 1;
$win->Show();
Win32::GUI::Dialog();


#--------------------------#
sub winMain_Resize
#--------------------------#
{
  # Header
  $win->lblHeader->Width($win->ScaleWidth()-300);
  # Input section
  $win->lblInputT->Width($win->ScaleWidth());
  $win->tfInput->Width($win->ScaleWidth()-174);
  $win->btnInput->Left($win->ScaleWidth()-167);
  $win->chInputDirRecurse->Left($win->ScaleWidth()-142);
  # Filters section
  $win->lblFiltersT->Width($win->ScaleWidth());
  $win->gridFilter->Width($win->ScaleWidth()-78);
  $win->gridFilter->Height($win->ScaleHeight()-400);
  $win->gridFilter->AutoSizeColumns();
  $win->gridFilter->ExpandLastColumn();
  $win->gridFilter->Refresh();
  $win->btnFilterSet->Left($win->ScaleWidth()-71);
  $win->btnFilterAdd->Left($win->ScaleWidth()-48);
  $win->btnFilterDel->Left($win->ScaleWidth()-25);
  # Functions section
  $win->lblFunctionsT->Width($win->ScaleWidth());
  $win->lblFunctionsT->Top($win->ScaleHeight()-205);
  $win->TabFunctions->Width($win->ScaleWidth()+3);
  $win->TabFunctions->Height($win->ScaleHeight()-200);
  $win->TabFunctions->Top($win->ScaleHeight()-180);
  $win->rbListFiles->Top($win->ScaleHeight()-145);
  $win->chListFilesOptFP->Top($win->ScaleHeight()-145);
  $win->chListFilesOptFN->Top($win->ScaleHeight()-120);
  $win->chListFilesOptHV->Top($win->ScaleHeight()-145);
  $win->chListFilesOptFD->Top($win->ScaleHeight()-120);
  $win->chListFilesOptNbrL->Top($win->ScaleHeight()-145);
  $win->chListFilesOptNH->Top($win->ScaleHeight()-145);
  $win->chListFilesOptNF->Top($win->ScaleHeight()-120);
  $win->rbListExt->Top($win->ScaleHeight()-120);
  $win->lblReportDir->Top($win->ScaleHeight()-82);
  $win->tfReportDir->Top($win->ScaleHeight()-85);
  $win->tfReportDir->Width($win->ScaleWidth()-396);
  $win->cbReportFormat->Top($win->ScaleHeight()-85);
  $win->cbReportFormat->Left($win->ScaleWidth()-302);
  $win->btnReportDir->Top($win->ScaleHeight()-85);
  $win->btnReportDir->Left($win->ScaleWidth()-240);
  $win->btnOpenReportDir->Top($win->ScaleHeight()-85);
  $win->btnOpenReportDir->Left($win->ScaleWidth()-217);
  $win->chOpenReport->Top($win->ScaleHeight()-85);
  $win->chOpenReport->Left($win->ScaleWidth()-190);
  # Copy/move tab
  $win->rbCopy->Top($win->ScaleHeight()-145);
  $win->rbMove->Top($win->ScaleHeight()-120);
  $win->chCopyTree->Top($win->ScaleHeight()-145);
  $win->chCopyRemDouble->Top($win->ScaleHeight()-120);
  $win->lblDestination->Top($win->ScaleHeight()-82);
  $win->tfDestinationDir->Top($win->ScaleHeight()-85);
  $win->tfDestinationDir->Width($win->ScaleWidth()-309);
  $win->btnDestinationDir->Top($win->ScaleHeight()-85);
  $win->btnDestinationDir->Left($win->ScaleWidth()-217);
  $win->chOpenDstDir->Top($win->ScaleHeight()-85);
  $win->chOpenDstDir->Left($win->ScaleWidth()-190);
  # Rename tab
  $win->rbRenByHash->Top($win->ScaleHeight()-145);
  $win->cbRenByHash->Top($win->ScaleHeight()-145);
  $win->rbRenSort->Top($win->ScaleHeight()-145);
  $win->rbRenSort->Left($win->ScaleWidth()/2);
  $win->btnRenSort->Top($win->ScaleHeight()-145);
  $win->btnRenSort->Left($win->ScaleWidth()/2+115);
  $win->rbRenReplace->Top($win->ScaleHeight()-115);
  $win->lblRenReplaceOk->Top($win->ScaleHeight()-116);
  $win->lblRenReplaceErr->Top($win->ScaleHeight()-116);
  $win->lblRenReplaceWarn->Top($win->ScaleHeight()-116);
  $win->tfRenReplace->Top($win->ScaleHeight()-115);
  $win->lblRenReplaceOk->Width($win->ScaleWidth()/2-73);
  $win->lblRenReplaceErr->Width($win->ScaleWidth()/2-73);
  $win->lblRenReplaceWarn->Width($win->ScaleWidth()/2-73);
  $win->tfRenReplace->Width($win->ScaleWidth()/2-75);
  $win->chRenReplaceRegex->Top($win->ScaleHeight()-90);
  $win->chRenReplaceCase->Top($win->ScaleHeight()-90);
  $win->chRenReplaceFolder->Top($win->ScaleHeight()-90);
  $win->lblRenReplaceBy->Top($win->ScaleHeight()-115);
  $win->lblRenReplaceByOk->Top($win->ScaleHeight()-116);
  $win->lblRenReplaceByErr->Top($win->ScaleHeight()-116);
  $win->lblRenReplaceByWarn->Top($win->ScaleHeight()-116);
  $win->tfRenReplaceBy->Top($win->ScaleHeight()-115);
  $win->lblRenReplaceBy->Left($win->ScaleWidth()/2+70);
  $win->tfRenReplaceBy->Left($win->ScaleWidth()/2+115);
  $win->tfRenReplaceBy->Width($win->ScaleWidth()/2-135);
  $win->lblRenReplaceByOk->Width($win->ScaleWidth()/2-133);
  $win->lblRenReplaceByErr->Width($win->ScaleWidth()/2-133);
  $win->lblRenReplaceByWarn->Width($win->ScaleWidth()/2-133);
  $win->lblRenReplaceByOk->Left($win->ScaleWidth()/2+114);
  $win->lblRenReplaceByErr->Left($win->ScaleWidth()/2+114);
  $win->lblRenReplaceByWarn->Left($win->ScaleWidth()/2+114);
  $win->chRenReplaceByEval->Top($win->ScaleHeight()-90);
  $win->chRenReplaceByEval->Left($win->ScaleWidth()/2+115);
  # Footer
  $win->lblFooter->Top($win->ScaleHeight()-55);
  $win->lblFooter->Width($win->ScaleWidth());
  $win->lblNotReady->Top($win->ScaleHeight()-40);
  $win->lblPbCurr->Top($win->ScaleHeight()-48);
  $win->lblPbCurr->Width($win->ScaleWidth()-240);
  $win->pb->Top($win->ScaleHeight()-27);
  $win->pb->Width($win->ScaleWidth()-330);
  $win->lblPbCount->Top($win->ScaleHeight()-25);
  $win->lblPbCount->Left($win->ScaleWidth()-315);
  $win->btnProcess->Move($win->ScaleWidth()-225, $win->ScaleHeight()-45);
  $win->btnStop->Move($win->ScaleWidth()-225, $win->ScaleHeight()-45);
  $win->btnPreview->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnWinConfig->Move($win->ScaleWidth()-135, $win->ScaleHeight()-45);
  $win->btnHelp->Move($win->ScaleWidth()-90, $win->ScaleHeight()-45);
  $win->btnAbout->Move($win->ScaleWidth()-45, $win->ScaleHeight()-45);
  
}  #--- End winMain_Resize

#--------------------------#
sub rbInputDir_Click
#--------------------------#
{
  # Enable InputDir options
  $win->chInputDirRecurse->Enable();
  
  # Enable filters
  $win->btnFilterSet->Enable();

}  #--- End rbInputDir_Click

#--------------------------#
sub tfInput_Change
#--------------------------#
{
  &isProcessReady(0);

}  #--- End tfInput_Change

#--------------------------#
sub btnInput_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfInput->Text();
  my $dir;

  if ($win->rbInputDir->Checked()) {
    # Show dialog window
    if ($lastDir) {
      my(@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) {
        while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
      }
      $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                          -title      => $STR{'selDir'}.':',
                                          -folderonly => 1                 ,
                                          -directory  => $lastDir          ,);
    } else {
      $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                          -title      => $STR{'selDir'}.':',
                                          -folderonly => 1                 , );
    }
  
    # Selected folder
    if ($dir and -d $dir) {
      if ($dir =~ /\\$/) { chop($dir); }
      $win->tfInput->Text($dir);
    }
  } else {
    my @filesStr;
  
    # Show OpenFile dialog window
    if ($lastDir and !-d $lastDir) {
      # Multiple files
      if ($lastDir =~ /" "/) { $lastDir = (split(/" "/, $lastDir))[0]; }
      # Single file
      my @parts = split(/ /, $lastDir);
      if (pop(@parts) =~ /\./) {
        while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
      }
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -directory     => $lastDir             ,
                                                -explorer      => 1                    , );
    } elsif (-d $lastDir) {
      my(@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) {
        while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
      }
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -directory     => $lastDir             ,
                                                -explorer      => 1                    , );
    } else {
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -explorer      => 1                    , );
    }
  
    # Selected file
    if ($filesStr[0] and scalar(@filesStr) > 0) {
      # Single file
      if ($filesStr[0] and scalar(@filesStr) == 1) { $win->tfInput->Text($filesStr[0]); }
      # Multiple files
      else {
        my $filesStr;
        foreach my $file (@filesStr) { $filesStr .= "\"$file\" "; }
        chop($filesStr);
        $win->tfInput->Text($filesStr);
      }
    }
  }
  
  &isProcessReady(0);
  
}  #--- End btnInputDir_Click

#--------------------------#
sub rbInputFiles_Click
#--------------------------#
{
  # Enable InputFiles options
  $win->chInputDirRecurse->Disable();
  
  # Disable filters
  $win->btnFilterSet->Disable();

}  #--- End rbInputFiles_Click

#--------------------------#
sub btnFilterSet_Click
#--------------------------#
{
  # Reset Filter window controls
  $winFilters->cbFiltersOp->SetCurSel(0);
  $winFilters->cbFiltersOp->Disable();
  $winFilters->cbFiltersType->SetCurSel(0);
  &cbFiltersType_Change();
  $winFilters->lblFiltersContainOk->Hide();
  $winFilters->lblFiltersContainErr->Hide();
  $winFilters->lblFiltersContainWarn->Hide();
  $winFilters->chFiltersContainsCase->Checked(0);
  $winFilters->chFiltersContainsRegex->Checked(0);
  $winFilters->chFiltersContainsFileOnly->Checked(0);
  $winFilters->tfFiltersContains->Text('');
  &OnlyFoldersOff();
    
  $winFilters->Center($win);
  $winFilters->Show();
  $win->Disable();

}  #--- End btnFilterSet_Click

#--------------------------#
sub btnFilterAdd_Click
#--------------------------#
{
  # Reset Filter window controls
  $winFilters->cbFiltersOp->SetCurSel(0);
  $winFilters->cbFiltersOp->Enable();
  $winFilters->cbFiltersType->SetCurSel(0);
  &cbFiltersType_Change();
  $winFilters->chFiltersContainsCase->Checked(0);
  $winFilters->chFiltersContainsRegex->Checked(0);
  $winFilters->chFiltersContainsFileOnly->Checked(0);
  $winFilters->tfFiltersContains->Text('');
  
  $winFilters->Center($win);
  $winFilters->Show();
  $win->Disable();

}  #--- End btnFilterAdd_Click

#--------------------------#
sub cbFiltersType_Change
#--------------------------#
{
  # Local variables
  my $type = $winFilters->cbFiltersType->GetCurSel();
  
  # Contains
  if ($type == 0) {
    $winFilters->chFiltersContainsCase->Show();
    $winFilters->chFiltersContainsRegex->Show();
    $winFilters->chFiltersContainsFileOnly->Show();
    $winFilters->tfFiltersContains->Show();
    $winFilters->btnFilterOk->Disable();
    
    # Hide File size options
    $winFilters->cbFiltersSizeOp->Hide();
    $winFilters->tfFiltersSize->Hide();
    $winFilters->cbFiltersSizeUnit->Hide();
    $winFilters->lblFilterItemList->Hide();
    $winFilters->tfFilterItemList->Hide();
    
    # Hide Last accessed options
    $winFilters->cbFiltersLastAccess->Hide();
    $winFilters->dtFiltersLastAccess->Hide();
    
    # Hide Last modified options
    $winFilters->cbFiltersLastModif->Hide();
    $winFilters->dtFiltersLastModif->Hide();
    
  # File size
  } elsif ($type == 1) {
    $winFilters->cbFiltersSizeOp->Show();
    $winFilters->tfFiltersSize->Show();
    $winFilters->cbFiltersSizeUnit->Show();
    $winFilters->lblFilterItemList->Show();
    $winFilters->tfFilterItemList->Show();
    $winFilters->btnFilterOk->Disable();
    
    # Hide Contains options
    $winFilters->chFiltersContainsCase->Hide();
    $winFilters->chFiltersContainsRegex->Hide();
    $winFilters->chFiltersContainsFileOnly->Hide();
    $winFilters->lblFiltersContainOk->Hide();
    $winFilters->lblFiltersContainErr->Hide();
    $winFilters->lblFiltersContainWarn->Hide();
    $winFilters->tfFiltersContains->Hide();
    
    # Hide Last accessed options
    $winFilters->cbFiltersLastAccess->Hide();
    $winFilters->dtFiltersLastAccess->Hide();
    
    # Hide Last modified options
    $winFilters->cbFiltersLastModif->Hide();
    $winFilters->dtFiltersLastModif->Hide();
    
  # Last accessed
  } elsif ($type == 2) {
    $winFilters->cbFiltersLastAccess->Show();
    $winFilters->dtFiltersLastAccess->Show();
    $winFilters->lblFilterItemList->Show();
    $winFilters->tfFilterItemList->Show();
    $winFilters->btnFilterOk->Enable();
    
    # Hide Contains options
    $winFilters->chFiltersContainsCase->Hide();
    $winFilters->chFiltersContainsRegex->Hide();
    $winFilters->chFiltersContainsFileOnly->Hide();
    $winFilters->lblFiltersContainOk->Hide();
    $winFilters->lblFiltersContainErr->Hide();
    $winFilters->lblFiltersContainWarn->Hide();
    $winFilters->tfFiltersContains->Hide();
    
    # Hide File size options
    $winFilters->cbFiltersSizeOp->Hide();
    $winFilters->tfFiltersSize->Hide();
    $winFilters->cbFiltersSizeUnit->Hide();
    
    # Hide Last modified options
    $winFilters->cbFiltersLastModif->Hide();
    $winFilters->dtFiltersLastModif->Hide();
    
  # Last modified
  } elsif ($type == 3) {
    $winFilters->cbFiltersLastModif->Show();
    $winFilters->dtFiltersLastModif->Show();
    $winFilters->lblFilterItemList->Show();
    $winFilters->tfFilterItemList->Show();
    $winFilters->btnFilterOk->Enable();
    
    # Hide Contains options
    $winFilters->chFiltersContainsCase->Hide();
    $winFilters->chFiltersContainsRegex->Hide();
    $winFilters->chFiltersContainsFileOnly->Hide();
    $winFilters->lblFiltersContainOk->Hide();
    $winFilters->lblFiltersContainErr->Hide();
    $winFilters->lblFiltersContainWarn->Hide();
    $winFilters->tfFiltersContains->Hide();
    
    # Hide File size options
    $winFilters->cbFiltersSizeOp->Hide();
    $winFilters->tfFiltersSize->Hide();
    $winFilters->cbFiltersSizeUnit->Hide();
    
    # Hide Last accessed options
    $winFilters->cbFiltersLastAccess->Hide();
    $winFilters->dtFiltersLastAccess->Hide();
    
  # Only Folders
  } else {
    $winFilters->btnFilterOk->Enable();
    
    # Hide Contains options
    $winFilters->chFiltersContainsCase->Hide();
    $winFilters->chFiltersContainsRegex->Hide();
    $winFilters->chFiltersContainsFileOnly->Hide();
    $winFilters->lblFiltersContainOk->Hide();
    $winFilters->lblFiltersContainErr->Hide();
    $winFilters->lblFiltersContainWarn->Hide();
    $winFilters->tfFiltersContains->Hide();
    
    # Hide File size options
    $winFilters->cbFiltersSizeOp->Hide();
    $winFilters->tfFiltersSize->Hide();
    $winFilters->cbFiltersSizeUnit->Hide();
    $winFilters->lblFilterItemList->Hide();
    $winFilters->tfFilterItemList->Hide();
    
    # Hide Last accessed options
    $winFilters->cbFiltersLastAccess->Hide();
    $winFilters->dtFiltersLastAccess->Hide();
    
    # Hide Last modified options
    $winFilters->cbFiltersLastModif->Hide();
    $winFilters->dtFiltersLastModif->Hide();
  }
  
  &isFilterReady(0);

}  #--- End cbFiltersType_Change

#--------------------------#
sub chFiltersContainsRegex_Click
#--------------------------#
{
  &isFilterReady(0);

}  #--- End chFiltersContainsRegex_Click

#--------------------------#
sub tfFiltersContains_Change
#--------------------------#
{
  &isFilterReady(0);

}  #--- End tfFiltersContains_Change

#--------------------------#
sub cbFiltersSizeOp_Change
#--------------------------#
{
  # Local variables
  my $op = $winFilters->cbFiltersSizeOp->GetCurSel();
  
  if ($op == 1) { # Equal
    $winFilters->lblFilterItemList->Enable();
    $winFilters->tfFilterItemList->Enable();
  } else {
    $winFilters->lblFilterItemList->Disable();
    $winFilters->tfFilterItemList->Disable();
  }

}  #--- End cbFiltersSizeOp_Change

#--------------------------#
sub tfFiltersSize_Change
#--------------------------#
{
  &isFilterReady(0);

}  #--- End tfFiltersSize_Change

#--------------------------#
sub tfFilterItemList_Change
#--------------------------#
{
  &isFilterReady(0);

}  #--- End tfFilterItemList_Change

#--------------------------#
sub cbFiltersLastAccess_Change
#--------------------------#
{
  # Local variables
  my $op = $winFilters->cbFiltersLastAccess->GetCurSel();
  
  if ($op == 1) { # Equal
    $winFilters->lblFilterItemList->Enable();
    $winFilters->tfFilterItemList->Enable();
  } else {
    $winFilters->lblFilterItemList->Disable();
    $winFilters->tfFilterItemList->Disable();
  }
  
  &isFilterReady(0);

}  #--- End cbFiltersLastAccess_Change

#--------------------------#
sub dtFiltersLastAccess_Change
#--------------------------#
{
  &isFilterReady(0);

}  #--- End dtFiltersLastAccess_Change

#--------------------------#
sub cbFiltersLastModif_Change
#--------------------------#
{
  # Local variables
  my $op = $winFilters->cbFiltersLastModif->GetCurSel();
  
  if ($op == 1) { # Equal
    $winFilters->lblFilterItemList->Enable();
    $winFilters->tfFilterItemList->Enable();
  } else {
    $winFilters->lblFilterItemList->Disable();
    $winFilters->tfFilterItemList->Disable();
  }
  
  &isFilterReady(0);

}  #--- End cbFiltersLastModif_Change

#--------------------------#
sub dtFiltersLastModif_Change
#--------------------------#
{
  &isFilterReady(0);

}  #--- End dtFiltersLastModif_Change

#--------------------------#
sub isFilterReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $type = $winFilters->cbFiltersType->GetCurSel();
  my $nextStep;
  
  # Contains
  if      ($type == 0) {
    my $regexStr = $winFilters->tfFiltersContains->Text();
    if ($regexStr) {
      if ($winFilters->chFiltersContainsRegex->Checked()) {
        my ($statusRegex, $msg);
        my $nbrLines = $winFilters->tfFiltersContains->GetLineCount();
        if ($nbrLines == 1) { ($statusRegex, $msg) = &validRegex($regexStr); }
        else {
          my $i = 0;
          while ($i <= $nbrLines) {
            if (my $line = $winFilters->tfFiltersContains->GetLine($i)) {
              ($statusRegex, $msg) = &validRegex($line);
              if ($statusRegex == 1) { last; }
            }
            $i++;
          }
        }
        
        # Warning
        if      ($statusRegex == 2) {
          $winFilters->lblFiltersContainWarn->Show();
          $winFilters->lblFiltersContainOk->Hide();
          $winFilters->lblFiltersContainErr->Hide();
        # Error
        } elsif ($statusRegex == 1) {
          $winFilters->lblFiltersContainErr->Show();
          $winFilters->lblFiltersContainOk->Hide();
          $winFilters->lblFiltersContainWarn->Hide();
          $nextStep = $STR{'errRegex'};
        # Ok
        } else {
          $winFilters->lblFiltersContainOk->Show();
          $winFilters->lblFiltersContainErr->Hide();
          $winFilters->lblFiltersContainWarn->Hide();
        }
      }
    } else {
      $winFilters->lblFiltersContainOk->Hide();
      $winFilters->lblFiltersContainErr->Hide();
      $winFilters->lblFiltersContainWarn->Hide();
      $nextStep = $STR{'setContains'};
    }

  # File size
  } elsif ($type == 1) {
    my $op = $winFilters->cbFiltersSizeOp->GetCurSel();
    if (($op == 1 and !$winFilters->tfFiltersSize->Text() and !$winFilters->tfFilterItemList->Text()) or
        ($op != 1 and !$winFilters->tfFiltersSize->Text())) {
      $nextStep = $STR{'setFileSize'};
    } elsif ($op == 1 and $winFilters->tfFilterItemList->Text()) { # Equal with a list of size
      my $nbrLines = $winFilters->tfFilterItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winFilters->tfFilterItemList->GetLine($i)) {
          if ($line !~ /^\d+$/) {
            $nextStep = $STR{'setFileSize'};
            last;
          }
        }
        $i++;
      }
    }
    
  # Last accessed
  } elsif ($type == 2) {
    my $op = $winFilters->cbFiltersLastAccess->GetCurSel();
    if ($op == 1 and $winFilters->tfFilterItemList->Text()) { # Equal with a list of date
      my $nbrLines = $winFilters->tfFilterItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winFilters->tfFilterItemList->GetLine($i)) {
          if ($line !~ /^\d{4}\-\d{2}\-\d{2}/) {
            $nextStep = $STR{'setDate'};
            last;
          }
        }
        $i++;
      }
    }
    
  # Last modified
  } elsif ($type == 3) {
    my $op = $winFilters->cbFiltersLastModif->GetCurSel();
    if ($op == 1 and $winFilters->tfFilterItemList->Text()) { # Equal with a list of date
      my $nbrLines = $winFilters->tfFilterItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winFilters->tfFilterItemList->GetLine($i)) {
          if ($line !~ /^\d{4}\-\d{2}\-\d{2}/) {
            $nextStep = $STR{'setDate'};
            last;
          }
        }
        $i++;
      }
    }
  }
  
  # Return an error message or enable the button
  if ($nextStep) {
    $winFilters->btnFilterOk->Disable();
    $winFilters->btnFilterNotReady->Enable();
    if ($confirm) {
      Win32::GUI::MessageBox($winFilters, "$STR{'notReady'} ?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040);
    }
  } else {
    $winFilters->btnFilterOk->Enable();
    $winFilters->btnFilterNotReady->Disable();
  }
  
}  #--- End isFilterReady

#--------------------------#
sub btnFilterNotReady_Click
#--------------------------#
{
  &isFilterReady(1);

}  #--- End btnFilterNotReady_Click


#--------------------------#
sub btnFilterCancel_Click
#--------------------------#
{
  &winFilters_Terminate();

}  #--- End btnFilterCancel_Click

#--------------------------#
sub winFilters_Terminate
#--------------------------#
{
  $winFilters->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winFilters_Terminate

#--------------------------#
sub btnFilterOk_Click
#--------------------------#
{
  # Close Filter window
  &winFilters_Terminate();
  
  # Fill the grid
  if ($winFilters->cbFiltersOp->IsEnabled()) {
    &feedFilterGrid($winFilters->cbFiltersOp->GetString($winFilters->cbFiltersOp->GetCurSel()));
  } else { 
    $win->gridFilter->DeleteNonFixedRows(); # Reset grid
    &feedFilterGrid(0);
  }
  
  # Enable buttons
  $win->btnFilterAdd->Enable();
  $win->btnFilterDel->Enable();

}  #--- End btnFilterOk_Click

#--------------------------#
sub feedFilterGrid
#--------------------------#
{
  # Operator
  my $operator = shift;
  
  # Type
  my $type = $winFilters->cbFiltersType->GetCurSel();
  my $typeOp;
  my $flags;
  my @searchStrings;
  if      ($type == 0) {
    # Search strings
    my $nbrItems = 0;
    for (my $i = 0; $i <= $winFilters->tfFiltersContains->GetLineCount(); $i++) {
      if ($winFilters->tfFiltersContains->GetLine($i)) {
        push(@searchStrings, $winFilters->tfFiltersContains->GetLine($i));
        $nbrItems++;
      }
    }
    if ($nbrItems > 1) { $operator = $STR{'OR'}; }    
    
    # Flags
    if ($winFilters->chFiltersContainsCase->Checked())      { $flags  = '1-'; }
    else                                                    { $flags  = '0-'; }
    if ($winFilters->chFiltersContainsRegex->Checked())     { $flags .= '1-'; }
    else                                                    { $flags .= '0-'; }
    if ($winFilters->chFiltersContainsFileOnly->Checked())  { $flags .= '1';  }
    else                                                    { $flags .= '0';  }

  # File size
  } elsif ($type == 1) {
    $typeOp      = $winFilters->cbFiltersSizeOp->GetString($winFilters->cbFiltersSizeOp->GetCurSel());
    my $sizeUnit = $winFilters->cbFiltersSizeUnit->GetString($winFilters->cbFiltersSizeUnit->GetCurSel());
    if ($winFilters->tfFiltersSize->Text()) {
      push(@searchStrings, $winFilters->tfFiltersSize->Text()." $sizeUnit");
    }
    if ($winFilters->tfFilterItemList->Text()) {
      # Search strings
      my $nbrItems = 0;
      for (my $i = 0; $i <= $winFilters->tfFilterItemList->GetLineCount(); $i++) {
        if ($winFilters->tfFilterItemList->GetLine($i)) {
          push(@searchStrings, $winFilters->tfFilterItemList->GetLine($i)." $sizeUnit");
          $nbrItems++;
        }
      }
      if ($nbrItems > 1) { $operator = $STR{'OR'}; }    
    }
    
  # Last accessed
  } elsif ($type == 2) {
    $typeOp = $winFilters->cbFiltersLastAccess->GetString($winFilters->cbFiltersLastAccess->GetCurSel());
    if ($winFilters->dtFiltersLastAccess->GetDate()) {
      my ($d, $m, $y) = $winFilters->dtFiltersLastAccess->GetDate();
      my $dateStr = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      push(@searchStrings, $dateStr);
    }
    if ($winFilters->tfFilterItemList->Text()) {
      # Search strings
      my $nbrItems = 0;
      for (my $i = 0; $i <= $winFilters->tfFilterItemList->GetLineCount(); $i++) {
        if ($winFilters->tfFilterItemList->GetLine($i)) {
          push(@searchStrings, $winFilters->tfFilterItemList->GetLine($i));
          $nbrItems++;
        }
      }
      if ($nbrItems > 1) { $operator = $STR{'OR'}; }    
    }
    
  # Last modified
  } elsif ($type == 3) {
    $typeOp = $winFilters->cbFiltersLastModif->GetString($winFilters->cbFiltersLastModif->GetCurSel());
    if ($winFilters->dtFiltersLastModif->GetDate()) {
      my ($d, $m, $y) = $winFilters->dtFiltersLastModif->GetDate();
      my $dateStr = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      push(@searchStrings, $dateStr);
    }
    if ($winFilters->tfFilterItemList->Text()) {
      # Search strings
      my $nbrItems = 0;
      for (my $i = 0; $i <= $winFilters->tfFilterItemList->GetLineCount(); $i++) {
        if ($winFilters->tfFilterItemList->GetLine($i)) {
          push(@searchStrings, $winFilters->tfFilterItemList->GetLine($i));
          $nbrItems++;
        }
      }
      if ($nbrItems > 1) { $operator = $STR{'OR'}; }    
    }
  }
  
  # Feed the grid
  my $typeStr = $winFilters->cbFiltersType->GetString($type);
  if (@searchStrings) {
    foreach my $string (@searchStrings) {
      if ($string and my $i = $win->gridFilter->InsertRow('-', -1)) {
        if ($operator and $i > 1) {
          $win->gridFilter->SetCellText($i, 0, $operator);
          $win->gridFilter->SetCellEditable($i, 0, 1);
          $win->gridFilter->SetCellType($i, 0, 6);
          $win->gridFilter->SetCellOptions($i, 0, [$STR{'OR'}, $STR{'AND'}]);
        }
        $win->gridFilter->SetCellText($i, 1, $typeStr);
        if ($typeOp) { $win->gridFilter->SetCellText($i, 2, $typeOp); }
        if ($flags)  { $win->gridFilter->SetCellText($i, 3, $flags);  }
        $win->gridFilter->SetCellText($i, 4, $string);
        $win->gridFilter->SetCellEditable($i, 1, 0);
        $win->gridFilter->SetCellEditable($i, 2, 0);
        $win->gridFilter->SetCellEditable($i, 3, 0);
        $win->gridFilter->SetCellEditable($i, 4, 0);
      }
    }
  } else { # Only Folder
    if (my $i = $win->gridFilter->InsertRow('-', -1)) {
      if ($operator and $i > 1) {
        $win->gridFilter->SetCellText($i, 0, $operator);
        $win->gridFilter->SetCellEditable($i, 0, 1);
        $win->gridFilter->SetCellType($i, 0, 6);
        $win->gridFilter->SetCellOptions($i, 0, [$STR{'OR'}, $STR{'AND'}]);
      }
      $win->gridFilter->SetCellText($i, 1, $typeStr);
      $win->gridFilter->SetCellEditable($i, 1, 0);
      $win->gridFilter->SetCellEditable($i, 2, 0);
      $win->gridFilter->SetCellEditable($i, 3, 0);
      $win->gridFilter->SetCellEditable($i, 4, 0);
    }
    &OnlyFoldersOn();
  }
    
  $win->gridFilter->AutoSizeColumns();
  $win->gridFilter->ExpandLastColumn();
  $win->gridFilter->Refresh();
  $win->gridFilter->SetListMode();

}  #--- End feedFilterGrid
  
#--------------------------#
sub btnFilterDel_Click
#--------------------------#
{
  # Local variables
  my (@coord) = $win->gridFilter->GetSelectedCellRange();
  
  my $firstSelectedRow;
  my $lastSelectedRow;
  if    ($coord[2]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[2]; }
  elsif ($coord[0]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[0]; }
  else {
    $firstSelectedRow = $win->gridFilter->GetRows()-1;
    $lastSelectedRow  = $win->gridFilter->GetRows()-1;
  }
  for (my $row = $lastSelectedRow; $row >= $firstSelectedRow; $row--) { $win->gridFilter->DeleteRow($row); }
  
  # Reset first line operator
  if ($win->gridFilter->GetCellText(1, 0) ne '-') { $win->gridFilter->SetCellText(1, 0, '-'); }
  
  # Reset options ?
  if (!&isOnlyFoldersOn()) { &OnlyFoldersOff(); }
  
  # Disable buttons ?
  if ($win->gridFilter->GetRows() == 1) {
    $win->btnFilterAdd->Disable();
    $win->btnFilterDel->Disable();
  }
  
  $win->gridFilter->AutoSizeColumns();
  $win->gridFilter->ExpandLastColumn();
  $win->gridFilter->Refresh();

}  #--- End btnFilterDel_Click

#--------------------------#
sub isOnlyFoldersOn
#--------------------------#
{
  for (my $row = 0; $row <= $win->gridFilter->GetRows(); $row++) {
    if ($win->gridFilter->GetCellText(1, 1) eq $STR{'rbFiltersDirOnly'}) { return(1); }
  }
  
  return(0);
  
}  #--- End isOnlyFoldersOn
  
#--------------------------#
sub OnlyFoldersOn
#--------------------------#
{
  # Lot of options and functions don't apply to folders, disable it
  # List full path only
  $win->chListFilesOptFN->Checked(0);
  $win->chListFilesOptFN->Disable();
  $win->chListFilesOptHV->Checked(0);
  $win->chListFilesOptHV->Disable();
  $win->chListFilesOptFD->Checked(0);
  $win->chListFilesOptFD->Disable();
  $win->chListFilesOptNbrL->Checked(0);
  $win->chListFilesOptNbrL->Disable();
  $win->chListFilesOptNF->Checked(0);
  $win->chListFilesOptNF->Disable();
  $win->rbListExt->Disable();
  # Copy or move : Can't remove duplicate
  $win->chCopyRemDouble->Checked(0);
  $win->chCopyRemDouble->Disable;
  # Rename : Disable all
  $win->rbRenByHash->Checked(0);
  $win->rbRenByHash->Disable();
  $win->cbRenByHash->Disable();
  $win->rbRenSort->Checked(0);
  $win->rbRenSort->Disable();
  $win->btnRenSort->Disable();
  $win->rbRenReplace->Checked(0);
  $win->rbRenReplace->Disable();
  $win->tfRenReplace->Disable();
  $win->lblRenReplaceBy->Disable();
  $win->tfRenReplaceBy->Disable();
  $win->chRenReplaceCase->Disable();
  $win->chRenReplaceRegex->Disable();
  $win->chRenReplaceByEval->Disable();
  $win->chRenReplaceFolder->Disable();
  $win->lblRenReplaceOk->Hide();
  $win->lblRenReplaceErr->Hide();
  $win->lblRenReplaceWarn->Hide();
  $win->lblRenReplaceByOk->Hide();
  $win->lblRenReplaceByErr->Hide();
  $win->lblRenReplaceByWarn->Hide();

}  #--- End OnlyFoldersOn

#--------------------------#
sub OnlyFoldersOff
#--------------------------#
{
  # Reactivate Functions and options
  $win->rbListFiles->Checked(1);
  $win->rbListExt->Checked(0);
  $win->chListFilesOptFP->Enable();
  $win->chListFilesOptFN->Enable();
  $win->chListFilesOptHV->Enable();
  $win->chListFilesOptFD->Enable();
  $win->chListFilesOptNbrL->Enable();
  $win->chListFilesOptNF->Enable();
  $win->rbListExt->Enable();
  $win->chCopyRemDouble->Enable();
  $win->rbRenByHash->Checked(1);
  $win->rbRenSort->Checked(0);
  $win->rbRenReplace->Checked(0);
  $win->rbRenByHash->Enable();
  $win->cbRenByHash->Enable();
  $win->rbRenSort->Enable();
  $win->btnRenSort->Disable();
  $win->rbRenReplace->Enable();
  $win->tfRenReplace->Disable();
  $win->lblRenReplaceBy->Disable();
  $win->chRenReplaceCase->Disable();
  $win->chRenReplaceRegex->Disable();
  $win->chRenReplaceFolder->Disable();

}  #--- End OnlyFoldersOff

#--------------------------#
sub TabFunctions_Click
#--------------------------#
{
  # Show List Function tab
  if (!$win->TabFunctions->SelectedItem()) {
    $win->rbListFiles->Checked(1);
    $win->rbListExt->Checked(0);
    $win->rbListFiles->Show();
    $win->chListFilesOptFP->Show();
    $win->chListFilesOptFN->Show();
    $win->chListFilesOptHV->Show();
    $win->chListFilesOptFD->Show();
    $win->chListFilesOptNbrL->Show();
    $win->chListFilesOptNH->Show();
    $win->chListFilesOptNF->Show();
    $win->rbListExt->Show();
    $win->lblReportDir->Show();
    $win->tfReportDir->Show();
    $win->cbReportFormat->Show();
    $win->btnReportDir->Show();
    $win->btnOpenReportDir->Show();
    $win->chOpenReport->Show();
    # Hide Copy or move Function tab
    $win->rbCopy->Checked(1);
    $win->rbCopy->Hide();
    $win->rbMove->Checked(0);
    $win->rbMove->Hide();
    $win->chCopyTree->Checked(0);
    $win->chCopyTree->Hide();
    $win->chCopyRemDouble->Checked(0);
    $win->chCopyRemDouble->Hide();
    $win->lblDestination->Hide();
    $win->tfDestinationDir->Text('');
    $win->tfDestinationDir->Hide();
    $win->btnDestinationDir->Hide();
    $win->chOpenDstDir->Hide();
    # Hide Rename Function tab
    $win->rbRenByHash->Checked(1);
    $win->rbRenByHash->Hide();
    $win->cbRenByHash->Hide();
    $win->rbRenSort->Checked(0);
    $win->rbRenSort->Hide();
    $win->btnRenSort->Hide();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Checked(0);
    $win->rbRenReplace->Hide();
    $win->tfRenReplace->Disable();
    $win->tfRenReplace->Hide();
    $win->tfRenReplace->Text('');
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Disable();
    $win->chRenReplaceFolder->Hide();
    $win->lblRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Disable();
    $win->tfRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Text('');
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->chRenReplaceByEval->Disable();
    $win->chRenReplaceByEval->Hide();
    
  # Show Copy or move Function tab
  } elsif ($win->TabFunctions->SelectedItem() == 1) {
    $win->rbCopy->Show();
    $win->rbMove->Show();
    $win->chCopyTree->Show();
    $win->chCopyRemDouble->Show();
    $win->lblDestination->Show();
    $win->tfDestinationDir->Show();
    $win->btnDestinationDir->Show();
    $win->chOpenDstDir->Show();
    # Hide List Function tab
    $win->rbListFiles->Hide();
    $win->chListFilesOptFP->Hide();
    $win->chListFilesOptFN->Hide();
    $win->chListFilesOptHV->Hide();
    $win->chListFilesOptFD->Hide();
    $win->chListFilesOptNbrL->Hide();
    $win->chListFilesOptNH->Hide();
    $win->chListFilesOptNF->Hide();
    $win->rbListExt->Hide();
    $win->lblReportDir->Hide();
    $win->tfReportDir->Hide();
    $win->cbReportFormat->Hide();
    $win->btnReportDir->Hide();
    $win->btnOpenReportDir->Hide();
    $win->chOpenReport->Hide();
    # Hide Rename Function tab
    $win->rbRenByHash->Checked(1);
    $win->rbRenByHash->Hide();
    $win->cbRenByHash->Hide();
    $win->rbRenSort->Checked(0);
    $win->rbRenSort->Hide();
    $win->btnRenSort->Hide();
    $win->btnRenSort->Disable();
    $win->rbRenReplace->Checked(0);
    $win->rbRenReplace->Hide();
    $win->tfRenReplace->Disable();
    $win->tfRenReplace->Hide();
    $win->tfRenReplace->Text('');
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceCase->Disable();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Disable();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Disable();
    $win->chRenReplaceFolder->Hide();
    $win->lblRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Disable();
    $win->tfRenReplaceBy->Hide();
    $win->tfRenReplaceBy->Text('');
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->chRenReplaceByEval->Disable();
    $win->chRenReplaceByEval->Hide();
    
  # Show Rename Function tab
  } elsif ($win->TabFunctions->SelectedItem() == 2) {
    $win->rbRenReplace->Show();
    $win->tfRenReplace->Show();
    $win->chRenReplaceCase->Show();
    $win->chRenReplaceRegex->Show();
    $win->chRenReplaceFolder->Show();
    $win->lblRenReplaceBy->Show();
    $win->tfRenReplaceBy->Show();
    $win->chRenReplaceByEval->Show();
    $win->rbRenByHash->Show();
    $win->cbRenByHash->Show();
    $win->rbRenSort->Show();
    $win->btnRenSort->Show();
    # Hide List Function tab
    $win->rbListFiles->Hide();
    $win->chListFilesOptFP->Hide();
    $win->chListFilesOptFN->Hide();
    $win->chListFilesOptHV->Hide();
    $win->chListFilesOptFD->Hide();
    $win->chListFilesOptNbrL->Hide();
    $win->chListFilesOptNH->Hide();
    $win->chListFilesOptNF->Hide();
    $win->rbListExt->Hide();
    $win->lblReportDir->Hide();
    $win->tfReportDir->Hide();
    $win->cbReportFormat->Hide();
    $win->btnReportDir->Hide();
    $win->btnOpenReportDir->Hide();
    $win->chOpenReport->Hide();
    # Hide Copy or move Function tab
    $win->rbCopy->Hide();
    $win->rbMove->Hide();
    $win->chCopyTree->Hide();
    $win->chCopyRemDouble->Hide();
    $win->lblDestination->Hide();
    $win->tfDestinationDir->Hide();
    $win->btnDestinationDir->Hide();
    $win->chOpenDstDir->Hide();
  }
  
  &isProcessReady(0);
  
}  #--- End TabFunctions_Click

#--------------------------#
sub rbListFiles_Click
#--------------------------#
{
  if (&isOnlyFoldersOn()) {   # Filter: Only folders
    $win->chListFilesOptFP->Enable();
    $win->chListFilesOptNH->Enable();
  } else {
    $win->chListFilesOptFP->Enable();
    $win->chListFilesOptFN->Enable();
    $win->chListFilesOptHV->Enable();
    $win->chListFilesOptFD->Enable();
    $win->chListFilesOptNbrL->Enable();
    $win->chListFilesOptNH->Enable();
    $win->chListFilesOptNF->Enable();
  }
  $win->cbReportFormat->Enable();
  
  &isProcessReady(0);

}  #--- End crbListFiles_Click

#--------------------------#
sub chListFilesOptFP_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOptFP_Click

#--------------------------#
sub chListFilesOptFN_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOptFN_Click

#--------------------------#
sub chListFilesOptHV_Click
#--------------------------#
{
  if ($win->chListFilesOptHV->Checked()) {
    $winHashVal->chListFilesHV1->Checked(1);
    $winHashVal->chListFilesHV2->Checked(1);
    $winHashVal->chListFilesHV3->Checked(1);
    $winHashVal->chListFilesHV4->Checked(1);
    $winHashVal->Center($win);
    $winHashVal->Show();
    $win->Disable();
    return(1);
  } else {
    $winHashVal->chListFilesHV1->Checked(0);
    $winHashVal->chListFilesHV2->Checked(0);
    $winHashVal->chListFilesHV3->Checked(0);
    $winHashVal->chListFilesHV4->Checked(0);
  }

}  #--- End chListFilesOptHV_Click

#--------------------------#
sub btnHashValuesOk_Click
#--------------------------#
{
  &winHashVal_Terminate();

}  #--- End btnHashValuesOk_Click

#--------------------------#
sub winHashVal_Terminate
#--------------------------#
{
  $winHashVal->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winHashVal_Terminate

#--------------------------#
sub chListFilesHV1_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesHV1_Click

#--------------------------#
sub chListFilesHV2_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesHV2_Click

#--------------------------#
sub chListFilesHV3_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesHV3_Click

#--------------------------#
sub chListFilesHV4_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesHV4_Click

#--------------------------#
sub chListFilesOptFD_Click
#--------------------------#
{
  if ($win->chListFilesOptFD->Checked()) {
    $winFileDetails->chListFilesFD1->Checked(1);
    $winFileDetails->chListFilesFD2->Checked(1);
    $winFileDetails->chListFilesFD3->Checked(1);
    $winFileDetails->Center($win);
    $winFileDetails->Show();
    $win->Disable();
    return(1);
  } else {
    $winFileDetails->chListFilesFD1->Checked(0);
    $winFileDetails->chListFilesFD2->Checked(0);
    $winFileDetails->chListFilesFD3->Checked(0);
  }

}  #--- End chListFilesOptFD_Click

#--------------------------#
sub btnFileDetailsOk_Click
#--------------------------#
{
  &winFileDetails_Terminate();

}  #--- End btnFileDetailsOk_Click

#--------------------------#
sub winFileDetails_Terminate
#--------------------------#
{
  $winFileDetails->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winFileDetails_Terminate

#--------------------------#
sub chListFilesFD1_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesFD1_Click

#--------------------------#
sub chListFilesFD2_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesFD2_Click

#--------------------------#
sub chListFilesFD3_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesFD3_Click

#--------------------------#
sub chListFilesOptNbrL_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End chListFilesOptNbrL_Click

#--------------------------#
sub rbListExt_Click
#--------------------------#
{
  $win->chListFilesOptFP->Disable();
  $win->chListFilesOptFN->Disable();
  $win->chListFilesOptHV->Disable();
  $win->chListFilesOptFD->Disable();
  $win->chListFilesOptNbrL->Disable();
  $win->chListFilesOptNH->Disable();
  $win->chListFilesOptNF->Disable();
  $win->cbReportFormat->Disable();
  
  &isProcessReady(0);

}  #--- End rbListExt_Click

#--------------------------#
sub tfReportDir_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $win->tfReportDir->Text();
  
  # Remember
  if ($saveDir and -d $saveDir) {
    $CONFIG{'DIR_REPORT'} = $saveDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'DIR_REPORT'});
    &saveConfig(\%CONFIG);
    if ($saveDir) {
      $win->tfReportDir->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($win, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010); }
    }
  }
  
  &isProcessReady(0);

}  #--- End tfReportDir_Change

#--------------------------#
sub cbReportFormat_Change
#--------------------------#
{
  # Local variables
  my $format = $win->cbReportFormat->GetCurSel();
  
  # Remember
  $CONFIG{'FORMAT_REPORT'} = $format;
  &saveConfig(\%CONFIG);

}  #--- End cbReportFormat_Change

#--------------------------#
sub btnReportDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfReportDir->Text();
  my $dir;

  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -directory  => $lastDir          ,
                                        -newui      => 1                 , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win              ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -newui      => 1                 , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $win->tfReportDir->Text($dir);
  }
  
}  #--- End btnReportDir_Click

#--------------------------#
sub btnOpenReportDir_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $win->tfReportDir->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }

}  #--- End btnOpenReportDir_Click

#--------------------------#
sub chOpenReport_Click
#--------------------------#
{
  # Save the choice
  if ($win->chOpenReport->Checked()) {
    $CONFIG{'AUTO_OPEN_REPORT'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_OPEN_REPORT'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOpenReport_Click

#--------------------------#
sub rbCopy_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End rbCopy_Click

#--------------------------#
sub rbMove_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End rbMove_Click

#--------------------------#
sub tfDestinationDir_Change
#--------------------------#
{
  &isProcessReady(0);

}  #--- End tfReportDir_Change

#--------------------------#
sub btnDestinationDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfDestinationDir->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win                 ,
                                        -title      => $STR{'selDirDst'}.':',
                                        -folderonly => 1                    ,
                                        -directory  => $lastDir             ,);
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $win                 ,
                                        -title      => $STR{'selDirDst'}.':',
                                        -folderonly => 1                    , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $win->tfDestinationDir->Text($dir);
  }
  
  &isProcessReady(0);
  
}  #--- End btnDestinationDir_Click

#--------------------------#
sub rbRenByHash_Click
#--------------------------#
{
  # Enable options
  $win->cbRenByHash->Enable();
  # Disable other option controls
  $win->btnRenSort->Disable();
  $win->tfRenReplace->Disable();
  $win->tfRenReplaceBy->Disable();
  $win->chRenReplaceCase->Disable();
  $win->chRenReplaceRegex->Disable();
  $win->chRenReplaceFolder->Disable();
  $win->chRenReplaceByEval->Disable();
  
  &isProcessReady(0);

}  #--- End rbRenByHash_Click

#--------------------------#
sub rbRenSort_Click
#--------------------------#
{
  # Enable options
  $win->btnRenSort->Enable();
  # Disable other option controls
  $win->cbRenByHash->Disable();
  $win->tfRenReplace->Disable();
  $win->tfRenReplaceBy->Disable();
  $win->chRenReplaceCase->Disable();
  $win->chRenReplaceRegex->Disable();
  $win->chRenReplaceFolder->Disable();
  $win->chRenReplaceByEval->Disable();
  
  &isProcessReady(0);

}  #--- End rbRenSort_Click

#--------------------------#
sub btnRenSort_Click
#--------------------------#
{
  &winRenBySortOptExample();
  $winRenBySortOpt->Center($win);
  $winRenBySortOpt->DoModal();

}  #--- End btnRenSort_Click

#--------------------------#
sub cbIncrValType_Change
#--------------------------#
{
  if ($START == 1) {
    $winRenBySortOpt->upDownInitVal->SetPos(1);
    my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
    if    (!$incrValType)     { $winRenBySortOpt->tfInitVal->Text(1);   $winRenBySortOpt->upDownInitVal->SetBase(10); } # '1,2,3,...'
    elsif ($incrValType == 1) { $winRenBySortOpt->upDownInitVal->SetBase(10); $winRenBySortOpt->tfInitVal->Text('a'); } # 'a-z,aa-zz,...'
    elsif ($incrValType == 2) { $winRenBySortOpt->upDownInitVal->SetBase(10); $winRenBySortOpt->tfInitVal->Text('A'); } # 'A-Z,AA-ZZ,...'
    elsif ($incrValType == 3) { $winRenBySortOpt->tfInitVal->Text(1);   $winRenBySortOpt->upDownInitVal->SetBase(16); } # '0-f,00-ff,...'
    elsif ($incrValType == 4) { $winRenBySortOpt->tfInitVal->Text(1);   $winRenBySortOpt->upDownInitVal->SetBase(16); } # '0-F,00-FF,...'
    elsif ($incrValType == 5) { $winRenBySortOpt->upDownInitVal->SetBase(10); $winRenBySortOpt->tfInitVal->Text('I'); } # 'I,II,III IV,...'
    &winRenBySortOptExample();
  }

}  #--- End cbIncrValType_Change

#--------------------------#
sub tfLength_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfLength_Change

#--------------------------#
sub upDownInitVal_Scroll
#--------------------------#
{
  my ($buf1, $bu2, $pos) = @_;
  my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
  my $formatedVal = &formatVal($incrValType, $pos, 1);
  $winRenBySortOpt->tfInitVal->Text($formatedVal);

}  #--- End upDownInitVal_Scroll

#--------------------------#
sub tfInitVal_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfInitVal_Change

#--------------------------#
sub tfStepVal_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfStepVal_Change

#--------------------------#
sub tfPrefix_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfPrefix_Change

#--------------------------#
sub tfSuffix_Change
#--------------------------#
{
  if ($START == 1) { &winRenBySortOptExample(); }

}  #--- End tfSuffix_Change

#--------------------------#
sub winRenBySortOptExample
#--------------------------#
{
  # Local variables
  my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
  my $length      = $winRenBySortOpt->tfLength->Text();
  my $initVal     = $winRenBySortOpt->tfInitVal->Text();
  my $stepVal     = $winRenBySortOpt->tfStepVal->Text();
  my $prefix      = $winRenBySortOpt->tfPrefix->Text();
  my $suffix      = $winRenBySortOpt->tfSuffix->Text();
  my $isValid     = 0;
  
  # Illegal characters in prefix or suffix
  if ($prefix =~ /[\<\>\:\"\/\\\|\?\*]/ or $suffix =~ /[\<\>\:\"\/\\\|\?\*]/) {
    $winRenBySortOpt->tfExample->Text($STR{'errChars'});
    
  } else {
    # Initial value
    if ($length and $initVal) {
      if    (!$incrValType     and $initVal =~ /^[0-9]+$/)      { $isValid = 1; } # '1,2,3,...'
      elsif ($incrValType == 1 and $initVal =~ /^[a-z]+$/)      { $isValid = 1; } # 'a-z,aa-zz,...'
      elsif ($incrValType == 2 and $initVal =~ /^[A-Z]+$/)      { $isValid = 1; } # 'A-Z,AA-ZZ,...'
      elsif ($incrValType == 3 and $initVal =~ /^[0-9a-f]+$/)   { $isValid = 1; } # '0-f,00-ff,...'
      elsif ($incrValType == 4 and $initVal =~ /^[0-9A-F]+$/)   { $isValid = 1; } # '0-F,00-FF,...'
      elsif ($incrValType == 5 and $initVal =~ /^[IVXLCDM_]+$/) { $isValid = 1; } # 'I,II,III IV,...'
    } else { $isValid = 0; }
    
    # Create example
    if ($isValid == 1) {
      $winRenBySortOpt->btnWinRenBySortOptOk->Enable();
      my $example = '';
      for (my $i = 0; $i < 3; $i++) { # Generate three values with selected options
        if ($prefix) { $example .= $prefix;  }
        my $currVal = ($i * $stepVal);
        my $initValDec = &convertInitVal($incrValType, $initVal);
        $currVal += $initValDec;
        my $formatedVal = &formatVal($incrValType, $currVal, $length);
        $example       .= $formatedVal;
        if ($suffix) { $example .= $suffix;  }
        $example .= '.ext, ';
      }
      $example .= '...';
      $winRenBySortOpt->tfExample->Text($example);
    } else {
      $winRenBySortOpt->tfExample->Text('');
      $winRenBySortOpt->btnWinRenBySortOptOk->Disable();
    }
  }
  
}  #--- End winRenBySortOptExample

#--------------------------#
sub convertInitVal
#--------------------------#
{
  # Local variables
  my ($incrValType, $initVal) = @_;
  my $decimal;

  # Decimal already
  if    (!$incrValType) { return($initVal); }
  # Alphabet
  elsif ($incrValType == 1 or $incrValType == 2) { # 'a-z,aa-zz,...' or 'A-Z,AA-ZZ,...'
    my @values = split('', $initVal);
    my $multi = 0;
    foreach (reverse @values) {
      if ($_ =~ /[a-zA-Z]/) {
        my $val2add = (ord(lc($_)) - 96);
        for (my $i = 0; $i < $multi; $i++) { $val2add = $val2add * 26; }
        $decimal += $val2add;
      }
      $multi++;
    }
  # Hexadecimal
  } elsif ($incrValType == 3 or $incrValType == 4) { # '0-f,00-ff,...' or '0-F,00-FF,...'
    $decimal = hex($initVal);
  # Roman
  } elsif ($incrValType == 5) { # 'I,II,III IV,...'
    $decimal = roman2int($initVal);
  }

  return($decimal);
  
}  #--- End convertInitVal

#--------------------------#
sub formatVal
#--------------------------#
{
  # Local variables
  my ($incrValType, $val, $length) = @_;
  my $convertedVal;
  my $nullChar;
  
  # Decimal
  if (!$incrValType) {
    $nullChar     = 0;
    $convertedVal = $val;
  # Alphabet
  } elsif ($incrValType == 1 or $incrValType == 2) { # 'a-z,aa-zz,...' or 'A-Z,AA-ZZ,...'
    $nullChar = '_';
    my @values;
    my $offset = $val;
    while ($offset > 26) {
      my $currOffset = int($offset / 26);
      push(@values, $offset - ($currOffset*26));
      $offset = $currOffset;
    }
    push(@values, $offset);
    foreach my $value (reverse @values) {
      if    ($incrValType == 1) { $value += 96; } # 'a-z,aa-zz,...'
      elsif ($incrValType == 2) { $value += 64; } # 'A-Z,AA-ZZ,...'
      $convertedVal .= chr($value);
    }
  # Hexadecimal
  } elsif ($incrValType == 3 or $incrValType == 4) { # '0-f,00-ff,...' or '0-F,00-FF,...'
    $nullChar = '0';
    $convertedVal .= sprintf("%x", $val);
    if    ($incrValType == 3) { $convertedVal = lc($convertedVal); }
    elsif ($incrValType == 4) { $convertedVal = uc($convertedVal); }
  # Roman
  } elsif ($incrValType == 5) { # 'I,II,III IV,...'
    $nullChar = '_';
    $convertedVal = int2roman($val);
  }
  
  # Fill with null
  while (length($convertedVal) < $length) { $convertedVal = $nullChar . $convertedVal; }

  return($convertedVal);
  
}  #--- End formatVal

#--------------------------#
sub btnWinRenBySortOptOk_Click
#--------------------------#
{
  &isProcessReady(0);
  return(-1);
  
}  #--- End btnWinRenBySortOptOk_Click

#--------------------------#
sub rbRenReplace_Click
#--------------------------#
{
  # Enable options
  $win->tfRenReplace->Enable();
  $win->chRenReplaceCase->Enable();
  $win->chRenReplaceRegex->Enable();
  $win->chRenReplaceFolder->Enable();
  # Disable other option controls
  $win->cbRenByHash->Disable();
  $win->btnRenSort->Disable();
  
  &isProcessReady(0);

}  #--- End rbRenReplace_Click

#--------------------------#
sub tfRenReplace_Change
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceRegexStatus;
  }
  
  # Enable By textfield
  if ($win->tfRenReplace->Text) {
    $win->tfRenReplaceBy->Enable();
    if ($win->chRenReplaceRegex->Checked()) { $win->chRenReplaceByEval->Enable(); }
  } else {
    $win->tfRenReplaceBy->Text('');
    $win->tfRenReplaceBy->Disable();
    $win->chRenReplaceByEval->Disable();
  }
  
  &isProcessReady(0);

}  #--- End tfRenReplace_Change

#--------------------------#
sub chRenReplaceRegex_Click
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceRegexStatus;
    $win->chRenReplaceByEval->Enable();
  } else {
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceByEval->Disable();
  }
  
  # Revaluate Replacement expression
  if ($win->tfRenReplaceBy->Text()) { &showRenReplaceByStatus; }
  
  &isProcessReady(0);

}  #--- End chRenReplaceRegex_Click

#--------------------------#
sub showRenReplaceRegexStatus
#--------------------------#
{
  # Local variables
  my $regex = $win->tfRenReplace->Text();
  if ($regex) {
    my ($statusRegex, $msg) = &validRegex($regex);
    
    # Warning
    if      ($statusRegex == 2) {
      $win->lblRenReplaceWarn->Show();
      $win->lblRenReplaceOk->Hide();
      $win->lblRenReplaceErr->Hide();
    # Error
    } elsif ($statusRegex) {
      $win->lblRenReplaceErr->Show();
      $win->lblRenReplaceOk->Hide();
      $win->lblRenReplaceWarn->Hide();
    # Ok
    } else {
      $win->lblRenReplaceOk->Show();
      $win->lblRenReplaceErr->Hide();
      $win->lblRenReplaceWarn->Hide();
    }
  } else {
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
  }

}  #--- End showRenReplaceRegexStatus

#--------------------------#
sub tfRenReplaceBy_Change
#--------------------------#
{
  &showRenReplaceByStatus;

  &isProcessReady(0);

}  #--- End tfRenReplace_Change

#--------------------------#
sub chRenReplaceByEval_Click
#--------------------------#
{
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceByStatus;
  } else {
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
  }
  &isProcessReady(0);

}  #--- End chRenReplaceByEval_Click

#--------------------------#
sub showRenReplaceByStatus
#--------------------------#
{
  # Local variables
  my $expr = $win->tfRenReplaceBy->Text();
  if ($expr) {
    my ($status, $msg) = &validReplacement;
    
    # Warning
    if      ($status and $status == 2) {
      $win->lblRenReplaceByWarn->Show();
      $win->lblRenReplaceByOk->Hide();
      $win->lblRenReplaceByErr->Hide();
    # Error
    } elsif ($status) {
      $win->lblRenReplaceByErr->Show();
      $win->lblRenReplaceByOk->Hide();
      $win->lblRenReplaceByWarn->Hide();
    # Ok
    } else {
      $win->lblRenReplaceByOk->Show();
      $win->lblRenReplaceByErr->Hide();
      $win->lblRenReplaceByWarn->Hide();
    }
  } else {
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
  }

}  #--- End showRenReplaceByStatus

#--------------------------#
sub btnProcess_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'Error'}, 0x40010);
  } else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        threads->exit();
      };
      
      # Local variables
      my %listFiles;
      
      # Show progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Show();
      $win->pb->Show();
      $win->lblPbCount->Show();
      $win->btnProcess->Hide();
      $win->btnStop->Show();
      $win->ChangeCursor($HOURGLASS);
      
      # List of file paths
      &getListFiles(\%listFiles, 1);
      
      # List Files or Extensions
      if (!$win->TabFunctions->SelectedItem()) {
        # List Files
        if    ($win->rbListFiles->Checked()) { &listFilesReport(\%listFiles); }
        # List Extensions
        elsif ($win->rbListExt->Checked())   { &listExtReport(\%listFiles);   }
      # Copy or move
      } elsif ($win->TabFunctions->SelectedItem() == 1) {
        &copyMove(\%listFiles, 1);
      # Rename
      } elsif ($win->TabFunctions->SelectedItem() == 2) {
        &renameFiles(\%listFiles, 1);
      }
      
      # Progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Hide();
      $win->pb->Hide();
      $win->lblPbCount->Hide();
      $win->btnProcess->Show();
      $win->btnStop->Hide();      
      $win->ChangeCursor($ARROW);
    });
  }
  
}  #--- End btnProcess_Click

#--------------------------#
sub btnStop_Click
#--------------------------#
{
  # Stop requests
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { $THR_PROCESS->kill('KILL')->detach(); }
  return(1);

}  #--- End btnStop_Click

#--------------------------#
sub btnPreview_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'Error'}, 0x40010);
  } else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        threads->exit();
      };
      
      # Show progress window
      $winPb->Center($winPreview);
      $winPb->Show();
      
      # Local variables
      my %listFiles;
      
      # Reset trees
      $winPreview->tvBefore->DeleteAllItems();
      $winPreview->tvAfter->DeleteAllItems();
      
      # List of file paths
      &getListFiles(\%listFiles, 0);
      
      # Fill the Before tree
      my $baseDir;
      if (-d $win->tfInput->Text()) { $baseDir = $win->tfInput->Text(); }
      else {
        my $filesStr = $win->tfInput->Text();
        # Set base dir
        if ($filesStr) {
          # Multiple files
          if ($filesStr =~ /" "/) {
            $baseDir = (split(/" "/, $filesStr))[0];
            $baseDir =~ s/\"//g;
          }
          # Single file
          else {
            my @pathParts = split(/\\/, $filesStr);
            pop(@pathParts);
            $baseDir = join("\\", @pathParts);
          }
        }
      }
      $winPreview->tfRootBefore->Text($baseDir);
      &createTree($winPreview->tvBefore, \%listFiles, undef, $baseDir);
      
      # Fill the After tree
      if (!(&isFunctionsReady()) and $win->TabFunctions->SelectedItem()) {
        my $refResListFiles;
        my $refResListSubFolders;
        my $dstDir;
        if      ($win->TabFunctions->SelectedItem() == 1) { # Copy or move
          $dstDir = $win->tfDestinationDir->Text();
          ($refResListFiles, $refResListSubFolders) = &copyMove(\%listFiles, 0);
        } elsif ($win->TabFunctions->SelectedItem() == 2) { # Rename
          $dstDir = $baseDir;
          ($refResListFiles, $refResListSubFolders) = &renameFiles(\%listFiles, 0);
        }
        $winPreview->tfRootAfter->Text($dstDir);
        if ($refResListSubFolders) { &createTree($winPreview->tvAfter, $refResListFiles, $refResListSubFolders, $dstDir); }
        else                       { &createTree($winPreview->tvAfter, $refResListFiles, undef, $dstDir);                 }
      }
      
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
    });
    
    # Show Window
    $winPreview->Center($win);
    $winPreview->DoModal();
    return(1);
  }

}  #--- End btnPreview_Click

#--------------------------#
sub createTree
#--------------------------#
{
  # Local variables
  my ($refTree, $refListFiles, $refResListSubFolders, $baseDir) = @_;
  # $refResListSubFolders is used to identify empty folders
  my %createdFolders;
  
  # Browse file and create nodes
  foreach my $file (keys %{$refListFiles}) {
    my $relPath   = $file =~ s/\Q$baseDir\E\\//r;
    my @pathParts = split(/\\/, $relPath);
    my $filename;
    if (!-d $file) { $filename = pop(@pathParts); }
    
    # Create folders that doesn't exists
    my $parent;
    my $folder;
    foreach my $part (@pathParts) {
      if ($parent) {
        $folder .= "\\" . $part;
        if (!exists($createdFolders{$folder})) {
          if ($part =~ /[\<\>\:\"\/\\\|\?\*]/) { # Illegal characters
            $parent = $refTree->InsertItem(-parent => $parent    ,
                                           -text   => $part . " ($STR{'Error'})",
                                           -bold   => 1          ,
                                           -image  => 0          ,
                                           -item   => 0xFFFF0003 , );
          } else {
            $parent = $refTree->InsertItem(-parent => $parent    ,
                                           -text   => $part      ,
                                           -image  => 0          ,
                                           -item   => 0xFFFF0003 , );
          }
          $createdFolders{$folder} = $parent;
          if ($refResListSubFolders and exists($$refResListSubFolders{$baseDir."\\".$folder})) {
            delete($$refResListSubFolders{$baseDir."\\".$folder}); # Folder has been created
          }
        } else { $parent = $createdFolders{$folder}; }
      } else       {
        $folder = $part;
        if (!exists($createdFolders{$folder})) {
          if ($part =~ /[\<\>\:\"\/\\\|\?\*]/) { # Illegal characters
            $parent = $refTree->InsertItem(-text  => $part . " ($STR{'Error'})",
                                           -bold  => 1          ,
                                           -image => 0          ,
                                           -item  => 0xFFFF0003 , );
          } else {
            $parent = $refTree->InsertItem(-text  => $part      ,
                                           -image => 0          ,
                                           -item  => 0xFFFF0003 , );
          }
          $createdFolders{$folder} = $parent;
          if ($refResListSubFolders and exists($$refResListSubFolders{$baseDir."\\".$folder})) {
            delete($$refResListSubFolders{$baseDir."\\".$folder}); # Folder has been created
          }
        } else { $parent = $createdFolders{$folder}; }
      }
    }
    
    # If filename
    if ($filename) {
      # File is marked as error
      if ($$refListFiles{$file} == 2) {
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename . " ($STR{'Error'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename . " ($STR{'Error'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        }
      # File is masked as removed
      } elsif ($$refListFiles{$file} == 3) {
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename . " ($STR{'Duplicate'} $STR{'Removed'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename . " ($STR{'Duplicate'} $STR{'Removed'})",
                                -bold   => 1          ,
                                -image  => 3          ,
                                -item   => 0xFFFF0003 , );
        }
      # File is masked as renamed
      } elsif ($$refListFiles{$file} == 4) {
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename . " ($STR{'Renamed'})",
                                -bold   => 0          ,
                                -image  => 4          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename . " ($STR{'Renamed'})",
                                -bold   => 0          ,
                                -image  => 4          ,
                                -item   => 0xFFFF0003 , );
        }
      } else {
        # Normal file
        if ($parent) {
          $refTree->InsertItem( -parent => $parent    ,
                                -text   => $filename  , 
                                -image  => 2          ,
                                -item   => 0xFFFF0003 , );
        } else {
          $refTree->InsertItem( -text   => $filename  ,  
                                -image  => 2          ,
                                -item   => 0xFFFF0003 , );
        }
      }
    }
  }
  
  # Create empty folder nodes
  if ($refResListSubFolders) {
    foreach my $folder (keys %{$refResListSubFolders}) {
      my $relPath   = $folder =~ s/\Q$baseDir\E\\//r;
      if ($relPath) {
        my @pathParts = split(/\\/, $relPath);
        
        # Create folders that doesn't exists
        my $parent;
        my $folder;
        foreach my $part (@pathParts) {
          if ($parent) {
            $folder .= "\\" . $part;
            if (!exists($createdFolders{$folder})) {
              $parent = $refTree->InsertItem(-parent        => $parent    ,
                                             -text          => $part      ,
                                             -image         => 0          ,
                                             -item          => 0xFFFF0003 , );
              $createdFolders{$folder} = $parent;
            } else { $parent = $createdFolders{$folder}; }
          } else       {
            $folder = $part;
            if (!exists($createdFolders{$folder})) {
              $parent = $refTree->InsertItem(-text          => $part      ,
                                             -image         => 0          ,
                                             -item          => 0xFFFF0003 , );
              $createdFolders{$folder} = $parent;
            } else { $parent = $createdFolders{$folder}; }
          }
        }
      }
    }
  }

}  #--- End createTree

#--------------------------#
sub tvBefore_Expand
#--------------------------#
{
  my $node = shift;
  $winPreview->tvBefore->SetItem($node, -image => 1);
  
}  #--- End tvBefore_Expand

#--------------------------#
sub tvBefore_Collapse
#--------------------------#
{
  my $node = shift;
  $winPreview->tvBefore->SetItem($node, -image => 0);
  
}  #--- End tvBefore_Collapse

#--------------------------#
sub tvAfter_Expand
#--------------------------#
{
  my $node = shift;
  $winPreview->tvAfter->SetItem($node, -image => 1);
  
}  #--- End tvAfter_Expand

#--------------------------#
sub tvAfter_Collapse
#--------------------------#
{
  my $node = shift;
  $winPreview->tvAfter->SetItem($node, -image => 0);
  
}  #--- End tvAfter_Collapse

#--------------------------#
sub winPreview_Resize
#--------------------------#
{
  $winPreview->tvBefore->Width($winPreview->ScaleWidth()/2-7);
  $winPreview->tvBefore->Height($winPreview->ScaleHeight()-65); 
  $winPreview->tfRootBefore->Width($winPreview->ScaleWidth()/2-72);
  $winPreview->lblAfterShadowT->Left($winPreview->ScaleWidth()/2+1); 
  $winPreview->lblAfterT->Left($winPreview->ScaleWidth()/2);
  $winPreview->lblRootAfter->Left($winPreview->ScaleWidth()/2+5);
  $winPreview->tfRootAfter->Left($winPreview->ScaleWidth()/2+65);
  $winPreview->tfRootAfter->Width($winPreview->ScaleWidth()/2-71);
  $winPreview->tvAfter->Left($winPreview->ScaleWidth()/2);
  $winPreview->tvAfter->Width($winPreview->ScaleWidth()/2-6);
  $winPreview->tvAfter->Height($winPreview->ScaleHeight()-65);
  
}  #--- End winPreview_Resize

#--------------------------#
sub winPreview_Terminate
#--------------------------#
{
  return(-1);
  
}  #--- End winPreview_Terminate

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { $THR_PROCESS->kill('KILL')->detach(); }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub getListFiles
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift;
  my $dir          = $win->tfInput->Text();
  
  # List of files (No filter)
  if (!-d $dir) {
    my $filesStr = $dir;
    # Multiple files
    if ($filesStr =~ /" "/) {
      my @items = split(/" "/, $filesStr);
      my $baseDir = shift(@items);
      $baseDir =~ s/^\"//;
      foreach my $item (@items) {
        $item =~ s/\"$//;
        $$refListFiles{$baseDir."\\".$item} = 1;
      }
      
    # Single file
    } else { $$refListFiles{$filesStr} = 1; }
    
  # Directory (List files and apply filters)
  } else {
    # Local variables
    my $filter;
    my $selSize;
    my $sizeOp;
    my $regex;
    my $selDateUT;
    my $dateOp;
    my @subFolders;
    my $nbrSubFolders = 1; # The base dir count as one
    my $count         = 0;
    
    # Set Filters
    my $refFilters  = &setFilters();
    my $nbrFilters  = keys %{$refFilters};
    my $onlyFolders = &isOnlyFoldersOn();
  
    # Open base directory
    if ($execute) { $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir);   }
    else          { $winPb->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir); }
    $$refListFiles{"$dir\\"} = 0;
    if (opendir(DIR,"$dir\\")) {
      while (my $file = readdir(DIR)) {
        my $filePath = "$dir\\$file";
        if ((-d $filePath) and ($file !~ /^\.\.?$/) and ($file ne 'System Volume Information')) { # It's a directory
          if ($win->chInputDirRecurse->Checked()) { # Subfolders option
            push(@subFolders, $filePath);
            $nbrSubFolders++;
            if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
            else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
          } else { $nbrSubFolders++; }
          
          # No filter or Only Folders (single filter)
          if (!$nbrFilters or ($nbrFilters == 1 and $onlyFolders)) {
            $$refListFiles{$filePath} = 0;
          # Filter
          } elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
            $$refListFiles{$filePath} = 0;
          }
        } elsif (!-d $filePath and -e $filePath) { # It's a file
          # No filter
          if    (!$nbrFilters) { $$refListFiles{$filePath} = 0; }
          # Filter match
          elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
            $$refListFiles{$filePath} = 0;
          }
        }
      }
      closedir(DIR);
    }
    $count++;
    if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
    else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
  
    # List folders and files in subfolders
    if ($win->chInputDirRecurse->Checked() and scalar(@subFolders) > 0) {
      foreach my $subFolder (@subFolders) {
        $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$subFolder);
        if (opendir(DIR,"$subFolder\\")) {
          while (my $file = readdir(DIR)) {
            my $filePath = "$subFolder\\$file";
            if ((-d $filePath) and ($file !~ /^\.\.?$/)) {                                      # It's a directory
              push(@subFolders, $filePath);
              $nbrSubFolders++;
              if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
              else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
              
              # No filter or Only Folders (single filter)
              if (!$nbrFilters or ($nbrFilters == 1 and $onlyFolders)) {
                $$refListFiles{$filePath} = 0;
              # Filter
              } elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
                $$refListFiles{$filePath} = 0;
              }
            } elsif (!-d $filePath and -e $filePath) { # It's a file
              # No filter
              if    (!$nbrFilters) { $$refListFiles{$filePath} = 0; }
              # Filter match
              elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
                $$refListFiles{$filePath} = 0;
              }
            }
          }
          closedir(DIR);
        }
        $count++;
        if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
        else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
      }
    }
    if ($execute) { 
      $win->lblPbCurr->Text('');
      $win->lblPbCount->Text('');
    } else { # Preview mode
      $win->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
    }
  }

}  #--- End getListFiles

#--------------------------#
sub setFilters
#--------------------------#
{
  # Local variables
  my %filters;
  my $i = 1;
  
  # Gather filter list
  for (my $row = 1; $row <= $win->gridFilter->GetRows(); $row++) {
    my $firstVal = $win->gridFilter->GetCellText($row, 0);
    if ($firstVal) {
      $filters{$i}{'Operator'} = $win->gridFilter->GetCellText($row, 0);
      if ($win->gridFilter->GetCellText($row, 1)) { $filters{$i}{'Type'}      = $win->gridFilter->GetCellText($row, 1); }
      if ($win->gridFilter->GetCellText($row, 2)) { $filters{$i}{'TypeOp'}    = $win->gridFilter->GetCellText($row, 2); }
      if ($win->gridFilter->GetCellText($row, 3)) { $filters{$i}{'Flags'}     = $win->gridFilter->GetCellText($row, 3); }
      if ($win->gridFilter->GetCellText($row, 4)) { $filters{$i}{'SearchStr'} = $win->gridFilter->GetCellText($row, 4); }
      if ($filters{$i}{'Type'} eq $STR{'rbFiltersLastAccess'} or $filters{$i}{'Type'} eq $STR{'rbFiltersLastModif'}) {
        my ($y, $m, $d) = split(/\-/, $filters{$i}{'SearchStr'});
        $filters{$i}{'DateUT'} = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
      }
    }
    $i++;
  }
  
  return(\%filters);  
  
}  #--- End setFilters

#--------------------------#
sub testFilters
#--------------------------#
{
  # Local variables
  my ($dir, $refFilters, $nbrFilters, $file, $path, $onlyFolders) = @_;
  my $match       = 0;
  
  # Path is a folder, only Contains filter applies
  if ($path and -d $path) {
    for (my $i = 1; $i <= $nbrFilters; $i++) {
      if ($$refFilters{$i}{'Type'} eq $STR{'rbFiltersContains'}) {
        # Regex option is checked
        my $expr;
        my ($case, $regex, $fileOnly) = split(/\-/, $$refFilters{$i}{'Flags'});
        if (!$regex) { $expr = quotemeta($$refFilters{$i}{'SearchStr'}); }
        else         { $expr = $$refFilters{$i}{'SearchStr'};            }
        if (!$fileOnly and
            ((!$case and $path =~ /$expr/i) or
             ($case and $path =~ /$expr/))) {
          # Match and next operator is OR
          if (exists($$refFilters{$i+1}{'Operator'}) and $$refFilters{$i+1}{'Operator'} eq $STR{'OR'}) {
            return(1);
          } else { $match = 1; }
        # Don't match and operator is AND
        } elsif (exists($$refFilters{$i+1}{'Operator'}) and $$refFilters{$i+1}{'Operator'} eq $STR{'AND'}) { return(0); }
      # Filter size, Last accessed or Last modified apply to files only
      } elsif (($$refFilters{$i}{'Type'} eq $STR{'rbFiltersSize'}       or
                $$refFilters{$i}{'Type'} eq $STR{'rbFiltersLastAccess'} or
                $$refFilters{$i}{'Type'} eq $STR{'rbFiltersLastModif'}) and
               ((exists($$refFilters{$i+1}{'Operator'}) and $$refFilters{$i+1}{'Operator'} eq $STR{'AND'}) or
                ($$refFilters{$i}{'Operator'} ne $STR{'OR'}))) {
        return(0);
      }
    }
    
  # Path is a file
  } elsif (!$onlyFolders) {
    for (my $i = 1; $i <= $nbrFilters; $i++) {
      my $matchTmp = 0;
      # Contains filter
      if      ($$refFilters{$i}{'Type'} eq $STR{'rbFiltersContains'}) {
        my $expr;
        my ($case, $regex, $fileOnly) = split(/\-/, $$refFilters{$i}{'Flags'});
        if (!$regex) { $expr = quotemeta($$refFilters{$i}{'SearchStr'}); }
        else         { $expr = $$refFilters{$i}{'SearchStr'};            }
        my $relPath = $path =~ s/\Q$dir\E\\//r;
        if ($fileOnly) { $relPath = $file; }
        if ((!$case and $path =~ /$expr/i) or ($case and $path =~ /$expr/)) {
          $matchTmp = 1;
        } else { $matchTmp = 0; }
      # File size filter
      } elsif ($$refFilters{$i}{'Type'} eq $STR{'rbFiltersSize'}) {
        if (&cmpFileSize($path, $$refFilters{$i}{'SearchStr'}, $$refFilters{$i}{'TypeOp'})) {
          $matchTmp = 1;
        } else { $matchTmp = 0; }
      # Filter: Last accessed or Last modified
      } elsif ($$refFilters{$i}{'Type'} eq $STR{'rbFiltersLastAccess'} or $$refFilters{$i}{'Type'} eq $STR{'rbFiltersLastModif'}) {
        my $cmpDateUT;
        if ($$refFilters{$i}{'Type'} eq $STR{'rbFiltersLastAccess'}) { $cmpDateUT = (stat($path))[8]; }
        else                                                         { $cmpDateUT = (stat($path))[9]; }
        if (&cmpDates($path, $$refFilters{$i}{'DateUT'}, $cmpDateUT, $$refFilters{$i}{'TypeOp'})) {
          $matchTmp = 1;
        } else { $matchTmp = 0; }
      }
      
      # Match
      if ($matchTmp and exists($$refFilters{$i+1}{'Operator'})) {
        # Next operator is OR
        if ($$refFilters{$i+1}{'Operator'} eq $STR{'OR'}) { return(1);  } # No need to check other filter
        else                                              { $match = 1; }
      # Don't match
      } elsif (!$matchTmp) {
        # Next or actual operator is AND
        if ((exists($$refFilters{$i+1}{'Operator'}) and
             ($$refFilters{$i+1}{'Operator'} eq $STR{'AND'}) or
              ($$refFilters{$i}{'Operator'} eq $STR{'AND'}))) { return(0); } # No need to check other filter
        else { $match = 0; }
      } else { $match = $matchTmp; }
    }
  }
  
  if ($match) { return(1); }
  else        { return(0); }

}  #--- End testFilters

#--------------------------#
sub cmpDates
#--------------------------#
{
  # Local variables
  my ($filePath, $selDateUT, $cmpDateUT, $dateOp) = @_;
  
  # For $cmpDateUT, Keep only date
  my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = localtime($cmpDateUT);
  my $cmpDateUTR = timelocal(0,0,0,$mday,$mon,$year); # Store in Unixtime format
  
  if ($dateOp eq $STR{'Before'} and $cmpDateUTR  < $selDateUT) { return(1); }
  if ($dateOp eq $STR{'Equal'}  and $cmpDateUTR == $selDateUT) { return(1); }
  if ($dateOp eq $STR{'After'}  and $cmpDateUTR  > $selDateUT) { return(1); }
  
  return(0);

}  #--- End cmpDates

#--------------------------#
sub cmpFileSize
#--------------------------#
{
  # Local variables
  my ($filePath, $searchStr, $sizeOp) = @_;
  my $fileSize = (stat($filePath))[7];
  my ($cmpSize, $sizeUnit) = split(/ /, $searchStr);

  # Round down file size
  if    ($sizeUnit eq $STR{'b'} ) { $fileSize = $fileSize; }
  elsif ($sizeUnit eq $STR{'Kb'}) { $fileSize = $fileSize / 1024; }
  elsif ($sizeUnit eq $STR{'Mb'}) { $fileSize = $fileSize / 1024 / 1024; }
  elsif ($sizeUnit eq $STR{'Gb'}) { $fileSize = $fileSize / 1024 / 1024 / 1024; }
  $fileSize = sprintf("%.0f", $fileSize);

  if ($sizeOp eq $STR{'Smaller'} and $fileSize  < $cmpSize) { return(1); }
  if ($sizeOp eq $STR{'Equal'}   and $fileSize == $cmpSize) { return(1); }
  if ($sizeOp eq $STR{'Bigger'}  and $fileSize  > $cmpSize) { return(1); }
  
  return(0);

}  #--- End cmpFileSize

#--------------------------#
sub listFilesReport
#--------------------------#
{
  # Local variables
  my $refListFiles   = shift;
  my $nbrFiles       = scalar(keys %{$refListFiles});
  my $logging        = 0;
  my $logFile;
  my $fhLog;
  
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  
  if ($win->tfReportDir->Text() and -d $win->tfReportDir->Text()) {
    # Show progress
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
      
    # Options
    my $chListFilesOptFP    = $win->chListFilesOptFP->Checked();          # Full path
    my $chListFilesOptFN    = $win->chListFilesOptFN->Checked();          # Filename
    my $chListFilesHV1      = $winHashVal->chListFilesHV1->Checked();     # MD5
    my $chListFilesHV2      = $winHashVal->chListFilesHV2->Checked();     # SHA1
    my $chListFilesHV3      = $winHashVal->chListFilesHV3->Checked();     # SHA256
    my $chListFilesHV4      = $winHashVal->chListFilesHV4->Checked();     # SHA512
    my $chListFilesFD1      = $winFileDetails->chListFilesFD1->Checked(); # File size
    my $chListFilesFD2      = $winFileDetails->chListFilesFD2->Checked(); # Last accessed
    my $chListFilesFD3      = $winFileDetails->chListFilesFD3->Checked(); # Last modified
    my $chListFilesOptNbrL  = $win->chListFilesOptNbrL->Checked();        # Number of lines
    
    # HTML format
    my $formatReport   = $win->cbReportFormat->GetCurSel();
    my ($reportFilename, $nbrError);
    if      ($formatReport == 1) {
      ($reportFilename, $nbrError) = &writeListFilesReportHTML( $refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptFN,
                                                                $chListFilesHV1, $chListFilesHV2, $chListFilesHV3, $chListFilesHV4,
                                                                $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrL,
                                                                $logging, $fhLog);
    # XLSX format
    } elsif ($formatReport == 2) {
      ($reportFilename, $nbrError) = &writeListFilesReportXLSX( $refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptFN,
                                                                $chListFilesHV1, $chListFilesHV2, $chListFilesHV3, $chListFilesHV4,
                                                                $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrL,
                                                                $logging, $fhLog);
    # Text format
    } else {
      ($reportFilename, $nbrError) = &writeListFilesReportTXT(  $refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptFN,
                                                                $chListFilesHV1, $chListFilesHV2, $chListFilesHV3, $chListFilesHV4,
                                                                $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrL,
                                                                $logging, $fhLog);
    }
     
    # Open report
    if ($win->chOpenReport->Checked()) { $win->ShellExecute('open', $reportFilename,'','',1); }
    
    # Logging
    if ($logging) {
      close($fhLog);
      if ($nbrError) {
        my $answer = Win32::GUI::MessageBox($win, $STR{'EndProcess1'}.' '.$nbrError." $STR{'EndProcess2'} $STR{'EndProcess3'}", $STR{'Process'}, 0x40024);
        # Open the log
        if ($answer == 6) { $win->ShellExecute('open', $logFile,'','',1); }
      }
    }
  }

}  #--- End listFilesReport

#--------------------------#
sub writeListFilesReportHTML
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptFN, $chListFilesHV1, $chListFilesHV2, $chListFilesHV3,
      $chListFilesHV4, $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrL, $logging, $fhLog,) = @_;
  my $searchedFolder = $win->tfInput->Text()."\\";
  my $nbrError       = 0;
  my $curr           = 0;
  
  # Write the report
  my ($s,$min,$h,$d,$m,$y) = (&date(time))[0,1,2,3,4,5];
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'."$y$m$d\_$h$min$s".'.html'; # Ex.: XL-FileTools report-20160520_082215.html
  if (open(my $fhReport, '>', $reportFilename)) {
    flock($fhReport, 2);
    print $fhReport "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\">\n";
    print $fhReport "<html>\n<head>\n<title>XL-FileTools $STR{'report'} $y-$m-$d $h:$min:$s</title>\n";
    print $fhReport "<style>\n";
    print $fhReport "table, td { border-collapse: collapse; border: 1px solid black; padding: 5px; }\n";
    print $fhReport "td { font-size:11pt; vertical-align: top; white-space: nowrap; }\n";
    print $fhReport ".header { text-align: center; font-weight: bold }\n";
    print $fhReport "</style>\n";
    print $fhReport "</head>\n";
    print $fhReport "<body style=\"font-family: Calibri, Verdana, Arial;\">\n";
    print $fhReport "<table align=\"center\">\n";
    
    # File Header
    if (!$win->chListFilesOptNH->Checked()) {
      print $fhReport "<tr>\n";
      if ($chListFilesOptFP)    { print $fhReport "<td class=\"header\">$STR{'chListFilesOptFP'}</td>\n";    } # Full path
      if ($chListFilesOptFN)    { print $fhReport "<td class=\"header\">$STR{'chListFilesOptFN'}</td>\n";    } # Filename
      if ($chListFilesHV1)      { print $fhReport "<td class=\"header\">$STR{'chListFilesHV1'}</td>\n";      } # MD5
      if ($chListFilesHV2)      { print $fhReport "<td class=\"header\">$STR{'chListFilesHV2'}</td>\n";      } # SHA1
      if ($chListFilesHV3)      { print $fhReport "<td class=\"header\">$STR{'chListFilesHV3'} </td>\n";     } # SHA256
      if ($chListFilesHV4)      { print $fhReport "<td class=\"header\">$STR{'chListFilesHV4'}</td>\n";      } # SHA512
      if ($chListFilesFD1)      { print $fhReport "<td class=\"header\">$STR{'rbFiltersSize'}</td>\n";       } # File size
      if ($chListFilesFD2)      { print $fhReport "<td class=\"header\">$STR{'rbFiltersLastAccess'}</td>\n"; } # Last accessed
      if ($chListFilesFD3)      { print $fhReport "<td class=\"header\">$STR{'rbFiltersLastModif'}</td>\n";  } # Last modified
      if ($chListFilesOptNbrL)  { print $fhReport "<td class=\"header\">$STR{'chListFilesOptNbrL'}</td>\n";  } # Number of lines
      print $fhReport "</tr>\n";
    }
    foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
      if ($file) {
        if    (-d $file and $win->chListFilesOptNF->Checked()) { } # No folder
        elsif (-d $file and $file eq $searchedFolder         ) { } # Searched folder
        else {
          my (@stats);
          if (!-d $file and ($chListFilesFD1 or $chListFilesFD2 or $chListFilesFD3)) { (@stats) = stat($file); } # File details
          $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
          print $fhReport "<tr>\n";
          # Full path
          if ($chListFilesOptFP) { print $fhReport "<td>$file</td>\n"; }
          # Filename
          if ($chListFilesOptFN) {
            if (!-d $file) { # For file only
              my @parts = split(/\\/, $file);
              my $filename = pop(@parts);
              print $fhReport "<td>$filename</td>\n";
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # MD5
          if ($chListFilesHV1) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
              if (my $digestMD5 = file_md5_hex($file)) {
                if ($CONFIG{'HASH_LOWERCASE'}) { print $fhReport "<td>".lc($digestMD5)."</td>\n"; }
                else                           { print $fhReport "<td>".uc($digestMD5)."</td>\n"; }
              } else {
                print $fhReport "<td>&nbsp;</td>\n";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n"; }
              }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # SHA1
          if ($chListFilesHV2) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
              if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
                if ($CONFIG{'HASH_LOWERCASE'}) { print $fhReport "<td>".lc($digestSHA1)."</td>\n"; }
                else                           { print $fhReport "<td>".uc($digestSHA1)."</td>\n"; }
              } else {
                print $fhReport "<td></td>\n";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n"; }
              }
            } else { print $fhReport "<td></td>\n"; }
          }
          # SHA256
          if ($chListFilesHV3) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...');
              if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
                if ($CONFIG{'HASH_LOWERCASE'}) { print $fhReport "<td>".lc($digestSHA256)."</td>\n"; }
                else                           { print $fhReport "<td>".uc($digestSHA256)."</td>\n"; }
              } else {
                print $fhReport "<td></td>\n";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA256'}: $file\n"; }
              }
            } else { print $fhReport "<td></td>\n"; }
          }
          # SHA512
          if ($chListFilesHV4) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...');
              if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
                if ($CONFIG{'HASH_LOWERCASE'}) { print $fhReport "<td>".lc($digestSHA512)."</td>\n"; }
                else                           { print $fhReport "<td>".uc($digestSHA512)."</td>\n"; }
              } else {
                print $fhReport "<td>&nbsp;</td>\n";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA512'}: $file</td>\n"; }
              }
            } else { print $fhReport "<td>\t"; }
          }
          # File size
          if ($chListFilesFD1) {
            if (!-d $file) { # For file only
              if ($stats[7]) { print $fhReport "<td>$stats[7]</td>\n"; }
              else           { print $fhReport "<td>&nbsp;</td>\n";          }
            }
          }
          # Last accessed
          if ($chListFilesFD2) {
            if (!-d $file) { # For file only
              if ($stats[8]) {
                my ($s,$min,$h,$d,$m,$y)  = (&date($stats[8]))[0,1,2,3,4,5];
                print $fhReport "<td>$y-$m-$d $h:$min:$s</td>\n";
              } else { print $fhReport "<td>&nbsp;</td>\n"; }
            }
          }
          # Last modified
          if ($chListFilesFD3) {
            if (!-d $file) { # For file only
              if ($stats[9]) {
                my ($s,$min,$h,$d,$m,$y)  = (&date($stats[9]))[0,1,2,3,4,5];
                print $fhReport "<td>$y-$m-$d $h:$min:$s</td>\n";
              } else { print $fhReport "<td>&nbsp;</td>\n"; }
            }
          }
          # Number of lines
          if ($chListFilesOptNbrL) {
            if (-T $file) { # For text file only
              $win->lblPbCurr->Text($STR{'NumberLines'}.': '.$file.'...');
              my $nbrLines = 0;
              if (open my $fh, '<', $file) {
                while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                close($fh);
              } else {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n"; }
              }
              if ($nbrLines) { print $fhReport "<td>$nbrLines</td>\n"; }
              else { print $fhReport "<td>0</td>\n"; }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          
          print $fhReport "</tr>\n";
        }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrFiles");
      $win->pb->StepIt();
    }
    
    print $fhReport "</table>\n</body>\n</html>\n";
    close($fhReport);
    return($reportFilename, $nbrError);
  }
  
}  #--- End writeListFilesReportHTML

#--------------------------#
sub writeListFilesReportXLSX
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptFN, $chListFilesHV1, $chListFilesHV2, $chListFilesHV3,
      $chListFilesHV4, $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrL, $logging, $fhLog,) = @_;
  my $searchedFolder = $win->tfInput->Text()."\\";
  my $nbrError       = 0;
  my $curr           = 0;
  
  # Write the report
  my ($s,$min,$h,$d,$m,$y) = (&date(time))[0,1,2,3,4,5];
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'."$y$m$d\_$h$min$s".'.xlsx'; # Ex.: XL-FileTools report-20160520_082215.xlsx
  if (my $excel = Excel::Writer::XLSX->new($reportFilename)) {
    if (my $sheet = $excel->add_worksheet($STR{'lblFunctions1T'})) {
      # Column size
      my $maxWidthCol1  = length($STR{'chListFilesOptFP'});
      my $maxWidthCol2  = length($STR{'chListFilesOptFN'});
      my $maxWidthCol3  = length($STR{'chListFilesHV1'});
      my $maxWidthCol4  = length($STR{'chListFilesHV2'});
      my $maxWidthCol5  = length($STR{'chListFilesHV3'});
      my $maxWidthCol6  = length($STR{'chListFilesHV4'});
      my $maxWidthCol7  = length($STR{'rbFiltersSize'});
      my $maxWidthCol8  = length($STR{'rbFiltersLastAccess'});
      my $maxWidthCol9  = length($STR{'rbFiltersLastModif'});
      my $maxWidthCol10 = length($STR{'chListFilesOptNbrL'});
  
      # Header
      my $i = 0;
      if (!$win->chListFilesOptNH->Checked()) {
        my $formatHeader = $excel->add_format();
        $formatHeader->set_bold();
        $formatHeader->set_align( 'center' );
        $formatHeader->set_align( 'vcenter' );
        my $j = 0; # Column no
        if ($chListFilesOptFP)    { $sheet->write( 0, $j, $STR{'chListFilesOptFP'}    , $formatHeader ); $j++; } # Full path
        if ($chListFilesOptFN)    { $sheet->write( 0, $j, $STR{'chListFilesOptFN'}    , $formatHeader ); $j++; } # Filename
        if ($chListFilesHV1)      { $sheet->write( 0, $j, $STR{'chListFilesHV1'}      , $formatHeader ); $j++; } # MD5
        if ($chListFilesHV2)      { $sheet->write( 0, $j, $STR{'chListFilesHV2'}      , $formatHeader ); $j++; } # SHA1
        if ($chListFilesHV3)      { $sheet->write( 0, $j, $STR{'chListFilesHV3'}      , $formatHeader ); $j++; } # SHA256
        if ($chListFilesHV4)      { $sheet->write( 0, $j, $STR{'chListFilesHV4'}      , $formatHeader ); $j++; } # SHA512
        if ($chListFilesFD1)      { $sheet->write( 0, $j, $STR{'rbFiltersSize'}       , $formatHeader ); $j++; } # File size
        if ($chListFilesFD2)      { $sheet->write( 0, $j, $STR{'rbFiltersLastAccess'} , $formatHeader ); $j++; } # Last accessed
        if ($chListFilesFD3)      { $sheet->write( 0, $j, $STR{'rbFiltersLastModif'}  , $formatHeader ); $j++; } # Last modified
        if ($chListFilesOptNbrL)  { $sheet->write( 0, $j, $STR{'chListFilesOptNbrL'}  , $formatHeader ); $j++; } # Number of lines
        $i++;
      }
      foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
        my $j = 0; # Column no
        if ($file) {
          if    (-d $file and $win->chListFilesOptNF->Checked()) { } # No folder
          elsif (-d $file and $file eq $searchedFolder         ) { } # Searched folder
          else {
            my (@stats);
            if (!-d $file and ($chListFilesFD1 or $chListFilesFD2 or $chListFilesFD3)) { (@stats) = stat($file); } # File details
            $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
            # Full path
            if ($chListFilesOptFP) {
              $sheet->write_string($i, $j, $file);
              $j++;
              if (length($file) > $maxWidthCol1) { $maxWidthCol1 = length($file); }
            }
            # Filename
            if ($chListFilesOptFN) {
              if (!-d $file) { # For file only
                my @parts = split(/\\/, $file);
                my $filename = pop(@parts);
                $sheet->write_string($i, $j, $filename);
                if (length($filename) > $maxWidthCol2) { $maxWidthCol2 = length($filename); }
              }
              $j++;
            }
            # MD5
            if ($chListFilesHV1) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
                if (my $digestMD5 = file_md5_hex($file)) {
                  if ($CONFIG{'HASH_LOWERCASE'}) { $sheet->write_string($i, $j, lc($digestMD5)); }
                  else                           { $sheet->write_string($i, $j, uc($digestMD5)); }
                  if (length($digestMD5) > $maxWidthCol3) { $maxWidthCol3 = length($digestMD5); }
                } else {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n"; }
                }
              }
              $j++;
            }
            # SHA1
            if ($chListFilesHV2) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
                if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
                  if ($CONFIG{'HASH_LOWERCASE'}) { $sheet->write_string($i, $j, lc($digestSHA1)); }
                  else                           { $sheet->write_string($i, $j, uc($digestSHA1)); }
                  if (length($digestSHA1) > $maxWidthCol4) { $maxWidthCol4 = length($digestSHA1); }
                } else {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n"; }
                }
              }
              $j++;
            }
            # SHA256
            if ($chListFilesHV3) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...');
                if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
                  if ($CONFIG{'HASH_LOWERCASE'}) { $sheet->write_string($i, $j, lc($digestSHA256)); }
                  else                           { $sheet->write_string($i, $j, uc($digestSHA256)); }
                  if (length($digestSHA256) > $maxWidthCol5) { $maxWidthCol5 = length($digestSHA256); }
                  
                } else {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA256'}: $file\n"; }
                }
              }
              $j++;
            }
            # SHA512
            if ($chListFilesHV4) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...');
                if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
                  if ($CONFIG{'HASH_LOWERCASE'}) { $sheet->write_string($i, $j, lc($digestSHA512)); }
                  else                           { $sheet->write_string($i, $j, uc($digestSHA512)); }
                  if (length($digestSHA512) > $maxWidthCol6) { $maxWidthCol6 = length($digestSHA512); }
                } else {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA512'}: $file\n"; }
                }
              }
              $j++;
            }
            # File size
            if ($chListFilesFD1) {
              if (!-d $file) { # For file only
                if ($stats[7]) {
                  $sheet->write_string($i, $j, $stats[7]);
                  if (length($stats[7]) > $maxWidthCol7) { $maxWidthCol7 = length($stats[7]); }
                }
              }
              $j++;
            }
            # Last accessed
            if ($chListFilesFD2) {
              if (!-d $file) { # For file only
                if ($stats[8]) {
                  my ($s,$min,$h,$d,$m,$y)  = (&date($stats[8]))[0,1,2,3,4,5];
                  $sheet->write_string($i, $j, "$y-$m-$d $h:$min:$s");
                  if (length("$y-$m-$d $h:$min:$s") > $maxWidthCol8) { $maxWidthCol8 = length("$y-$m-$d $h:$min:$s"); }
                }
              }
              $j++;
            }
            # Last modified
            if ($chListFilesFD3) {
              if (!-d $file) { # For file only
                if ($stats[9]) {
                  my ($s,$min,$h,$d,$m,$y)  = (&date($stats[9]))[0,1,2,3,4,5];
                  $sheet->write_string($i, $j, "$y-$m-$d $h:$min:$s");
                  if (length("$y-$m-$d $h:$min:$s") > $maxWidthCol9) { $maxWidthCol9 = length("$y-$m-$d $h:$min:$s"); }
                }
              }
              $j++;
            }
            # Number of lines
            if ($chListFilesOptNbrL) {
              if (-T $file) { # For text file only
                $win->lblPbCurr->Text($STR{'NumberLines'}.': '.$file.'...');
                my $nbrLines = 0;
                if (open my $fh, '<', $file) {
                  while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                  close($fh);
                } else {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n"; }
                }
                if ($nbrLines) {
                  $sheet->write_string($i, $j, $nbrLines);
                  if (length($nbrLines) > $maxWidthCol10) { $maxWidthCol10 = length($nbrLines); }
                } else { $sheet->write_string($i, $j, 0); }
              }
              $j++;
            }
            $i++;
          }
        }
        
        # Progress
        $curr++;
        $win->lblPbCount->Text("$curr / $nbrFiles");
        $win->pb->StepIt();
      }
      
      # Set column width
      my $j = 0;
      if ($chListFilesOptFP)    { $sheet->set_column($j, $j, $maxWidthCol1);  $j++; } # Full path
      if ($chListFilesOptFN)    { $sheet->set_column($j, $j, $maxWidthCol2);  $j++; } # Filename
      if ($chListFilesHV1)      { $sheet->set_column($j, $j, $maxWidthCol3);  $j++; } # MD5
      if ($chListFilesHV2)      { $sheet->set_column($j, $j, $maxWidthCol4);  $j++; } # SHA1
      if ($chListFilesHV3)      { $sheet->set_column($j, $j, $maxWidthCol5);  $j++; } # SHA256
      if ($chListFilesHV4)      { $sheet->set_column($j, $j, $maxWidthCol6);  $j++; } # SHA512
      if ($chListFilesFD1)      { $sheet->set_column($j, $j, $maxWidthCol7);  $j++; } # File size
      if ($chListFilesFD2)      { $sheet->set_column($j, $j, $maxWidthCol8);  $j++; } # Last accessed
      if ($chListFilesFD3)      { $sheet->set_column($j, $j, $maxWidthCol9);  $j++; } # Last modified
      if ($chListFilesOptNbrL)  { $sheet->set_column($j, $j, $maxWidthCol10); $j++; } # Number of lines
    }
    
    $excel->close(); # Close the file
    return($reportFilename, $nbrError);
  }
  
}  #--- End writeListFilesReportXLSX

#--------------------------#
sub writeListFilesReportTXT
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptFN, $chListFilesHV1, $chListFilesHV2, $chListFilesHV3,
      $chListFilesHV4, $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrL, $logging, $fhLog,) = @_;
  my $searchedFolder = $win->tfInput->Text()."\\";
  my $nbrError       = 0;
  my $curr           = 0;
  
  # File Header
  my $header;
  if (!$win->chListFilesOptNH->Checked()) {
    if ($chListFilesOptFP)    { $header .= $STR{'chListFilesOptFP'}     . "\t"; } # Full path
    if ($chListFilesOptFN)    { $header .= $STR{'chListFilesOptFN'}     . "\t"; } # Filename
    if ($chListFilesHV1)      { $header .= $STR{'chListFilesHV1'}       . "\t"; } # MD5
    if ($chListFilesHV2)      { $header .= $STR{'chListFilesHV2'}       . "\t"; } # SHA1
    if ($chListFilesHV3)      { $header .= $STR{'chListFilesHV3'}       . "\t"; } # SHA256
    if ($chListFilesHV4)      { $header .= $STR{'chListFilesHV4'}       . "\t"; } # SHA512
    if ($chListFilesFD1)      { $header .= $STR{'rbFiltersSize'}        . "\t"; } # File size
    if ($chListFilesFD2)      { $header .= $STR{'rbFiltersLastAccess'}  . "\t"; } # Last accessed
    if ($chListFilesFD3)      { $header .= $STR{'rbFiltersLastModif'}   . "\t"; } # Last modified
    if ($chListFilesOptNbrL)  { $header .= $STR{'chListFilesOptNbrL'}   . "\t"; } # Number of lines
    chop($header);
  }
  
  # Write the report
  my ($s,$min,$h,$d,$m,$y) = (&date(time))[0,1,2,3,4,5];
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'."$y$m$d\_$h$min$s".'.txt'; # Ex.: XL-FileTools report-20160520_082215.txt
  if (open(my $fhReport, '>', $reportFilename)) {
    flock($fhReport, 2);
    if (!$win->chListFilesOptNH->Checked()) { print $fhReport "$header\n"; }
    foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
      if ($file) {
        if    (-d $file and $win->chListFilesOptNF->Checked()) { } # No folder
        elsif (-d $file and $file eq $searchedFolder         ) { } # Searched folder
        else {
          my (@stats);
          if (!-d $file and ($chListFilesFD1 or $chListFilesFD2 or $chListFilesFD3)) { (@stats) = stat($file); } # File details
          $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
          my $newLine;
          # Full path
          if ($chListFilesOptFP) { $newLine .= "$file\t"; }
          # Filename
          if ($chListFilesOptFN) {
            if (!-d $file) { # For file only
              my @parts = split(/\\/, $file);
              my $filename = pop(@parts);
              $newLine .= "$filename\t";
            } else { $newLine .= "\t"; }
          }
          # MD5
          if ($chListFilesHV1) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
              if (my $digestMD5 = file_md5_hex($file)) {
                if ($CONFIG{'HASH_LOWERCASE'}) { $newLine .= lc($digestMD5) ."\t"; }
                else                           { $newLine .= uc($digestMD5) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n"; }
              }
            } else { $newLine .= "\t"; }
          }
          # SHA1
          if ($chListFilesHV2) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
              if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
                if ($CONFIG{'HASH_LOWERCASE'}) { $newLine .= lc($digestSHA1) ."\t"; }
                else                           { $newLine .= uc($digestSHA1) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n"; }
              }
            } else { $newLine .= "\t"; }
          }
          # SHA256
          if ($chListFilesHV3) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...');
              if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
                if ($CONFIG{'HASH_LOWERCASE'}) { $newLine .= lc($digestSHA256) ."\t"; }
                else                           { $newLine .= uc($digestSHA256) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA256'}: $file\n"; }
              }
            } else { $newLine .= "\t"; }
          }
          # SHA512
          if ($chListFilesHV4) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...');
              if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
                if ($CONFIG{'HASH_LOWERCASE'}) { $newLine .= lc($digestSHA512) ."\t"; }
                else                           { $newLine .= uc($digestSHA512) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA512'}: $file\n"; }
              }
            } else { $newLine .= "\t"; }
          }
          # File size
          if ($chListFilesFD1) {
            if (!-d $file) { # For file only
              if ($stats[7]) { $newLine .= "$stats[7]\t"; }
              else           { $newLine .= "\t";          }
            }
          }
          # Last accessed
          if ($chListFilesFD2) {
            if (!-d $file) { # For file only
              if ($stats[8]) {
                my ($s,$min,$h,$d,$m,$y)  = (&date($stats[8]))[0,1,2,3,4,5];
                $newLine .= "$y-$m-$d $h:$min:$s\t";
              } else { $newLine .= "\t"; }
            }
          }
          # Last modified
          if ($chListFilesFD3) {
            if (!-d $file) { # For file only
              if ($stats[9]) {
                my ($s,$min,$h,$d,$m,$y)  = (&date($stats[9]))[0,1,2,3,4,5];
                $newLine .= "$y-$m-$d $h:$min:$s\t";
              } else { $newLine .= "\t"; }
            }
          }
          # Number of lines
          if ($chListFilesOptNbrL) {
            if (-T $file) { # For text file only
              $win->lblPbCurr->Text($STR{'NumberLines'}.': '.$file.'...');
              my $nbrLines = 0;
              if (open my $fh, '<', $file) {
                while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                close($fh);
              } else {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n"; }
              }
              if ($nbrLines) { $newLine .= $nbrLines ."\t"; }
              else { $newLine .= "0\t"; }
            } else { $newLine .= "\t"; }
          }
          
          # Print line
          if ($newLine) {
            chop($newLine);
            print $fhReport "$newLine\n";
          }
        }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrFiles");
      $win->pb->StepIt();
    }
    
    close($fhReport);
    return($reportFilename, $nbrError);
  }
  
}  #--- End writeListFilesReportTXT

#--------------------------#
sub listExtReport
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $nbrFiles     = scalar(keys %{$refListFiles});
  my $dirReport    = $win->tfReportDir->Text();
  my $count        = 0;
  my %listExtensions;
  
  if ($dirReport) {
    # Show progress
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
    $win->lblPbCurr->Text($STR{'ListingExtensions'}.'...');
    
    # List extensions
    foreach my $file (keys %{$refListFiles}) {
      if (!-d $file) { # Not a directory
        my $filename = (split(/\\/, $file))[-1];
        if ($filename =~ /\./) { # There is an extension
          my $extension   = (split(/\./, $file))[-1];
          my $extensionUC = uc($extension);
          if (exists($listExtensions{$extensionUC})) { $listExtensions{$extensionUC}++;   }
          else                                       { $listExtensions{$extensionUC} = 1; }
        } else { # No extension
          if (exists($listExtensions{'*No extension'})) { $listExtensions{'*No extension'}++;   }
          else                                          { $listExtensions{'*No extension'} = 1; }
        }
      }
      $count++;
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    }
      
    # Write the report
    $win->lblPbCurr->Text($STR{'WritingReport'}.'...');
    my ($s,$min,$h,$d,$m,$y) = (&date(time))[0,1,2,3,4,5];
    my $reportFilename = $dirReport."\\"."XL-FileTools ".$STR{'report'}.'-'."$y$m$d\_$h$min$s".'.txt'; # Ex.: XL-FileTools report-20160520_082215.txt
    if (open(my $fhReport, '>', $reportFilename)) {
      flock($fhReport, 2);
      print $fhReport "$STR{'Extension'}\t$STR{'Count'}\n";
      foreach my $ext (reverse sort { $listExtensions{$a} <=> $listExtensions{$b} } keys %listExtensions) {
        print $fhReport "$ext\t".$listExtensions{$ext}."\n" ;
      }
      close($fhReport);
    
      # Open report
      if ($win->chOpenReport->Checked()) { $win->ShellExecute('open', $reportFilename,'','',1); }
    }
  }
  
}  #--- End listExtReport

#--------------------------#
sub copyMove
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift; # If 0, preview mode
  my $dstFolder    = $win->tfDestinationDir->Text();
  my $logging      = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->chUseDestDirCM->Checked() and -d $dstFolder) {
      $logFile = $dstFolder;
    } else {
      if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
        $logFile = $winConfig->tfLoggingDir->Text();
      } else { $logFile = $USERDIR; }
    }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  
  if ($dstFolder) {
    # Local variales
    my $nbrFiles     = scalar(keys %{$refListFiles});
    my $optCopyTree  = $win->chCopyTree->Checked();
    my $optDuplicate = $win->chCopyRemDouble->Checked();
    my $selFunctCopy = $win->rbCopy->Checked();
    my $dir          = $win->tfInput->Text();
    my $nbrCopyMove  = 0;
    my $count        = 0;
    my $srcDriveLetter;
    my $sameVolume   = 1;
    my $totalSize;
    my %listMD5;
    my %resListFiles;
    my %listSubFolders;
    my %movedDirs;
    
    # Show progress
    if ($execute) {
      $win->pb->SetRange(0, $nbrFiles);
      $win->pb->SetPos(0);
      $win->pb->SetStep(1);
      $win->lblPbCount->Text("0 / $nbrFiles");
      $win->lblPbCurr->Text($STR{'PreProcessing'}.'...');
    } else { # Preview mode
      $winPb->pbWinPb->SetRange(0, $nbrFiles);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->lblCount->Text("0 / $nbrFiles");
      $winPb->lblPbCurr->Text($STR{'PreProcessing'}.'...');
    }
  
    # Pre-process list of files
    #   - Remove folders from the list (folders)
    #   - If Exclude duplicates option is checked, calculate MD5 hash for each file and remove duplicate
    #   - Calculate total size to be copied or moved
    #   - Set destination path
    #   - Note source drive letter
    foreach my $file (keys %{$refListFiles}) {
      # It's a directory, remove it
      if (-d $file) {
        my $dstPath;
        if ($optCopyTree) { # If we duplicate tree structure
          $dstPath = $file =~ s/\Q$dir//r;
          $dstPath = $dstFolder . $dstPath;
          $listSubFolders{$dstPath} = 1;
        }
        delete($$refListFiles{$file});
        # If moving, remember moved dir
        if (!$selFunctCopy and $file ne "$dir\\" and !exists($movedDirs{$file})) { $movedDirs{$file} = 1; }
        next;
      } else {
        # It's a file and we must exclude duplicates
        if ($optDuplicate and my $digestMD5 = file_md5_hex($file)) {
          if (exists($listMD5{$digestMD5})) { # Duplicate, remove it
            delete($$refListFiles{$file});
            if ($execute) { if ($logging) { print $fhLog "$STR{'Duplicate'} $STR{'Removed'}: $file\n"; } }
            else { # For preview, mark this file as removed-duplicate
              if ($optCopyTree and $dir) { # Duplicate tree structure
                my $dstPath = $file =~ s/\Q$dir//r;
                $dstPath = $dstFolder . $dstPath;
                $resListFiles{$dstPath} = 3;
              } else {                     # Files only
                my $filename = (split(/\\/, $file))[-1];
                my $dstPath  = $dstFolder . "\\" . $filename;
                $resListFiles{$dstPath} = 3;
              }
            }
            next;
          } else { $listMD5{$digestMD5} = 1; }
        }
        # Calculate size
        $totalSize += (stat($file))[7];
        # Set destination path
        if ($optCopyTree and $dir) {              # Duplicate tree structure
          my $dstPath = $file =~ s/\Q$dir//r;
          $dstPath = $dstFolder . $dstPath;
          $$refListFiles{$file} = $dstPath;
        } else {                                  # Files only
          my $filename = (split(/\\/, $file))[-1];
          my $dstPath  = $dstFolder . "\\" . $filename;
          $$refListFiles{$file} = $dstPath;
        }
        
        # Note source drive letter
        if (!$srcDriveLetter and $file =~ /^([a-zA-Z])\:/i) { $srcDriveLetter = $1; }
      }
      $count++;
      if ($execute) {
        $win->lblPbCount->Text("$count / $nbrFiles");
        $win->pb->StepIt();
      } else { # Preview mode
        $winPb->lblCount->Text("$count / $nbrFiles");
        $winPb->pbWinPb->StepIt();
      }
    }
    
    # Check if there is enough space on destination volume
    # Not important if we move file on the same volume
    if ($dstFolder =~ /^([a-zA-Z])\:/i) {
      my $dstDriveLetter = $1;
      if ($selFunctCopy or (!$selFunctCopy and $dstDriveLetter ne $srcDriveLetter)) {
        $sameVolume = 0; # Destination is on another volume
        my $freeSpace = (Win32::DriveInfo::DriveSpace("$dstDriveLetter:"))[6];
        # Not enough space
        if ($totalSize and $totalSize >= $freeSpace) {
          # Show an error message and quit
          Win32::GUI::MessageBox($win, $STR{'errSpace'}, $STR{'Error'}, 0x40010);
          if ($execute and $logging) {
            print $fhLog "$STR{'Error'}: $STR{'errSpace'}\n";
            close($fhLog);
          }
          return;
        }
      }
      
      # Enough space, we continue
      $nbrFiles = scalar(keys %{$refListFiles});
      
      # Show progress
      if ($execute) {
        $win->pb->SetRange(0, $nbrFiles);
        $win->pb->SetPos(0);
        $win->pb->SetStep(1);
        $win->lblPbCount->Text("0 / $nbrFiles");
        $win->lblPbCurr->Text($STR{'Processing'}.'...');
      } else { # Preview mode
        $winPb->pbWinPb->SetRange(0, $nbrFiles);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->lblCount->Text("0 / $nbrFiles");
        $winPb->lblPbCurr->Text($STR{'Processing'}.'...');
      }
      $count = 0;
      
      # Copy or move file
      foreach my $file (keys %{$refListFiles}) {
        # Copy file
        if ($selFunctCopy) {
          if ($execute) {
            $win->lblPbCurr->Text($STR{'rbCopy'}.': '.$file.'...');
            if (fcopy($file, $$refListFiles{$file})) {
              $nbrCopyMove++;
              if ($logging) { print $fhLog "$STR{'Copied'} $file -> $$refListFiles{$file}\n"; }
            } else {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'Copying'} $file\n"; }
            }
          } else { # Preview mode
            $winPb->lblPbCurr->Text($STR{'rbCopy'}.': '.$file.'...');
            $resListFiles{$$refListFiles{$file}} = 1;
          }
        # Move file
        } else {
          if ($execute) {
            $win->lblPbCurr->Text($STR{'rbMove'}.': '.$file.'...');
            if ($optCopyTree) {
              # Create destination directory if doesn't exist
              my @pathParts = split(/\\/, $$refListFiles{$file});
              pop(@pathParts);
              my $dstPath   = join("\\", @pathParts);
              if (-d $dstPath or (!-d $dstPath and File::Copy::Recursive::pathmk($dstPath))) {
                if ($sameVolume and rename($file, $$refListFiles{$file})) { # Rename if same volume
                  $nbrCopyMove++;
                  if ($logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
                } elsif (!$sameVolume and fmove($file, $$refListFiles{$file})) { # Use Move if different volume
                  $nbrCopyMove++;
                  if ($logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
                } elsif ($execute) {
                  $nbrError++;
                  if ($logging) { print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"; }
                }
              } else {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"; }
              }
            } else {
              if ($sameVolume and rename($file, $$refListFiles{$file})) {
                $nbrCopyMove++;
                if ($execute and $logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
              } elsif (!$sameVolume and fmove($file, $$refListFiles{$file})) { # Use Move if different volume
                $nbrCopyMove++;
                if ($logging) { print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n"; }
              } elsif ($execute) {
                $nbrError++;
                if ($logging) { print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"; }
              }
            }
          } else { # Preview mode
            $winPb->lblPbCurr->Text($STR{'rbMove'}.': '.$file.'...');
            $resListFiles{$$refListFiles{$file}} = 1;
          }
        }
        $count++;
        if ($execute) {
          $win->lblPbCount->Text("$count / $nbrFiles");
          $win->pb->StepIt();
        } else { # Preview mode
          $winPb->lblCount->Text("$count / $nbrFiles");
          $winPb->pbWinPb->StepIt();
        }
      }
      
      # Create empty folders if we duplicate tree structure
      if ($optCopyTree) {
        foreach my $subfolder (sort keys %listSubFolders) {
          if ($execute and !-d $subfolder) { # Folder doesn't exist, create it
            if (File::Copy::Recursive::pathmk($subfolder)) {
              $nbrCopyMove++;
            } else {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'Creating'} $subfolder\n"; }
            }
          }
        }
      }
      
      # Delete moved dir (if empty)
      foreach my $movedDir (reverse sort keys %movedDirs) { rmdir($movedDir); }
    }
    if ($execute) {
      # Open destination folder
      if ($win->chOpenDstDir->Checked() and -d $dstFolder) {
        # Open Window Explorer
        Win32::Process::Create(my $ProcessObj                 ,
                               "$ENV{'WINDIR'}\\explorer.exe" ,
                               "explorer $dstFolder"          ,
                               0                              ,
                               NORMAL_PRIORITY_CLASS          ,
                               ".");
      }
      
      # Final popup
      my $endMsg  = "$STR{'Renaming'} $STR{'Finished'}!\n";
      if ($selFunctCopy) { $endMsg .= "$nbrCopyMove $STR{'Copied2'}\n"; }
      else               { $endMsg .= "$nbrCopyMove $STR{'Moved2'}\n";  }
      $endMsg    .= "$nbrError $STR{'EndErrors'}\n";
      if ($logging) {
        close($fhLog);
        if ($nbrCopyMove or $nbrError) { # If copied/moved files or errors, open the log ?
          $endMsg .= "\n$STR{'OpenLog'} ?";
          my $answer = Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40024);
          # Open the log
          if ($answer == 6) { $win->ShellExecute('open', $logFile,'','',1); }
        } else {
          Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
        }
      } else {
        Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
      }
    } else { return(\%resListFiles, \%listSubFolders); } # Preview
  }

}  #--- End copyMove

#--------------------------#
sub renameFiles
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift; # If 0, preview mode
  my $dirReport    = $win->tfReportDir->Text();
  my $logging      = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    $logging = 1;
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  
  if ($dirReport) {
    # Local variales
    my $nbrFiles   = scalar(keys %{$refListFiles});
    my $dir        = $win->tfInput->Text();
    my $nbrRenamed = 0;
    my $refResListFiles;
    my $refListSubFolders;
    
    # Show progress
    $win->ChangeCursor($HOURGLASS);
    if ($execute) { $win->lblPbCurr->Text($STR{'PreProcessing'}.'...');   }
    else          { $winPb->lblPbCurr->Text($STR{'PreProcessing'}.'...'); } # Preview mode
  
    # Call the right rename function
    if      ($win->rbRenByHash->Checked() ) {
      ($nbrRenamed, $refResListFiles, $nbrError)                     = &renameByHash(   $refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    } elsif ($win->rbRenSort->Checked()   ) {
      ($nbrRenamed, $refResListFiles, $nbrError)                     = &renameBySort(   $refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    } elsif ($win->rbRenReplace->Checked()) {
      ($nbrRenamed, $refResListFiles, $refListSubFolders, $nbrError) = &renameReplaceBy($refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    }
    
    if ($execute) {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $win->lblPbCurr->Text('');
      $win->lblPbCurr->Hide();
      $win->lblPbCount->Text('');
      $win->lblPbCount->Hide();
      $win->pb->SetPos(0);
      $win->pb->Hide();
      $win->btnStop->Hide();
      $win->btnProcess->Show();
      
      # Final popup
      my $endMsg  = "$STR{'Renaming'} $STR{'Finished'}!\n";
      $endMsg    .= "$nbrRenamed $STR{'Renamed2'}\n";
      $endMsg    .= "$nbrError $STR{'EndErrors'}\n";
      if ($logging) {
        close($fhLog);
        if ($nbrRenamed or $nbrError) { # If renamed files or errors, open the log ?
          $endMsg .= "\n$STR{'OpenLog'} ?";
          my $answer = Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40024);
          # Open the log
          if ($answer == 6) { $win->ShellExecute('open', $logFile,'','',1); }
        } else {
          Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
        }
      } else {
        Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040);
      }
    } else { return($refResListFiles, $refListSubFolders); } # Preview mode
  }

}  #--- End renameFiles

#--------------------------#
sub renameByHash
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $hashAlgo   = $win->cbRenByHash->SelectedItem();
  my $nbrRenamed = 0;
  my $count      = 0;
  my $nbrError   = 0;
  my %resListFiles;
  
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  
  # Browse list of files, calculate hash and rename
  foreach my $file (keys %{$refListFiles}) {
    my $renamed = 0;
    
    # It's a directory, remove it
    if     (-d $file) { delete($$refListFiles{$file}); }
    else {
      # Split path and filename
      my @pathParts = split(/\\/, $file);
      my $filename  = pop(@pathParts);
      my $dstPath = join("\\", @pathParts);
      my $extension;
      if ($filename) { $extension = (split(/\./, $filename))[-1]; }
      
      # Calculate hash
      if (!$win->cbRenByHash->SelectedItem()) {
        if ($execute) { $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');   }
        else          { $winPb->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...'); }
        
        # MD5
        if (my $digestMD5 = file_md5_hex($file)) {
          if ($CONFIG{'HASH_LOWERCASE'}) { $digestMD5 = lc($digestMD5); }
          else                           { $digestMD5 = uc($digestMD5); }
          my $dstFilename = "$dstPath\\$digestMD5";
          if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
          # File already exists
          if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
            my $i;
            while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
              $i++;
              $dstFilename = "$dstPath\\$digestMD5".'_'.$i;
              if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
            }
            $renamed = 1;
          }
          # Rename
          if ($execute) {
            if (rename($file, $dstFilename)) {
              $nbrRenamed++;
              if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n"; }
            } else {
              $nbrError++;
              if ($logging) { print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
            }
          }
          elsif ($renamed) { $resListFiles{$dstFilename} = 4; }
          else             { $resListFiles{$dstFilename} = 1; }
        } elsif ($execute) {
          $nbrError++;
          if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingMD5'} $file\n"; }
        }
        
      # SHA1
      } elsif ($win->cbRenByHash->SelectedItem() == 1) {
        if ($execute) { $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...'); }
        else          { $winPb->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...'); }
        if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
          if ($CONFIG{'HASH_LOWERCASE'}) { $digestSHA1 = lc($digestSHA1); }
          else                           { $digestSHA1 = uc($digestSHA1); }
          my $dstFilename = "$dstPath\\$digestSHA1";
          if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
          # File already exists
          if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
            my $i;
            while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
              $i++;
              $dstFilename = "$dstPath\\$digestSHA1".'_'.$i;
              if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
            }
            $renamed = 1;
          }
          # Rename
          if ($execute) {
            if (rename($file, $dstFilename)) {
              $nbrRenamed++;
              if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n"; }
            } else {
              $nbrError++;
              if ($logging) {  print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
            }
          }
          elsif ($renamed) { $resListFiles{$dstFilename} = 4; } # Renamed file existed, renamed
          else             { $resListFiles{$dstFilename} = 1; }
        } elsif ($execute) {
          $nbrError++;
          if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA1'} $file\n"; }
        }
        
      # SHA256
      } elsif ($win->cbRenByHash->SelectedItem() == 2) {
        if ($execute) { $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...'); }
        else          { $winPb->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...'); }
        if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
          if ($CONFIG{'HASH_LOWERCASE'}) { $digestSHA256 = lc($digestSHA256); }
          else                           { $digestSHA256 = uc($digestSHA256); }
          my $dstFilename = "$dstPath\\$digestSHA256";
          if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
          # File already exists
          if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
            my $i;
            while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
              $i++;
              $dstFilename = "$dstPath\\$digestSHA256".'_'.$i;
              if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
            }
            $renamed = 1;
          }
          # Rename
          if ($execute) {
            if (rename($file, $dstFilename)) {
              $nbrRenamed++;
              if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n"; }
            } else {
              $nbrError++;
              if ($logging) {  print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
            }
          }
          elsif ($renamed) { $resListFiles{$dstFilename} = 4; } # Renamed file existed, renamed
          else             { $resListFiles{$dstFilename} = 1; }
        } elsif ($execute) {
          $nbrError++;
          if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA256'} $file\n"; }
        }
        
      # SHA512
      } elsif ($win->cbRenByHash->SelectedItem() == 3) {
        if ($execute) { $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...'); }
        else          { $winPb->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...'); }
        if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
          if ($CONFIG{'HASH_LOWERCASE'}) { $digestSHA512 = lc($digestSHA512); }
          else                           { $digestSHA512 = uc($digestSHA512); }
          my $dstFilename = "$dstPath\\$digestSHA512";
          if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
          # File already exists
          if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
            my $i;
            while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
              $i++;
              $dstFilename = "$dstPath\\$digestSHA512".'_'.$i;
              if ($extension) { $dstFilename .= '.'.$extension; } # Add extension
            }
            $renamed = 1;
          }
          # Rename
          if ($execute) {
            if (rename($file, $dstFilename)) {
              $nbrRenamed++;
              if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n"; }
            } else {
              $nbrError++;
              if ($logging) {  print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
            }
          }
          elsif ($renamed) { $resListFiles{$dstFilename} = 4; } # Renamed file existed, renamed
          else             { $resListFiles{$dstFilename} = 1; }
        } elsif ($execute) {
          $nbrError++;
          if ($logging) { print $fhLog "$STR{'Error'} $STR{'HashingSHA512'} $file\n"; }
        }
      }
    }
    
    $count++;
    if ($execute) {
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  
  return($nbrRenamed, \%resListFiles, $nbrError);

}  #--- End renameByHash

#--------------------------#
sub renameBySort
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $incrValType = $winRenBySortOpt->cbIncrValType->GetCurSel();
  my $length      = $winRenBySortOpt->tfLength->Text();
  my $initVal     = $winRenBySortOpt->tfInitVal->Text();
  my $stepVal     = $winRenBySortOpt->tfStepVal->Text();
  my $prefix      = $winRenBySortOpt->tfPrefix->Text();
  my $suffix      = $winRenBySortOpt->tfSuffix->Text();
  my $nbrRenamed  = 0;
  my $count       = 0;
  my $nbrError    = 0;
  my %resListFiles;
  
  # Sort list of files
  if ($execute) { $win->lblPbCurr->Text($STR{'SortFiles'}.'...');   }
  else          { $winPb->lblPbCurr->Text($STR{'SortFiles'}.'...'); }
  my $sortType = $winRenBySortOpt->cbSortByType->GetCurSel();
  my $order    = $winRenBySortOpt->rbAsc->Checked();
  # Divide by subfolders
  my %subFolders;
  foreach my $file (keys %{$refListFiles}) {
    if (!-d $file) {
      my @pathParts = split(/\\/, $file);
      pop(@pathParts);
      my $subFolder = join("\\", @pathParts);
      push(@{$subFolders{$subFolder}}, $file);
    } else { delete($$refListFiles{$file}); } # Remove folder from the list
  }
  # Sort by folder
  foreach my $subFolder (keys %subFolders) {
    my @sortedFiles;
    if      (!$sortType     and  $order) { @sortedFiles = sort {uc($a) cmp uc($b)} @{$subFolders{$subFolder}};               } # Ascending
    elsif   (!$sortType     and !$order) { @sortedFiles = sort {uc($b) cmp uc($a)} @{$subFolders{$subFolder}};               } # Descending
    # File Size
    elsif   ($sortType == 1 and  $order) { @sortedFiles = sort {(stat($a))[7] <=> (stat($b))[7]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 1 and !$order) { @sortedFiles = sort {(stat($b))[7] <=> (stat($a))[7]} @{$subFolders{$subFolder}}; } # Descending
    # Last accessed
    elsif   ($sortType == 2 and  $order) { @sortedFiles = sort {(stat($a))[8] <=> (stat($b))[8]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 2 and !$order) { @sortedFiles = sort {(stat($b))[8] <=> (stat($a))[8]} @{$subFolders{$subFolder}}; } # Descending
    # Last modified
    elsif   ($sortType == 3 and  $order) { @sortedFiles = sort {(stat($a))[9] <=> (stat($b))[9]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 3 and !$order) { @sortedFiles = sort {(stat($b))[9] <=> (stat($a))[9]} @{$subFolders{$subFolder}}; } # Descending
    my $i = &convertInitVal($incrValType, $initVal);
    # Store position of each file
    foreach my $file (@sortedFiles) { $$refListFiles{$file} = $i; $i++; }
  }
  
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }

  # Rename file
  if ($execute) { $win->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  else          { $winPb->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  foreach my $file (sort {$$refListFiles{$a} <=> $$refListFiles{$b}} keys %{$refListFiles}) {
    my $renamed = 0;
    # Set the destination filename
    my $posVal = $$refListFiles{$file};
    my $dstFilename;
    if ($prefix) { $dstFilename .= $prefix; }
    my $formatedVal = &formatVal($incrValType, $posVal, $length);
    $dstFilename .= $formatedVal;            
    if ($suffix) { $dstFilename .= $suffix; }
    my @pathParts   = split(/\\/, $file);
    my $srcFilename = pop(@pathParts);
    my $extension   = (split(/\./, $srcFilename))[-1];
    my $dstFile     = join("\\", @pathParts);
    $dstFile       .= "\\$dstFilename";
    if ($extension) { $dstFile .= "\.$extension"; }
    
    # File already exists
    if (-e $dstFile or exists($resListFiles{$dstFile})) {
      my $i;
      while (-e $dstFile or exists($resListFiles{$dstFile})) {
        $i++;
        $dstFile        = join("\\", @pathParts);
        $dstFile       .= "\\$dstFilename".'_'.$i;
        if ($extension) { $dstFile .= '.'.$extension; } # Add extension
      }
      $renamed = 1;
    }
    
    # Rename
    if ($execute) {
      if (rename($file, $dstFile)) {
        $nbrRenamed++;
        if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFile\n"; }
      } else {
        $nbrError++;
        if ($logging) { print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
      }
    }
    elsif ($renamed) { $resListFiles{$dstFile} = 4; } # Renamed file existed, renamed
    else             { $resListFiles{$dstFile} = 1; }
    
    $count++;
    if ($execute) { 
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  
  return($nbrRenamed, \%resListFiles, $nbrError);

}  #--- End renameBySort

#--------------------------#
sub renameReplaceBy
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $srcExpr       = $win->tfRenReplace->Text();
  my $srcExprCase   = $win->chRenReplaceCase->Checked();
  my $srcExprRegex  = $win->chRenReplaceRegex->Checked();
  my $srcExprFolder = $win->chRenReplaceFolder->Checked();
  my $dstExpr       = $win->tfRenReplaceBy->Text();
  my $dstExprEval   = $win->chRenReplaceByEval->Checked();
  my $nbrRenamed    = 0;
  my $count         = 0;
  my $nbrError      = 0;
  my %renamedDirs;
  my %resListFiles;
  my %listSubFolders;
  
  # Escape replace expresion if not regex
  if    (!$srcExprRegex)                      { $srcExpr = quotemeta($srcExpr);  }
  elsif ($dstExpr =~ /\$1/ and !$dstExprEval) { $dstExpr = '"' . $dstExpr . '"'; }
  
  # Base dir
  my $dir = $win->tfInput->Text();
  my $inputIsNotDir = 0;
  if (!-d $dir) { # Input is not a dir
    my $filesStr = $dir;
    if ($filesStr) {
      $inputIsNotDir = 1;
      # Multiple files
      if ($filesStr =~ /" "/) {
        $dir = (split(/" "/, $filesStr))[0];
        $dir =~ s/\"//g;
      }
      # Single file
      else {
        my @pathParts = split(/\\/, $filesStr);
        pop(@pathParts);
        $dir = join("\\", @pathParts);
      }
    }
  }
  
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  
  # Browse list of files and rename file that contains expression
  if ($execute) { $win->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  else          { $winPb->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  foreach my $file (sort keys %{$refListFiles}) {
    my $relPath;
    my $dstFile;
    my $isDir;
    my $invalidDir;
    my $noMatch;
    my $renamed = 0;
    
    # Remove basedir from filename if input is dir
    if ($dir) { $relPath = $file =~ s/\Q$dir//r; }
    
    # If input is not dir, only filename can be renamed
    if ($inputIsNotDir) { $relPath = (split(/\\/, $file))[-1]; }
    
    # If $file is a subfolder
    if (-d $file) {
      $isDir = 1;
      # If $file is basedir or if we only rename filenames, step to next file
      if (!$srcExprFolder or $relPath eq "\\") {
        $count++;
        if ($execute) {
          $win->lblPbCount->Text("$count / $nbrFiles");
          $win->pb->StepIt();
        } else { # Preview mode
          $winPb->lblCount->Text("$count / $nbrFiles");
          $winPb->pbWinPb->StepIt();
        }
        next;
      }
    }
    
    # If source file contains expression
    if ($relPath and ($srcExprCase and $relPath =~ /$srcExpr/) or (!$srcExprCase and $relPath =~ /$srcExpr/i)) {
      my @pathParts  = split(/\\/, $relPath);
      my $filename;
      if (!$isDir) { $filename = pop(@pathParts); }
      my $relDstPath = join("\\", @pathParts);
      
      # Expression match a directory
      if ($srcExprFolder and $relDstPath and (($srcExprCase and $relDstPath =~ /$srcExpr/) or (!$srcExprCase and $relDstPath =~ /$srcExpr/i))) {
        my $relSrcPath = join("\\", @pathParts);
        # Create the destination dir
        if ($srcExprCase) {
          if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
            $relDstPath =~ s/$srcExpr/$dstExpr/eeg;
          } else { $relDstPath =~ s/$srcExpr/$dstExpr/g; } # Keyword
        } else {
          if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
            $relDstPath =~ s/$srcExpr/$dstExpr/eegi;
          } else { $relDstPath =~ s/$srcExpr/$dstExpr/gi; } # Keyword
        }
        if ($@) { $invalidDir = 1; } # Error with replace
        # Valid destination folder name
        if (!$invalidDir and $relDstPath =~ /\\(.+)/ and &validName($1)) {
          my $newDir = $dir . $relDstPath;
          if ($execute) {
            if    (!File::Copy::Recursive::pathmk($newDir)) { $relPath = ''; } # Error renaming dir
            elsif (!exists($renamedDirs{$relSrcPath})     ) { $renamedDirs{$relSrcPath} = 1; }
          }
        } else { $invalidDir = 1; }
      }
      
      # Expression match filename
      elsif (!$srcExprFolder and !$isDir) {
        if ($filename and ($srcExprCase and $filename =~ /$srcExpr/) or (!$srcExprCase and $filename =~ /$srcExpr/i)) {
          # Rename file
          if ($srcExprCase) {
            if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
              $filename =~ s/$srcExpr/$dstExpr/eeg;
            } else { $filename =~ s/$srcExpr/$dstExpr/g; } # Keyword
          } else {
            if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
              $filename =~ s/$srcExpr/$dstExpr/eegi;
            } else { $filename =~ s/$srcExpr/$dstExpr/gi; } # Keyword
          }
          if ($@) { $filename = ''; } # Error with replace
        }
        # Valid destination filename
        if (!&validName($filename)) { $filename = ''; }
      }
      
      # No match
      else { $noMatch = 1; }
      
      # Set the new filename
      if (!$noMatch) {
        if    ($relDstPath and $filename) { $dstFile = $dir . $relDstPath . "\\" . $filename; }
        elsif ($filename)                 { $dstFile = $dir               . "\\" . $filename; }
        elsif ($isDir) { # Subfolder
          $dstFile = $dir . $relDstPath;
          $listSubFolders{$dstFile} = 1;
          # If directory has the same name, but case are different, rename
          # Otherwise, remove from list
          if ($file ne $dstFile and uc($file) ne uc($dstFile)) { $dstFile = ''; }
        }
      }
      
      # Rename the file
      if ($dstFile) {
        # File or directory already exists
        if (-e $dstFile or exists($resListFiles{$dstFile})) {
          my @filenameParts = split(/\./, $filename);
          my $extension;
          my $dstFilename;
          if (scalar(@filenameParts) > 1) { $extension = pop(@filenameParts); }
          $dstFilename = join('.', @filenameParts);
          my $i;
          while (-e $dstFile or exists($resListFiles{$dstFile})) {
            $i++;
            $dstFile = $dir . "$relDstPath\\$dstFilename".'_'.$i;
            if ($extension) { $dstFile .= '.'.$extension; } # Add extension
          }
          $renamed = 1;
        }
        
        if ($execute) {
          if (rename($file, $dstFile)) {
            $nbrRenamed++;
            if ($logging) { print $fhLog "$STR{'Renamed'} $file -> $dstFile\n"; }
          } else {
            $nbrError++;
            if ($logging) { print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n"; }
          }
        } else {
          # Illegal characters
          if ($filename and $filename =~ /[\<\>\:\"\/\\\|\?\*]/ or $invalidDir) {
            $resListFiles{$dstFile} = 2;
          }
          elsif ($renamed) { $resListFiles{$dstFile} = 4; } # Renamed file existed, renamed
          else             { $resListFiles{$dstFile} = 1; }
        }
      }
    }
    
    $count++;
    if ($execute) { 
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  
  # Delete renamed dir (if empty)
  foreach my $renamedDir (reverse sort keys %renamedDirs) {
    my $renamedDirPath = $dir . $renamedDir;
    rmdir($renamedDirPath);
  }
  
  return($nbrRenamed, \%resListFiles, \%listSubFolders, $nbrError);

}  #--- End renameReplaceBy

#--------------------------#
sub lblNotReady_Click
#--------------------------#
{
  &isProcessReady(1);

}  #--- End lblNotReady_Click

#--------------------------#
sub isProcessReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  my $input = $win->tfInput->Text();
  
  # Check Input
  if (!$win->tfInput->Text()) {
    $nextStep = $STR{'selectInput'};
    $win->btnPreview->Disable();
  } else {
    my $dir;
    if ($input =~ /" "/) { $input =~ s/"//g; $dir = (split(/ /, $input))[0]; }
    else { $dir = $input; }
    if (-d $dir or -e $dir) { $win->btnPreview->Enable(); }
    else {
      $nextStep = $STR{'selectInput'};
      $win->btnPreview->Disable();
    }
  }
  
  # Is Function Ready ?
  if (!$nextStep) { $nextStep = &isFunctionsReady(); }

  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnProcess->Disable();
    $win->lblNotReady->Show();
    if ($confirm) { Win32::GUI::MessageBox($win, "$STR{'notReady'} ?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040); }
  } else {
    $win->btnProcess->Enable();
    $win->lblNotReady->Hide();
  }

}  #--- End isProcessReady

#--------------------------#
sub isFunctionsReady
#--------------------------#
{
  # Lists
  if (!$win->TabFunctions->SelectedItem()         and  $win->rbListFiles->Checked()      and
      !$win->chListFilesOptFP->Checked()          and !$win->chListFilesOptFN->Checked() and
      !$win->chListFilesOptHV->Checked()          and !$win->chListFilesOptFD->Checked() and
      !$win->chListFilesOptNbrL->Checked()) {
    return($STR{'setListFilesOpt'});
  } elsif ($win->rbListFiles->Checked() and !-d $win->tfReportDir->Text()) {
    return($STR{'selectReportDir'});
  }
  # Copy or move
  if ($win->TabFunctions->SelectedItem() == 1 and !$win->tfDestinationDir->Text()) {
    return($STR{'selectDstDir'});
  }
  # Rename By Sort
  if ($win->TabFunctions->SelectedItem() == 2 and $win->rbRenSort->Checked()) {
    my $length      = $winRenBySortOpt->tfLength->Text();
    my $initVal     = $winRenBySortOpt->tfInitVal->Text();
    my $stepVal     = $winRenBySortOpt->tfStepVal->Text();
    if (!$length and !$initVal and !$stepVal) {
      return($STR{'setRenReplaceBy'});
    }
  }
  # Rename Replace
  if ($win->TabFunctions->SelectedItem() == 2 and $win->rbRenReplace->Checked() and !$win->tfRenReplace->Text()) {
    return($STR{'setRenBySortOpt'});
  } elsif ($win->TabFunctions->SelectedItem() == 2 and $win->rbRenReplace->Checked() and
           ($win->chRenReplaceRegex->Checked() or $win->chRenReplaceByEval->Checked())) { # Valid regex
    # Regex is valid ?
    if ($win->chRenReplaceRegex->Checked()) {
      if ($win->tfRenReplace->Text()) {
        my ($status, $msg) = &validRegex($win->tfRenReplace->Text());
        if ($status and $status == 1) {
          my $errorMsg = $STR{'errRegex'} . ' ' . $STR{'errRegexReplace'} . ":\n\n";
          if ($msg) { $errorMsg .= $msg; }
          return($errorMsg);
        }
      }
      # Replacement expression is valid ?
      if ($win->tfRenReplaceBy->Text()) {
        my ($status, $msg) = &validReplacement;
        if ($status and $status == 1) {
          my $errorMsg = $STR{'errBy'} . ' ' . $STR{'errRegexReplaceBy'} . ":\n\n";
          if ($msg) { $errorMsg .= $msg; }
          return($errorMsg);
        }
      }
    }
  }
  
}  #--- End isFunctionsReady
  
#--------------------------#
sub validRegex
#--------------------------#
{
  # Local variables
  my $regex = shift;
  
  if ($regex) {
    eval { if ('test' =~ /$regex/) { } };
    if ($@) {
      my $errRegex = (split(/ at /,$@))[0];
      return(1, $errRegex);
    } else {
      # Valid but senseless regex
      if ($regex =~ /^\||\|\||(?:[^\\]\|$)/ or $regex =~ /^\(\.\*\)$/) { return(2, undef); }
      else { return(0, undef); }
    }
  }
  
}  #--- End validRegex

#--------------------------#
sub validName
#--------------------------#
{
  # Local variables
  my $name = shift;
  
  # Contains illegal characters (in a window filename or folder) ?
  if ($name =~ /[\<\>\:\"\/\\\|\?\*]/) { return(0); }
  else                                 { return(1); }
  
}  #--- End validName

#--------------------------#
sub validReplacement
#--------------------------#
{
  # Local variables
  my $expr = $win->tfRenReplaceBy->Text();
  my $test = 'test';
  
  if ($expr =~ /\$1/ and !$win->chRenReplaceByEval->Checked()) { $expr = '"' . $expr . '"';  } # Capture with Eval not checked
  if ($win->chRenReplaceByEval->Checked() or $expr =~ /\$1/)   { $test =~ s/(.+)/$expr/eegi; } # Regex
  else                                                         { $test =~ s/(.+)/$expr/gi;   } # Keyword
  if ($@) {
    # Error
    my $err = (split(/ at /,$@))[0];
    return(1, $err);
  } else {
    # Warning for illegal characters
    if ($expr =~ /[\<\>\:\"\/\\\|\?\*]/) { return(2, undef); }
    
    # Replacement ok
    return(0, undef);
  }  
  
}  #--- End validReplacement

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  
  $winConfig->Center($win);
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if (!$winConfig->configTab->SelectedItem()) {
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->lblFuncShadowT->Show();
    $winConfig->lblFuncT->Show();
    $winConfig->chHashLowercase->Show();
    # Hide logging tab
    $winConfig->chEnableLogging->Hide();
    $winConfig->btnOpenLog->Hide();
    $winConfig->rbUseDefaultDir->Hide();
    $winConfig->rbLoggingDir->Hide();
    $winConfig->tfLoggingDir->Hide();
    $winConfig->btnLoggingDir->Hide();
    $winConfig->chUseDestDirCM->Hide();
    
  # Show Logging tab
  } else {
    $winConfig->chEnableLogging->Show();
    $winConfig->btnOpenLog->Show();
    # Show options
    $winConfig->rbUseDefaultDir->Show();
    $winConfig->rbLoggingDir->Show();
    $winConfig->tfLoggingDir->Show();
    $winConfig->btnLoggingDir->Show();
    $winConfig->chUseDestDirCM->Show();
    if ($winConfig->chEnableLogging->Checked()) {
      # Enable options
      $winConfig->rbUseDefaultDir->Enable();
      $winConfig->rbLoggingDir->Enable();
      $winConfig->chUseDestDirCM->Enable();
      if ($winConfig->rbUseDefaultDir->Checked()) {
        $winConfig->tfLoggingDir->Disable();
        $winConfig->btnLoggingDir->Disable();
      } else {
        $winConfig->tfLoggingDir->Enable();
        $winConfig->btnLoggingDir->Enable();
      }
    } else {
      # Disable options
      $winConfig->rbUseDefaultDir->Disable();
      $winConfig->rbLoggingDir->Disable();
      $winConfig->tfLoggingDir->Disable();
      $winConfig->btnLoggingDir->Disable();
      $winConfig->chUseDestDirCM->Disable();
    }
    # Hide general tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->lblFuncShadowT->Hide();
    $winConfig->lblFuncT->Hide();
    $winConfig->chHashLowercase->Hide();
  }

}  #--- End configTab_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnCheckUpdate_Click
#--------------------------#
{
  &updateTool(1);

}  #--- End btnCheckUpdate_Click

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub updateTool
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent('XL-FileTools Update $VERSION');
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'update4'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open Firefox to XL-FileTools page
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
          Win32::GUI::MessageBox($winConfig, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-FileTools",0x40010);
      }
    }
  }
  # Error 
  else {
    if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'errorConnection'}.': '.$res->status_line, "$STR{'update3'} XL-FileTools",0x40010); }
  }

}  #--- End updateTool

#--------------------------#
sub chHashLowercase_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chHashLowercase->Checked()) {
    $CONFIG{'HASH_LOWERCASE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'HASH_LOWERCASE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chHashLowercase_Click

#--------------------------#
sub chEnableLogging_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chEnableLogging->Checked()) {
    $CONFIG{'ENABLE_LOGGING'} = 1;
    &saveConfig(\%CONFIG);
    
    # Enable options
    $winConfig->rbUseDefaultDir->Enable();
    $winConfig->rbLoggingDir->Enable();
    $winConfig->tfLoggingDir->Enable();
    $winConfig->btnLoggingDir->Enable();
    $winConfig->chUseDestDirCM->Enable();
    
  } else {
    $CONFIG{'ENABLE_LOGGING'} = 0;
    &saveConfig(\%CONFIG);
    
    # Disable options
    $winConfig->rbUseDefaultDir->Disable();
    $winConfig->rbLoggingDir->Disable();
    $winConfig->tfLoggingDir->Disable();
    $winConfig->btnLoggingDir->Disable();
    $winConfig->chUseDestDirCM->Disable();
  }

}  #--- End chEnableLogging_Click

#--------------------------#
sub btnOpenLog_Click
#--------------------------#
{
  # Local variables
  my $logFile;
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
  }
  
  # Open file with default program
  if ($logFile and -T $logFile) {
    $win->ShellExecute('open', $logFile,'','',1) or Win32::GUI::MessageBox($win, "$STR{'errorOpening'}: ".Win32::FormatMessage(Win32::GetLastError()), $STR{'error'}, 0x40010);
  }

}  #--- End btnOpenLog_Click

#--------------------------#
sub rbUseDefaultDir_Click
#--------------------------#
{
  # Save the choice
  $CONFIG{'LOG_USE_DEFAULT_DIR'} = 1;
  &saveConfig(\%CONFIG);
  
  $winConfig->tfLoggingDir->Disable();
  $winConfig->btnLoggingDir->Disable();

}  #--- End rbUseDefaultDir_Click

#--------------------------#
sub rbLoggingDir_Click
#--------------------------#
{
  # Save the choice
  $CONFIG{'LOG_USE_DEFAULT_DIR'} = 0;
  &saveConfig(\%CONFIG);

  $winConfig->tfLoggingDir->Enable();
  $winConfig->btnLoggingDir->Enable();

}  #--- End rbLoggingDir_Click

#--------------------------#
sub tfLoggingDir_Change
#--------------------------#
{
  # Local variables
  my $loggingDir = $winConfig->tfLoggingDir->Text();
  
  # Remember
  if ($loggingDir and -d $loggingDir) {
    $CONFIG{'LOGGING_DIR'} = $loggingDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'LOGGING_DIR'});
    &saveConfig(\%CONFIG);
    if ($loggingDir) {
      $win->tfLoggingDir->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010); }
    }
  }

}  #--- End tfLoggingDir_Change

#--------------------------#
sub btnLoggingDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLoggingDir->Text();
  my $dir;

  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig        ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -directory  => $lastDir          ,
                                        -newui      => 1                 , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winConfig        ,
                                        -title      => $STR{'selDir'}.':',
                                        -folderonly => 1                 ,
                                        -newui      => 1                 , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winConfig->tfLoggingDir->Text($dir);
  }
  
}  #--- End btnLoggingDir_Click

#--------------------------#
sub chUseDestDirCM_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chUseDestDirCM->Checked()) {
    $CONFIG{'LOG_USE_DST_DIR'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'LOG_USE_DST_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chUseDestDirCM_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  # Open Firefox to XL-FileTools page
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-FileTools",0x40010);

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                    ,
                                              -parent      => $win                          ,
                                              -text        => $STR{'about'}.' XL-FileTools' ,
                                              -pos         => [$winPosX, $winPosY]          ,
                                              -size        => [520, 170]                    ,
                                              -background  => [255, 255, 255]               ,
                                              -hasmaximize => 0                             ,
                                              -hasminimize => 1                             ,
                                              -helpbutton  => 0                             ,
                                              -resizable   => 0                             ,
                                              -dialogui    => 1                             , );
  $winAbout->SetIcon($winICO);
  
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -foreground  => [0  , 0  , 102]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'version'}:\n$STR{'website'}:\n$STR{'author'}:\n$STR{'translatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10                 ,
                        -foreground  => [185, 154,   0]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -foreground  => [0  , 0  , 102]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2016 Alain Rioux', );
  
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Open and load config values
  open(CONFIG, $CONFIG_FILE);
  my @tab = <CONFIG>;
  close(CONFIG);
  
  foreach (@tab) {
    chomp($_);
    my ($key, $value) = split(/ = /, $_);
    if ($key) { $$refConfig{$key}  = $value; }
  }
  
  # General tab
  if (exists($$refConfig{'TOOL_AUTO_UPDATE'}))      { $winConfig->chAutoUpdate->Checked($$refConfig{'TOOL_AUTO_UPDATE'});           }
  else                                              { $winConfig->chAutoUpdate->Checked(1);                                         } # Default is checked
  if (exists($$refConfig{'HASH_LOWERCASE'}))        { $winConfig->chHashLowercase->Checked($$refConfig{'HASH_LOWERCASE'});          }
  else                                              { $winConfig->chHashLowercase->Checked(1);                                      } # Default is checked
  # Logging
  if (exists($$refConfig{'ENABLE_LOGGING'}))        { $winConfig->chEnableLogging->Checked($$refConfig{'ENABLE_LOGGING'});          }
  else                                              { $winConfig->chEnableLogging->Checked(1);                                      } # Default is checked
  if (exists($$refConfig{'LOGGING_DIR'}) and -d $$refConfig{'LOGGING_DIR'}) { # Use defined logging dir
    $winConfig->tfLoggingDir->Text($$refConfig{'LOGGING_DIR'});
    $winConfig->rbLoggingDir->Checked(1);
    $winConfig->rbUseDefaultDir->Checked(0);
    $winConfig->tfLoggingDir->Enable();
    $winConfig->btnLoggingDir->Enable();
  } else {                                                                    # Use default dir
    $winConfig->rbUseDefaultDir->Checked(1);
    $winConfig->rbLoggingDir->Checked(0);
    $winConfig->tfLoggingDir->Disable();
    $winConfig->btnLoggingDir->Disable();
  }
  if (exists($$refConfig{'LOG_USE_DST_DIR'}))       { $winConfig->chUseDestDirCM->Checked($$refConfig{'LOG_USE_DST_DIR'});          }
  else                                              { $winConfig->chUseDestDirCM->Checked(0);                                       } # Default is not checked
  
  # Folder for report
  if (exists($$refConfig{'DIR_REPORT'}) and
      -d $$refConfig{'DIR_REPORT'})                 { $win->tfReportDir->Text($$refConfig{'DIR_REPORT'});                           }
  else                                              { $win->tfReportDir->Text($USERDIR);                                            } # Default dir
  if (exists($$refConfig{'FORMAT_REPORT'}))         { $win->cbReportFormat->SetCurSel($$refConfig{'FORMAT_REPORT'});                }
  else                                              { $win->cbReportFormat->SetCurSel(0);                                           } # Default is TXT
  if (exists($$refConfig{'AUTO_OPEN_REPORT'}))      { $win->chOpenReport->Checked($$refConfig{'AUTO_OPEN_REPORT'});                 }
  else                                              { $win->chOpenReport->Checked(1);                                               } # Default is checked

}  #--- End loadConfig

#--------------------------#
sub date
#--------------------------#
{
  # Local variables
  my ($time) = @_;
  
  # Conversion
  if (!$time or $time == 0) { $time = time; }
  my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($time);

  # Format
  $y += 1900;
  $m++;
  $m   = $m   < 10 ? $m   = "0".$m   : $m;
  $d   = $d   < 10 ? $d   = "0".$d   : $d;
  $h   = $h   < 10 ? $h   = "0".$h   : $h;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  
  return($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST);

}  #--- End date

