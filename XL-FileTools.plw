#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name   : XL-FileTools
# Website     : http://le-tools.com/XL-FileTools.html
# SourceForge : https://sourceforge.net/p/xl-filetools
# GitHub      : https://github.com/arioux/XL-FileTools
# Description : Part of the XL-Toolkit, XL-FileTools provides a bunch of functions
#               for files like filtering, listing, copying, moving and renaming.
# Creation    : 2016-05-14
# Modified    : 2019-04-14
my $VERSION   = '4.2.2';
# Author      : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2016-2019  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#

#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use Archive::Zip;
use JSON qw(encode_json decode_json);
use Digest::MD5::File qw(file_md5_hex);
use Digest::SHA qw(sha1_hex sha256_hex sha512_hex);
use Text::Roman qw(:all);
use Excel::Writer::XLSX;
use Win32::OLE;
use Win32::OLE::Enum;                # Use MS Word
use Spreadsheet::ParseExcel;
use Spreadsheet::ParseExcel::Simple; # MS Excel (old format, xls)
use Spreadsheet::XLSX;               # MS Excel (new format, xlsx)
use CAM::PDF;
use File::Copy;
use File::Copy::Recursive qw(fcopy fmove);
use File::Find;
use B::Hooks::EndOfScope::PP::FieldHash;
use B::Hooks::EndOfScope::PP;
use Params::Validate::PP;
use DateTime;
use DateTime::TimeZone;
use Time::Local 'timelocal';
use Win32::UTCFileTime qw(:globally);
use Win32::API();
use Win32::DriveInfo;
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI::Grid;
use Win32::Process;
use threads;
use threads::shared;
require "XL-FileToolsGraph.pl";
require "XL-FileToolsLang.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $REF_ARG = \@ARGV;                                                          # If objects passed (using SendTo)
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-FileTools") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-FileTools"; }
else                                                { $USERDIR = $PROGDIR;                                    }
my $LANG_FILE    = "$USERDIR\\Lang.ini";                                       # Langage file
my $CONFIG_FILE  = "$USERDIR\\XL-FileTools.ini";                               # Configuration file
my $URL_DOC      = "http://le-tools.com/XL-FileToolsDoc.html";                 # Online documentation
my $URL_TOOL     = 'http://le-tools.com/XL-FileTools.html#Download';           # Url of the tool
my $URL_VER      = 'http://www.le-tools.com/download/XL-FileToolsVer.txt';     # Url of the version file
my %CONFIG       :shared;                                                      # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW        :shared;                                                      # Arrow pointer
my $HOURGLASS    :shared;                                                      # Hourglass pointer
my $THR_PROCESS;                                                               # Thread for process
my $THR_UPDATE;                                                                # Thread for update
my $START = 0;                                                                 # Indicate when program is started
my %ZONE_MAP = ('ADT'    => '-0300', # Atlantic Daylight Time                  # Ambiguous timezones
                'AST'    => '-0400', # Atlantic Standard Time
                'BST'    => '+0100', # British Summer Time
                'BT'     => '+0600', # Baghdad Time
                'CAT'    => '+0200', # Central Africa Time
                'CCT'    => '+0630', # Cocos Islands Time
                'CDT'    => '-0500', # Central Daylight Time
                'CST'    => '-0600', # Central Standard Time
                'EAST'   => '-0600', # Easter Island Standard Time
                'ECT'    => '-0500', # Ecuador Time
                'EDT'    => '-0400', # Eastern Daylight Time
                'EST'    => '-0500', # Eastern Standard Time
                'FDT'    => '-0100', # Fernando de Noronha Daylight Time
                'FST'    => '-0200', # Fernando de Noronha Standard Time
                'GST'    => '-0200', # South Georgia Time
                'IDT'    => '+0300', # Israel Daylight Time
                'IST'    => '+0200', # Israel Standard Time
                'MET'    => '+0100', # Middle European Time
                'NFT'    => '-0230', # Newfoundland Daylight Time
                'NST'    => '-0330', # Newfoundland Standard Time
                'PST'    => '-0800', # Pacific Standard Time
                'SAST'   => '+0200', # South Africa Standard Time
                'SST'    => '+0800', # Singapore Standard Time
                'WAST'   => '+0200', # West Africa Summer Time
                'WST'    => '+0800', # Western Standard Time}
              );

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#
my ($winICO, $logoBmp, $logo128Bmp, $filterList128, $openDirBmp, $openFileBmp, $processBmp, $stopBmp,
    $previewBmp, $config32Bmp, $helpBmp, $aboutBmp, $config128Bmp, $browseBmp, $folderClosedBmp,
    $folderOpenedBmp, $fileBmp, $delFileBmp, $warnFileBmp, $filterSet, $filterAdd, $filterDel,
    $importTab16Bmp, $saveTab16Bmp) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#
&loadDefaultStr(\%STR);                                                        # Load default language (en)
&loadStr(\%STR, $LANG_FILE) if -e $LANG_FILE and -T $LANG_FILE;                # If language file, load translated strings

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#
my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 710;
my $winHeight = 480;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;
# Main Window
my $win = Win32::GUI::Window->new(-name        => 'winMain'               ,
                                  -text        => 'XL-FileTools'          ,
                                  -background  => [255, 255, 255]         ,
                                  -size        => [$winWidth, $winHeight] ,
                                  -pos         => [$winPosX , $winPosY]   ,
                                  -minheight   => $winHeight              ,
                                  -minwidth    => $winWidth               , );
$win->SetIcon($winICO);
# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGB2;
my $font10;
my $font10b;
my $font10u;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $fontGB2 = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size =>  8);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size =>  8, -bold => 1, -underline => 1);
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1);
  $fontGB2 = new Win32::GUI::Font(-name => 'Arial', -size => 14, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size => 10);
  $font10b = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $font10u = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1, -underline => 1);
}
# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);
# Header
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [300, 60]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $logoBmp                , );
$win->AddLabel(       -name        => 'lblHeader'             ,
                      -size        => [400, 60]               ,
                      -pos         => [300,  0]               ,
                      -background  => [250, 250, 250]         , );
# Input section
$win->AddLabel(       -name        => 'lblInputT'             ,
                      -size        => [$winWidth, 24]         ,
                      -pos         => [  0, 60]               ,
                      -text        => ' '.$STR{'lblInputT'}   ,
                      -font        => $fontGB                 ,
                      -foreground  => [255, 255, 255]         ,
                      -background  => [255, 210,  84]         , );
$win->AddRadioButton( -name        => 'rbInputDir'            ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5, 90]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbInputDir'}      ,
                      -font        => $font10                 ,
                      -checked     => 1                       ,
                      -group       => 1                       , );
$win->AddRadioButton( -name        => 'rbInputFiles'          ,
                      -size        => [ 80, 22]               ,
                      -pos         => [ 90, 90]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'rbInputFiles'}    ,
                      -font        => $font10                 , );
$win->AddButton(      -name        => 'btnFileFilters'        ,
                      -size        => [110, 22]               ,
                      -pos         => [665, 90]               ,
                      -text        => $STR{'FileFilters'}.'...', );
$win->AddCheckbox(    -name        => 'chInputDirRecurse'     ,
                      -size        => [135, 22]               ,
                      -pos         => [665,115]               ,
                      -text        => $STR{'chInputDirRecurse'},
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 ,
                      -checked     => 1                       , );
$win->AddTextfield(   -name        => 'tfInput'               ,
                      -size        => [465, 22]               ,
                      -pos         => [  5,115]               , );
$win->AddButton(      -name        => 'btnInput'              ,
                      -size        => [ 22, 22]               ,
                      -pos         => [557,115]               ,
                      -bitmap      => $openDirBmp             , );
# Functions
$win->AddLabel(         -name         => 'lblFunctionsT'        ,
                        -size         => [$winWidth, 24]        ,
                        -pos          => [  0,148]              ,
                        -text         => ' '.$STR{'Functions'}  ,
                        -font         => $fontGB                ,
                        -foreground   => [255, 255, 255]        ,
                        -background   => [255, 210,  84]        , );
$win->AddTabStrip(      -name         => 'TabFunctions'         ,
                        -size         => [$winWidth-4, 24]      ,
                        -pos          => [  0,172]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions1T'} , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions2T'} , );
$win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions3T'} , );
# Lists
$win->AddTabStrip(      -name         => 'TabFuncLists'         ,
                        -size         => [$winWidth-4, 24]      ,
                        -pos          => [  0,195]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , );
$win->TabFuncLists->InsertItem(-text  => $STR{'Files'}          , );
$win->TabFuncLists->InsertItem(-text  => $STR{'Extensions'}     , );
$win->AddLabel(         -name         => 'lblListIncludeShadowT',
                        -size         => [100, 25]              ,
                        -pos          => [  6,226]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Include'}.':'    ,
                        -font         => $fontGB2               , );
$win->AddLabel(         -name         => 'lblListIncludeT'      ,
                        -size         => [100, 25]              ,
                        -pos          => [  5,225]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'Include'}.':'    ,
                        -font         => $fontGB2               , );
$win->AddCheckbox(      -name         => 'chListFilesOptFP'     , # Full path
                        -size         => [130, 22]              ,
                        -pos          => [110,225]              ,
                        -text         => $STR{'FullPath'}       ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                , );
$win->AddCheckbox(      -name         => 'chListFilesOptP'      , # Path
                        -size         => [130, 22]              ,
                        -pos          => [110,250]              ,
                        -text         => $STR{'Path'}           ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                , );
$win->AddCheckbox(      -name         => 'chListFilesOptFN'     , # Filename
                        -size         => [130, 22]              ,
                        -pos          => [110,275]              ,
                        -text         => $STR{'Filename'}       ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => $STR{'tipFilesOnly'}   , );
$win->AddCheckbox(      -name         => 'chListFilesOptFE'     , # File extension
                        -size         => [130, 22]              ,
                        -pos          => [110,300]              ,
                        -text         => $STR{'Extension'}      ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => $STR{'tipFilesOnly'}   , );
$win->AddCheckbox(      -name         => 'chListFilesOptFD'     , # File details
                        -size         => [140, 22]              ,
                        -pos          => [245,225]              ,
                        -text         => $STR{'FileDetails'}.'...',
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                , );
$win->AddCheckbox(      -name         => 'chListFilesOptHV'     , # Hash values
                        -size         => [140, 22]              ,
                        -pos          => [245,250]              ,
                        -text         => $STR{'HashValues'}.'...',
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => $STR{'tipFilesOnly'}   , );
$win->AddCheckbox(      -name         => 'chListFilesOptCount'  , # Count
                        -size         => [130, 22]              ,
                        -pos          => [245,275]              ,
                        -text         => $STR{'CountDupl'}.'...',
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => $STR{'tipFilesOnly'}   , );
$win->AddCheckbox(      -name         => 'chListFilesOptLM'     , # List of members
                        -size         => [130, 22]              ,
                        -pos          => [245,300]              ,
                        -text         => $STR{'ListMembers'}    ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => "Xls(x) $STR{'and'} Zip", );
$win->AddCheckbox(      -name         => 'chListFilesOptNbrF'   , # Number of files
                        -size         => [150, 22]              ,
                        -pos          => [390,225]              ,
                        -text         => $STR{'NumberFiles'}    ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => $STR{'tipFolderZip'}   , );
$win->AddCheckbox(      -name         => 'chListFilesOptNbrL'   , # Number of lines
                        -size         => [150, 22]              ,
                        -pos          => [390,250]              ,
                        -text         => $STR{'NumberLines'}    ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => $STR{'tipTxtFilesOnly'}, );
$win->AddCheckbox(      -name         => 'chListFilesOptNbrP'   , # Number of pages
                        -size         => [150, 22]              ,
                        -pos          => [390,275]              ,
                        -text         => $STR{'NumberPages'}    ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -tip          => "Doc(x), Xls(x) $STR{'and'} Pdf", );
$win->AddCheckbox(      -name         => 'chListFilesOptNH'     , # No header
                        -size         => [150, 22]              ,
                        -pos          => [545,225]              ,
                        -text         => $STR{'NoHeader'}       ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                , );
$win->AddCheckbox(      -name         => 'chListFilesOptNF'     , # No folder
                        -size         => [150, 22]              ,
                        -pos          => [545,250]              ,
                        -text         => $STR{'NoFolder'}       ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                , );
$win->AddLabel(         -name         => 'lblListExtOptShadowT' ,
                        -size         => [100, 25]              ,
                        -pos          => [  6,229]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Options'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblListExtOptT'       ,
                        -size         => [100, 25]              ,
                        -pos          => [  5,228]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'Options'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblListExtMinLength'  ,
                        -size         => [120, 22]              ,
                        -pos          => [110,232]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblLength'}.':'  ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfListExtMinLength'   ,
                        -size         => [ 60, 24]              ,
                        -pos          => [235,229]              ,
                        -number       => 1                      ,
                        -visible      => 0                      , );
$win->AddUpDown(        -name         => 'upDownByListExtMinLength',
                        -visible      => 0                      , );
$win->upDownByListExtMinLength->SetRange(0,100);
$win->upDownByListExtMinLength->SetPos(0);
$win->AddLabel(         -name         => 'lblListExtMaxLength'  ,
                        -size         => [120, 22]              ,
                        -pos          => [110,262]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblLengthMax'}.':',
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfListExtMaxLength'   ,
                        -size         => [ 60, 24]              ,
                        -pos          => [235,259]              ,
                        -number       => 1                      ,
                        -visible      => 0                      , );
$win->AddUpDown(        -name         => 'upDownByListExtMaxLength',
                        -visible      => 0                      , );
$win->upDownByListExtMaxLength->SetRange(1,100);
$win->upDownByListExtMaxLength->SetPos(4);
$win->AddLabel(         -name         => 'lblListReportShadowT' ,
                        -size         => [100, 25]              ,
                        -pos          => [  6,289]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblReportDir'}.':',
                        -font         => $fontGB2               , );
$win->AddLabel(         -name         => 'lblListReportT'       ,
                        -size         => [100, 25]              ,
                        -pos          => [  5,288]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'lblReportDir'}.':',
                        -font         => $fontGB2               , );
$win->AddTextfield(     -name         => 'tfReportDir'          ,
                        -size         => [315, 22]              ,
                        -pos          => [110,285]              , );
$win->AddCombobox(      -name         => 'cbReportFormat'       ,
                        -size         => [ 60, 22]              ,
                        -pos          => [410,285]              ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      , );
$win->cbReportFormat->Add('TXT', 'HTML', 'XLSX'                 , );
$win->cbReportFormat->SetCurSel(0);
$win->AddButton(        -name         => 'btnReportDir'         ,
                        -size         => [ 22, 22]              ,
                        -pos          => [477,285]              ,
                        -bitmap       => $openDirBmp            ,
                        -tip          => $STR{'selDirReport'}   , );
$win->AddButton(        -name         => 'btnOpenReportDir'     ,
                        -size         => [ 22, 22]              ,
                        -pos          => [499,285]              ,
                        -bitmap       => $browseBmp             ,
                        -tip          => $STR{'browseDirReport'}, );
$win->AddCheckbox(      -name         => 'chOpenReport'         ,
                        -size         => [185, 22]              ,
                        -pos          => [110,286]              ,
                        -text         => $STR{'chOpenReport'}   ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -checked      => 1                      , );
# Copy or move
$win->AddTabStrip(      -name         => 'TabFuncCopy'          ,
                        -size         => [$winWidth-4, 24]      ,
                        -pos          => [  0,195]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        ,
                        -visible      => 0                      , );
$win->TabFuncCopy->InsertItem(-text   => $STR{'Copy'}           , );
$win->TabFuncCopy->InsertItem(-text   => $STR{'Move'}           , );
$win->TabFuncCopy->SetCurSel(0);
$win->AddLabel(         -name         => 'lblCopyOptShadowT'    ,
                        -size         => [135, 25]              ,
                        -pos          => [  6,229]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Options'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblCopyOptT'          ,
                        -size         => [135, 25]              ,
                        -pos          => [  5,228]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'Options'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chCopyTree'           ,
                        -size         => [250, 22]              ,
                        -pos          => [145,230]              ,
                        -text         => $STR{'chCopyTree'}     ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chCopyRemDouble'      ,
                        -size         => [250, 22]              ,
                        -pos          => [145,255]              ,
                        -text         => $STR{'chCopyRemDouble'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblCopyDestShadowT'   ,
                        -size         => [125, 25]              ,
                        -pos          => [  6,289]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'lblDestination'}.':',
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblCopyDestT'         ,
                        -size         => [135, 25]              ,
                        -pos          => [  5,288]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'lblDestination'}.':',
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfDestinationDir'     ,
                        -size         => [405, 22]              ,
                        -pos          => [145,285]              ,
                        -visible      => 0                      , );
$win->AddButton(        -name         => 'btnDestinationDir'    ,
                        -size         => [ 22, 22]              ,
                        -pos          => [497,285]              ,
                        -bitmap       => $openDirBmp            ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chOpenDstDir'         ,
                        -size         => [185, 22]              ,
                        -pos          => [145,285]              ,
                        -text         => $STR{'chOpenDstDir'}   ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      ,
                        -checked      => 1                      , );
# Rename
$win->AddTabStrip(      -name         => 'TabFuncRen'           ,
                        -size         => [$winWidth-4, 24]      ,
                        -pos          => [  0,195]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        ,
                        -visible      => 0                      , );
$win->TabFuncRen->InsertItem(-text    => $STR{'ByHash'}         , );
$win->TabFuncRen->InsertItem(-text    => $STR{'BySort'}         , );
$win->TabFuncRen->InsertItem(-text    => $STR{'Replace'}        , );
$win->TabFuncRen->SetCurSel(0);
$win->AddLabel(         -name         => 'lblRenHashTypeShadowT',
                        -size         => [115, 25]              ,
                        -pos          => [  6,229]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Type'}.':'       ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenHashTypeT'      ,
                        -size         => [115, 25]              ,
                        -pos          => [  5,228]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'Type'}.':'       ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddCombobox(      -name         => 'cbRenByHash'          ,
                        -size         => [100, 22]              ,
                        -pos          => [125,230]              ,
                        -font         => $font10                ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      ,
                        -visible      => 0                      , );
$win->cbRenByHash->Add( 'MD5', 'SHA1', 'SHA256', 'SHA512',      , );
$win->cbRenByHash->SetCurSel(0);
$win->AddLabel(         -name         => 'lblRenHashOptShadowT' ,
                        -size         => [115, 25]              ,
                        -pos          => [  6,264]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Options'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenHashOptT'       ,
                        -size         => [115, 25]              ,
                        -pos          => [  5,263]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'Options'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chRenByHashNoDupl'    ,
                        -size         => [250, 22]              ,
                        -pos          => [125,265]              ,
                        -text         => $STR{'ExcludeDuplicates'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chRenByHashRemExt'    ,
                        -size         => [250, 22]              ,
                        -pos          => [125,290]              ,
                        -text         => $STR{'RemoveExtensions'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
# Rename By sort
$win->AddLabel(         -name         => 'lblRenBySortShadowT'  ,
                        -size         => [200, 25]              ,
                        -pos          => [  6,229]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'sortOpt'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenBySortT'        ,
                        -size         => [200, 25]              ,
                        -pos          => [  5,228]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'sortOpt'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenBySort'         ,
                        -size         => [ 80, 20]              ,
                        -pos          => [210,231]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'sortBy'}.':'     ,
                        -visible      => 0                      , );
$win->AddCombobox(      -name         => 'cbRenBySortType'      ,
                        -size         => [130,100]              ,
                        -pos          => [295,228]              ,
                        -font         => $font10                ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      ,
                        -visible      => 0                      , );
$win->cbRenBySortType->Add($STR{'cbSortByAlpha'}, $STR{'FileSize'}    ,
                           $STR{'LastAccessed'} , $STR{'LastModified'},);
$win->cbRenBySortType->SetCurSel(0);
$win->AddRadioButton(   -name         => 'rbRenBySortAsc'       ,
                        -size         => [100, 22]              ,
                        -pos          => [450,229]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Ascending'}      ,
                        -font         => $font10                ,
                        -checked      => 1                      ,
                        -group        => 1                      ,
                        -visible      => 0                      , );
$win->AddRadioButton(   -name         => 'rbRenBySortDsc'       ,
                        -size         => [120, 22]              ,
                        -pos          => [555,229]              ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Descending'}     ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblBySortRenShadowT'  ,
                        -size         => [200, 25]              ,
                        -pos          => [  6,261]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'renameOpt'}.':'  ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblBySortRenT'        ,
                        -size         => [200, 25]              ,
                        -pos          => [  5,260]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'renameOpt'}.':'  ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblBySortRenExample'  ,
                        -size         => [ 80, 20]              ,
                        -pos          => [210,263]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblExample'}.':' ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfBySortRenExample'   ,
                        -size         => [150, 24]              ,
                        -pos          => [295,260]              ,
                        -readonly     => 1                      ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chBySortRenRemExt'    ,
                        -size         => [250, 22]              ,
                        -pos          => [455,261]              ,
                        -text         => $STR{'RemoveExtensions'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblBySortRenIncrValType',
                        -size         => [115, 20]              ,
                        -pos          => [  5,295]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblIncrValType'}.':',
                        -visible      => 0                      , );
$win->AddCombobox(      -name         => 'cbBySortRenIncrValType',
                        -size         => [100, 40]              ,
                        -pos          => [125,292]              ,
                        -font         => $font10                ,
                        -dropdownlist => 1                      ,
                        -vscroll      => 1                      ,
                        -visible      => 0                      , );
$win->cbBySortRenIncrValType->Add('1,2,3,...'    , 'a-z,aa-zz,...'  ,
                                  'A-Z,AA-ZZ,...', '0-f,00-ff,...'  ,
                                  '0-F,00-FF,...', 'I,II,III IV,...',);
$win->cbBySortRenIncrValType->SetCurSel(0);
$win->AddLabel(         -name         => 'lblBySortRenLength'   ,
                        -size         => [115, 20]              ,
                        -pos          => [  5,327]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblLength'}.':'  ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfBySortRenLength'    ,
                        -size         => [ 60, 24]              ,
                        -pos          => [125,324]              ,
                        -number       => 1                      ,
                        -visible      => 0                      , );
$win->AddUpDown(        -name         => 'upDownBySortRenLength',
                        -visible      => 0                      , );
$win->upDownBySortRenLength->SetRange(1,32);
$win->upDownBySortRenLength->SetPos(0);
$win->AddLabel(         -name         => 'lblBySortRenInitVal'  ,
                        -size         => [115, 20]              ,
                        -pos          => [250,295]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblInitVal'}.':' ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfBySortRenInitVal'   ,
                        -size         => [ 60, 24]              ,
                        -pos          => [370,292]              ,
                        -visible      => 0                      , );
$win->AddUpDown(        -name         => 'upDownBySortRenInitVal',
                        -visible      => 0                      , );
$win->upDownBySortRenInitVal->SetRange(0,100);
$win->upDownBySortRenInitVal->SetPos(1);
$win->AddLabel(         -name         => 'lblBySortRenStepVal'  ,
                        -size         => [115, 20]              ,
                        -pos          => [250,327]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblStepVal'}.':' ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfBySortRenStepVal'   ,
                        -size         => [ 60, 24]              ,
                        -pos          => [370,324]              ,
                        -number       => 1                      ,
                        -visible      => 0                      , );
$win->AddUpDown(        -name         => 'upDownBySortRenStepVal',
                        -visible      => 0                      , );
$win->upDownBySortRenStepVal->SetRange(1,100);
$win->upDownBySortRenStepVal->SetPos(0);
$win->AddLabel(         -name         => 'lblBySortRenPrefix'   ,
                        -size         => [115, 20]              ,
                        -pos          => [455,295]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblPrefix'}.':'  ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfBySortRenPrefix'    ,
                        -size         => [100, 24]              ,
                        -pos          => [575,292]              ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblBySortRenSuffix'   ,
                        -size         => [115, 20]              ,
                        -pos          => [455,327]              ,
                        -font         => $font10                ,
                        -background   => [255, 255, 255]        , 
                        -text         => $STR{'lblSuffix'}.':'  ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfBySortRenSuffix'    ,
                        -size         => [100, 24]              ,
                        -pos          => [575,324]              ,
                        -visible      => 0                      , );
# Rename Replace
$win->AddLabel(         -name         => 'lblReplaceShadowT'    ,
                        -size         => [110, 25]              ,
                        -pos          => [  6,229]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'Replace'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblReplaceT'          ,
                        -size         => [115, 25]              ,
                        -pos          => [  5,228]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'Replace'}.':'    ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceOk'      ,
                        -size         => [152, 24]              ,
                        -pos          => [124,229]              ,
                        -background   => [  0, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceErr'     ,
                        -size         => [152, 24]              ,
                        -pos          => [124,229]              ,
                        -background   => [255,   0,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceWarn'    ,
                        -size         => [152, 24]              ,
                        -pos          => [124,229]              ,
                        -background   => [255, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfRenReplace'         ,
                        -size         => [150, 22]              ,
                        -pos          => [125,230]              ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceRegex'    ,
                        -size         => [ 85, 22]              ,
                        -pos          => [125,255]              ,
                        -text         => $STR{'Regex'}          ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceCase'     ,
                        -size         => [120, 22]              ,
                        -pos          => [215,255]              ,
                        -text         => $STR{'MatchCase'}      ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceFolder'   ,
                        -size         => [110, 22]              ,
                        -pos          => [340,255]              ,
                        -text         => $STR{'Folders'}        ,
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblReplaceByShadowT'  ,
                        -size         => [110, 25]              ,
                        -pos          => [  6,289]              ,
                        -foreground   => [180, 180, 180]        ,
                        -background   => [255, 255, 255]        ,
                        -text         => $STR{'By'}.':'         ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblReplaceByT'        ,
                        -size         => [115, 25]              ,
                        -pos          => [  5,288]              ,
                        -addstyle     => 11                     , # Transparent
                        -foreground   => [250, 195,  27]        ,
                        -text         => $STR{'By'}.':'         ,
                        -font         => $fontGB2               ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByOk'    ,
                        -size         => [152, 24]              ,
                        -pos          => [124,289]              ,
                        -background   => [  0, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByErr'   ,
                        -size         => [152, 24]              ,
                        -pos          => [124,289]              ,
                        -background   => [255,   0,   0]        ,
                        -visible      => 0                      , );
$win->AddLabel(         -name         => 'lblRenReplaceByWarn'  ,
                        -size         => [152, 24]              ,
                        -pos          => [124,289]              ,
                        -background   => [255, 255,   0]        ,
                        -visible      => 0                      , );
$win->AddTextfield(     -name         => 'tfRenReplaceBy'       ,
                        -size         => [150, 22]              ,
                        -pos          => [125,290]              ,
                        -disabled     => 1                      ,
                        -visible      => 0                      , );
$win->AddCheckbox(      -name         => 'chRenReplaceByEval'  ,
                        -size         => [ 60, 22]              ,
                        -pos          => [125,315]              ,
                        -text         => $STR{'chRenReplaceByEval'},
                        -background   => [255, 255, 255]        ,
                        -font         => $font10                ,
                        -disabled     => 1                      ,
                        -visible      => 0                      , );
# Footer
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [$winWidth, 80]         ,
                      -pos         => [  2,$winHeight-82]     ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10, $winHeight-65]    ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddLabel(       -name        => 'lblPbCurr'             ,
                      -size        => [495, 20]               ,
                      -pos         => [ 10, $winHeight-75]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddProgressBar( -name        => 'pb'                    ,
                      -size        => [410, 20]               ,
                      -pos         => [ 10, $winHeight-55]    ,
                      -smooth      => 1                       ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblPbCount'            ,
                      -size        => [ 85, 20]               ,
                      -pos         => [425, $winHeight-53]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnProcess'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [465,$winHeight-75]     ,
                      -bitmap      => $processBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Process'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnStop'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [465,$winHeight-75]     ,
                      -bitmap      => $stopBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'StopProcess'}     ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnPreview'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [510,$winHeight-75]     ,
                      -bitmap      => $previewBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Preview'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [555,$winHeight-75]     ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Configuration'}   , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [600,$winHeight-75]     ,
                      -bitmap      => $helpBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [645,$winHeight-75]     ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'About'}           , );

#------------------------------------------------------------------------------#
# Hash values options window
#------------------------------------------------------------------------------#
my $winHashVal = Win32::GUI::Window->new( -name        => 'winHashVal'           ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'HashValues'}     ,
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [220, 120]             ,
                                          -hasmaximize => 0                      ,
                                          -hasminimize => 0                      ,
                                          -resizable   => 0                      ,
                                          -dialogui    => 1                      , );
$winHashVal->SetIcon($winICO);
$winHashVal->AddCheckbox( -name         => 'chListFilesHV1'       ,
                          -size         => [ 90, 22]              ,
                          -pos          => [  5,  5]              ,
                          -text         => 'MD5'                  ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddCheckbox( -name         => 'chListFilesHV2'       ,
                          -size         => [ 90, 22]              ,
                          -pos          => [  5, 30]              ,
                          -text         => 'SHA1'                 ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddCheckbox( -name         => 'chListFilesHV3'       ,
                          -size         => [100, 22]              ,
                          -pos          => [100,  5]              ,
                          -text         => 'SHA256'               ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddCheckbox( -name         => 'chListFilesHV4'       ,
                          -size         => [100, 22]              ,
                          -pos          => [100, 30]              ,
                          -text         => 'SHA512'               ,
                          -background   => [255, 255, 255]        ,
                          -font         => $font10                ,
                          -tabstop      => 1                      , );
$winHashVal->AddButton(   -name         => 'btnHashValuesOk'      ,
                          -text         => $STR{'Ok'}             ,
                          -size         => [ 60, 25]              ,
                          -pos          => [ 80, 60]              ,
                          -ok           => 1                      ,
                          -default      => 1                      , );

#------------------------------------------------------------------------------#
# File details options window
#------------------------------------------------------------------------------#
my $winFileDetails = Win32::GUI::Window->new( -name        => 'winFileDetails'       ,
                                              -background  => [255, 255, 255]        ,
                                              -parent      => $win                   ,
                                              -text        => $STR{'FileDetails'}    ,
                                              -pos         => [$winPosX, $winPosY]   ,
                                              -size        => [200, 145]             ,
                                              -hasmaximize => 0                      ,
                                              -hasminimize => 0                      ,
                                              -resizable   => 0                      ,
                                              -dialogui    => 1                      , );
$winFileDetails->SetIcon($winICO);
$winFileDetails->AddCheckbox( -name         => 'chListFilesFD1'       , # File or dir size
                              -size         => [180, 22]              ,
                              -pos          => [  5,  5]              ,
                              -text         => $STR{'Size'}           ,
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winFileDetails->AddCheckbox( -name         => 'chListFilesFD2'       , # Last accessed
                              -size         => [180, 22]              ,
                              -pos          => [  5, 30]              ,
                              -text         => $STR{'LastAccessed'}   ,
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winFileDetails->AddCheckbox( -name         => 'chListFilesFD3'       , # Last modified
                              -size         => [180, 22]              ,
                              -pos          => [  5, 55]              ,
                              -text         => $STR{'LastModified'}   ,
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winFileDetails->AddButton(   -name         => 'btnFileDetailsOk'     ,
                              -text         => $STR{'Ok'}             ,
                              -size         => [ 60, 25]              ,
                              -pos          => [ 70, 85]              ,
                              -ok           => 1                      ,
                              -default      => 1                      , );

#------------------------------------------------------------------------------#
# Count options window
#------------------------------------------------------------------------------#
my $winCountOpt = Win32::GUI::Window->new(-name        => 'winCountOpt'         ,
                                          -background  => [255, 255, 255]       ,
                                          -parent      => $win                  ,
                                          -text        => $STR{'BasedOn'}.':'   ,
                                          -pos         => [$winPosX, $winPosY]  ,
                                          -size        => [160, 120]            ,
                                          -hasmaximize => 0                     ,
                                          -hasminimize => 0                     ,
                                          -resizable   => 0                     ,
                                          -dialogui    => 1                     , );
$winCountOpt->SetIcon($winICO);
$winCountOpt->AddRadioButton( -name         => 'rbListFilesCountMD5'  , # Based on MD5
                              -size         => [180, 22]              ,
                              -pos          => [  5,  5]              ,
                              -text         => 'MD5'                  ,
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -checked      => 1                      ,
                              -group        => 1                      ,
                              -tabstop      => 1                      , );
$winCountOpt->AddRadioButton( -name         => 'rbListFilesCountFN'   , # Based on filename
                              -size         => [180, 22]              ,
                              -pos          => [  5, 30]              ,
                              -text         => $STR{'Filename'}       ,
                              -background   => [255, 255, 255]        ,
                              -font         => $font10                ,
                              -tabstop      => 1                      , );
$winCountOpt->AddButton(      -name         => 'btnWinCountOk'        ,
                              -text         => $STR{'Ok'}             ,
                              -size         => [ 60, 25]              ,
                              -pos          => [ 50, 60]              ,
                              -ok           => 1                      ,
                              -default      => 1                      , );

#------------------------------------------------------------------------------#
# Preview window
#------------------------------------------------------------------------------#
my $winPreview = Win32::GUI::Window->new( -name        => 'winPreview'           ,
                                          -background  => [255, 255, 255]        ,
                                          -parent      => $win                   ,
                                          -text        => $STR{'winPreview'}     ,
                                          -pos         => [$winPosX, $winPosY]   ,
                                          -size        => [$winWidth, $winHeight],
                                          -hasmaximize => 1                      ,
                                          -hasminimize => 1                      ,
                                          -resizable   => 1                      ,
                                          -dialogui    => 1                      ,
                                          -dialogui    => 1                      , );
$winPreview->SetIcon($winICO);
my $imageList = new Win32::GUI::ImageList(16, 16, 1|0x0010, 5, 5);
$imageList->Add($folderClosedBmp, 0);
$imageList->Add($folderOpenedBmp, 0);
$imageList->Add($fileBmp        , 0);
$imageList->Add($delFileBmp     , 0);
$imageList->Add($warnFileBmp    , 0);
$winPreview->AddLabel(                    -name        => 'lblBeforeShadowT',
                                          -size        => [100, 22]         ,
                                          -pos         => [  6,  6]         ,
                                          -font        => $fontGB2          ,
                                          -foreground  => [180, 180, 180]   ,
                                          -background  => [255, 255, 255]   ,
                                          -text        => $STR{'Before'}.':', );
$winPreview->AddLabel(                    -name        => 'lblBeforeT'      ,
                                          -size        => [100, 22]         ,
                                          -pos         => [  5,  5]         ,
                                          -font        => $fontGB2          ,
                                          -addstyle    => 11                , # Transparent
                                          -foreground  => [250, 195,  27]   ,
                                          -text        => $STR{'Before'}.':', );
$winPreview->AddLabel(                    -name        => 'lblRootBefore'   ,
                                          -size        => [ 55, 20]         ,
                                          -pos         => [ 10, 38]         ,
                                          -font        => $font10           ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'Root'}.':'  , );
$winPreview->AddTextfield(                -name        => 'tfRootBefore'    ,
                                          -size        => [240, 22]         ,
                                          -pos         => [ 70, 35]         ,
                                          -readonly    => 1                 , );
$winPreview->AddTreeView(                 -name        => 'tvBefore'        ,
                                          -size        => [305,330]         ,
                                          -pos         => [  5, 60]         ,
                                          -background  => [255, 255, 255]   ,
                                          -rootlines   => 1                 ,
                                          -lines       => 1                 ,
                                          -buttons     => 1                 ,
                                          -imagelist   => $imageList        , );
$winPreview->AddLabel(                    -name        => 'lblAfterShadowT' ,
                                          -size        => [100, 22]         ,
                                          -pos         => [316,  6]         ,
                                          -font        => $fontGB2          ,
                                          -foreground  => [180, 180, 180]   ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'After'}.':' , );
$winPreview->AddLabel(                    -name        => 'lblAfterT'       ,
                                          -size        => [100, 22]         ,
                                          -pos         => [315,  5]         ,
                                          -font        => $fontGB2          ,
                                          -addstyle    => 11                , # Transparent
                                          -foreground  => [250, 195,  27]   ,
                                          -text        => $STR{'After'}.':' , );
$winPreview->AddLabel(                    -name        => 'lblRootAfter'    ,
                                          -size        => [ 55, 20]         ,
                                          -pos         => [315, 38]         ,
                                          -font        => $font10           ,
                                          -background  => [255, 255, 255]   , 
                                          -text        => $STR{'Root'}.':'  , );
$winPreview->AddTextfield(                -name        => 'tfRootAfter'     ,
                                          -size        => [240, 22]         ,
                                          -pos         => [380, 35]         ,
                                          -readonly    => 1                 , );
$winPreview->AddTreeView(                 -name        => 'tvAfter'         ,
                                          -size        => [305,330]         ,
                                          -pos         => [315, 60]         ,
                                          -background  => [255, 255, 255]   ,
                                          -rootlines   => 1                 ,
                                          -lines       => 1                 ,
                                          -buttons     => 1                 ,
                                          -imagelist   => $imageList        , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -parent      => $win                    ,
                                            -text        => $STR{'winConfig'}       ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [600, 285]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);
$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $config128Bmp         ,
                          -background   => [255, 255, 255]       , );

# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'      ,
                                    -size         => [455,250]        ,
                                    -pos          => [140,  5]        ,
                                    -fixedwidth   => 1                ,
                                    -tabstop      => 1                ,
                                    -background   => [255, 255, 255]  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'general'}  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'logging'}  , );
# General tab
# Tool Section
$winConfig->AddLabel(       -name        => 'lblToolShadowT'        ,
                            -size        => [ 80, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB2                , );
$winConfig->AddLabel(       -name        => 'lblToolT'              ,
                            -size        => [ 80, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [250, 195,  27]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB2                , );
$winConfig->AddButton(      -name        => 'btnExportLang'         ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 68]               ,
                            -text        => $STR{'Export'}.'Lang.ini',
                            -font        => $font10                 , );
$winConfig->AddButton(      -name        => 'btnOpenUserDir'        ,
                            -size        => [125, 24]               ,
                            -pos         => [285, 68]               ,
                            -text        => $STR{'OpenUserDir'}.'...',
                            -font        => $font10                 , );
$winConfig->AddButton(      -name        => 'btnCheckUpdate'        ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 98]               ,
                            -text        => $STR{'checkUpdate'}     ,
                            -font        => $font10                 , );
$winConfig->AddCheckbox(    -name        => 'chAutoUpdate'          ,
                            -size        => [250, 20]               ,
                            -pos         => [285,100]               ,
                            -text        => $STR{'AutoUpdateTip'}   ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font10                 ,
                            -tabstop     => 1                       ,
                            -checked     => 1                       , );
# Functions section
$winConfig->AddLabel(       -name         => 'lblFuncShadowT'        ,
                            -size         => [350, 22]               ,
                            -pos          => [151,136]               ,
                            -foreground   => [180, 180, 180]         ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'Functions'}.':'   ,
                            -font         => $fontGB2                , );
$winConfig->AddLabel(       -name         => 'lblFuncT'              ,
                            -size         => [350, 22]               ,
                            -pos          => [150,135]               ,
                            -addstyle     => 11                      , # Transparent
                            -foreground   => [250, 195,  27]         ,
                            -text         => $STR{'Functions'}.':'   ,
                            -font         => $fontGB2                , );
$winConfig->AddLabel(       -name         => 'lblLocalTZ'            ,
                            -size         => [120, 22]               ,
                            -pos          => [150,173]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'localTimezone'}.':',
                            -font         => $font10                 , );
$winConfig->AddCombobox(    -name         => 'cbLocalTZ'             ,
                            -size         => [260,100]               ,
                            -pos          => [285,170]               ,
                            -font         => $font10                 ,
                            -dropdownlist => 1                       ,
                            -vscroll      => 1                       , );
$winConfig->AddCheckbox(    -name         => 'chFormatFileSize'      ,
                            -size         => [350, 20]               ,
                            -pos          => [150,200]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'formatFileSize'}  ,
                            -font         => $font10                 ,
                            -tabstop      => 1                       , );
$winConfig->AddCheckbox(    -name         => 'chHashLowercase'       ,
                            -size         => [350, 20]               ,
                            -pos          => [150,225]               ,
                            -background   => [255, 255, 255]         ,
                            -text         => $STR{'chHashLowercase'} ,
                            -font         => $font10                 ,
                            -tabstop      => 1                       , );
# Logging tab
$winConfig->AddCheckbox(    -name        => 'chEnableLogging'       ,
                            -size        => [200, 20]               ,
                            -pos         => [150, 40]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chEnableLogging'} ,
                            -font        => $font10                 ,
                            -checked     => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddButton(      -name        => 'btnOpenLog'            ,
                            -size        => [150, 24]               ,
                            -pos         => [400, 38]               ,
                            -text        => $STR{'OpenLog'}         ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbUseDefaultDir'       ,
                            -size        => [150, 20]               ,
                            -pos         => [150, 70]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'rbUseDefaultDir'} ,
                            -font        => $font10                 ,
                            -group       => 1                       ,
                            -checked     => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbLoggingDir'          ,
                            -size        => [245, 20]               ,
                            -pos         => [150, 95]               ,
                            -font        => $font10                 ,
                            -background  => [255, 255, 255]         , 
                            -text        => $STR{'rbLoggingDir'}.':',
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfLoggingDir'          ,
                            -size        => [400, 22]               ,
                            -pos         => [150,120]               ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddButton(      -name        => 'btnLoggingDir'         ,
                            -size        => [ 22, 22]               ,
                            -pos         => [552,120]               ,
                            -bitmap      => $openDirBmp             ,
                            -disabled    => 1                       ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );
$winConfig->AddCheckbox(    -name        => 'chUseDestDirCM'        ,
                            -size        => [300, 20]               ,
                            -pos         => [150,150]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chUseDestDirCM'}  ,
                            -font        => $font10                 ,
                            -visible     => 0                       ,
                            -tabstop     => 1                       , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'                   ,
                                        -parent      => $winPreview               ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]      ,
                                        -size        => [600, 170]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);
$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [460, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#
my $winFileFilters;
my $winSelFileFilters;
# List of timezone
my @listTZ = DateTime::TimeZone->all_names;
foreach (@listTZ) { $winConfig->cbLocalTZ->Add($_); }
&loadConfig(\%CONFIG);
if ($CONFIG{'TOOL_AUTO_UPDATE'}) { $THR_UPDATE = threads->create(sub { sleep(2); &updateTool(0); }); }
# Set input (objects sent)
if ($$REF_ARG[0]) {
  if (!$$REF_ARG[1]) {
    if    (-d $$REF_ARG[0]) {             # A folder
      $win->tfInput->Text($$REF_ARG[0]);
      $win->rbInputDir->Checked(1);
      $win->rbInputFiles->Checked(0);
      &rbInputDir_Click();
    } else {                              # Single file
      $win->tfInput->Text($$REF_ARG[0]);
      $win->rbInputDir->Checked(0);
      $win->rbInputFiles->Checked(1);
      &rbInputFiles_Click();
    }
  } else {                                # Multiple files
    my $argStr;
    my @path = split(/\\/, $$REF_ARG[1]);
    pop(@path);
    $argStr = '"'.join("\\", @path).'" ';
    foreach my $file (@$REF_ARG) { $argStr .= '"'.(split(/\\/, $file))[-1].'" '; }
    chop($argStr);
    $win->tfInput->Text($argStr);
    $win->rbInputDir->Checked(0);
    $win->rbInputFiles->Checked(1);
    &rbInputFiles_Click();
  }
}
$START = 1;
$win->Show();
Win32::GUI::Dialog();

#--------------------------#
sub winMain_Resize
#--------------------------#
{
  # Header
  $win->lblHeader->Width($win->ScaleWidth()-300);
  # Input section
  $win->lblInputT->Width($win->ScaleWidth());
  $win->btnFileFilters->Left($win->ScaleWidth()-142);
  $win->tfInput->Width($win->ScaleWidth()-174);
  $win->btnInput->Left($win->ScaleWidth()-167);
  $win->chInputDirRecurse->Left($win->ScaleWidth()-142);
  # Functions section
  $win->lblFunctionsT->Width($win->ScaleWidth());
  $win->TabFunctions->Width($win->ScaleWidth()+3);
  $win->TabFuncLists->Width($win->ScaleWidth()+3);
  $win->TabFuncCopy->Width($win->ScaleWidth()+3);
  $win->TabFuncRen->Width($win->ScaleWidth()+3);
  $win->tfReportDir->Width($win->ScaleWidth()-236);
  $win->cbReportFormat->Left($win->ScaleWidth()-122);
  $win->btnReportDir->Left($win->ScaleWidth()-60);
  $win->btnOpenReportDir->Left($win->ScaleWidth()-37);
  $win->lblListReportShadowT->Top($win->ScaleHeight()-106);
  $win->lblListReportT->Top($win->ScaleHeight()-107);
  $win->tfReportDir->Top($win->ScaleHeight()-105);
  $win->cbReportFormat->Top($win->ScaleHeight()-105);
  $win->btnReportDir->Top($win->ScaleHeight()-105);
  $win->btnOpenReportDir->Top($win->ScaleHeight()-105);
  $win->chOpenReport->Top($win->ScaleHeight()-80);
  # Copy/move tab
  $win->tfDestinationDir->Width($win->ScaleWidth()-182);
  $win->btnDestinationDir->Left($win->ScaleWidth()-36);
  $win->lblCopyDestShadowT->Top($win->ScaleHeight()-106);
  $win->lblCopyDestT->Top($win->ScaleHeight()-107);
  $win->tfDestinationDir->Top($win->ScaleHeight()-105);
  $win->btnDestinationDir->Top($win->ScaleHeight()-105);
  $win->chOpenDstDir->Top($win->ScaleHeight()-80);
  # Rename tab
  $win->tfBySortRenExample->Width($win->ScaleWidth()-500);
  $win->chBySortRenRemExt->Left($win->ScaleWidth()-200);
  $win->lblRenReplaceOk->Width($win->ScaleWidth()-138);
  $win->lblRenReplaceErr->Width($win->ScaleWidth()-138);
  $win->lblRenReplaceWarn->Width($win->ScaleWidth()-138);
  $win->tfRenReplace->Width($win->ScaleWidth()-140);
  $win->lblRenReplaceByOk->Width($win->ScaleWidth()-138);
  $win->lblRenReplaceByErr->Width($win->ScaleWidth()-138);
  $win->lblRenReplaceByWarn->Width($win->ScaleWidth()-138);
  $win->tfRenReplaceBy->Width($win->ScaleWidth()-140);  
  # Footer
  $win->lblFooter->Top($win->ScaleHeight()-55);
  $win->lblFooter->Width($win->ScaleWidth());
  $win->lblNotReady->Top($win->ScaleHeight()-40);
  $win->lblPbCurr->Top($win->ScaleHeight()-48);
  $win->lblPbCurr->Width($win->ScaleWidth()-240);
  $win->pb->Top($win->ScaleHeight()-27);
  $win->pb->Width($win->ScaleWidth()-330);
  $win->lblPbCount->Top($win->ScaleHeight()-25);
  $win->lblPbCount->Left($win->ScaleWidth()-315);
  $win->btnProcess->Move($win->ScaleWidth()-225, $win->ScaleHeight()-45);
  $win->btnStop->Move($win->ScaleWidth()-225, $win->ScaleHeight()-45);
  $win->btnPreview->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnWinConfig->Move($win->ScaleWidth()-135, $win->ScaleHeight()-45);
  $win->btnHelp->Move($win->ScaleWidth()-90, $win->ScaleHeight()-45);
  $win->btnAbout->Move($win->ScaleWidth()-45, $win->ScaleHeight()-45);
  
}  #--- End winMain_Resize

#--------------------------#
sub winMain_Terminate
#--------------------------#
{
  -1;
  
}  #--- End winMain_Terminate

#--------------------------#
sub rbInputDir_Click
#--------------------------#
{
  if (!$win->tfInput->Text() or !-d $win->tfInput->Text()) { $win->tfInput->Text(''); }
  $win->btnFileFilters->Show();
  $win->chInputDirRecurse->Show();

}  #--- End rbInputDir_Click

#--------------------------#
sub tfInput_Change { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub btnInput_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfInput->Text();
  my $dir;
  if ($win->rbInputDir->Checked()) {
    # Show dialog window
    if ($lastDir) {
      my(@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDir'}.':', -folderonly => 1,
                                         -directory => $lastDir);
    } else {
      $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDir'}.':', -folderonly => 1);
    }
    # Selected folder
    if ($dir and -d $dir) {
      chop($dir) if $dir =~ /\\$/;
      $win->tfInput->Text($dir);
    }
  } else {
    my @filesStr;
    # Show OpenFile dialog window
    if ($lastDir and !-d $lastDir) {
      # Multiple files
      if ($lastDir =~ /" "/) { $lastDir = (split(/" "/, $lastDir))[0]; }
      # Single file
      my @parts = split(/ /, $lastDir);
      if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -directory     => $lastDir             ,
                                                -explorer      => 1                    , );
    } elsif (-d $lastDir) {
      my(@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -directory     => $lastDir             ,
                                                -explorer      => 1                    , );
    } else {
      @filesStr = Win32::GUI::GetOpenFileName(  -owner         => $win                 ,
                                                -title         => $STR{'selFiles'}.':' ,
                                                -defaultfilter => 0                    ,
                                                -filemustexist => 1                    ,
                                                -multisel      => 1                    ,
                                                -explorer      => 1                    , );
    }
    # Selected file
    if ($filesStr[0] and scalar(@filesStr) > 0) {
      # Single file
      if ($filesStr[0] and scalar(@filesStr) == 1) { $win->tfInput->Text($filesStr[0]); }
      # Multiple files
      else {
        my $filesStr;
        foreach my $file (@filesStr) { $filesStr .= "\"$file\" "; }
        chop($filesStr);
        $win->tfInput->Text($filesStr);
      }
    }
  }
  &isProcessReady(0);
  return(1);
  
}  #--- End btnInputDir_Click

#--------------------------#
sub rbInputFiles_Click
#--------------------------#
{
  if (!$win->tfInput->Text() or -d $win->tfInput->Text()) { $win->tfInput->Text(''); }
  $win->btnFileFilters->Hide();
  $win->chInputDirRecurse->Hide();

}  #--- End rbInputFiles_Click

#--------------------------#
sub btnFileFilters_Click
#--------------------------#
{
  &createWinFileFilters() if !$winFileFilters;
  $winFileFilters->Center($win);
  $winFileFilters->Show();
  return(1);

}  #--- End btnFileFilters_Click

#--------------------------#
sub createWinFileFilters
#--------------------------#
{
  # Create File Filters window
  $winFileFilters = Win32::GUI::Window->new(-name        => 'winFileFilters'       ,
                                            -background  => [255, 255, 255]        ,
                                            -parent      => $win                   ,
                                            -text        => $STR{'FileFilters'}    ,
                                            -pos         => [$winPosX, $winPosY]   ,
                                            -size        => [790, 220]             ,
                                            -minsize     => [790, 220]             ,
                                            -hasmaximize => 1                      ,
                                            -hasminimize => 1                      ,
                                            -resizable   => 1                      ,
                                            -dialogui    => 1                      , );
  $winFileFilters->SetIcon($winICO);
  $winFileFilters->AddLabel(    -name         => 'lblLogo'               ,
                                -size         => [128,128]               ,
                                -pos          => [  0,  5]               ,
                                -bitmap       => $filterList128          ,
                                -background   => [255, 255, 255]         , );
  # File filters grid
  $winFileFilters->AddGrid(     -name         => 'gridFileFilters'       ,
                                -size         => [610,180]               ,
                                -pos          => [140,  5]               ,
                                -background   => [255, 255, 255]         ,
                                -columns      => 5                       ,
                                -fixedrows    => 1                       ,
                                -fixedcolumns => 0                       ,
                                -editable     => 0                       ,
                                -hscroll      => 1                       ,
                                -vscroll      => 1                       , );
  $winFileFilters->gridFileFilters->SetListMode(1);
  $winFileFilters->AddButton(   -name         => 'btnFileFilterAdd'      ,
                                -size         => [ 22, 22]               ,
                                -pos          => [580,  5]               ,
                                -bitmap       => $filterAdd              ,
                                -tip          => $STR{'filterAddTip'}    , );
  $winFileFilters->AddButton(   -name         => 'btnFileFilterDel'      ,
                                -size         => [ 22, 22]               ,
                                -pos          => [602,  5]               ,
                                -bitmap       => $filterDel              ,
                                -tip          => $STR{'filterDelTip'}    ,
                                -disabled     => 1                       , );
  $winFileFilters->AddButton(   -name         => 'btnFileFiltersImport'  ,
                                -size         => [ 22, 22]               ,
                                -pos          => [580, 29]               ,
                                -bitmap       => $importTab16Bmp         ,
                                -tip          => $STR{'filterImportTip'} , );
  $winFileFilters->AddButton(   -name         => 'btnFileFiltersSave'    ,
                                -size         => [ 22, 22]               ,
                                -pos          => [602, 29]               ,
                                -bitmap       => $saveTab16Bmp           ,
                                -tip          => $STR{'filterSaveTip'}   ,
                                -disabled     => 1                       , );
  $winFileFilters->AddButton(   -name         => 'btnFileFiltersOk'      ,
                                -text         => $STR{'Ok'}              ,
                                -size         => [ 60, 30]               ,
                                -pos          => [195,190]               ,
                                -font         => $font10                 ,
                                -ok           => 1                       ,
                                -default      => 1                       , );
  # Set File Filter grid header
  $winFileFilters->gridFileFilters->SetCellText(0, 0, $STR{'Operator'} );
  $winFileFilters->gridFileFilters->SetCellText(0, 1, $STR{'Type'}     );
  $winFileFilters->gridFileFilters->SetCellText(0, 2, $STR{'TypeOp'}   );
  $winFileFilters->gridFileFilters->SetCellText(0, 3, $STR{'flags'}    );
  $winFileFilters->gridFileFilters->SetCellText(0, 4, $STR{'searchStr'});
  $winFileFilters->gridFileFilters->SetCellFormat(0, 0, 1); # Center column headers
  $winFileFilters->gridFileFilters->SetCellFormat(0, 1, 1);
  $winFileFilters->gridFileFilters->SetCellFormat(0, 2, 1);
  $winFileFilters->gridFileFilters->SetCellFormat(0, 3, 1);
  $winFileFilters->gridFileFilters->SetCellFormat(0, 4, 1);
  $winFileFilters->gridFileFilters->AutoSize();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  
}  #--- End createWinFileFilters

#--------------------------#
sub winFileFilters_Resize
#--------------------------#
{
  $winFileFilters->gridFileFilters->Width($winFileFilters->ScaleWidth()-190);
  $winFileFilters->gridFileFilters->Height($winFileFilters->ScaleHeight()-45);
  $winFileFilters->gridFileFilters->AutoSize();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  $winFileFilters->btnFileFilterAdd->Left($winFileFilters->ScaleWidth()-48);
  $winFileFilters->btnFileFilterDel->Left($winFileFilters->ScaleWidth()-24);
  $winFileFilters->btnFileFiltersImport->Left($winFileFilters->ScaleWidth()-48);
  $winFileFilters->btnFileFiltersSave->Left($winFileFilters->ScaleWidth()-24);
  $winFileFilters->btnFileFiltersOk->Left($winFileFilters->ScaleWidth()/2);
  $winFileFilters->btnFileFiltersOk->Top($winFileFilters->ScaleHeight()-35);

}  #--- End winFileFilters_Resize

#--------------------------#
sub btnFileFiltersOk_Click
#--------------------------#
{
  # Only Folder
  if    (&isOnlyFoldersOn()              ) { &OnlyFoldersOn();  }
  elsif ($win->TabFunctions->Count() == 2) { &OnlyFoldersOff(); }
  &winFileFilters_Terminate();

}  #--- End btnFileFiltersOk_Click

#--------------------------#
sub winFileFilters_Terminate
#--------------------------#
{
  $winFileFilters->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);

}  #--- End winFileFilters_Terminate

#--------------------------#
sub btnFileFilterAdd_Click
#--------------------------#
{
  &createWinSelFileFilters() if !$winSelFileFilters;
  # Only folders option can't be combined with other filter than Contains
  my $onlyFolderOn = 0;
  if (my $nbrFilters = $winFileFilters->gridFileFilters->GetRows() > 1) {
    my $otherFilters = 0;
    for (my $row = 1; $row < $winFileFilters->gridFileFilters->GetRows(); $row++) {
      if    ($winFileFilters->gridFileFilters->GetCellText($row, 1) eq $STR{'OnlyFolders'} ) { $onlyFolderOn = 1 ; }
      elsif ($winFileFilters->gridFileFilters->GetCellText($row, 1) ne $STR{'Contains'}    ) { $otherFilters = 1 ; }
    }
    # Only folder
    if      ($onlyFolderOn and $winSelFileFilters->TabSelFileFiltersType->Count() > 1) {
      $winSelFileFilters->TabSelFileFiltersType->DeleteAllItems();
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'Contains'});
    # There are other filters
    } elsif ($otherFilters and $winSelFileFilters->TabSelFileFiltersType->Count() > 1) {
      $winSelFileFilters->TabSelFileFiltersType->DeleteAllItems();
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'Contains'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'FileSize'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastAccessed'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastModified'});
    # There is only Contains, reset tabs
    } elsif (!$onlyFolderOn and $winSelFileFilters->TabSelFileFiltersType->Count() != 5) {
      $winSelFileFilters->TabSelFileFiltersType->DeleteAllItems();
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'Contains'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'FileSize'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastAccessed'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastModified'});
      $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'OnlyFolders'});
    }
  # Reset tabs
  } elsif ($winSelFileFilters->TabSelFileFiltersType->Count() != 5) {
    $winSelFileFilters->TabSelFileFiltersType->DeleteAllItems();
    $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'Contains'});
    $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'FileSize'});
    $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastAccessed'});
    $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastModified'});
    $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'OnlyFolders'});
  }
  # Reset Filter window controls
  $winSelFileFilters->lblSelFileFiltersEditRow->Text('');
  $winSelFileFilters->lblSelFileFiltersOp->Disable();
  $winSelFileFilters->cbSelFileFiltersOp->SetCurSel(0);
  $winSelFileFilters->cbSelFileFiltersOp->Disable();
  $winSelFileFilters->TabSelFileFiltersType->SetCurSel(0);
  &TabSelFileFiltersType_Change($onlyFolderOn);
  $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
  $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
  $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
  $winSelFileFilters->chSelFileFiltersContainsCase->Checked(0);
  $winSelFileFilters->chSelFileFiltersContainsRegex->Checked(0);
  $winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked(0);
  $winSelFileFilters->tfSelFileFiltersContains->Text('');
  $winSelFileFilters->tfSelFileFiltersSize->Text('');
  $winSelFileFilters->tfSelFileFiltersItemList->Text('');
  # Enable/Disable operator
  if ($winFileFilters->gridFileFilters->GetRows() > 1) {
    $winSelFileFilters->lblSelFileFiltersOp->Enable();
    $winSelFileFilters->cbSelFileFiltersOp->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersOp->Disable();
    $winSelFileFilters->cbSelFileFiltersOp->Disable();
  }
  $winSelFileFilters->Center($win);
  $winSelFileFilters->Show();

}  #--- End btnFileFilterAdd_Click

#--------------------------#
sub gridFileFilters_DblClick
#--------------------------#
{
  # Local variables
  my $row = shift;
  &createWinSelFileFilters() if !$winSelFileFilters;
  my $onlyFolderOn = &isOnlyFoldersOn();
  if ($row != 0) {
    # Gather values of current selection
    my $operator  = $winFileFilters->gridFileFilters->GetCellText($row, 0);
    my $type      = $winFileFilters->gridFileFilters->GetCellText($row, 1);
    my $typeOp    = $winFileFilters->gridFileFilters->GetCellText($row, 2);
    my $flagsStr  = $winFileFilters->gridFileFilters->GetCellText($row, 3);
    my $searchStr = $winFileFilters->gridFileFilters->GetCellText($row, 4);
    # Set values
    $winSelFileFilters->lblSelFileFiltersEditRow->Text($row);
    if    ($type eq $STR{'Contains'}    ) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(0); }
    elsif ($type eq $STR{'FileSize'}    ) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(1); }
    elsif ($type eq $STR{'LastAccessed'}) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(2); }
    elsif ($type eq $STR{'LastModified'}) { $winSelFileFilters->TabSelFileFiltersType->SetCurSel(3); }
    else                                  { return(1); } # Only Folder can not be edited
    &TabSelFileFiltersType_Change($onlyFolderOn);
    if ($row == 1) { # First line, no operator
      $winSelFileFilters->cbSelFileFiltersOp->SetCurSel(0);
      $winSelFileFilters->cbSelFileFiltersOp->Disable();
    } else {
      $winSelFileFilters->cbSelFileFiltersOp->SetCurSel($winSelFileFilters->cbSelFileFiltersOp->FindStringExact($operator));
      $winSelFileFilters->cbSelFileFiltersOp->Enable();
    }
    # Reset other values
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->chSelFileFiltersContainsCase->Checked(0);
    $winSelFileFilters->chSelFileFiltersContainsRegex->Checked(0);
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked(0);
    $winSelFileFilters->tfSelFileFiltersContains->Text('');
    $winSelFileFilters->tfSelFileFiltersSize->Text('');
    $winSelFileFilters->tfSelFileFiltersItemList->Text('');
    # Filter is Contains
    if ($type eq $STR{'Contains'}) {
      my ($case, $regex, $fileOnly) = split(/-/, $flagsStr);
      $winSelFileFilters->chSelFileFiltersContainsCase->Checked(1)     if $case;
      $winSelFileFilters->chSelFileFiltersContainsRegex->Checked(1)    if $regex;
      $winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked(1) if $fileOnly;
      $winSelFileFilters->tfSelFileFiltersContains->Text($searchStr);
    # Filter by size
    } elsif ($type eq $STR{'FileSize'}) {
      $winSelFileFilters->cbSelFileFiltersSizeOp->SetCurSel($winSelFileFilters->cbSelFileFiltersSizeOp->FindStringExact($typeOp));
      my ($size, $sizeUnit) = split(/ /, $searchStr);
      $winSelFileFilters->tfSelFileFiltersSize->Text($size);
      $winSelFileFilters->cbSelFileFiltersSizeUnit->SetCurSel($winSelFileFilters->cbSelFileFiltersSizeUnit->FindStringExact($sizeUnit));
    # Filter by last accessed datetime
    } elsif ($type eq $STR{'LastAccessed'}) {
      $winSelFileFilters->cbSelFileFiltersLastAccess->SetCurSel($winSelFileFilters->cbSelFileFiltersLastAccess->FindStringExact($typeOp));
      my ($y, $m, $d) = split(/-/, $searchStr);
      $winSelFileFilters->dtSelFileFiltersLastAccess->SetDate($y, $m, $d);
    # Filter by last modified datetime
    } elsif ($type eq $STR{'LastModified'}) {
      $winSelFileFilters->cbSelFileFiltersLastModif->SetCurSel($winSelFileFilters->cbSelFileFiltersLastModif->FindStringExact($typeOp));
      my ($y, $m, $d) = split(/-/, $searchStr);
      $winSelFileFilters->dtSelFileFiltersLastModif->SetDate($y, $m, $d);
    }
  }
  $winSelFileFilters->btnSelFileFiltersOk->Enable();
  $winSelFileFilters->Center($win);
  $winSelFileFilters->Show();
  $win->Disable();

}  #--- End gridFileFilters_DblClick

#--------------------------#
sub createWinSelFileFilters
#--------------------------#
{
  # Select File Filters window
  $winSelFileFilters = Win32::GUI::Window->new( -name        => 'winSelFileFilters'    ,
                                                -background  => [255, 255, 255]        ,
                                                -parent      => $win                   ,
                                                -text        => $STR{'FileFilters'}    ,
                                                -pos         => [$winPosX, $winPosY]   ,
                                                -size        => [595, 250]             ,
                                                -hasmaximize => 0                      ,
                                                -hasminimize => 0                      ,
                                                -resizable   => 0                      ,
                                                -dialogui    => 1                      , );
  $winSelFileFilters->SetIcon($winICO);
  $winSelFileFilters->AddLabel(     -name         => 'lblLogo'               ,
                                    -size         => [128,128]               ,
                                    -pos          => [  0,  5]               ,
                                    -bitmap       => $filterList128          ,
                                    -background   => [255, 255, 255]         , );
  $winSelFileFilters->AddTabStrip(  -name         => 'TabSelFileFiltersType' ,
                                    -size         => [451,223]               ,
                                    -pos          => [140,  0]               ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       ,
                                    -background   => [255, 255, 255]         , );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'Contains'}    );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'FileSize'}    );
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastAccessed'});
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'LastModified'});
  $winSelFileFilters->TabSelFileFiltersType->InsertItem(-text => $STR{'OnlyFolders'} );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersOp'   ,
                                    -size         => [100, 22]               ,
                                    -pos          => [145, 38]               ,
                                    -text         => $STR{'Operator'}.':'    ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -disabled     => 1                       , );
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersOp'    ,
                                    -size         => [ 60, 22]               ,
                                    -pos          => [250, 35]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -disabled     => 1                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersOp->Add($STR{'OR'}, $STR{'AND'}, );
  $winSelFileFilters->cbSelFileFiltersOp->SetCurSel(0);
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersEditRow',
                                    -size         => [ 10, 22]               ,
                                    -pos          => [540, 38]               ,
                                    -visible      => 0                       , ); # Hidden, Edit mode from caller
  # Filter: Contains
  $winSelFileFilters->AddCheckbox(  -name         => 'chSelFileFiltersContainsCase',
                                    -size         => [125, 22]               ,
                                    -pos          => [145, 70]               ,
                                    -text         => $STR{'MatchCase'}       ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddCheckbox(  -name         => 'chSelFileFiltersContainsRegex',
                                    -size         => [ 60, 22]               ,
                                    -pos          => [275, 70]               ,
                                    -text         => $STR{'Regex'}           ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddCheckbox(  -name         => 'chSelFileFiltersContainsFileOnly',
                                    -size         => [200, 22]               ,
                                    -pos          => [370, 70]               ,
                                    -text         => $STR{'FilenameOnly'}    ,
                                    -background   => [255, 255, 255]         ,
                                    -font         => $font10                 ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersContainOk',
                                    -size         => [432, 72]               ,
                                    -pos          => [144, 94]               ,
                                    -background   => [  0, 255,   0]         ,
                                    -visible      => 0                       , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersContainErr',
                                    -size         => [432, 72]               ,
                                    -pos          => [144, 94]               ,
                                    -background   => [255,   0,   0]         ,
                                    -visible      => 0                       , );
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersContainWarn',
                                    -size         => [432, 72]               ,
                                    -pos          => [144, 94]               ,
                                    -background   => [255, 255,   0]         ,
                                    -visible      => 0                       , );
  $winSelFileFilters->AddTextfield( -name         => 'tfSelFileFiltersContains',
                                    -size         => [430, 70]               ,
                                    -pos          => [145, 95]               ,
                                    -multiline    => 1                       ,
                                    -wantreturn   => 1                       ,
                                    -vscroll      => 1                       ,
                                    -autohscroll  => 1                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->tfSelFileFiltersContains->MaxLength(5000000);
  # Filter: File size
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersSizeOp',
                                    -size         => [110, 22]               ,
                                    -pos          => [250, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersSizeOp->Add($STR{'Smaller'}, $STR{'Equal'}, $STR{'Bigger'}, );
  $winSelFileFilters->cbSelFileFiltersSizeOp->SetCurSel(0);
  $winSelFileFilters->AddTextfield( -name         => 'tfSelFileFiltersSize'  ,
                                    -size         => [ 80, 24]               ,
                                    -pos          => [365, 65]               ,
                                    -number       => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersSizeUnit',
                                    -size         => [ 80, 22]               ,
                                    -pos          => [450, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -vscroll      => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersSizeUnit->Add($STR{'b'}, $STR{'Kb'}, $STR{'Mb'},$STR{'Gb'});
  $winSelFileFilters->cbSelFileFiltersSizeUnit->SetCurSel(0);
  $winSelFileFilters->AddLabel(     -name         => 'lblSelFileFiltersItemList',
                                    -size         => [ 60, 22]               ,
                                    -pos          => [145, 95]               ,
                                    -background   => [255, 255, 255]         ,
                                    -text         => 'List:'                 ,
                                    -font         => $font10                 ,
                                    -visible      => 0                       ,
                                    -disabled     => 1                       , );
  $winSelFileFilters->AddTextfield( -name         => 'tfSelFileFiltersItemList',
                                    -size         => [280, 70]               ,
                                    -pos          => [250, 95]               ,
                                    -multiline    => 1                       ,
                                    -wantreturn   => 1                       ,
                                    -vscroll      => 1                       ,
                                    -autohscroll  => 1                       ,
                                    -visible      => 0                       ,
                                    -disabled     => 1                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->tfSelFileFiltersItemList->MaxLength(5000000);
  # Filter: Last accessed
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersLastAccess',
                                    -size         => [110, 22]               ,
                                    -pos          => [250, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -vscroll      => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersLastAccess->Add($STR{'Before'}, $STR{'Equal'}, $STR{'After'});
  $winSelFileFilters->cbSelFileFiltersLastAccess->SetCurSel(0);
  $winSelFileFilters->AddDateTime(  -name         => 'dtSelFileFiltersLastAccess',
                                    -size         => [110, 24]               ,
                                    -pos          => [365, 65]               ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -format       => "shortdate"             ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  # Filter: Last modified
  $winSelFileFilters->AddCombobox(  -name         => 'cbSelFileFiltersLastModif',
                                    -size         => [110, 22]               ,
                                    -pos          => [250, 65]               ,
                                    -font         => $font10                 ,
                                    -dropdownlist => 1                       ,
                                    -vscroll      => 1                       ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->cbSelFileFiltersLastModif->Add($STR{'Before'}, $STR{'Equal'},$STR{'After'});
  $winSelFileFilters->cbSelFileFiltersLastModif->SetCurSel(0);
  $winSelFileFilters->AddDateTime(  -name         => 'dtSelFileFiltersLastModif',
                                    -size         => [110, 24]               ,
                                    -pos          => [365, 65]               ,
                                    -font         => $font10                 ,
                                    -background   => [255, 255, 255]         ,
                                    -format       => "shortdate"             ,
                                    -visible      => 0                       ,
                                    -tabstop      => 1                       , );
  $winSelFileFilters->AddButton(    -name         => 'btnSelFileFiltersNotReady',
                                    -size         => [ 30, 30]               ,
                                    -pos          => [225,180]               ,
                                    -text         => '?'                     ,
                                    -font         => $font10                 , );
  $winSelFileFilters->AddButton(    -name         => 'btnSelFileFiltersOk'   ,
                                    -size         => [100, 30]               ,
                                    -pos          => [270,180]               ,
                                    -text         => $STR{'SetAddFilter'}    ,
                                    -font         => $font10                 ,
                                    -disabled     => 1                       , );
  $winSelFileFilters->AddButton(    -name         => 'btnSelFileFiltersCancel',
                                    -size         => [100, 30]               ,
                                    -pos          => [385,180]               ,
                                    -text         => $STR{'cancel'}          ,
                                    -font         => $font10                 , );
  
}  #--- End createWinSelFileFilters

#--------------------------#
sub TabSelFileFiltersType_Change
#--------------------------#
{
  # Local variables
  my $onlyFolderOn = shift;
  my $type         = $winSelFileFilters->TabSelFileFiltersType->SelectedItem();
  # Contains
  if (!$type) {
    $winSelFileFilters->chSelFileFiltersContainsCase->Show();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Show();
    if (!$onlyFolderOn) { $winSelFileFilters->chSelFileFiltersContainsFileOnly->Show(); }
    else                { $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide(); }
    $winSelFileFilters->tfSelFileFiltersContains->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Disable();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    $winSelFileFilters->lblSelFileFiltersItemList->Hide();
    $winSelFileFilters->tfSelFileFiltersItemList->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  # File size
  } elsif ($type == 1) {
    $winSelFileFilters->cbSelFileFiltersSizeOp->Show();
    $winSelFileFilters->tfSelFileFiltersSize->Show();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Show();
    $winSelFileFilters->lblSelFileFiltersItemList->Show();
    $winSelFileFilters->tfSelFileFiltersItemList->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Disable();
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  # Last accessed
  } elsif ($type == 2) {
    $winSelFileFilters->cbSelFileFiltersLastAccess->Show();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Show();
    $winSelFileFilters->lblSelFileFiltersItemList->Show();
    $winSelFileFilters->tfSelFileFiltersItemList->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Enable();
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  # Last modified
  } elsif ($type == 3) {
    $winSelFileFilters->cbSelFileFiltersLastModif->Show();
    $winSelFileFilters->dtSelFileFiltersLastModif->Show();
    $winSelFileFilters->lblSelFileFiltersItemList->Show();
    $winSelFileFilters->tfSelFileFiltersItemList->Show();
    $winSelFileFilters->btnSelFileFiltersOk->Enable();
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
  # Last modified
  } else {
    # Hide Contains options
    $winSelFileFilters->chSelFileFiltersContainsCase->Hide();
    $winSelFileFilters->chSelFileFiltersContainsRegex->Hide();
    $winSelFileFilters->chSelFileFiltersContainsFileOnly->Hide();
    $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
    $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
    $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
    $winSelFileFilters->tfSelFileFiltersContains->Hide();
    # Hide File size options
    $winSelFileFilters->cbSelFileFiltersSizeOp->Hide();
    $winSelFileFilters->tfSelFileFiltersSize->Hide();
    $winSelFileFilters->cbSelFileFiltersSizeUnit->Hide();
    $winSelFileFilters->lblSelFileFiltersItemList->Hide();
    $winSelFileFilters->tfSelFileFiltersItemList->Hide();
    # Hide Last accessed options
    $winSelFileFilters->cbSelFileFiltersLastAccess->Hide();
    $winSelFileFilters->dtSelFileFiltersLastAccess->Hide();
    # Hide Last modified options
    $winSelFileFilters->cbSelFileFiltersLastModif->Hide();
    $winSelFileFilters->dtSelFileFiltersLastModif->Hide();
  }
  &isSelFileFiltersReady(0);

}  #--- End TabSelFileFiltersType_Change

#--------------------------#
sub chSelFileFiltersContainsRegex_Click { &isSelFileFiltersReady(0); }
sub tfSelFileFiltersContains_Change     { &isSelFileFiltersReady(0); }
sub tfSelFileFiltersSize_Change         { &isSelFileFiltersReady(0); }
sub tfSelFileFiltersItemList_Change     { &isSelFileFiltersReady(0); }
sub dtSelFileFiltersLastAccess_Change   { &isSelFileFiltersReady(0); }
sub dtSelFileFiltersLastModif_Change    { &isSelFileFiltersReady(0); }
#--------------------------#

#--------------------------#
sub cbSelFileFiltersSizeOp_Change
#--------------------------#
{
  # Local variables
  my $op = $winSelFileFilters->cbSelFileFiltersSizeOp->GetCurSel();
  if ($op == 1) { # Equal
    $winSelFileFilters->lblSelFileFiltersItemList->Enable();
    $winSelFileFilters->tfSelFileFiltersItemList->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersItemList->Disable();
    $winSelFileFilters->tfSelFileFiltersItemList->Disable();
  }

}  #--- End cbSelFileFiltersSizeOp_Change

#--------------------------#
sub cbSelFileFiltersLastAccess_Change
#--------------------------#
{
  # Local variables
  my $op = $winSelFileFilters->cbSelFileFiltersLastAccess->GetCurSel();
  if ($op == 1) { # Equal
    $winSelFileFilters->lblSelFileFiltersItemList->Enable();
    $winSelFileFilters->tfSelFileFiltersItemList->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersItemList->Disable();
    $winSelFileFilters->tfSelFileFiltersItemList->Disable();
  }
  &isSelFileFiltersReady(0);

}  #--- End cbSelFileFiltersLastAccess_Change

#--------------------------#
sub cbSelFileFiltersLastModif_Change
#--------------------------#
{
  # Local variables
  my $op = $winSelFileFilters->cbSelFileFiltersLastModif->GetCurSel();
  if ($op == 1) { # Equal
    $winSelFileFilters->lblSelFileFiltersItemList->Enable();
    $winSelFileFilters->tfSelFileFiltersItemList->Enable();
  } else {
    $winSelFileFilters->lblSelFileFiltersItemList->Disable();
    $winSelFileFilters->tfSelFileFiltersItemList->Disable();
  }
  &isSelFileFiltersReady(0);

}  #--- End cbSelFileFiltersLastModif_Change

#--------------------------#
sub isSelFileFiltersReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $type    = $winSelFileFilters->TabSelFileFiltersType->SelectedItem();
  my $nextStep;
  # Contains
  if (!$type) {
    my $regexStr = $winSelFileFilters->tfSelFileFiltersContains->Text();
    if ($regexStr) {
      if ($winSelFileFilters->chSelFileFiltersContainsRegex->Checked()) {
        my ($statusRegex, $msg);
        my $nbrLines = $winSelFileFilters->tfSelFileFiltersContains->GetLineCount();
        if ($nbrLines == 1) { ($statusRegex, $msg) = &validRegex($regexStr); }
        else {
          my $i = 0;
          while ($i <= $nbrLines) {
            if (my $line = $winSelFileFilters->tfSelFileFiltersContains->GetLine($i)) {
              ($statusRegex, $msg) = &validRegex($line);
              last if $statusRegex == 1;
            }
            $i++;
          }
        }
        # Warning
        if      ($statusRegex == 2) {
          $winSelFileFilters->lblSelFileFiltersContainWarn->Show();
          $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
          $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
        # Error
        } elsif ($statusRegex == 1) {
          $winSelFileFilters->lblSelFileFiltersContainErr->Show();
          $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
          $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
          $nextStep = $STR{'errRegex'}.' '.$msg;
        # Ok
        } else {
          $winSelFileFilters->lblSelFileFiltersContainOk->Show();
          $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
          $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
        }
      }
    } else {
      $winSelFileFilters->lblSelFileFiltersContainOk->Hide();
      $winSelFileFilters->lblSelFileFiltersContainErr->Hide();
      $winSelFileFilters->lblSelFileFiltersContainWarn->Hide();
      $nextStep = $STR{'setContains'};
    }
  # File size
  } elsif ($type == 1) {
    my $op = $winSelFileFilters->cbSelFileFiltersSizeOp->GetCurSel();
    if (($op == 1 and !$winSelFileFilters->tfSelFileFiltersSize->Text() and !$winSelFileFilters->tfSelFileFiltersItemList->Text()) or
        ($op != 1 and !$winSelFileFilters->tfSelFileFiltersSize->Text())) {
      $nextStep = $STR{'setFileSize'};
    } elsif ($op == 1 and $winSelFileFilters->tfSelFileFiltersItemList->Text()) { # Equal with a list of size
      my $nbrLines = $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) {
          if ($line !~ /^\d+$/) { $nextStep = $STR{'setFileSize'}; last; }
        }
        $i++;
      }
    }
  # Last accessed
  } elsif ($type == 2) {
    my $op = $winSelFileFilters->cbSelFileFiltersLastAccess->GetCurSel();
    if ($op == 1 and $winSelFileFilters->tfSelFileFiltersItemList->Text()) { # Equal with a list of date
      my $nbrLines = $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) {
          if ($line !~ /^\d{4}\-\d{2}\-\d{2}/) { $nextStep = $STR{'setDate'}; last; }
        }
        $i++;
      }
    }
  # Last modified
  } elsif ($type == 3) {
    my $op = $winSelFileFilters->cbSelFileFiltersLastModif->GetCurSel();
    if ($op == 1 and $winSelFileFilters->tfSelFileFiltersItemList->Text()) { # Equal with a list of date
      my $nbrLines = $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount();
      my $i = 0;
      while ($i <= $nbrLines) {
        if (my $line = $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)) {
          if ($line !~ /^\d{4}\-\d{2}\-\d{2}/) { $nextStep = $STR{'setDate'}; last; }
        }
        $i++;
      }
    }
  }
  # Return an error message or enable the button
  if ($nextStep) {
    $winSelFileFilters->btnSelFileFiltersOk->Disable();
    $winSelFileFilters->btnSelFileFiltersNotReady->Enable();
    Win32::GUI::MessageBox($winSelFileFilters, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $winSelFileFilters->btnSelFileFiltersOk->Enable();
    $winSelFileFilters->btnSelFileFiltersNotReady->Disable();
  }
  
}  #--- End isSelFileFiltersReady

#--------------------------#
sub btnSelFileFiltersNotReady_Click { &isSelFileFiltersReady(1); }
sub btnSelFileFiltersCancel_Click   { &winSelFileFilters_Terminate(); }
#--------------------------#

#--------------------------#
sub winSelFileFilters_Terminate
#--------------------------#
{
  $winSelFileFilters->Hide();
  $winFileFilters->Enable();
  return(0);

}  #--- End winSelFileFilters_Terminate

#--------------------------#
sub btnSelFileFiltersOk_Click
#--------------------------#
{
  # Close Filter window
  &winSelFileFilters_Terminate();
  # Local variables
  my $editRow  = $winSelFileFilters->lblSelFileFiltersEditRow->Text();
  my $operator = 0;
  my $type     = $winSelFileFilters->TabSelFileFiltersType->SelectedItem();
  my $typeOp;
  my $flags;
  my @searchStrings;
  my $searchStr;
  $operator = $winSelFileFilters->cbSelFileFiltersOp->GetString($winSelFileFilters->cbSelFileFiltersOp->GetCurSel())
  if ($winSelFileFilters->cbSelFileFiltersOp->IsEnabled());
  if (!$type) {
    # Search strings
    for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersContains->GetLineCount(); $i++) {
      push(@searchStrings, $winSelFileFilters->tfSelFileFiltersContains->GetLine($i))
      if $winSelFileFilters->tfSelFileFiltersContains->GetLine($i);
    }
    # Flags
    if ($winSelFileFilters->chSelFileFiltersContainsCase->Checked())     { $flags  = '1-'; }
    else                                                                 { $flags  = '0-'; }
    if ($winSelFileFilters->chSelFileFiltersContainsRegex->Checked())    { $flags .= '1-'; }
    else                                                                 { $flags .= '0-'; }
    if ($winSelFileFilters->chSelFileFiltersContainsFileOnly->Checked()) { $flags .= '1';  }
    else                                                                 { $flags .= '0';  }
  # File size
  } elsif ($type == 1) {
    $typeOp      = $winSelFileFilters->cbSelFileFiltersSizeOp->GetString($winSelFileFilters->cbSelFileFiltersSizeOp->GetCurSel());
    my $sizeUnit = $winSelFileFilters->cbSelFileFiltersSizeUnit->GetString($winSelFileFilters->cbSelFileFiltersSizeUnit->GetCurSel());
    push(@searchStrings, $winSelFileFilters->tfSelFileFiltersSize->Text()." $sizeUnit")
    if $winSelFileFilters->tfSelFileFiltersSize->Text();
    if ($winSelFileFilters->tfSelFileFiltersItemList->Text()) {
      # Search strings
      for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount(); $i++) {
        push(@searchStrings, $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i)." $sizeUnit")
        if $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i);
      }
    }
  # Last accessed
  } elsif ($type == 2) {
    $typeOp = $winSelFileFilters->cbSelFileFiltersLastAccess->GetString($winSelFileFilters->cbSelFileFiltersLastAccess->GetCurSel());
    if ($winSelFileFilters->dtSelFileFiltersLastAccess->GetDate()) {
      my ($d, $m, $y) = $winSelFileFilters->dtSelFileFiltersLastAccess->GetDate();
      my $dateStr = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      push(@searchStrings, $dateStr);
    }
    if ($winSelFileFilters->tfSelFileFiltersItemList->Text()) {
      # Search strings
      for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount(); $i++) {
        push(@searchStrings, $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i))
        if $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i);
      }
    }
  # Last modified
  } elsif ($type == 3) {
    $typeOp = $winSelFileFilters->cbSelFileFiltersLastModif->GetString($winSelFileFilters->cbSelFileFiltersLastModif->GetCurSel());
    if ($winSelFileFilters->dtSelFileFiltersLastModif->GetDate()) {
      my ($d, $m, $y) = $winSelFileFilters->dtSelFileFiltersLastModif->GetDate();
      my $dateStr = sprintf("%04d\-%02d\-%02d", $y, $m, $d);
      push(@searchStrings, $dateStr);
    }
    if ($winSelFileFilters->tfSelFileFiltersItemList->Text()) {
      # Search strings
      for (my $i = 0; $i <= $winSelFileFilters->tfSelFileFiltersItemList->GetLineCount(); $i++) {
        push(@searchStrings, $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i))
        if $winSelFileFilters->tfSelFileFiltersItemList->GetLine($i);
      }
    }
  }
  # Feed the grid
  my $typeStr  = $winSelFileFilters->TabSelFileFiltersType->GetString($type);
  my $nbrItems = scalar(@searchStrings);
  $operator = $STR{'OR'} if $nbrItems > 1;
  if (@searchStrings) {
    my $row;
    foreach my $string (@searchStrings) {
      if ($string) {
        if ($editRow) { $row = $editRow++; } # Edit mode
        else          { $row = $winFileFilters->gridFileFilters->InsertRow('-', -1); }
        if ($operator and $row > 1) {
          $winFileFilters->gridFileFilters->SetCellText($row, 0, $operator);
          $winFileFilters->gridFileFilters->SetCellEditable($row, 0, 1);
          $winFileFilters->gridFileFilters->SetCellType($row, 0, 6);
          $winFileFilters->gridFileFilters->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
        }
        $winFileFilters->gridFileFilters->SetCellText($row, 1, $typeStr);
        $winFileFilters->gridFileFilters->SetCellText($row, 2, $typeOp) if $typeOp;
        $winFileFilters->gridFileFilters->SetCellText($row, 3, $flags ) if $flags;
        $winFileFilters->gridFileFilters->SetCellText($row, 4, $string);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 1, 0);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 2, 0);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 3, 0);
        $winFileFilters->gridFileFilters->SetCellEditable($row, 4, 0);
      }
    }
  } else { # File formats
    my $row;
    if ($editRow) { $row = $editRow; } # Edit mode
    else          { $row = $winFileFilters->gridFileFilters->InsertRow('-', -1); }
    if ($operator and $row > 1) {
      $winFileFilters->gridFileFilters->SetCellText($row, 0, $operator);
      $winFileFilters->gridFileFilters->SetCellEditable($row, 0, 1);
      $winFileFilters->gridFileFilters->SetCellType($row, 0, 6);
      $winFileFilters->gridFileFilters->SetCellOptions($row, 0, [$STR{'OR'}, $STR{'AND'}]);
    }
    $winFileFilters->gridFileFilters->SetCellText($row, 1, $typeStr);
    $winFileFilters->gridFileFilters->SetCellText($row, 2, $typeOp) if $typeOp;
    $winFileFilters->gridFileFilters->SetCellEditable($row, 1, 0);
    $winFileFilters->gridFileFilters->SetCellEditable($row, 2, 0);
    $winFileFilters->gridFileFilters->SetCellEditable($row, 3, 0);
    $winFileFilters->gridFileFilters->SetCellText($row, 4, $searchStr) if $searchStr;
    $winFileFilters->gridFileFilters->SetCellEditable($row, 4, 0);
  }
  $winFileFilters->gridFileFilters->AutoSizeColumns();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  $winFileFilters->gridFileFilters->Refresh();
  $winFileFilters->btnFileFilterDel->Enable();
  $winFileFilters->btnFileFiltersSave->Enable();

}  #--- End btnSelFileFiltersOk_Click
  
#--------------------------#
sub btnFileFilterDel_Click
#--------------------------#
{
  # Local variables
  my (@coord) = $winFileFilters->gridFileFilters->GetSelectedCellRange();
  my $firstSelectedRow;
  my $lastSelectedRow;
  if    ($coord[2]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[2]; }
  elsif ($coord[0]) { $firstSelectedRow = $coord[0]; $lastSelectedRow = $coord[0]; }
  else {
    $firstSelectedRow = $winFileFilters->gridFileFilters->GetRows()-1;
    $lastSelectedRow  = $winFileFilters->gridFileFilters->GetRows()-1;
  }
  for (my $row = $lastSelectedRow; $row >= $firstSelectedRow; $row--) {
    $winFileFilters->gridFileFilters->DeleteRow($row) if $winFileFilters->gridFileFilters->IsCellSelected($row, 0);
  }
  # Reset first line operator
  $winFileFilters->gridFileFilters->SetCellText(1, 0, '-') if $winFileFilters->gridFileFilters->GetCellText(1, 0) ne '-';
  # Disable Delete buttons if no more filter
  if ($winFileFilters->gridFileFilters->GetRows() == 1) {
    $winFileFilters->btnFileFilterDel->Disable();
    $winFileFilters->btnFileFiltersSave->Disable();
  }
  $winFileFilters->gridFileFilters->AutoSizeColumns();
  $winFileFilters->gridFileFilters->ExpandLastColumn();
  $winFileFilters->gridFileFilters->Refresh();

}  #--- End btnFileFilterDel_Click

#--------------------------#
sub btnFileFiltersImport_Click
#--------------------------#
{
  # Local variables
  my $dir;
  if (-d "$USERDIR\\FileFilters") { $dir = "$USERDIR\\FileFilters"; }
  else                            { $dir = $USERDIR;                }
  # Select the json file
  my $file = Win32::GUI::GetOpenFileName( -owner         => $winFileFilters            ,
                                          -title         => $STR{'selFile'}.':'        ,
                                          -filter        => ['JSON (*.json)', '*.json'],
                                          -filemustexist => 1                          ,
                                          -directory     => $dir                       ,
                                          -explorer      => 1                          , );
  if ($file and -T $file) {
    if (open(my $json, $file)) {
      my $jsonText = <$json>;
      close($json);
      my $jsonObj = JSON->new;
      my $refFilter = $jsonObj->decode($jsonText);
      $winFileFilters->gridFileFilters->DeleteNonFixedRows(); # Reset grid
      foreach my $row (sort {$a <=> $b} keys %{$refFilter}) {
        # Feed the grid
        if ($$refFilter{$row}{type} and my $newLine = $winFileFilters->gridFileFilters->InsertRow('-', -1)) {
          $winFileFilters->gridFileFilters->SetCellText($newLine, 0, $$refFilter{$row}{operator});
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 0, 1);
          $winFileFilters->gridFileFilters->SetCellType($newLine, 0, 6);
          $winFileFilters->gridFileFilters->SetCellOptions($newLine, 0, [$STR{'OR'}, $STR{'AND'}]);
          $winFileFilters->gridFileFilters->SetCellText($newLine, 1, $$refFilter{$row}{type});
          $winFileFilters->gridFileFilters->SetCellText($newLine, 2, $$refFilter{$row}{typeOp}  ) if $$refFilter{$row}{typeOp};
          $winFileFilters->gridFileFilters->SetCellText($newLine, 3, $$refFilter{$row}{flagsStr}) if $$refFilter{$row}{flagsStr};
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 1, 0);
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 2, 0);
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 3, 0);
          $winFileFilters->gridFileFilters->SetCellText($newLine, 4, $$refFilter{$row}{searchStr}) if $$refFilter{$row}{searchStr};
          $winFileFilters->gridFileFilters->SetCellEditable($newLine, 4, 0);
        }
      }
      if ($winFileFilters->gridFileFilters->GetRows() > 1) {
        $winFileFilters->gridFileFilters->AutoSizeColumns();
        $winFileFilters->gridFileFilters->ExpandLastColumn();
        $winFileFilters->gridFileFilters->Refresh();
        $winFileFilters->btnFileFilterDel->Enable();
        $winFileFilters->btnFileFiltersSave->Enable();
      }
    } else { Win32::GUI::MessageBox($winFileFilters, "$STR{'errorOpening'} $file", $STR{'errorOpening'}, 0x40010); }
  }
  
}  #--- End btnFileFiltersImport_Click

#--------------------------#
sub btnFileFiltersSave_Click
#--------------------------#
{
  # Create the directory for File Filters files (json)
  if (!-d "$USERDIR\\FileFilters") { mkdir("$USERDIR\\FileFilters"); }
  # Show SaveFileWindow for database
  my $file = Win32::GUI::GetSaveFileName( -owner            => $winFileFilters            ,
                                          -title            => $STR{'selFile'}.':'        ,
                                          -filter           => ['JSON (*.json)', '*.json'],
                                          -directory        => "$USERDIR\\FileFilters"    ,
                                          -overwriteprompt  => 1                          , );
  if ($file) {
    $file .= '.json' if $file !~ /\.json$/;
    # Gather all filters
    my %filters;
    for (my $row = 1; $row <= $winFileFilters->gridFileFilters->GetRows(); $row++) {
      $filters{$row}{operator}  = $winFileFilters->gridFileFilters->GetCellText($row, 0);
      $filters{$row}{type}      = $winFileFilters->gridFileFilters->GetCellText($row, 1);
      $filters{$row}{typeOp}    = $winFileFilters->gridFileFilters->GetCellText($row, 2);
      $filters{$row}{flagsStr}  = $winFileFilters->gridFileFilters->GetCellText($row, 3);
      $filters{$row}{searchStr} = $winFileFilters->gridFileFilters->GetCellText($row, 4);
    }
    # Create or update JSON
    my $jsonObj = JSON->new;
    my $jsonText = $jsonObj->encode(\%filters);
    if (open(my $json, '>:encoding(cp1252)', $file)) {
      print $json $jsonText;
      close($json);
    } else { Win32::GUI::MessageBox($winFileFilters, "$STR{'errorWriting'} $file", $STR{'errorWriting'}, 0x40010); }
  }
  
}  #--- End btnFileFiltersSave_Click

#--------------------------#
sub isOnlyFoldersOn
#--------------------------#
{
  if ($winFileFilters) {
    for (my $row = 0; $row <= $winFileFilters->gridFileFilters->GetRows(); $row++) {
      return(1) if $winFileFilters->gridFileFilters->GetCellText(1, 1) eq $STR{'OnlyFolders'};
    }
    return(0);
  }
  
}  #--- End isOnlyFoldersOn
  
#--------------------------#
sub OnlyFoldersOn
#--------------------------#
{
  # Lot of options and functions don't apply to folders, disable it
  $win->TabFunctions->DeleteAllItems();
  $win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions1T'} , );
  $win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions2T'} , );
  $win->TabFunctions->SetCurSel(0);
  &TabFunctions_Click();
  # BringWindowToTop fix a display bug
  $win->chListFilesOptFP->BringWindowToTop();
  $win->chListFilesOptP->BringWindowToTop();
  $win->chListFilesOptNH->BringWindowToTop();
  $win->lblListReportShadowT->BringWindowToTop();
  $win->lblListReportT->BringWindowToTop();
  $win->tfReportDir->BringWindowToTop();
  $win->cbReportFormat->BringWindowToTop();
  $win->btnReportDir->BringWindowToTop();
  $win->btnOpenReportDir->BringWindowToTop();
  $win->chOpenReport->BringWindowToTop();

}  #--- End OnlyFoldersOn

#--------------------------#
sub OnlyFoldersOff
#--------------------------#
{
  # Lot of options and functions don't apply to folders, disable it
  $win->TabFunctions->DeleteAllItems();
  $win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions1T'} , );
  $win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions2T'} , );
  $win->TabFunctions->InsertItem(-text  => $STR{'lblFunctions3T'} , );
  $win->TabFunctions->SetCurSel(0);
  &TabFunctions_Click();

}  #--- End OnlyFoldersOff

#--------------------------#
sub TabFunctions_Click
#--------------------------#
{
  # Show List Function tab
  if (!$win->TabFunctions->SelectedItem()) {
    $win->TabFuncLists->Show();
    if (&isOnlyFoldersOn()) {
      # Remove List Extensions tab
      if ($win->TabFuncLists->Count() > 1) {
        $win->TabFuncLists->DeleteAllItems();
        $win->TabFuncLists->InsertItem(-text => $STR{'Files'});
        $win->TabFuncLists->SetCurSel(0);
        &TabFuncLists_Click();
      }
      $win->lblListIncludeShadowT->Show();
      $win->lblListIncludeT->Show();
      $win->chListFilesOptFP->Show();
      $win->chListFilesOptP->Show();
      $win->chListFilesOptNH->Show();
      $win->chListFilesOptFN->Hide();
      $win->chListFilesOptFE->Hide();
      $win->chListFilesOptCount->Hide();
      $win->chListFilesOptLM->Hide();
      $win->chListFilesOptHV->Hide();
      $win->chListFilesOptFD->Show();
      $win->chListFilesOptNbrF->Show();
      $win->chListFilesOptNbrL->Hide();
      $win->chListFilesOptNbrP->Hide();
      $win->chListFilesOptNF->Hide();
    } elsif ($win->TabFuncLists->Count() == 1) {
      # Reset tabs
      $win->TabFuncLists->DeleteAllItems();
      $win->TabFuncLists->InsertItem(-text => $STR{'Files'}     );
      $win->TabFuncLists->InsertItem(-text => $STR{'Extensions'});
      $win->TabFuncLists->SetCurSel(0);
      &TabFuncLists_Click();
    # List Files
    } elsif (!$win->TabFuncLists->SelectedItem()) {
      $win->lblListIncludeShadowT->Show();
      $win->lblListIncludeT->Show();
      $win->chListFilesOptFP->Show();
      $win->chListFilesOptP->Show();
      $win->chListFilesOptNH->Show();
      $win->chListFilesOptFN->Show();
      $win->chListFilesOptFE->Show();
      $win->chListFilesOptCount->Show();
      $win->chListFilesOptLM->Show();
      $win->chListFilesOptHV->Show();
      $win->chListFilesOptFD->Show();
      $win->chListFilesOptNbrF->Show();
      $win->chListFilesOptNbrL->Show();
      $win->chListFilesOptNbrP->Show();
      $win->chListFilesOptNF->Show();
    # List extension
    } else {
      $win->lblListExtOptShadowT->Show();
      $win->lblListExtOptT->Show();
      $win->lblListExtMinLength->Show();
      $win->tfListExtMinLength->Show();
      $win->upDownByListExtMinLength->Show();
      $win->lblListExtMaxLength->Show();
      $win->tfListExtMaxLength->Show();
      $win->upDownByListExtMaxLength->Show();
    }
    $win->lblListReportShadowT->Show();
    $win->lblListReportT->Show();
    $win->tfReportDir->Show();
    $win->cbReportFormat->Show();
    $win->btnReportDir->Show();
    $win->btnOpenReportDir->Show();
    $win->chOpenReport->Show();
    # Hide Copy or move Function tab
    $win->TabFuncCopy->Hide();
    $win->lblCopyOptShadowT->Hide();
    $win->lblCopyOptT->Hide();
    $win->chCopyTree->Hide();
    $win->chCopyRemDouble->Hide();
    $win->lblCopyDestShadowT->Hide();
    $win->lblCopyDestT->Hide();
    $win->tfDestinationDir->Hide();
    $win->btnDestinationDir->Hide();
    $win->chOpenDstDir->Hide();
    # Hide Rename Function tab
    $win->lblRenHashTypeShadowT->Hide();
    $win->lblRenHashTypeT->Hide();
    $win->cbRenByHash->Hide();
    $win->lblRenHashOptShadowT->Hide();
    $win->lblRenHashOptT->Hide();
    $win->chRenByHashNoDupl->Hide();
    $win->chRenByHashRemExt->Hide();
    $win->lblRenBySortShadowT->Hide();
    $win->lblRenBySortT->Hide();
    $win->lblRenBySort->Hide();
    $win->cbRenBySortType->Hide();
    $win->rbRenBySortAsc->Hide();
    $win->rbRenBySortDsc->Hide();
    $win->lblBySortRenShadowT->Hide();
    $win->lblBySortRenT->Hide();
    $win->lblBySortRenExample->Hide();
    $win->tfBySortRenExample->Hide();
    $win->chBySortRenRemExt->Hide();
    $win->lblBySortRenIncrValType->Hide();
    $win->cbBySortRenIncrValType->Hide();
    $win->lblBySortRenInitVal->Hide();
    $win->tfBySortRenInitVal->Hide();
    $win->upDownBySortRenInitVal->Hide();
    $win->lblBySortRenStepVal->Hide();
    $win->tfBySortRenStepVal->Hide();
    $win->upDownBySortRenStepVal->Hide();
    $win->lblBySortRenLength->Hide();
    $win->tfBySortRenLength->Hide();
    $win->upDownBySortRenLength->Hide();
    $win->lblBySortRenPrefix->Hide();
    $win->tfBySortRenPrefix->Hide();
    $win->lblBySortRenSuffix->Hide();
    $win->tfBySortRenSuffix->Hide();
    $win->lblReplaceShadowT->Hide();
    $win->lblReplaceT->Hide();
    $win->tfRenReplace->Hide();
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Hide();
    $win->lblReplaceByShadowT->Hide();
    $win->lblReplaceByT->Hide();
    $win->tfRenReplaceBy->Hide();
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->chRenReplaceByEval->Hide();
  # Show Copy or move Function tab
  } elsif ($win->TabFunctions->SelectedItem() == 1) {
    $win->TabFuncCopy->Show();
    if (&isOnlyFoldersOn()) {
      $win->chCopyRemDouble->Checked(0);
      $win->chCopyRemDouble->Hide;
    } else { $win->chCopyRemDouble->Show(); }
    $win->lblCopyOptShadowT->Show();
    $win->lblCopyOptT->Show();
    $win->chCopyTree->Show();
    $win->lblCopyDestShadowT->Show();
    $win->lblCopyDestT->Show();
    $win->tfDestinationDir->Show();
    $win->btnDestinationDir->Show();
    $win->chOpenDstDir->Show();
    # Hide List Function tab
    $win->TabFuncLists->Hide();
    $win->lblListIncludeShadowT->Hide();
    $win->lblListIncludeT->Hide();
    $win->chListFilesOptFP->Hide();
    $win->chListFilesOptP->Hide();
    $win->chListFilesOptFN->Hide();
    $win->chListFilesOptFE->Hide();
    $win->chListFilesOptCount->Hide();
    $win->chListFilesOptLM->Hide();
    $win->chListFilesOptHV->Hide();
    $win->chListFilesOptFD->Hide();
    $win->chListFilesOptNbrF->Hide();
    $win->chListFilesOptNbrL->Hide();
    $win->chListFilesOptNbrP->Hide();
    $win->chListFilesOptNH->Hide();
    $win->chListFilesOptNF->Hide();
    $win->lblListExtOptShadowT->Hide();
    $win->lblListExtOptT->Hide();
    $win->lblListExtMinLength->Hide();
    $win->tfListExtMinLength->Hide();
    $win->upDownByListExtMinLength->Hide();
    $win->lblListExtMaxLength->Hide();
    $win->tfListExtMaxLength->Hide();
    $win->upDownByListExtMaxLength->Hide();
    $win->lblListReportShadowT->Hide();
    $win->lblListReportT->Hide();
    $win->tfReportDir->Hide();
    $win->cbReportFormat->Hide();
    $win->btnReportDir->Hide();
    $win->btnOpenReportDir->Hide();
    $win->chOpenReport->Hide();
    # Hide Rename Function tab
    $win->lblRenHashTypeShadowT->Hide();
    $win->lblRenHashTypeT->Hide();
    $win->cbRenByHash->Hide();
    $win->lblRenHashOptShadowT->Hide();
    $win->lblRenHashOptT->Hide();
    $win->chRenByHashNoDupl->Hide();
    $win->chRenByHashRemExt->Hide();
    $win->lblRenBySortShadowT->Hide();
    $win->lblRenBySortT->Hide();
    $win->lblRenBySort->Hide();
    $win->cbRenBySortType->Hide();
    $win->rbRenBySortAsc->Hide();
    $win->rbRenBySortDsc->Hide();
    $win->lblBySortRenShadowT->Hide();
    $win->lblBySortRenT->Hide();
    $win->lblBySortRenExample->Hide();
    $win->tfBySortRenExample->Hide();
    $win->chBySortRenRemExt->Hide();
    $win->lblBySortRenIncrValType->Hide();
    $win->cbBySortRenIncrValType->Hide();
    $win->lblBySortRenInitVal->Hide();
    $win->tfBySortRenInitVal->Hide();
    $win->upDownBySortRenInitVal->Hide();
    $win->lblBySortRenStepVal->Hide();
    $win->tfBySortRenStepVal->Hide();
    $win->upDownBySortRenStepVal->Hide();
    $win->lblBySortRenLength->Hide();
    $win->tfBySortRenLength->Hide();
    $win->upDownBySortRenLength->Hide();
    $win->lblBySortRenPrefix->Hide();
    $win->tfBySortRenPrefix->Hide();
    $win->lblBySortRenSuffix->Hide();
    $win->tfBySortRenSuffix->Hide();
    $win->lblReplaceShadowT->Hide();
    $win->lblReplaceT->Hide();
    $win->tfRenReplace->Hide();
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Hide();
    $win->lblReplaceByShadowT->Hide();
    $win->lblReplaceByT->Hide();
    $win->tfRenReplaceBy->Hide();
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->chRenReplaceByEval->Hide();
  # Show Rename Function tab
  } elsif ($win->TabFunctions->SelectedItem() == 2) {
    $win->TabFuncRen->Show();
    &TabFuncRen_Click();
    # Hide List Function tab
    $win->TabFuncLists->Hide();
    $win->lblListIncludeShadowT->Hide();
    $win->lblListIncludeT->Hide();
    $win->chListFilesOptFP->Hide();
    $win->chListFilesOptP->Hide();
    $win->chListFilesOptFN->Hide();
    $win->chListFilesOptFE->Hide();
    $win->chListFilesOptCount->Hide();
    $win->chListFilesOptLM->Hide();
    $win->chListFilesOptHV->Hide();
    $win->chListFilesOptFD->Hide();
    $win->chListFilesOptNbrF->Hide();
    $win->chListFilesOptNbrL->Hide();
    $win->chListFilesOptNbrP->Hide();
    $win->chListFilesOptNH->Hide();
    $win->chListFilesOptNF->Hide();
    $win->lblListExtOptShadowT->Hide();
    $win->lblListExtOptT->Hide();
    $win->lblListExtMinLength->Hide();
    $win->tfListExtMinLength->Hide();
    $win->upDownByListExtMinLength->Hide();
    $win->lblListExtMaxLength->Hide();
    $win->tfListExtMaxLength->Hide();
    $win->upDownByListExtMaxLength->Hide();
    $win->lblListReportShadowT->Hide();
    $win->lblListReportT->Hide();
    $win->tfReportDir->Hide();
    $win->cbReportFormat->Hide();
    $win->btnReportDir->Hide();
    $win->btnOpenReportDir->Hide();
    $win->chOpenReport->Hide();
    # Hide Copy or move Function tab
    $win->TabFuncCopy->Hide();
    $win->lblCopyOptShadowT->Hide();
    $win->lblCopyOptT->Hide();
    $win->chCopyTree->Hide();
    $win->chCopyRemDouble->Hide();
    $win->lblCopyDestShadowT->Hide();
    $win->lblCopyDestT->Hide();
    $win->tfDestinationDir->Hide();
    $win->btnDestinationDir->Hide();
    $win->chOpenDstDir->Hide();
  }
  &isProcessReady(0);
  
}  #--- End TabFunctions_Click

#--------------------------#
sub TabFuncLists_Click
#--------------------------#
{
  # Show List Files tab
  if (!$win->TabFuncLists->SelectedItem()) {
    $win->lblListIncludeShadowT->Show();
    $win->lblListIncludeT->Show();
    $win->chListFilesOptFP->Show();
    $win->chListFilesOptP->Show();
    $win->chListFilesOptFN->Show();
    $win->chListFilesOptLM->Show();
    $win->chListFilesOptFE->Show();
    $win->chListFilesOptCount->Show();
    $win->chListFilesOptHV->Show();
    $win->chListFilesOptFD->Show();
    $win->chListFilesOptNbrF->Show();
    $win->chListFilesOptNbrL->Show();
    $win->chListFilesOptNbrP->Show();
    $win->chListFilesOptNH->Show();
    $win->chListFilesOptNF->Show();
    $win->lblListExtOptShadowT->Hide();
    $win->lblListExtOptT->Hide();
    $win->lblListExtMinLength->Hide();
    $win->tfListExtMinLength->Hide();
    $win->upDownByListExtMinLength->Hide();
    $win->lblListExtMaxLength->Hide();
    $win->tfListExtMaxLength->Hide();
    $win->upDownByListExtMaxLength->Hide();
    &isProcessReady(0);
  # Show List extension tab
  } else {
    $win->lblListExtOptShadowT->Show();
    $win->lblListExtOptT->Show();
    $win->lblListExtMinLength->Show();
    $win->tfListExtMinLength->Show();
    $win->upDownByListExtMinLength->Show();
    $win->lblListExtMaxLength->Show();
    $win->tfListExtMaxLength->Show();
    $win->upDownByListExtMaxLength->Show();
    $win->lblListIncludeShadowT->Hide();
    $win->lblListIncludeT->Hide();
    $win->chListFilesOptFP->Hide();
    $win->chListFilesOptP->Hide();
    $win->chListFilesOptFN->Hide();
    $win->chListFilesOptFE->Hide();
    $win->chListFilesOptCount->Hide();
    $win->chListFilesOptLM->Hide();
    $win->chListFilesOptHV->Hide();
    $win->chListFilesOptFD->Hide();
    $win->chListFilesOptNbrF->Hide();
    $win->chListFilesOptNbrL->Hide();
    $win->chListFilesOptNbrP->Hide();
    $win->chListFilesOptNH->Hide();
    $win->chListFilesOptNF->Hide();
    &isProcessReady(0);
  }
  
}  #--- End TabFuncLists_Click

#--------------------------#
sub chListFilesOptFP_Click { &isProcessReady(0); }
sub chListFilesOptF_Click  { &isProcessReady(0); }
sub chListFilesOptFN_Click { &isProcessReady(0); }
sub chListFilesOptFE_Click { &isProcessReady(0); }
sub chListFilesOptLM_Click { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub chListFilesOptHV_Click
#--------------------------#
{
  if ($win->chListFilesOptHV->Checked()) {
    $winHashVal->chListFilesHV1->Checked(1);
    $winHashVal->chListFilesHV2->Checked(1);
    $winHashVal->chListFilesHV3->Checked(1);
    $winHashVal->chListFilesHV4->Checked(1);
    $winHashVal->Center($win);
    $winHashVal->Show();
    $win->Disable();
    return(1);
  } else {
    $winHashVal->chListFilesHV1->Checked(0);
    $winHashVal->chListFilesHV2->Checked(0);
    $winHashVal->chListFilesHV3->Checked(0);
    $winHashVal->chListFilesHV4->Checked(0);
    &isProcessReady(0);
  }

}  #--- End chListFilesOptHV_Click

#--------------------------#
sub btnHashValuesOk_Click  { &winHashVal_Terminate(); }
#--------------------------#

#--------------------------#
sub winHashVal_Terminate
#--------------------------#
{
  &isProcessReady(0);
  $winHashVal->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winHashVal_Terminate

#--------------------------#
sub chListFilesHV1_Click { &isProcessReady(0); }
sub chListFilesHV2_Click { &isProcessReady(0); }
sub chListFilesHV3_Click { &isProcessReady(0); }
sub chListFilesHV4_Click { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub chListFilesOptFD_Click
#--------------------------#
{
  if ($win->chListFilesOptFD->Checked()) {
    $winFileDetails->chListFilesFD1->Checked(1);
    $winFileDetails->chListFilesFD2->Checked(1);
    $winFileDetails->chListFilesFD3->Checked(1);
    $winFileDetails->Center($win);
    $winFileDetails->Show();
    $win->Disable();
    return(1);
  } else {
    $winFileDetails->chListFilesFD1->Checked(0);
    $winFileDetails->chListFilesFD2->Checked(0);
    $winFileDetails->chListFilesFD3->Checked(0);
    &isProcessReady(0);
  }

}  #--- End chListFilesOptFD_Click

#--------------------------#
sub btnFileDetailsOk_Click { &winFileDetails_Terminate(); }
#--------------------------#

#--------------------------#
sub winFileDetails_Terminate
#--------------------------#
{
  &isProcessReady(0);
  $winFileDetails->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winFileDetails_Terminate

#--------------------------#
sub chListFilesFD1_Click     { &isProcessReady(0); }
sub chListFilesFD2_Click     { &isProcessReady(0); }
sub chListFilesFD3_Click     { &isProcessReady(0); }
sub chListFilesOptNbrF_Click { &isProcessReady(0); }
sub chListFilesOptNbrL_Click { &isProcessReady(0); }
sub chListFilesOptNbrP_Click { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub chListFilesOptCount_Click
#--------------------------#
{
  if ($win->chListFilesOptCount->Checked()) {
    $winCountOpt->Center($win);
    $winCountOpt->Show();
    $win->Disable();
    return(1);
  } else { &isProcessReady(0); }

}  #--- End chListFilesOptCount_Click

#--------------------------#
sub btnWinCountOk_Click { &winCountOpt_Terminate(); }
#--------------------------#

#--------------------------#
sub winCountOpt_Terminate
#--------------------------#
{
  &isProcessReady(0);
  $winCountOpt->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winCountOpt_Terminate

#--------------------------#
sub chListFilesOptNF_Click
#--------------------------#
{
  if ($win->chListFilesOptNF->Checked()) {
    $win->chListFilesOptNbrF->Checked(0);
    $win->chListFilesOptNbrF->Disable();
  } else { $win->chListFilesOptNbrF->Enable(); }
  
}  #--- End chListFilesOptNF_Click 

#--------------------------#
sub tfReportDir_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $win->tfReportDir->Text();
  # Remember
  if ($saveDir and -d $saveDir) {
    $CONFIG{'DIR_REPORT'} = $saveDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'DIR_REPORT'});
    &saveConfig(\%CONFIG);
    if ($saveDir) {
      $win->tfReportDir->Text('');
      Win32::GUI::MessageBox($win, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }
  &isProcessReady(0);

}  #--- End tfReportDir_Change

#--------------------------#
sub cbReportFormat_Change
#--------------------------#
{
  # Local variables
  my $format = $win->cbReportFormat->GetCurSel();
  # Remember
  $CONFIG{'FORMAT_REPORT'} = $format;
  &saveConfig(\%CONFIG);

}  #--- End cbReportFormat_Change

#--------------------------#
sub btnReportDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfReportDir->Text();
  my $dir;
  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDir'}.':', -folderonly => 1, -newui => 1,
                                       -directory  => $lastDir);
  } else {
    $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDir'}.':', -folderonly => 1, -newui => 1);
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    $win->tfReportDir->Text($dir);
  }
  return(1);
  
}  #--- End btnReportDir_Click

#--------------------------#
sub btnOpenReportDir_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $win->tfReportDir->Text();
  # Open Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $outputDir", 0,
                         NORMAL_PRIORITY_CLASS, ".")if -d $outputDir;

}  #--- End btnOpenReportDir_Click

#--------------------------#
sub chOpenReport_Click
#--------------------------#
{
  # Save the choice
  if ($win->chOpenReport->Checked()) {
    $CONFIG{'AUTO_OPEN_REPORT'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_OPEN_REPORT'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOpenReport_Click

#--------------------------#
sub tfDestinationDir_Change { &isProcessReady(0); }
#--------------------------#

#--------------------------#
sub btnDestinationDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $win->tfDestinationDir->Text();
  my $dir;
  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDirDst'}.':', -folderonly => 1,
                                       -directory  => $lastDir);
  } else {
    $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => $STR{'selDirDst'}.':', -folderonly => 1);
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    $win->tfDestinationDir->Text($dir);
  }
  &isProcessReady(0);
  return(1);
  
}  #--- End btnDestinationDir_Click

#--------------------------#
sub TabFuncRen_Click
#--------------------------#
{
  # Show Rename by hash tab
  if (!$win->TabFuncRen->SelectedItem()) {
    $win->lblRenHashTypeShadowT->Show();
    $win->lblRenHashTypeT->Show();
    $win->cbRenByHash->Show();
    $win->lblRenHashOptShadowT->Show();
    $win->lblRenHashOptT->Show();
    $win->chRenByHashNoDupl->Show();
    $win->chRenByHashRemExt->Show();
    # Hide other controls
    $win->lblRenBySortShadowT->Hide();
    $win->lblRenBySortT->Hide();
    $win->lblRenBySort->Hide();
    $win->cbRenBySortType->Hide();
    $win->rbRenBySortAsc->Hide();
    $win->rbRenBySortDsc->Hide();
    $win->lblBySortRenShadowT->Hide();
    $win->lblBySortRenT->Hide();
    $win->lblBySortRenExample->Hide();
    $win->tfBySortRenExample->Hide();
    $win->chBySortRenRemExt->Hide();
    $win->lblBySortRenIncrValType->Hide();
    $win->cbBySortRenIncrValType->Hide();
    $win->lblBySortRenInitVal->Hide();
    $win->tfBySortRenInitVal->Hide();
    $win->upDownBySortRenInitVal->Hide();
    $win->lblBySortRenStepVal->Hide();
    $win->tfBySortRenStepVal->Hide();
    $win->upDownBySortRenStepVal->Hide();
    $win->lblBySortRenLength->Hide();
    $win->tfBySortRenLength->Hide();
    $win->upDownBySortRenLength->Hide();
    $win->lblBySortRenPrefix->Hide();
    $win->tfBySortRenPrefix->Hide();
    $win->lblBySortRenSuffix->Hide();
    $win->tfBySortRenSuffix->Hide();
    $win->lblReplaceShadowT->Hide();
    $win->lblReplaceT->Hide();
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->tfRenReplace->Hide();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Hide();
    $win->lblReplaceByShadowT->Hide();
    $win->lblReplaceByT->Hide();
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->tfRenReplaceBy->Hide();
    $win->chRenReplaceByEval->Hide();
  # Show Rename by sort
  } elsif ($win->TabFuncRen->SelectedItem() == 1) {
    $win->lblRenBySortShadowT->Show();
    $win->lblRenBySortT->Show();
    $win->lblRenBySort->Show();
    $win->cbRenBySortType->Show();
    $win->rbRenBySortAsc->Show();
    $win->rbRenBySortDsc->Show();
    $win->lblBySortRenShadowT->Show();
    $win->lblBySortRenT->Show();
    $win->lblBySortRenExample->Show();
    $win->tfBySortRenExample->Show();
    $win->chBySortRenRemExt->Show();
    $win->lblBySortRenIncrValType->Show();
    $win->cbBySortRenIncrValType->Show();
    $win->lblBySortRenInitVal->Show();
    $win->tfBySortRenInitVal->Show();
    $win->upDownBySortRenInitVal->Show();
    $win->lblBySortRenStepVal->Show();
    $win->tfBySortRenStepVal->Show();
    $win->upDownBySortRenStepVal->Show();
    $win->lblBySortRenLength->Show();
    $win->tfBySortRenLength->Show();
    $win->upDownBySortRenLength->Show();
    $win->lblBySortRenPrefix->Show();
    $win->tfBySortRenPrefix->Show();
    $win->lblBySortRenSuffix->Show();
    $win->tfBySortRenSuffix->Show();
    &winBySortRenOptExample() if !$win->tfBySortRenExample->Text();
    # Hide other controls
    $win->lblRenHashTypeShadowT->Hide();
    $win->lblRenHashTypeT->Hide();
    $win->cbRenByHash->Hide();
    $win->lblRenHashOptShadowT->Hide();
    $win->lblRenHashOptT->Hide();
    $win->chRenByHashNoDupl->Hide();
    $win->chRenByHashRemExt->Hide();
    $win->lblReplaceShadowT->Hide();
    $win->lblReplaceT->Hide();
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->tfRenReplace->Hide();
    $win->lblReplaceByShadowT->Hide();
    $win->lblReplaceByT->Hide();
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
    $win->tfRenReplaceBy->Hide();
    $win->chRenReplaceCase->Hide();
    $win->chRenReplaceRegex->Hide();
    $win->chRenReplaceFolder->Hide();
    $win->chRenReplaceByEval->Hide();
  # Show Rename - Replace by tab
  } else {
    $win->lblReplaceShadowT->Show();
    $win->lblReplaceT->Show();
    $win->tfRenReplace->Show();
    $win->chRenReplaceCase->Show();
    $win->chRenReplaceRegex->Show();
    $win->chRenReplaceFolder->Show();
    $win->lblReplaceByShadowT->Show();
    $win->lblReplaceByT->Show();
    $win->tfRenReplaceBy->Show();
    $win->chRenReplaceByEval->Show();
    # Hide other controls
    $win->lblRenHashTypeShadowT->Hide();
    $win->lblRenHashTypeT->Hide();
    $win->cbRenByHash->Hide();
    $win->lblRenHashOptShadowT->Hide();
    $win->lblRenHashOptT->Hide();
    $win->chRenByHashNoDupl->Hide();
    $win->chRenByHashRemExt->Hide();
    $win->lblRenBySortShadowT->Hide();
    $win->lblRenBySortT->Hide();
    $win->lblRenBySort->Hide();
    $win->cbRenBySortType->Hide();
    $win->rbRenBySortAsc->Hide();
    $win->rbRenBySortDsc->Hide();
    $win->lblBySortRenShadowT->Hide();
    $win->lblBySortRenT->Hide();
    $win->lblBySortRenExample->Hide();
    $win->tfBySortRenExample->Hide();
    $win->chBySortRenRemExt->Hide();
    $win->lblBySortRenIncrValType->Hide();
    $win->cbBySortRenIncrValType->Hide();
    $win->lblBySortRenInitVal->Hide();
    $win->tfBySortRenInitVal->Hide();
    $win->upDownBySortRenInitVal->Hide();
    $win->lblBySortRenStepVal->Hide();
    $win->tfBySortRenStepVal->Hide();
    $win->upDownBySortRenStepVal->Hide();
    $win->lblBySortRenLength->Hide();
    $win->tfBySortRenLength->Hide();
    $win->upDownBySortRenLength->Hide();
    $win->lblBySortRenPrefix->Hide();
    $win->tfBySortRenPrefix->Hide();
    $win->lblBySortRenSuffix->Hide();
    $win->tfBySortRenSuffix->Hide();
  }
  &isProcessReady(0);
  
}  #--- End TabFuncRen_Click

#--------------------------#
sub cbBySortRenIncrValType_Change
#--------------------------#
{
  if ($START == 1) {
    $win->upDownBySortRenInitVal->SetPos(1);
    my $incrValType = $win->cbBySortRenIncrValType->GetCurSel();
    if    (!$incrValType)     { $win->tfBySortRenInitVal->Text(1);   $win->upDownBySortRenInitVal->SetBase(10); } # '1,2,3,...'
    elsif ($incrValType == 1) { $win->upDownBySortRenInitVal->SetBase(10); $win->tfBySortRenInitVal->Text('a'); } # 'a-z,aa-zz,...'
    elsif ($incrValType == 2) { $win->upDownBySortRenInitVal->SetBase(10); $win->tfBySortRenInitVal->Text('A'); } # 'A-Z,AA-ZZ,...'
    elsif ($incrValType == 3) { $win->tfBySortRenInitVal->Text(1);   $win->upDownBySortRenInitVal->SetBase(16); } # '0-f,00-ff,...'
    elsif ($incrValType == 4) { $win->tfBySortRenInitVal->Text(1);   $win->upDownBySortRenInitVal->SetBase(16); } # '0-F,00-FF,...'
    elsif ($incrValType == 5) { $win->upDownBySortRenInitVal->SetBase(10); $win->tfBySortRenInitVal->Text('I'); } # 'I,II,III IV,...'
    &winBySortRenOptExample();
  }

}  #--- End cbIncrValType_Change

#--------------------------#
sub upDownBySortRenInitVal_Scroll
#--------------------------#
{
  my ($buf1, $bu2, $pos) = @_;
  my $incrValType = $win->cbBySortRenIncrValType->GetCurSel();
  my $formatedVal = &formatVal($incrValType, $pos, 1);
  $win->tfBySortRenInitVal->Text($formatedVal);

}  #--- End upDownInitVal_Scroll

#--------------------------#
sub chBySortRenRemExt_Click   { &winBySortRenOptExample() if $START; }
sub tfBySortRenLength_Change  { &winBySortRenOptExample() if $START; }
sub tfBySortRenInitVal_Change { &winBySortRenOptExample() if $START; }
sub tfBySortRenStepVal_Change { &winBySortRenOptExample() if $START; }
sub tfBySortRenPrefix_Change  { &winBySortRenOptExample() if $START; }
sub tfBySortRenSuffix_Change  { &winBySortRenOptExample() if $START; }
#--------------------------#

#--------------------------#
sub winBySortRenOptExample
#--------------------------#
{
  # Local variables
  my $removeExt   = $win->chBySortRenRemExt->Checked();
  my $incrValType = $win->cbBySortRenIncrValType->GetCurSel();
  my $length      = $win->tfBySortRenLength->Text();
  my $initVal     = $win->tfBySortRenInitVal->Text();
  my $stepVal     = $win->tfBySortRenStepVal->Text();
  my $prefix      = $win->tfBySortRenPrefix->Text();
  my $suffix      = $win->tfBySortRenSuffix->Text();
  my $isValid     = 0;
  # Illegal characters in prefix or suffix
  if ($prefix =~ /[\<\>\:\"\/\\\|\?\*]/ or $suffix =~ /[\<\>\:\"\/\\\|\?\*]/) {
    $win->tfBySortRenExample->Text($STR{'errChars'});
  } else {
    # Initial value
    if ($length and $initVal) {
      if    (!$incrValType     and $initVal =~ /^[0-9]+$/)      { $isValid = 1; } # '1,2,3,...'
      elsif ($incrValType == 1 and $initVal =~ /^[a-z]+$/)      { $isValid = 1; } # 'a-z,aa-zz,...'
      elsif ($incrValType == 2 and $initVal =~ /^[A-Z]+$/)      { $isValid = 1; } # 'A-Z,AA-ZZ,...'
      elsif ($incrValType == 3 and $initVal =~ /^[0-9a-f]+$/)   { $isValid = 1; } # '0-f,00-ff,...'
      elsif ($incrValType == 4 and $initVal =~ /^[0-9A-F]+$/)   { $isValid = 1; } # '0-F,00-FF,...'
      elsif ($incrValType == 5 and $initVal =~ /^[IVXLCDM_]+$/) { $isValid = 1; } # 'I,II,III IV,...'
    } else { $isValid = 0; }
    # Create example
    if ($isValid == 1) {
      my $example = '';
      for (my $i = 0; $i < 3; $i++) { # Generate three values with selected options
        $example       .= $prefix if $prefix;
        my $currVal     = ($i * $stepVal);
        my $initValDec  = &convertInitVal($incrValType, $initVal);
        $currVal       += $initValDec;
        my $formatedVal = &formatVal($incrValType, $currVal, $length);
        $example       .= $formatedVal;
        $example       .= $suffix if $suffix;
        $example       .= '.ext' if !$removeExt;
        $example       .= ', ';
      }
      $example .= '...';
      $win->tfBySortRenExample->Text($example);
    } else {
      $win->tfBySortRenExample->Text('');
    }
  }
  
}  #--- End winBySortRenOptExample

#--------------------------#
sub convertInitVal
#--------------------------#
{
  # Local variables
  my ($incrValType, $initVal) = @_;
  my $decimal;
  # Decimal already
  if    (!$incrValType) { return($initVal); }
  # Alphabet
  elsif ($incrValType == 1 or $incrValType == 2) { # 'a-z,aa-zz,...' or 'A-Z,AA-ZZ,...'
    my @values = split('', $initVal);
    my $multi = 0;
    foreach (reverse @values) {
      if ($_ =~ /[a-zA-Z]/) {
        my $val2add = (ord(lc($_)) - 96);
        for (my $i = 0; $i < $multi; $i++) { $val2add = $val2add * 26; }
        $decimal += $val2add;
      }
      $multi++;
    }
  }
  elsif ($incrValType == 3 or $incrValType == 4) { $decimal = hex($initVal);       } # Hexadecimal: '0-f,00-ff,...' or '0-F,00-FF,...'
  elsif ($incrValType == 5)                      { $decimal = roman2int($initVal); } # Roman: 'I,II,III IV,...'
  return($decimal);
  
}  #--- End convertInitVal

#--------------------------#
sub formatVal
#--------------------------#
{
  # Local variables
  my ($incrValType, $val, $length) = @_;
  my $convertedVal;
  my $nullChar;
  # Decimal
  if (!$incrValType) {
    $nullChar     = 0;
    $convertedVal = $val;
  # Alphabet
  } elsif ($incrValType == 1 or $incrValType == 2) { # 'a-z,aa-zz,...' or 'A-Z,AA-ZZ,...'
    $nullChar = '_';
    my @values;
    my $offset = $val;
    while ($offset > 26) {
      my $currOffset = int($offset / 26);
      push(@values, $offset - ($currOffset*26));
      $offset = $currOffset;
    }
    push(@values, $offset);
    foreach my $value (reverse @values) {
      if    ($incrValType == 1) { $value += 96; } # 'a-z,aa-zz,...'
      elsif ($incrValType == 2) { $value += 64; } # 'A-Z,AA-ZZ,...'
      $convertedVal .= chr($value);
    }
  # Hexadecimal
  } elsif ($incrValType == 3 or $incrValType == 4) { # '0-f,00-ff,...' or '0-F,00-FF,...'
    $nullChar = '0';
    $convertedVal .= sprintf("%x", $val);
    if    ($incrValType == 3) { $convertedVal = lc($convertedVal); }
    elsif ($incrValType == 4) { $convertedVal = uc($convertedVal); }
  # Roman
  } elsif ($incrValType == 5) { # 'I,II,III IV,...'
    $nullChar = '_';
    $convertedVal = int2roman($val);
  }
  # Fill with null
  while (length($convertedVal) < $length) { $convertedVal = $nullChar . $convertedVal; }
  return($convertedVal);
  
}  #--- End formatVal

#--------------------------#
sub tfRenReplace_Change
#--------------------------#
{
  # Test Regex if necessary
  &showRenReplaceRegexStatus if $win->chRenReplaceRegex->Checked();
  # Enable By textfield
  if ($win->tfRenReplace->Text) {
    $win->tfRenReplaceBy->Enable();
    $win->chRenReplaceByEval->Enable() if $win->chRenReplaceRegex->Checked();
  } else {
    $win->tfRenReplaceBy->Text('');
    $win->tfRenReplaceBy->Disable();
    $win->chRenReplaceByEval->Checked(0);
    $win->chRenReplaceByEval->Disable();
  }
  &isProcessReady(0);

}  #--- End tfRenReplace_Change

#--------------------------#
sub chRenReplaceRegex_Click
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRenReplaceRegex->Checked()) {
    &showRenReplaceRegexStatus;
    $win->chRenReplaceByEval->Enable();
  } else {
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
    $win->chRenReplaceByEval->Checked(0);
    $win->chRenReplaceByEval->Disable();
  }
  # Revaluate Replacement expression
  &showRenReplaceByStatus;
  &isProcessReady(0);

}  #--- End chRenReplaceRegex_Click

#--------------------------#
sub showRenReplaceRegexStatus
#--------------------------#
{
  # Local variables
  my $regex = $win->tfRenReplace->Text();
  if ($regex) {
    my ($statusRegex, $msg) = &validRegex($regex);
    # Warning
    if      ($statusRegex == 2) {
      $win->lblRenReplaceWarn->Show();
      $win->lblRenReplaceOk->Hide();
      $win->lblRenReplaceErr->Hide();
    # Error
    } elsif ($statusRegex) {
      $win->lblRenReplaceErr->Show();
      $win->lblRenReplaceOk->Hide();
      $win->lblRenReplaceWarn->Hide();
    # Ok
    } else {
      $win->lblRenReplaceOk->Show();
      $win->lblRenReplaceErr->Hide();
      $win->lblRenReplaceWarn->Hide();
    }
  } else {
    $win->lblRenReplaceOk->Hide();
    $win->lblRenReplaceErr->Hide();
    $win->lblRenReplaceWarn->Hide();
  }

}  #--- End showRenReplaceRegexStatus

#--------------------------#
sub tfRenReplaceBy_Change
#--------------------------#
{
  &showRenReplaceByStatus;
  &isProcessReady(0);

}  #--- End tfRenReplace_Change

#--------------------------#
sub chRenReplaceByEval_Click
#--------------------------#
{
  if ($win->chRenReplaceRegex->Checked()) { &showRenReplaceByStatus; }
  else {
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
  }
  &isProcessReady(0);

}  #--- End chRenReplaceByEval_Click

#--------------------------#
sub showRenReplaceByStatus
#--------------------------#
{
  # Local variables
  my $expr = $win->tfRenReplaceBy->Text();
  if ($expr and ($win->chRenReplaceRegex->Checked() or ($win->chRenReplaceByEval->IsEnabled() and
                                                        $win->chRenReplaceByEval->Checked()))) {
    my ($status, $msg) = &validReplacement;
    # Warning
    if      ($status and $status == 2) {
      $win->lblRenReplaceByWarn->Show();
      $win->lblRenReplaceByOk->Hide();
      $win->lblRenReplaceByErr->Hide();
    # Error
    } elsif ($status) {
      $win->lblRenReplaceByErr->Show();
      $win->lblRenReplaceByOk->Hide();
      $win->lblRenReplaceByWarn->Hide();
    # Ok
    } else {
      $win->lblRenReplaceByOk->Show();
      $win->lblRenReplaceByErr->Hide();
      $win->lblRenReplaceByWarn->Hide();
    }
  } else {
    $win->lblRenReplaceByOk->Hide();
    $win->lblRenReplaceByErr->Hide();
    $win->lblRenReplaceByWarn->Hide();
  }

}  #--- End showRenReplaceByStatus

#--------------------------#
sub btnProcess_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'Error'}, 0x40010); }
  else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        threads->exit();
      };
      # Local variables
      my %listFiles;
      # Show progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Show();
      $win->pb->Show();
      $win->lblPbCount->Show();
      $win->btnProcess->Hide();
      $win->btnStop->Show();
      $win->ChangeCursor($HOURGLASS);
      # List of file paths
      &getListFiles(\%listFiles, 1);
      # List Files or Extensions
      if (!$win->TabFunctions->SelectedItem()) {
        if (!$win->TabFuncLists->SelectedItem()) { &listFilesReport(\%listFiles); } # List Files
        else                                     { &listExtReport(\%listFiles);   } # List Extensions
      }
      elsif ($win->TabFunctions->SelectedItem() == 1) { &copyMove(\%listFiles, 1);    } # Copy or move
      elsif ($win->TabFunctions->SelectedItem() == 2) { &renameFiles(\%listFiles, 1); } # Rename
      # Progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Hide();
      $win->pb->Hide();
      $win->lblPbCount->Hide();
      $win->btnProcess->Show();
      $win->btnStop->Hide();      
      $win->ChangeCursor($ARROW);
    });
  }
  
}  #--- End btnProcess_Click

#--------------------------#
sub btnStop_Click
#--------------------------#
{
  # Stop requests
  $THR_PROCESS->kill('KILL')->detach() if $THR_PROCESS and $THR_PROCESS->is_running();
  return(1);

}  #--- End btnStop_Click

#--------------------------#
sub btnPreview_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'Error'}, 0x40010); }
  else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'Error'}, 0x40010);
        threads->exit();
      };
      # Show progress window
      $winPb->Center($winPreview);
      $winPb->Show();
      # Local variables
      my %listFiles;
      # Reset trees
      $winPreview->tvBefore->DeleteAllItems();
      $winPreview->tvAfter->DeleteAllItems();
      # List of file paths
      &getListFiles(\%listFiles, 0);
      # Fill the Before tree
      my $baseDir;
      if (-d $win->tfInput->Text()) { $baseDir = $win->tfInput->Text(); }
      else {
        my $filesStr = $win->tfInput->Text();
        # Set base dir
        if ($filesStr) {
          # Multiple files
          if ($filesStr =~ /" "/) {
            $baseDir = (split(/" "/, $filesStr))[0];
            $baseDir =~ s/\"//g;
          }
          # Single file
          else {
            my @pathParts = split(/\\/, $filesStr);
            pop(@pathParts);
            $baseDir = join("\\", @pathParts);
          }
        }
      }
      $winPreview->tfRootBefore->Text($baseDir);
      &createTree($winPreview->tvBefore, \%listFiles, undef, $baseDir);
      # Fill the After tree
      if (!(&isFunctionsReady()) and $win->TabFunctions->SelectedItem()) {
        my $refResListFiles;
        my $refResListSubFolders;
        my $dstDir;
        if      ($win->TabFunctions->SelectedItem() == 1) { # Copy or move
          $dstDir = $win->tfDestinationDir->Text();
          ($refResListFiles, $refResListSubFolders) = &copyMove(\%listFiles, 0);
        } elsif ($win->TabFunctions->SelectedItem() == 2) { # Rename
          $dstDir = $baseDir;
          ($refResListFiles, $refResListSubFolders) = &renameFiles(\%listFiles, 0);
        }
        $winPreview->tfRootAfter->Text($dstDir);
        if ($refResListSubFolders) { &createTree($winPreview->tvAfter, $refResListFiles, $refResListSubFolders, $dstDir); }
        else                       { &createTree($winPreview->tvAfter, $refResListFiles, undef, $dstDir);                 }
      }
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
    });
    # Show Window
    $winPreview->Center($win);
    $winPreview->DoModal();
    return(1);
  }

}  #--- End btnPreview_Click

#--------------------------#
sub createTree
#--------------------------#
{
  # Local variables
  my ($refTree, $refListFiles, $refResListSubFolders, $baseDir) = @_;
  # $refResListSubFolders is used to identify empty folders
  my %createdFolders;
  # Browse file and create nodes
  foreach my $file (keys %{$refListFiles}) {
    my $relPath   = $file =~ s/\Q$baseDir\E\\//r;
    my @pathParts = split(/\\/, $relPath);
    my $filename;
    $filename = pop(@pathParts) if !-d $file;
    # Create folders that doesn't exists
    my $parent;
    my $folder;
    foreach my $part (@pathParts) {
      if ($parent) {
        $folder .= "\\" . $part;
        if (!exists($createdFolders{$folder})) {
          if ($part =~ /[\<\>\:\"\/\\\|\?\*]/) { # Illegal characters
            $parent = $refTree->InsertItem(-parent => $parent, -text => $part . " ($STR{'Error'})", -bold => 1, -image => 0, -item => 0xFFFF0003);
          } else {
            $parent = $refTree->InsertItem(-parent => $parent, -text => $part, -image => 0, -item => 0xFFFF0003);
          }
          $createdFolders{$folder} = $parent;
          if ($refResListSubFolders and exists($$refResListSubFolders{$baseDir."\\".$folder})) {
            delete($$refResListSubFolders{$baseDir."\\".$folder}); # Folder has been created
          }
        } else { $parent = $createdFolders{$folder}; }
      } else       {
        $folder = $part;
        if (!exists($createdFolders{$folder})) {
          if ($part =~ /[\<\>\:\"\/\\\|\?\*]/) { # Illegal characters
            $parent = $refTree->InsertItem(-text  => $part . " ($STR{'Error'})", -bold  => 1, -image => 0,
                                           -item  => 0xFFFF0003);
          } else { $parent = $refTree->InsertItem(-text  => $part, -image => 0, -item  => 0xFFFF0003); }
          $createdFolders{$folder} = $parent;
          if ($refResListSubFolders and exists($$refResListSubFolders{$baseDir."\\".$folder})) {
            delete($$refResListSubFolders{$baseDir."\\".$folder}); # Folder has been created
          }
        } else { $parent = $createdFolders{$folder}; }
      }
    }
    # If filename
    if ($filename) {
      # File is marked as error
      if ($$refListFiles{$file} == 2) {
        if ($parent) { $refTree->InsertItem( -parent => $parent, -text => $filename . " ($STR{'Error'})",
                                            -bold => 1, -image => 3, -item => 0xFFFF0003); }
        else         { $refTree->InsertItem( -text => $filename . " ($STR{'Error'})",
                                            -bold => 1, -image => 3, -item => 0xFFFF0003); }
      # File is masked as removed
      } elsif ($$refListFiles{$file} == 3) {
        if ($parent) { $refTree->InsertItem(-parent => $parent, -text => $filename . " ($STR{'Duplicate'} $STR{'Removed'})",
                                            -bold => 1, -image => 3, -item => 0xFFFF0003); }
        else         { $refTree->InsertItem(-text => $filename . " ($STR{'Duplicate'} $STR{'Removed'})",
                                            -bold => 1, -image => 3, -item => 0xFFFF0003); }
      # File is masked as renamed
      } elsif ($$refListFiles{$file} == 4) {
        if ($parent) { $refTree->InsertItem(-parent => $parent, -text => $filename . " ($STR{'Renamed'})",
                                            -bold => 0, -image => 4, -item => 0xFFFF0003); }
        else         { $refTree->InsertItem(-text => $filename . " ($STR{'Renamed'})",
                                            -bold => 0, -image => 4, -item => 0xFFFF0003); }
      } else {
        # Normal file
        if ($parent) { $refTree->InsertItem(-parent => $parent, -text => $filename, -image => 2, -item => 0xFFFF0003); }
        else         { $refTree->InsertItem(-text => $filename, -image => 2, -item => 0xFFFF0003); }
      }
    }
  }
  # Create empty folder nodes
  if ($refResListSubFolders) {
    foreach my $folder (keys %{$refResListSubFolders}) {
      my $relPath   = $folder =~ s/\Q$baseDir\E\\//r;
      if ($relPath) {
        my @pathParts = split(/\\/, $relPath);
        # Create folders that doesn't exists
        my $parent;
        my $folder;
        foreach my $part (@pathParts) {
          if ($parent) {
            $folder .= "\\" . $part;
            if (!exists($createdFolders{$folder})) {
              $parent = $refTree->InsertItem(-parent => $parent, -text => $part, -image => 0, -item => 0xFFFF0003);
              $createdFolders{$folder} = $parent;
            } else { $parent = $createdFolders{$folder}; }
          } else       {
            $folder = $part;
            if (!exists($createdFolders{$folder})) {
              $parent = $refTree->InsertItem(-text => $part, -image => 0, -item => 0xFFFF0003);
              $createdFolders{$folder} = $parent;
            } else { $parent = $createdFolders{$folder}; }
          }
        }
      }
    }
  }

}  #--- End createTree

#--------------------------#
sub tvBefore_Expand
#--------------------------#
{
  my $node = shift;
  $winPreview->tvBefore->SetItem($node, -image => 1);
  
}  #--- End tvBefore_Expand

#--------------------------#
sub tvBefore_Collapse
#--------------------------#
{
  my $node = shift;
  $winPreview->tvBefore->SetItem($node, -image => 0);
  
}  #--- End tvBefore_Collapse

#--------------------------#
sub tvAfter_Expand
#--------------------------#
{
  my $node = shift;
  $winPreview->tvAfter->SetItem($node, -image => 1);
  
}  #--- End tvAfter_Expand

#--------------------------#
sub tvAfter_Collapse
#--------------------------#
{
  my $node = shift;
  $winPreview->tvAfter->SetItem($node, -image => 0);
  
}  #--- End tvAfter_Collapse

#--------------------------#
sub winPreview_Resize
#--------------------------#
{
  $winPreview->tvBefore->Width($winPreview->ScaleWidth()/2-7);
  $winPreview->tvBefore->Height($winPreview->ScaleHeight()-65); 
  $winPreview->tfRootBefore->Width($winPreview->ScaleWidth()/2-72);
  $winPreview->lblAfterShadowT->Left($winPreview->ScaleWidth()/2+1); 
  $winPreview->lblAfterT->Left($winPreview->ScaleWidth()/2);
  $winPreview->lblRootAfter->Left($winPreview->ScaleWidth()/2+5);
  $winPreview->tfRootAfter->Left($winPreview->ScaleWidth()/2+65);
  $winPreview->tfRootAfter->Width($winPreview->ScaleWidth()/2-71);
  $winPreview->tvAfter->Left($winPreview->ScaleWidth()/2);
  $winPreview->tvAfter->Width($winPreview->ScaleWidth()/2-6);
  $winPreview->tvAfter->Height($winPreview->ScaleHeight()-65);
  
}  #--- End winPreview_Resize

#--------------------------#
sub winPreview_Terminate { return(-1); }
#--------------------------#

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  $THR_PROCESS->kill('KILL')->detach() if $THR_PROCESS and $THR_PROCESS->is_running();
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub getListFiles
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift;
  my $dir          = $win->tfInput->Text();
  # List of files (No filter)
  if (!-d $dir) {
    my $filesStr = $dir;
    if ($filesStr =~ /" "/) {                 # Multiple files
      my @items = split(/" "/, $filesStr);
      my $baseDir = shift(@items);
      $baseDir =~ s/^\"//;
      foreach my $item (@items) {
        $item =~ s/\"$//;
        $$refListFiles{$baseDir."\\".$item} = 1;
      }
    } else { $$refListFiles{$filesStr} = 1; } # Single file
  }
  # Directory (List files and apply filters)
  else {
    # Local variables
    my $filter;
    my $selSize;
    my $sizeOp;
    my $regex;
    my $selDateUT;
    my $dateOp;
    my @subFolders;
    my $nbrSubFolders = 1; # The base dir count as one
    my $count         = 0;
    # Set Filters
    my $refFilters;
    my $nbrFilters;
    my $onlyFolders;
    if ($winFileFilters) {
      $refFilters  = &setFilters();
      $nbrFilters  = keys %{$refFilters};
      $onlyFolders = &isOnlyFoldersOn();
    }
    # Open base directory
    if ($execute) { $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir);   }
    else          { $winPb->lblPbCurr->Text($STR{'ListingFile'}.': '.$dir); }
    $$refListFiles{"$dir\\"} = 0;
    if (opendir(DIR,"$dir\\")) {
      while (my $file = readdir(DIR)) {
        my $filePath = "$dir\\$file";
        if ((-d $filePath) and ($file !~ /^\.\.?$/) and ($file ne 'System Volume Information')) { # It's a directory
          if ($win->chInputDirRecurse->Checked()) { # Subfolders option
            push(@subFolders, $filePath);
            $nbrSubFolders++;
            if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
            else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
          } else { $nbrSubFolders++; }
          # No filter or Only Folders (single filter)
          if (!$nbrFilters or ($nbrFilters == 1 and $onlyFolders)) {
            $$refListFiles{$filePath} = 0;
          # Filter
          } elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
            $$refListFiles{$filePath} = 0;
          }
        } elsif (!-d $filePath and -e $filePath) { # It's a file
          # No filter
          if    (!$nbrFilters) { $$refListFiles{$filePath} = 0; }
          # Filter match
          elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
            $$refListFiles{$filePath} = 0;
          }
        }
      }
      closedir(DIR);
    }
    $count++;
    if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
    else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
    # List folders and files in subfolders
    if ($win->chInputDirRecurse->Checked() and scalar(@subFolders) > 0) {
      foreach my $subFolder (@subFolders) {
        $win->lblPbCurr->Text($STR{'ListingFile'}.': '.$subFolder);
        if (opendir(DIR,"$subFolder\\")) {
          while (my $file = readdir(DIR)) {
            my $filePath = "$subFolder\\$file";
            if ((-d $filePath) and ($file !~ /^\.\.?$/)) { # It's a directory
              push(@subFolders, $filePath);
              $nbrSubFolders++;
              if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
              else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
              # No filter or Only Folders (single filter)
              if (!$nbrFilters or ($nbrFilters == 1 and $onlyFolders)) {
                $$refListFiles{$filePath} = 0;
              # Filter
              } elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
                $$refListFiles{$filePath} = 0;
              }
            } elsif (!-d $filePath and -e $filePath) { # It's a file
              if (exists($$refListFiles{$subFolder})) { $$refListFiles{$subFolder}++; }
              # No filter
              if    (!$nbrFilters) { $$refListFiles{$filePath} = 0; }
              # Filter match
              elsif ($nbrFilters and &testFilters($dir, $refFilters, $nbrFilters, $file, $filePath, $onlyFolders)) {
                $$refListFiles{$filePath} = 0;
              }
            }
          }
          closedir(DIR);
        }
        $count++;
        if ($execute) { $win->lblPbCount->Text("$count/$nbrSubFolders"); }
        else          { $winPb->lblCount->Text("$count/$nbrSubFolders"); }
      }
    }
    if ($execute) { 
      $win->lblPbCurr->Text('');
      $win->lblPbCount->Text('');
    } else { # Preview mode
      $win->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
    }
  }

}  #--- End getListFiles

#--------------------------#
sub setFilters
#--------------------------#
{
  # Local variables
  my %filters;
  my $i = 1;
  # Gather filter list
  for (my $row = 1; $row <= $winFileFilters->gridFileFilters->GetRows(); $row++) {
    my $firstVal = $winFileFilters->gridFileFilters->GetCellText($row, 0);
    if ($firstVal) {
      $filters{$i}{'Operator'}  = $winFileFilters->gridFileFilters->GetCellText($row, 0);
      $filters{$i}{'Type'}      = $winFileFilters->gridFileFilters->GetCellText($row, 1) if $winFileFilters->gridFileFilters->GetCellText($row, 1);
      $filters{$i}{'TypeOp'}    = $winFileFilters->gridFileFilters->GetCellText($row, 2) if $winFileFilters->gridFileFilters->GetCellText($row, 2);
      $filters{$i}{'Flags'}     = $winFileFilters->gridFileFilters->GetCellText($row, 3) if $winFileFilters->gridFileFilters->GetCellText($row, 3);
      $filters{$i}{'SearchStr'} = $winFileFilters->gridFileFilters->GetCellText($row, 4) if $winFileFilters->gridFileFilters->GetCellText($row, 4);
      if ($filters{$i}{'Type'} eq $STR{'LastAccessed'} or $filters{$i}{'Type'} eq $STR{'LastModified'}) {
        my ($y, $m, $d) = split(/\-/, $filters{$i}{'SearchStr'});
        $filters{$i}{'DateUT'} = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
      }
    }
    $i++;
  }
  return(\%filters);  
  
}  #--- End setFilters

#--------------------------#
sub testFilters
#--------------------------#
{
  # Local variables
  my ($dir, $refFilters, $nbrFilters, $file, $path, $onlyFolders) = @_;
  my $match       = 0;
  # Path is a folder, only Contains filter applies
  if ($path and -d $path) {
    for (my $i = 1; $i <= $nbrFilters; $i++) {
      if ($$refFilters{$i}{'Type'} eq $STR{'Contains'}) {
        # Regex option is checked
        my $expr;
        my ($case, $regex, $fileOnly) = split(/\-/, $$refFilters{$i}{'Flags'});
        if (!$regex) { $expr = quotemeta($$refFilters{$i}{'SearchStr'}); }
        else         { $expr = $$refFilters{$i}{'SearchStr'};            }
        if (!$fileOnly and ((!$case and $path =~ /$expr/i) or ($case and $path =~ /$expr/))) {
          # Match and next operator is OR
          if (exists($$refFilters{$i+1}{'Operator'}) and $$refFilters{$i+1}{'Operator'} eq $STR{'OR'}) {
            return(1);
          } else { $match = 1; }
        # Don't match and operator is AND
        } elsif (exists($$refFilters{$i+1}{'Operator'}) and $$refFilters{$i+1}{'Operator'} eq $STR{'AND'}) { return(0); }
      # Filter size, Last accessed or Last modified apply to files only
      } elsif (($$refFilters{$i}{'Type'} eq $STR{'FileSize'}     or
                $$refFilters{$i}{'Type'} eq $STR{'LastAccessed'} or $$refFilters{$i}{'Type'} eq $STR{'LastModified'}) and
               ((exists($$refFilters{$i+1}{'Operator'}) and $$refFilters{$i+1}{'Operator'} eq $STR{'AND'}) or
                ($$refFilters{$i}{'Operator'} ne $STR{'OR'}))) {
        return(0);
      }
    }
  # Path is a file
  } elsif (!$onlyFolders) {
    for (my $i = 1; $i <= $nbrFilters; $i++) {
      my $matchTmp = 0;
      # Contains filter
      if ($$refFilters{$i}{'Type'} eq $STR{'Contains'}) {
        my $expr;
        my ($case, $regex, $fileOnly) = split(/\-/, $$refFilters{$i}{'Flags'});
        if (!$regex) { $expr = quotemeta($$refFilters{$i}{'SearchStr'}); }
        else         { $expr = $$refFilters{$i}{'SearchStr'};            }
        my $relPath = $path =~ s/\Q$dir\E\\//r;
        $relPath    = $file if $fileOnly;
        if ((!$case and $relPath =~ /$expr/i) or ($case and $relPath =~ /$expr/)) {
          $matchTmp = 1;
        } else { $matchTmp = 0; }
      # File size filter
      } elsif ($$refFilters{$i}{'Type'} eq $STR{'FileSize'}) {
        if (&cmpFileSize($path, $$refFilters{$i}{'SearchStr'}, $$refFilters{$i}{'TypeOp'})) {
          $matchTmp = 1;
        } else { $matchTmp = 0; }
      # Filter: Last accessed or Last modified
      } elsif ($$refFilters{$i}{'Type'} eq $STR{'LastAccessed'} or $$refFilters{$i}{'Type'} eq $STR{'LastModified'}) {
        my $cmpDateUT;
        if ($$refFilters{$i}{'Type'} eq $STR{'LastAccessed'}) { $cmpDateUT = (stat($path))[8]; }
        else                                                         { $cmpDateUT = (stat($path))[9]; }
        if (&cmpDates($path, $$refFilters{$i}{'DateUT'}, $cmpDateUT, $$refFilters{$i}{'TypeOp'})) {
          $matchTmp = 1;
        } else { $matchTmp = 0; }
      }
      # Match
      if ($matchTmp and exists($$refFilters{$i+1}{'Operator'})) {
        # Next operator is OR
        if ($$refFilters{$i+1}{'Operator'} eq $STR{'OR'}) { return(1);  } # No need to check other filter
        else { $match = 1; }
      # Don't match
      } elsif (!$matchTmp) {
        # Next or actual operator is AND
        if ((exists($$refFilters{$i+1}{'Operator'}) and
             ($$refFilters{$i+1}{'Operator'} eq $STR{'AND'}) or
              ($$refFilters{$i}{'Operator'} eq $STR{'AND'}))) { return(0); } # No need to check other filter
        else { $match = 0; }
      } else { $match = $matchTmp; }
    }
  }
  return(1) if $match;
  return(0);

}  #--- End testFilters

#--------------------------#
sub cmpDates
#--------------------------#
{
  # Local variables
  my ($filePath, $selDateUT, $cmpDateUT, $dateOp) = @_;
  # For $cmpDateUT, Keep only date
  my ($sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst) = localtime($cmpDateUT);
  my $cmpDateUTR = timelocal(0,0,0,$mday,$mon,$year); # Store in Unixtime format
  return(1) if $dateOp eq $STR{'Before'} and $cmpDateUTR  < $selDateUT;
  return(1) if $dateOp eq $STR{'Equal'}  and $cmpDateUTR == $selDateUT;
  return(1) if $dateOp eq $STR{'After'}  and $cmpDateUTR  > $selDateUT;
  return(0);

}  #--- End cmpDates

#--------------------------#
sub cmpFileSize
#--------------------------#
{
  # Local variables
  my ($filePath, $searchStr, $sizeOp) = @_;
  my $fileSize = (stat($filePath))[7];
  my ($cmpSize, $sizeUnit) = split(/ /, $searchStr);
  # Round down file size
  if    ($sizeUnit eq $STR{'b'} ) { $fileSize = $fileSize; }
  elsif ($sizeUnit eq $STR{'Kb'}) { $fileSize = $fileSize / 1024; }
  elsif ($sizeUnit eq $STR{'Mb'}) { $fileSize = $fileSize / 1024 / 1024; }
  elsif ($sizeUnit eq $STR{'Gb'}) { $fileSize = $fileSize / 1024 / 1024 / 1024; }
  $fileSize = sprintf("%.0f", $fileSize);
  return(1) if $sizeOp eq $STR{'Smaller'} and $fileSize  < $cmpSize;
  return(1) if $sizeOp eq $STR{'Equal'}   and $fileSize == $cmpSize;
  return(1) if $sizeOp eq $STR{'Bigger'}  and $fileSize  > $cmpSize;
  return(0);

}  #--- End cmpFileSize

#--------------------------#
sub listFilesReport
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $nbrFiles     = scalar(keys %{$refListFiles});
  my $logging      = 0;
  my $logFile;
  my $fhLog;
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  if ($win->tfReportDir->Text() and -d $win->tfReportDir->Text()) {
    # Show progress
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
    # Options
    my $chListFilesOptFP    = $win->chListFilesOptFP->Checked();          # Full path
    my $chListFilesOptP     = $win->chListFilesOptP->Checked();           # Path
    my $chListFilesOptFN    = $win->chListFilesOptFN->Checked();          # Filename
    my $chListFilesOptFE    = $win->chListFilesOptFE->Checked();          # File extension
    my $chListFilesOptCount = $win->chListFilesOptCount->Checked();       # Count
    my $chListFilesHV1      = $winHashVal->chListFilesHV1->Checked();     # MD5
    my $chListFilesHV2      = $winHashVal->chListFilesHV2->Checked();     # SHA1
    my $chListFilesHV3      = $winHashVal->chListFilesHV3->Checked();     # SHA256
    my $chListFilesHV4      = $winHashVal->chListFilesHV4->Checked();     # SHA512
    my $chListFilesFD1      = $winFileDetails->chListFilesFD1->Checked(); # File or dir size
    my $chListFilesFD2      = $winFileDetails->chListFilesFD2->Checked(); # Last accessed
    my $chListFilesFD3      = $winFileDetails->chListFilesFD3->Checked(); # Last modified
    my $chListFilesOptNbrF  = $win->chListFilesOptNbrF->Checked();        # Number of files
    my $chListFilesOptNbrL  = $win->chListFilesOptNbrL->Checked();        # Number of lines
    my $chListFilesOptNbrP  = $win->chListFilesOptNbrP->Checked();        # Number of pages
    my $chListFilesOptLM    = $win->chListFilesOptLM->Checked();          # List of members
    my $basedOnMD5          = $winCountOpt->rbListFilesCountMD5->Checked(); # Based on MD5 (else Filename)
    # Create selected format report
    my $formatReport   = $win->cbReportFormat->GetCurSel();
    my ($reportFilename, $nbrError);
    # Count duplicates
    my %count; # md5 or filename => count
    if ($chListFilesOptCount) {
      $win->lblPbCurr->Text($STR{'Counting'}.'...');
      my $curr = 0;
      foreach my $file (keys %{$refListFiles}) {
        if (!-d $file) {
          if ($basedOnMD5) {
            if (my $digestMD5 = file_md5_hex($file)) {
              if (exists($count{$digestMD5})) { $count{$digestMD5}++;   }
              else                            { $count{$digestMD5} = 1; }
            }
          } else {
            my (@fileParts) = split(/\\/, $file);
            my $filename = pop(@fileParts);
            if (exists($count{$filename})) { $count{$filename}++;   }
            else                           { $count{$filename} = 1; }
          }
        }
        # Progress
        $curr++;
        $win->lblPbCount->Text("$curr / $nbrFiles");
        $win->pb->StepIt();
      }
      $win->pb->SetPos(0);
    }
    # HTML format
    if      ($formatReport == 1) {
      ($reportFilename, $nbrError) = &writeListFilesReportHTML($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptP, $chListFilesOptFN,
                                                               $chListFilesOptFE, $chListFilesOptCount, $chListFilesOptLM, $chListFilesHV1,
                                                               $chListFilesHV2, $chListFilesHV3, $chListFilesHV4, $chListFilesFD1, $chListFilesFD2,
                                                               $chListFilesFD3, $chListFilesOptNbrF, $chListFilesOptNbrL, $chListFilesOptNbrP,
                                                               $basedOnMD5, \%count, $logging, $fhLog);
    # XLSX format
    } elsif ($formatReport == 2) {
      ($reportFilename, $nbrError) = &writeListFilesReportXLSX($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptP, $chListFilesOptFN,
                                                               $chListFilesOptFE, $chListFilesOptCount, $chListFilesOptLM, $chListFilesHV1,
                                                               $chListFilesHV2, $chListFilesHV3, $chListFilesHV4, $chListFilesFD1, $chListFilesFD2,
                                                               $chListFilesFD3, $chListFilesOptNbrF, $chListFilesOptNbrL, $chListFilesOptNbrP,
                                                               $basedOnMD5, \%count, $logging, $fhLog);
    # Text format
    } else {
      ($reportFilename, $nbrError) = &writeListFilesReportTXT( $refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptP, $chListFilesOptFN,
                                                               $chListFilesOptFE, $chListFilesOptCount, $chListFilesOptLM, $chListFilesHV1,
                                                               $chListFilesHV2, $chListFilesHV3, $chListFilesHV4, $chListFilesFD1, $chListFilesFD2,
                                                               $chListFilesFD3, $chListFilesOptNbrF, $chListFilesOptNbrL, $chListFilesOptNbrP,
                                                               $basedOnMD5, \%count, $logging, $fhLog);
    }
    $win->ShellExecute('open', $reportFilename,'','',1) if $win->chOpenReport->Checked(); # Open report
    # Logging
    if ($logging) {
      close($fhLog);
      if ($nbrError) {
        my $answer = Win32::GUI::MessageBox($win, $STR{'EndProcess1'}.' '.$nbrError." $STR{'EndProcess2'} $STR{'EndProcess3'}", $STR{'Process'}, 0x40024);
        $win->ShellExecute('open', $logFile,'','',1) if $answer == 6; # Open the log
      }
    }
  }

}  #--- End listFilesReport

#--------------------------#
sub writeListFilesReportHTML
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptP, $chListFilesOptFN, $chListFilesOptFE, $chListFilesOptCount, $chListFilesOptLM,
      $chListFilesHV1, $chListFilesHV2, $chListFilesHV3, $chListFilesHV4, $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrF,
      $chListFilesOptNbrL, $chListFilesOptNbrP, $basedOnMD5, $refCount, $logging, $fhLog) = @_;
  my $searchedFolder = $win->tfInput->Text()."\\";
  my $nbrError       = 0;
  my $curr           = 0;
  # Write the report
  my $timeStr  = &date(time);
  my $timeStr2 = $timeStr;
  $timeStr2    =~ s/[-:]//g;
  $timeStr2    =~ s/[ ]/_/g;
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'.$timeStr2.'.html'; # Ex.: XL-FileTools report-20160520_082215.html
  if (open(my $fhReport, '>', $reportFilename)) {
    flock($fhReport, 2);
    print $fhReport "<!DOCTYPE html>\n";
    print $fhReport "<html>\n<head>\n<title>XL-FileTools $STR{'report'} $timeStr</title>\n";
    print $fhReport "<meta name=\"generator\" content=\"XL-FileTools $VERSION\">\n";
    print $fhReport "<style>\n";
    print $fhReport "table, td { border-collapse: collapse; border: 1px solid black; padding: 5px; }\n";
    print $fhReport "td { font-size:11pt; vertical-align: top; white-space: nowrap; }\n";
    print $fhReport ".header { text-align: center; font-weight: bold }\n";
    print $fhReport "</style>\n";
    print $fhReport "</head>\n";
    print $fhReport "<body style=\"font-family: Calibri, Verdana, Arial;\">\n";
    print $fhReport "<table align=\"center\">\n";
    # File Header
    if (!$win->chListFilesOptNH->Checked()) {
      print $fhReport "<tr>\n";
      print $fhReport "<td class=\"header\">$STR{'FullPath'}</td>\n"     if $chListFilesOptFP;
      print $fhReport "<td class=\"header\">$STR{'Path'}</td>\n"         if $chListFilesOptP;
      print $fhReport "<td class=\"header\">$STR{'Filename'}</td>\n"     if $chListFilesOptFN;
      print $fhReport "<td class=\"header\">$STR{'Extension'}</td>\n"    if $chListFilesOptFE;
      print $fhReport "<td class=\"header\">$STR{'Count'}</td>\n"        if $chListFilesOptCount;
      print $fhReport "<td class=\"header\">MD5</td>\n"                  if $chListFilesHV1;
      print $fhReport "<td class=\"header\">SHA1</td>\n"                 if $chListFilesHV2;
      print $fhReport "<td class=\"header\">SHA256</td>\n"               if $chListFilesHV3;
      print $fhReport "<td class=\"header\">SHA512</td>\n"               if $chListFilesHV4;
      print $fhReport "<td class=\"header\">$STR{'Size'}</td>\n"         if $chListFilesFD1;
      print $fhReport "<td class=\"header\">$STR{'LastAccessed'}</td>\n" if $chListFilesFD2;
      print $fhReport "<td class=\"header\">$STR{'LastModified'}</td>\n" if $chListFilesFD3;
      print $fhReport "<td class=\"header\">$STR{'NumberFiles'}</td>\n"  if $chListFilesOptNbrF;
      print $fhReport "<td class=\"header\">$STR{'NumberLines'}</td>\n"  if $chListFilesOptNbrL;
      print $fhReport "<td class=\"header\">$STR{'NumberPages'}</td>\n"  if $chListFilesOptNbrP;
      print $fhReport "<td class=\"header\">$STR{'ListMembers'}</td>\n"  if $chListFilesOptLM;
      print $fhReport "</tr>\n";
    }
    foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
      if ($file) {
        if    (-d $file and ($win->chListFilesOptNF->Checked() or (!$chListFilesOptFP and !$chListFilesOptP))) { } # No folder
        elsif (-d $file and $file eq $searchedFolder         ) { } # Searched folder
        else {
          my (@stats) = stat($file) if $chListFilesFD1 or $chListFilesFD2 or $chListFilesFD3; # File details
          my $digestMD5;
          $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
          print $fhReport "<tr>\n";
          # Full path
          if ($chListFilesOptFP) { print $fhReport "<td>$file</td>\n"; }
          # Path
          if ($chListFilesOptP) {
            my $path = $file =~ s/\Q$searchedFolder\E\\?//r;
            print $fhReport "<td>$path</td>\n";
          }
          # Filename
          if ($chListFilesOptFN) {
            if (!-d $file) { # For file only
              my @parts     = split(/\\/, $file);
              my $filename  = pop(@parts);
              print $fhReport "<td>$filename</td>\n";
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # File extension
          if ($chListFilesOptFE) {
            if (!-d $file) { # For file only
              my @parts     = split(/\\/, $file);
              my $filename  = pop(@parts);
              if ($filename =~ /\./ and $filename =~ /\.([^\.]+)$/) { # Extension
                print $fhReport "<td>$1</td>\n";
              } else { print $fhReport "<td>&nbsp;</td>\n"; }              
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # Count
          if ($chListFilesOptCount) {
            if (!-d $file) { # For file only
              if ($basedOnMD5) {
                if ($digestMD5 = file_md5_hex($file)) {
                  if (exists($$refCount{$digestMD5})) {
                    print $fhReport "<td>$$refCount{$digestMD5}</td>\n";
                  } else { print $fhReport "<td>&nbsp;</td>\n"; }
                } else { print $fhReport "<td>&nbsp;</td>\n"; }
              } else {
                my (@fileParts) = split(/\\/, $file);
                my $filename    = pop(@fileParts);
                if (exists($$refCount{$filename})) {
                  print $fhReport "<td>$$refCount{$filename}</td>\n";
                } else { print $fhReport "<td>&nbsp;</td>\n"; }
              }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # MD5
          if ($chListFilesHV1) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
              if ($digestMD5 or (!$digestMD5 and $digestMD5 = file_md5_hex($file))) {
                if ($winConfig->chHashLowercase->Checked()) { print $fhReport "<td>".lc($digestMD5)."</td>\n"; }
                else                                        { print $fhReport "<td>".uc($digestMD5)."</td>\n"; }
              } else {
                print $fhReport "<td>&nbsp;</td>\n";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n" if $logging;
              }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # SHA1
          if ($chListFilesHV2) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
              if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
                
                if ($winConfig->chHashLowercase->Checked()) { print $fhReport "<td>".lc($digestSHA1)."</td>\n"; }
                else                                        { print $fhReport "<td>".uc($digestSHA1)."</td>\n"; }
              } else {
                print $fhReport "<td></td>\n";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n" if $logging;
              }
            } else { print $fhReport "<td></td>\n"; }
          }
          # SHA256
          if ($chListFilesHV3) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...');
              if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
                if ($winConfig->chHashLowercase->Checked()) { print $fhReport "<td>".lc($digestSHA256)."</td>\n"; }
                else                                        { print $fhReport "<td>".uc($digestSHA256)."</td>\n"; }
              } else {
                print $fhReport "<td></td>\n";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingSHA256'}: $file\n" if $logging;
              }
            } else { print $fhReport "<td></td>\n"; }
          }
          # SHA512
          if ($chListFilesHV4) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...');
              if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
                if ($winConfig->chHashLowercase->Checked()) { print $fhReport "<td>".lc($digestSHA512)."</td>\n"; }
                else                                        { print $fhReport "<td>".uc($digestSHA512)."</td>\n"; }
              } else {
                print $fhReport "<td>&nbsp;</td>\n";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingSHA512'}: $file</td>\n" if $logging;
              }
            } else { print $fhReport "<td>\t"; }
          }
          # File size
          if ($chListFilesFD1) {
            if (!-d $file) { # File size
              my $sizeStr;
              if    ($winConfig->chFormatFileSize->Checked()) { $sizeStr = &formatFileSize($stats[7]); }
              elsif ($stats[7]                              ) { $sizeStr = $stats[7];                  }
              if ($sizeStr) { print $fhReport "<td>$sizeStr</td>\n"; }
              else          { print $fhReport "<td>&nbsp;</td>\n";   }
            } else {         # Calculate dir size
              my $dirSize = 0;
              find(sub { $dirSize += -s if -f }, $file);
              if ($winConfig->chFormatFileSize->Checked()) {
                my $sizeStr = &formatFileSize($dirSize);
                print $fhReport "<td>$sizeStr</td>\n";
              } else { print $fhReport "<td>$dirSize</td>\n"; }
            }
          }
          # Last accessed
          if ($chListFilesFD2) {
            if ($stats[8]) {
              my $timeStr = &date($stats[8]);
              print $fhReport "<td>$timeStr</td>\n";
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # Last modified
          if ($chListFilesFD3) {
            if ($stats[9]) {
              my $timeStr = &date($stats[9]);
              print $fhReport "<td>$timeStr</td>\n";
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # Number of files
          if ($chListFilesOptNbrF) {
            if (-d $file) { # Folder
              if ($$refListFiles{$file}) { print $fhReport "<td>$$refListFiles{$file}</td>\n"; }
              else                       { print $fhReport "<td>0</td>\n";                     }
            } elsif ($file =~ /\.zip$/ and my $zip = Archive::Zip->new($file)) { # Zip archive
              my $nbrFiles = $zip->numberOfMembers();
              if ($nbrFiles) { print $fhReport "<td>$nbrFiles</td>\n"; }
              else           { print $fhReport "<td>0</td>\n";         }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # Number of lines
          if ($chListFilesOptNbrL) {
            if (-T $file) { # For text file only
              $win->lblPbCurr->Text($STR{'CalcNbrLines'}.': '.$file.'...');
              my $nbrLines = 0;
              if (open my $fh, '<', $file) {
                while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                close($fh);
              } else {
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n" if $logging;
              }
              if ($nbrLines) { print $fhReport "<td>$nbrLines</td>\n"; }
              else           { print $fhReport "<td>0</td>\n";         }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # Number of pages
          if ($chListFilesOptNbrP) {
            if ($file =~ /\.(?:docx?|xlsx?|pdf)$/) { # For doc(x), xls(x) and PDF
              $win->lblPbCurr->Text($STR{'CalcNbrPages'}.': '.$file.'...');
              my $nbrPages = 0;
              if ($file =~ /\.docx?$/) { # For Doc or Docx, use MS Word
                if (my $document = Win32::OLE->GetObject($file, sub {$_[0]->Quit;})) { # Doc(x)
                  $nbrPages = $document->ActiveWindow->ActivePane->Pages->Count();
                  $document->close();
                  $document->Quit;
                  Win32::OLE->QuitMessageLoop();
                  Win32::OLE->Uninitialize();
                }
              } elsif ($file =~ /\.xls$/  ) { # Xls
                if (my $xls = Spreadsheet::ParseExcel::Simple->read($file)) { $nbrPages = scalar($xls->sheets);          }
              } elsif ($file =~ /\.xlsx$/ ) { # Xlsx
                if (my $xlsx = Spreadsheet::XLSX->new($file)              ) { $nbrPages = scalar(@{$xlsx->{Worksheet}}); }
              } elsif ($file =~ /\.pdf$/  ) { # PDF
                if (my $pdf = CAM::PDF->new($file)                        ) { $nbrPages = $pdf->numPages();              }
              }
              if ($nbrPages) { print $fhReport "<td>$nbrPages</td>\n"; }
              else           { print $fhReport "<td>0</td>\n";         }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          # List of members
          if ($chListFilesOptLM) {
            if ($file =~ /\.(?:xlsx?|zip)$/) { # For xls(x) and Zip
              my @list;
              if      ($file =~ /\.xls$/  ) { # Xls
                my $parser   = Spreadsheet::ParseExcel->new();
                if (my $xls = $parser->parse($file)) {
                  for my $sheet ( $xls->worksheets() ) { push(@list, $sheet->get_name()); }
                }
              } elsif ($file =~ /\.xlsx$/ ) { # Xlsx
                if (my $xlsx = Spreadsheet::XLSX->new($file)) {
                  foreach (@{$xlsx->{Worksheet}}) { push(@list, $_->{Name}); }
                }
              } elsif ($file =~ /\.zip/   ) { # Zip
                if (my $zip = Archive::Zip->new($file)) {
                  my @members = $zip->members();
                  foreach (sort @members) { push(@list, $_->fileName()); }
                }
              }
              if (scalar(@list)) {
                my $cellStr;
                foreach (@list) { $cellStr .= "$_<br>"; }
                $cellStr =~ s/<br>$//;
                print $fhReport "<td>$cellStr</td>\n";
              } else { print $fhReport "<td>&nbsp;</td>\n"; }
            } else { print $fhReport "<td>&nbsp;</td>\n"; }
          }
          print $fhReport "</tr>\n";
        }
      }
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrFiles");
      $win->pb->StepIt();
    }
    print $fhReport "</table>\n</body>\n</html>\n";
    close($fhReport);
    return($reportFilename, $nbrError);
  }
  
}  #--- End writeListFilesReportHTML

#--------------------------#
sub writeListFilesReportXLSX
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptP, $chListFilesOptFN, $chListFilesOptFE, $chListFilesOptCount, $chListFilesOptLM,
      $chListFilesHV1, $chListFilesHV2, $chListFilesHV3, $chListFilesHV4, $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrF,
      $chListFilesOptNbrL, $chListFilesOptNbrP, $basedOnMD5, $refCount, $logging, $fhLog) = @_;
  my $searchedFolder = $win->tfInput->Text()."\\";
  my $nbrError       = 0;
  my $curr           = 0;
  # Write the report
  my $timeStr = &date(time);
  $timeStr    =~ s/[-:]//g;
  $timeStr    =~ s/[ ]/_/g;
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'.$timeStr.'.xlsx'; # Ex.: XL-FileTools report-20160520_082215.xlsx
  if (my $excel = Excel::Writer::XLSX->new($reportFilename)) {
    # Set metadata
    $excel->set_properties(comments => 'Generated by XL-FileTools '.$VERSION);
    # Create a sheet
    if (my $sheet = $excel->add_worksheet($STR{'lblFunctions1T'})) {
      my $formatHeader  = $excel->add_format(align => 'center', size => 10, valign => 'vcenter', bold => 1);
      my $formatNormal	= $excel->add_format(align => 'top'		, size => 10);
      my $formatDetails	= $excel->add_format(align => 'top'		, size => 10, text_wrap => 1);
      # Column size
      my $maxWidthCol1  = length($STR{'FullPath'});
      my $maxWidthCol13 = length($STR{'Path'});
      my $maxWidthCol2  = length($STR{'Filename'});
      my $maxWidthCol15 = length($STR{'Extension'});
      my $maxWidthCol12 = length($STR{'Count'});
      my $maxWidthCol3  = length('MD5');
      my $maxWidthCol4  = length('SHA1');
      my $maxWidthCol5  = length('SHA256');
      my $maxWidthCol6  = length('SHA512');
      my $maxWidthCol7  = length($STR{'Size'});
      my $maxWidthCol8  = length($STR{'LastAccessed'});
      my $maxWidthCol9  = length($STR{'LastModified'});
      my $maxWidthCol10 = length($STR{'NumberFiles'});
      my $maxWidthCol11 = length($STR{'NumberLines'});
      my $maxWidthCol14 = length($STR{'NumberPages'});
      my $maxWidthCol16 = length($STR{'ListMembers'});
      # Header
      my $i = 0;
      if (!$win->chListFilesOptNH->Checked()) {
        my $j = 0; # Column no
        if ($chListFilesOptFP)    { $sheet->write_string(0, $j, $STR{'FullPath'}    , $formatHeader); $j++; }
        if ($chListFilesOptP)     { $sheet->write_string(0, $j, $STR{'Path'}        , $formatHeader); $j++; }
        if ($chListFilesOptFN)    { $sheet->write_string(0, $j, $STR{'Filename'}    , $formatHeader); $j++; }
        if ($chListFilesOptFE)    { $sheet->write_string(0, $j, $STR{'Extension'}   , $formatHeader); $j++; }
        if ($chListFilesOptCount) { $sheet->write_string(0, $j, $STR{'Count'}       , $formatHeader); $j++; }
        if ($chListFilesHV1)      { $sheet->write_string(0, $j, 'MD5'               , $formatHeader); $j++; }
        if ($chListFilesHV2)      { $sheet->write_string(0, $j, 'SHA1'              , $formatHeader); $j++; }
        if ($chListFilesHV3)      { $sheet->write_string(0, $j, 'SHA256'            , $formatHeader); $j++; }
        if ($chListFilesHV4)      { $sheet->write_string(0, $j, 'SHA512'            , $formatHeader); $j++; }
        if ($chListFilesFD1)      { $sheet->write_string(0, $j, $STR{'Size'}        , $formatHeader); $j++; }
        if ($chListFilesFD2)      { $sheet->write_string(0, $j, $STR{'LastAccessed'}, $formatHeader); $j++; }
        if ($chListFilesFD3)      { $sheet->write_string(0, $j, $STR{'LastModified'}, $formatHeader); $j++; }
        if ($chListFilesOptNbrF)  { $sheet->write_string(0, $j, $STR{'NumberFiles'} , $formatHeader); $j++; }
        if ($chListFilesOptNbrL)  { $sheet->write_string(0, $j, $STR{'NumberLines'} , $formatHeader); $j++; }
        if ($chListFilesOptNbrP)  { $sheet->write_string(0, $j, $STR{'NumberPages'} , $formatHeader); $j++; }
        if ($chListFilesOptLM)    { $sheet->write_string(0, $j, $STR{'ListMembers'} , $formatHeader); $j++; }
        $i++;
      }
      foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
        my $j = 0; # Column no
        if ($file) {
          if    (-d $file and ($win->chListFilesOptNF->Checked() or (!$chListFilesOptFP and !$chListFilesOptP))) { } # No folder
          elsif (-d $file and $file eq $searchedFolder         ) { } # Searched folder
          else {
            my $digestMD5;
            my (@stats) = stat($file) if $chListFilesFD1 or $chListFilesFD2 or $chListFilesFD3; # File details
            $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
            # Full path
            if ($chListFilesOptFP) {
              $sheet->write_string($i, $j, $file, $formatNormal);
              $j++;
              $maxWidthCol1 = length($file) if length($file) > $maxWidthCol1;
            }
            # Path
            if ($chListFilesOptP) {
              my $path = $file =~ s/\Q$searchedFolder\E\\?//r;
              $sheet->write_string($i, $j, $path, $formatNormal);
              $j++;
              $maxWidthCol13 = length($file) if length($file) > $maxWidthCol13;
            }
            # Filename
            if ($chListFilesOptFN) {
              if (!-d $file) { # For file only
                my @parts     = split(/\\/, $file);
                my $filename  = pop(@parts);
                $sheet->write_string($i, $j, $filename, $formatNormal);
                $maxWidthCol2 = length($filename) if length($filename) > $maxWidthCol2;
              }
              $j++;
            }
            # File extension
            if ($chListFilesOptFE) {
              if (!-d $file) { # For file only
                my @parts     = split(/\\/, $file);
                my $filename  = pop(@parts);
                if ($filename =~ /\./ and $filename =~ /\.([^\.]+)$/) { # Extension
                  my $ext = $1;
                  $sheet->write_string($i, $j, $ext, $formatNormal);
                  $maxWidthCol15 = length($ext) if length($ext) > $maxWidthCol15;
                }
              }
              $j++;
            }
            # Count
            if ($chListFilesOptCount) {
              if (!-d $file) { # For file only
                if ($basedOnMD5) {
                  if ($digestMD5 = file_md5_hex($file)) {
                    if (exists($$refCount{$digestMD5})) {
                      $sheet->write_string($i, $j, $$refCount{$digestMD5}, $formatNormal);
                      $maxWidthCol12 = length($$refCount{$digestMD5}) if length($$refCount{$digestMD5}) > $maxWidthCol12;
                    }
                  }
                } else {
                  my (@fileParts) = split(/\\/, $file);
                  my $filename    = pop(@fileParts);
                  if (exists($$refCount{$filename})) {
                    $sheet->write_string($i, $j, $$refCount{$filename}, $formatNormal);
                    $maxWidthCol12 = length($$refCount{$filename}) if length($$refCount{$filename}) > $maxWidthCol12;
                  }
                }
              }
              $j++;
            }
            # MD5
            if ($chListFilesHV1) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
                if ($digestMD5 or (!$digestMD5 and $digestMD5 = file_md5_hex($file))) {
                  if ($winConfig->chHashLowercase->Checked()) { $sheet->write_string($i, $j, lc($digestMD5), $formatNormal); }
                  else                                        { $sheet->write_string($i, $j, uc($digestMD5), $formatNormal); }
                  $maxWidthCol3 = length($digestMD5) if length($digestMD5) > $maxWidthCol3;
                } else {
                  $nbrError++;
                  print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n" if $logging;
                }
              }
              $j++;
            }
            # SHA1
            if ($chListFilesHV2) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
                if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
                  if ($winConfig->chHashLowercase->Checked()) { $sheet->write_string($i, $j, lc($digestSHA1), $formatNormal); }
                  else                                        { $sheet->write_string($i, $j, uc($digestSHA1), $formatNormal); }
                  $maxWidthCol4 = length($digestSHA1) if length($digestSHA1) > $maxWidthCol4;
                } else {
                  $nbrError++;
                  print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n"  if $logging;
                }
              }
              $j++;
            }
            # SHA256
            if ($chListFilesHV3) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...');
                if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
                  if ($winConfig->chHashLowercase->Checked()) { $sheet->write_string($i, $j, lc($digestSHA256), $formatNormal); }
                  else                                        { $sheet->write_string($i, $j, uc($digestSHA256), $formatNormal); }
                  $maxWidthCol5 = length($digestSHA256) if length($digestSHA256) > $maxWidthCol5;
                } else {
                  $nbrError++;
                  print $fhLog "$STR{'Error'} $STR{'HashingSHA256'}: $file\n"  if $logging;
                }
              }
              $j++;
            }
            # SHA512
            if ($chListFilesHV4) {
              if (!-d $file) { # For file only
                $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...');
                if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
                  if ($winConfig->chHashLowercase->Checked()) { $sheet->write_string($i, $j, lc($digestSHA512), $formatNormal); }
                  else                                        { $sheet->write_string($i, $j, uc($digestSHA512), $formatNormal); }
                  $maxWidthCol6 = length($digestSHA512) if length($digestSHA512) > $maxWidthCol6;
                } else {
                  $nbrError++;
                  print $fhLog "$STR{'Error'} $STR{'HashingSHA512'}: $file\n"  if $logging;
                }
              }
              $j++;
            }
            # File size
            if ($chListFilesFD1) {
              if (!-d $file) { # File size
                if ($stats[7]) {
                  my $sizeStr;
                  if ($winConfig->chFormatFileSize->Checked()) { $sizeStr = &formatFileSize($stats[7]); }
                  else                                         { $sizeStr = $stats[7];                  }
                  $sheet->write_string($i, $j, $sizeStr, $formatNormal);
                  $maxWidthCol7 = length($sizeStr) if length($sizeStr) > $maxWidthCol7;
                }
              } else {          # Calculate dir size
                my $dirSize = 0;
                find(sub { $dirSize += -s if -f }, $file);
                my $sizeStr;
                if ($winConfig->chFormatFileSize->Checked()) {
                  $sizeStr = &formatFileSize($dirSize);
                  $sheet->write_string($i, $j, $sizeStr, $formatNormal);
                } else { $sheet->write_string($i, $j, $dirSize, $formatNormal); $sizeStr = $dirSize; }
                $maxWidthCol7 = length($sizeStr) if length($sizeStr) > $maxWidthCol7;
              }
              $j++;
            }
            # Last accessed
            if ($chListFilesFD2) {
              my $timeStr = &date($stats[8]);
              $sheet->write_string($i, $j, $timeStr, $formatNormal);
              $maxWidthCol8 = length($timeStr) if length($timeStr) > $maxWidthCol8;
              $j++;
            }
            # Last modified
            if ($chListFilesFD3) {
              if ($stats[9]) {
                my $timeStr = &date($stats[9]);
                $sheet->write_string($i, $j, $timeStr, $formatNormal);
                $maxWidthCol9 = length($timeStr) if length($timeStr) > $maxWidthCol9;
              }
              $j++;
            }
            # Number of files
            if ($chListFilesOptNbrF) { # For folder only
              if (-d $file) {
                if ($$refListFiles{$file}) {
                  $sheet->write_string($i, $j, $$refListFiles{$file}, $formatNormal);
                  $maxWidthCol10 = length("$$refListFiles{$file}") if length("$$refListFiles{$file}") > $maxWidthCol10;
                } else { $sheet->write_string($i, $j, 0, $formatNormal); }
              } elsif ($file =~ /\.zip$/ and my $zip = Archive::Zip->new($file)) { # Zip archive
                my $nbrFiles = $zip->numberOfMembers();
                if ($nbrFiles) {
                  $sheet->write_string($i, $j, $nbrFiles, $formatNormal);
                  $maxWidthCol10 = length("$nbrFiles") if length("$nbrFiles") > $maxWidthCol10;
                } else { $sheet->write_string($i, $j, 0, $formatNormal); }
              }
              $j++;
            }
            # Number of lines
            if ($chListFilesOptNbrL) {
              if (-T $file) { # For text file only
                $win->lblPbCurr->Text($STR{'CalcNbrLines'}.': '.$file.'...');
                my $nbrLines = 0;
                if (open my $fh, '<', $file) {
                  while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                  close($fh);
                } else {
                  $nbrError++;
                  print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n"  if $logging;
                }
                if ($nbrLines) {
                  $sheet->write_string($i, $j, $nbrLines, $formatNormal);
                  $maxWidthCol11 = length("$nbrLines") if length("$nbrLines") > $maxWidthCol11;
                } else { $sheet->write_string($i, $j, 0, $formatNormal); }
              }
              $j++;
            }
            # Number of pages
            if ($chListFilesOptNbrP) {
              if ($file =~ /\.(?:docx?|xlsx?|pdf)$/) { # For doc(x), xls(x) and PDF
                $win->lblPbCurr->Text($STR{'CalcNbrPages'}.': '.$file.'...');
                my $nbrPages = 0;
                if ($file =~ /\.docx?$/) { # For Doc or Docx, use MS Word
                  if (my $document = Win32::OLE->GetObject($file, sub {$_[0]->Quit;})) { # Doc(x)
                    $nbrPages = $document->ActiveWindow->ActivePane->Pages->Count();
                    $document->close();
                    $document->Quit;
                    Win32::OLE->QuitMessageLoop();
                    Win32::OLE->Uninitialize();
                  }
                } elsif ($file =~ /\.xls$/  ) { # Xls
                  if (my $xls = Spreadsheet::ParseExcel::Simple->read($file)) { $nbrPages = scalar($xls->sheets);          }
                } elsif ($file =~ /\.xlsx$/ ) { # Xlsx
                  if (my $xlsx = Spreadsheet::XLSX->new($file)              ) { $nbrPages = scalar(@{$xlsx->{Worksheet}}); }
                } elsif ($file =~ /\.pdf$/  ) { # PDF
                  if (my $pdf = CAM::PDF->new($file)                        ) { $nbrPages = $pdf->numPages();              }
                }
                if ($nbrPages) {
                  $sheet->write_string($i, $j, $nbrPages, $formatNormal);
                  $maxWidthCol14 = length("$nbrPages") if length("$nbrPages") > $maxWidthCol14;
                } else { $sheet->write_string($i, $j, 0, $formatNormal); }
              }
              $j++;
            }
            # List of members
            if ($chListFilesOptLM) {
              if ($file =~ /\.(?:xlsx?|zip)$/) { # For xls(x) and Zip
                my @list;
                if      ($file =~ /\.xls$/  ) { # Xls
                  my $parser   = Spreadsheet::ParseExcel->new();
                  if (my $xls = $parser->parse($file)) {
                    for my $sheet ( $xls->worksheets() ) { push(@list, $sheet->get_name()); }
                  }
                } elsif ($file =~ /\.xlsx$/ ) { # Xlsx
                  if (my $xlsx = Spreadsheet::XLSX->new($file)) {
                    foreach (@{$xlsx->{Worksheet}}) { push(@list, $_->{Name}); }
                  }
                } elsif ($file =~ /\.zip/   ) { # Zip
                  if (my $zip = Archive::Zip->new($file)) {
                    my @members = $zip->members();
                    foreach (sort @members) { push(@list, $_->fileName()); }
                  }
                }
                if (scalar(@list)) {
                  my $cellStr;
                  foreach (@list) {
                    $cellStr .= $_ . "\r\n";
                    $maxWidthCol16 = length($_) if length($_) > $maxWidthCol16;
                  }
                  $cellStr =~ s/\r\n$//;
                  $sheet->write_string($i, $j, $cellStr, $formatDetails);
                }
              }
              $j++;
            }
            $i++;
          }
        }
        # Progress
        $curr++;
        $win->lblPbCount->Text("$curr / $nbrFiles");
        $win->pb->StepIt();
      }
      # Set column width
      my $j = 0;
      if ($chListFilesOptFP)    { $sheet->set_column($j, $j, $maxWidthCol1);  $j++; } # Full path
      if ($chListFilesOptP)     { $sheet->set_column($j, $j, $maxWidthCol13); $j++; } # Path
      if ($chListFilesOptFN)    { $sheet->set_column($j, $j, $maxWidthCol2);  $j++; } # Filename
      if ($chListFilesOptFE)    { $sheet->set_column($j, $j, $maxWidthCol15); $j++; } # File extension
      if ($chListFilesOptCount) { $sheet->set_column($j, $j, $maxWidthCol12); $j++; } # Count
      if ($chListFilesHV1)      { $sheet->set_column($j, $j, $maxWidthCol3);  $j++; } # MD5
      if ($chListFilesHV2)      { $sheet->set_column($j, $j, $maxWidthCol4);  $j++; } # SHA1
      if ($chListFilesHV3)      { $sheet->set_column($j, $j, $maxWidthCol5);  $j++; } # SHA256
      if ($chListFilesHV4)      { $sheet->set_column($j, $j, $maxWidthCol6);  $j++; } # SHA512
      if ($chListFilesFD1)      { $sheet->set_column($j, $j, $maxWidthCol7);  $j++; } # File size
      if ($chListFilesFD2)      { $sheet->set_column($j, $j, $maxWidthCol8);  $j++; } # Last accessed
      if ($chListFilesFD3)      { $sheet->set_column($j, $j, $maxWidthCol9);  $j++; } # Last modified
      if ($chListFilesOptNbrF)  { $sheet->set_column($j, $j, $maxWidthCol10); $j++; } # Number of files
      if ($chListFilesOptNbrL)  { $sheet->set_column($j, $j, $maxWidthCol11); $j++; } # Number of lines
      if ($chListFilesOptNbrP)  { $sheet->set_column($j, $j, $maxWidthCol14); $j++; } # Number of pages
      if ($chListFilesOptLM)    { $sheet->set_column($j, $j, $maxWidthCol16); $j++; } # List of members
    }
    $excel->close(); # Close the file
    return($reportFilename, $nbrError);
  }
  
}  #--- End writeListFilesReportXLSX

#--------------------------#
sub writeListFilesReportTXT
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $chListFilesOptFP, $chListFilesOptP, $chListFilesOptFN, $chListFilesOptFE, $chListFilesOptCount, $chListFilesOptLM,
      $chListFilesHV1, $chListFilesHV2, $chListFilesHV3, $chListFilesHV4, $chListFilesFD1, $chListFilesFD2, $chListFilesFD3, $chListFilesOptNbrF,
      $chListFilesOptNbrL, $chListFilesOptNbrP, $basedOnMD5, $refCount, $logging, $fhLog) = @_;
  my $searchedFolder = $win->tfInput->Text()."\\";
  my $nbrError       = 0;
  my $curr           = 0;
  # File Header
  my $header;
  if (!$win->chListFilesOptNH->Checked()) {
    $header .= $STR{'FullPath'}     . "\t" if $chListFilesOptFP;
    $header .= $STR{'Path'}         . "\t" if $chListFilesOptP;
    $header .= $STR{'Filename'}     . "\t" if $chListFilesOptFN;
    $header .= $STR{'Extension'}    . "\t" if $chListFilesOptFE;
    $header .= $STR{'Count'}        . "\t" if $chListFilesOptCount;
    $header .= 'MD5'                . "\t" if $chListFilesHV1;
    $header .= 'SHA1'               . "\t" if $chListFilesHV2;
    $header .= 'SHA256'             . "\t" if $chListFilesHV3;
    $header .= 'SHA512'             . "\t" if $chListFilesHV4;
    $header .= $STR{'Size'}         . "\t" if $chListFilesFD1;
    $header .= $STR{'LastAccessed'} . "\t" if $chListFilesFD2;
    $header .= $STR{'LastModified'} . "\t" if $chListFilesFD3;
    $header .= $STR{'NumberFiles'}  . "\t" if $chListFilesOptNbrF;
    $header .= $STR{'NumberLines'}  . "\t" if $chListFilesOptNbrL;
    $header .= $STR{'NumberPages'}  . "\t" if $chListFilesOptNbrP;
    $header .= $STR{'ListMembers'}  . "\t" if $chListFilesOptLM;
    chop($header);
  }
  # Write the report
  my $timeStr = &date(time);
  $timeStr    =~ s/[-:]//g;
  $timeStr    =~ s/[ ]/_/g;
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'.$timeStr.'.txt'; # Ex.: XL-FileTools report-20160520_082215.txt
  if (open(my $fhReport, '>', $reportFilename)) {
    flock($fhReport, 2);
    if (!$win->chListFilesOptNH->Checked()) { print $fhReport "$header\n"; }
    foreach my $file (sort { $a cmp $b } keys %{$refListFiles}) {
      if ($file) {
        if    (-d $file and ($win->chListFilesOptNF->Checked() or (!$chListFilesOptFP and !$chListFilesOptP))) { } # No folder
        elsif (-d $file and $file eq $searchedFolder         ) { } # Searched folder
        else {
          my (@stats) = stat($file) if $chListFilesFD1 or $chListFilesFD2 or $chListFilesFD3; # File details
          my $digestMD5;
          $win->lblPbCurr->Text($STR{'Processing'}.': '.$file);
          my $newLine;
          # Full path
          if ($chListFilesOptFP) { $newLine .= "$file\t"; }
          # Path
          if ($chListFilesOptFP) {
            my $path  = $file =~ s/\Q$searchedFolder\E\\?//r;
            $newLine .= "$path\t";
          }
          # Filename
          if ($chListFilesOptFN) {
            if (!-d $file) { # For file only
              my @parts     = split(/\\/, $file);
              my $filename  = pop(@parts);
              $newLine     .= "$filename\t";
            } else { $newLine .= "\t"; }
          }
          # File extension
          if ($chListFilesOptFE) {
            if (!-d $file) { # For file only
              my @parts     = split(/\\/, $file);
              my $filename  = pop(@parts);
              if ($filename =~ /\./ and $filename =~ /\.([^\.]+)$/) { # Extension
                $newLine .= "$1\t";
              } else { $newLine .= "\t"; }
            } else { $newLine .= "\t"; }
          }
          # Count
          if ($chListFilesOptCount) {
            if (!-d $file) { # For file only
              if ($basedOnMD5) {
                if ($digestMD5 = file_md5_hex($file)) {
                  if (exists($$refCount{$digestMD5})) {
                    $newLine .= "$$refCount{$digestMD5}\t";
                  } else { $newLine .= "\t"; }
                } else { $newLine .= "\t"; }
              } else {
                my (@fileParts) = split(/\\/, $file);
                my $filename    = pop(@fileParts);
                if (exists($$refCount{$filename})) {
                  $newLine .= "$$refCount{$filename}\t";
                } else { $newLine .= "\t"; }
              }
            } else { $newLine .= "\t"; }
          }
          # MD5
          if ($chListFilesHV1) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingMD5'}.': '.$file.'...');
              if ($digestMD5 or (!$digestMD5 and $digestMD5 = file_md5_hex($file))) {
                if ($winConfig->chHashLowercase->Checked()) { $newLine .= lc($digestMD5) ."\t"; }
                else                                        { $newLine .= uc($digestMD5) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingMD5'}: $file\n"  if $logging;
              }
            } else { $newLine .= "\t"; }
          }
          # SHA1
          if ($chListFilesHV2) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA1'}.': '.$file.'...');
              if (my $digestSHA1 = Digest::SHA->new(1)->addfile($file,"b")->hexdigest) {
                if ($winConfig->chHashLowercase->Checked()) { $newLine .= lc($digestSHA1) ."\t"; }
                else                                        { $newLine .= uc($digestSHA1) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingSHA1'}: $file\n"  if $logging;
              }
            } else { $newLine .= "\t"; }
          }
          # SHA256
          if ($chListFilesHV3) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA256'}.': '.$file.'...');
              if (my $digestSHA256 = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) {
                if ($winConfig->chHashLowercase->Checked()) { $newLine .= lc($digestSHA256) ."\t"; }
                else                                        { $newLine .= uc($digestSHA256) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingSHA256'}: $file\n"  if $logging;
              }
            } else { $newLine .= "\t"; }
          }
          # SHA512
          if ($chListFilesHV4) {
            if (!-d $file) { # For file only
              $win->lblPbCurr->Text($STR{'HashingSHA512'}.': '.$file.'...');
              if (my $digestSHA512 = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) {
                if ($winConfig->chHashLowercase->Checked()) { $newLine .= lc($digestSHA512) ."\t"; }
                else                                        { $newLine .= uc($digestSHA512) ."\t"; }
              } else {
                $newLine .= "\t";
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'HashingSHA512'}: $file\n" if $logging;
              }
            } else { $newLine .= "\t"; }
          }
          # File size
          if ($chListFilesFD1) {
            if (!-d $file) { # File size
              my $sizeStr;
              if    ($winConfig->chFormatFileSize->Checked()) { $sizeStr = &formatFileSize($stats[7]); }
              elsif ($stats[7]                              ) { $sizeStr = $stats[7];                  }
              if ($sizeStr) { $newLine .= "$sizeStr\t"; }
              else          { $newLine .= "\t";         }
            } else {         # Calculate dir size
              my $dirSize = 0;
              find(sub { $dirSize += -s if -f }, $file);
              if ($winConfig->chFormatFileSize->Checked()) {
                my $sizeStr = &formatFileSize($dirSize);
                $newLine   .= "$sizeStr\t";
              } else { $newLine .= "$dirSize\t"; }
            }
          }
          # Last accessed
          if ($chListFilesFD2) {
            if ($stats[8]) { $newLine .= &date($stats[8]) . "\t"; }
            else           { $newLine .= "\t"; }
          }
          # Last modified
          if ($chListFilesFD3) {
            if ($stats[9]) { $newLine .= &date($stats[9]) . "\t"; }
            else           { $newLine .= "\t"; }
          }
          # Number of files
          if ($chListFilesOptNbrF) {
            if (-d $file) { # Folders
              if ($$refListFiles{$file}) { $newLine .= $$refListFiles{$file} . "\t"; }
              else                       { $newLine .= "0\t"; }
            } elsif ($file =~ /\.zip$/ and my $zip = Archive::Zip->new($file)) { # Zip archive
              my $nbrFiles = $zip->numberOfMembers();
              if ($nbrFiles) { $newLine .= $nbrFiles . "\t"; }
              else           { $newLine .= "0\t"; }
            } else { $newLine .= "\t"; }
          }
          # Number of lines
          if ($chListFilesOptNbrL) {
            if (-T $file) { # For text file only
              $win->lblPbCurr->Text($STR{'CalcNbrLines'}.': '.$file.'...');
              my $nbrLines = 0;
              if (open my $fh, '<', $file) {
                while (sysread $fh, my $buffer, 4096) { $nbrLines += ($buffer =~ tr/\n//); }
                close($fh);
              } else {
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'Reading'}: $file: $!\n" if $logging;
              }
              if ($nbrLines) { $newLine .= $nbrLines ."\t"; }
              else           { $newLine .= "0\t"; }
            } else { $newLine .= "\t"; }
          }
          # Number of pages
          if ($chListFilesOptNbrP) {
            if ($file =~ /\.(?:docx?|xlsx?|pdf)$/) { # For doc(x), xls(x) and PDF
              $win->lblPbCurr->Text($STR{'CalcNbrPages'}.': '.$file.'...');
              my $nbrPages = 0;
              if ($file =~ /\.docx?$/) { # For Doc or Docx, use MS Word
                if (my $document = Win32::OLE->GetObject($file, sub {$_[0]->Quit;})) { # Doc(x)
                  $nbrPages = $document->ActiveWindow->ActivePane->Pages->Count();
                  $document->close();
                  $document->Quit;
                  Win32::OLE->QuitMessageLoop();
                  Win32::OLE->Uninitialize();
                }
              } elsif ($file =~ /\.xls$/  ) { # Xls
                if (my $xls = Spreadsheet::ParseExcel::Simple->read($file)) { $nbrPages = scalar($xls->sheets);          }
              } elsif ($file =~ /\.xlsx$/ ) { # Xlsx
                if (my $xlsx = Spreadsheet::XLSX->new($file)              ) { $nbrPages = scalar(@{$xlsx->{Worksheet}}); }
              } elsif ($file =~ /\.pdf$/  ) { # PDF
                if (my $pdf = CAM::PDF->new($file)                        ) { $nbrPages = $pdf->numPages();              }
              }
              if ($nbrPages) { $newLine .= $nbrPages ."\t"; }
              else           { $newLine .= "0\t"; }
            } else { $newLine .= "\t"; }
          }
          # List Members
          if ($chListFilesOptLM) {
            if ($file =~ /\.(?:xlsx?|zip)$/) { # For xls(x) and Zip
              my @list;
              if      ($file =~ /\.xls$/  ) { # Xls
                my $parser   = Spreadsheet::ParseExcel->new();
                if (my $xls = $parser->parse($file)) {
                  for my $sheet ( $xls->worksheets() ) { push(@list, $sheet->get_name()); }
                }
              } elsif ($file =~ /\.xlsx$/ ) { # Xlsx
                if (my $xlsx = Spreadsheet::XLSX->new($file)) {
                  foreach (@{$xlsx->{Worksheet}}) { push(@list, $_->{Name}); }
                }
              } elsif ($file =~ /\.zip/   ) { # Zip
                if (my $zip = Archive::Zip->new($file)) {
                  my @members = $zip->members();
                  foreach (sort @members) { push(@list, $_->fileName()); }
                }
              }
              if (scalar(@list)) {
                foreach (@list) { $newLine .= $_ .", "; }
                $newLine =~ s/, $/\t/;
              } else { $newLine .= "\t"; }
            } else { $newLine .= "\t"; }
          }
          # Print line
          if ($newLine) {
            chop($newLine);
            print $fhReport "$newLine\n";
          }
        }
      }
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrFiles");
      $win->pb->StepIt();
    }
    close($fhReport);
    return($reportFilename, $nbrError);
  }
  
}  #--- End writeListFilesReportTXT

#--------------------------#
sub listExtReport
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $nbrFiles     = scalar(keys %{$refListFiles});
  my $dirReport    = $win->tfReportDir->Text();
  my $minLength    = $win->tfListExtMinLength->Text();
  my $maxLength    = $win->tfListExtMaxLength->Text();
  my $count        = 0;
  my %listExtensions;
  if ($dirReport) {
    # Show progress
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
    $win->lblPbCurr->Text($STR{'ListingExtensions'}.'...');
    # List extensions
    foreach my $file (keys %{$refListFiles}) {
      if (!-d $file) { # Not a directory
        my $filename = (split(/\\/, $file))[-1];
        if ($filename =~ /\./) { # There is an extension
          my $extension = (split(/\./, $file))[-1];
          my $length    = length($extension);
          if ($length >= $minLength and $length <= $maxLength) {
            my $extensionUC = uc($extension);
            if (exists($listExtensions{$extensionUC})) { $listExtensions{$extensionUC}++;   }
            else                                       { $listExtensions{$extensionUC} = 1; }
          }
        } elsif (!$minLength) { # No extension
          if (exists($listExtensions{'*No extension'})) { $listExtensions{'*No extension'}++;   }
          else                                          { $listExtensions{'*No extension'} = 1; }
        }
      }
      $count++;
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    }
    # Write the report
    $win->lblPbCurr->Text($STR{'WritingReport'}.'...');
    my $formatReport = $win->cbReportFormat->GetCurSel();
    my ($reportFilename);
    if      ($formatReport == 1) {
      $reportFilename = &listExtReportHTML($dirReport, \%listExtensions);
    # XLSX format
    } elsif ($formatReport == 2) {
      $reportFilename = &listExtReportXLSX($dirReport, \%listExtensions);
    # Text format
    } else {
      $reportFilename = &listExtReportTXT( $dirReport, \%listExtensions);
    }
    $win->ShellExecute('open', $reportFilename,'','',1) if $win->chOpenReport->Checked() and $reportFilename; # Open report
  }
  
}  #--- End listExtReport

#--------------------------#
sub listExtReportHTML
#--------------------------#
{
  # Local variables
  my ($dirReport, $refListExtensions) = @_;
  my $timeStr  = &date(time);
  my $timeStr2 = $timeStr;
  $timeStr2    =~ s/[-:]//g;
  $timeStr2    =~ s/[ ]/_/g;
  # Create the HTML report
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'.$timeStr2.'.html'; # Ex.: XL-FileTools report-20160520_082215.html
  if (open(my $fhReport, '>', $reportFilename)) {
    flock($fhReport, 2);
    print $fhReport "<!DOCTYPE html>\n";
    print $fhReport "<html>\n<head>\n<title>XL-FileTools $STR{'report'} $timeStr</title>\n";
    print $fhReport "<meta name=\"generator\" content=\"XL-FileTools $VERSION\">\n";
    print $fhReport "<style>\n";
    print $fhReport "table, td { border-collapse: collapse; border: 1px solid black; padding: 5px; }\n";
    print $fhReport "td { font-size:11pt; vertical-align: top; white-space: nowrap; }\n";
    print $fhReport ".header { text-align: center; font-weight: bold }\n";
    print $fhReport "</style>\n";
    print $fhReport "</head>\n";
    print $fhReport "<body style=\"font-family: Calibri, Verdana, Arial;\">\n";
    print $fhReport "<table align=\"center\">\n";
    print $fhReport "<tr>\n";
    print $fhReport "<td class=\"header\">$STR{'Extension'}</td>\n";
    print $fhReport "<td class=\"header\">$STR{'Count'}</td>\n";
    print $fhReport "</tr>\n";
    foreach my $ext (reverse sort { $$refListExtensions{$a} <=> $$refListExtensions{$b} } keys %{$refListExtensions}) {
      print $fhReport "<tr><td>$ext</td><td>$$refListExtensions{$ext}</td></tr>\n";
    }
    print $fhReport "</table>\n</body>\n</html>\n";
    close($fhReport);
    return($reportFilename);
  }

}  #--- End listExtReportHTML

#--------------------------#
sub listExtReportXLSX
#--------------------------#
{
  # Local variables
  my ($dirReport, $refListExtensions) = @_;
  my $timeStr = &date(time);
  $timeStr    =~ s/[-:]//g;
  $timeStr    =~ s/[ ]/_/g;
  my $reportFilename = $win->tfReportDir->Text()."\\"."XL-FileTools ".$STR{'report'}.'-'.$timeStr.'.xlsx'; # Ex.: XL-FileTools report-20160520_082215.xlsx
  if (my $excel = Excel::Writer::XLSX->new($reportFilename)) {
    # Set metadata
    $excel->set_properties(comments => 'Generated by XL-FileTools '.$VERSION);
    # Create a sheet
    if (my $sheet = $excel->add_worksheet($STR{'Extensions'})) {
      # Column size
      my $maxWidthCol1 = length($STR{'Extension'});
      my $maxWidthCol2 = length($STR{'Count'});
      # Header
      my $i = 0;
      my $formatHeader = $excel->add_format();
      $formatHeader->set_bold();
      $formatHeader->set_align( 'center' );
      $formatHeader->set_align( 'vcenter' );
      my $j = 0; # Column no
      $sheet->write_string(0, $j, $STR{'Extension'}, $formatHeader); $j++;
      $sheet->write_string(0, $j, $STR{'Count'}    , $formatHeader); $j++;
      $i++;
      foreach my $ext (reverse sort { $$refListExtensions{$a} <=> $$refListExtensions{$b} } keys %{$refListExtensions}) {
        $j = 0;
        $sheet->write_string($i, $j, $ext);
        $j++;
        $maxWidthCol1 = length($ext) if length($ext) > $maxWidthCol1;
        $sheet->write_number($i, $j, $$refListExtensions{$ext});
        $j++;
        $maxWidthCol1 = length($$refListExtensions{$ext}) if length($$refListExtensions{$ext}) > $maxWidthCol1;
        $i++;
      }
      # Set column width
      $j = 0;
      $sheet->set_column($j, $j, $maxWidthCol1); # Extension
      $j++;
      $sheet->set_column($j, $j, $maxWidthCol2); # Count
    }
    $excel->close(); # Close the file
    return($reportFilename);
  }

}  #--- End listExtReportXLSX

#--------------------------#
sub listExtReportTXT
#--------------------------#
{
  # Local variables
  my ($dirReport, $refListExtensions) = @_;
  my $timeStr = &date(time);
  $timeStr    =~ s/[-:]//g;
  $timeStr    =~ s/[ ]/_/g;
  # Create the text report
  my $reportFilename = $dirReport."\\"."XL-FileTools ".$STR{'report'}.'-'.$timeStr.'.txt'; # Ex.: XL-FileTools report-20160520_082215.txt
  if (open(my $fhReport, '>', $reportFilename)) {
    flock($fhReport, 2);
    print $fhReport "$STR{'Extension'}\t$STR{'Count'}\n";
    foreach my $ext (reverse sort { $$refListExtensions{$a} <=> $$refListExtensions{$b} } keys %{$refListExtensions}) {
      print $fhReport "$ext\t".$$refListExtensions{$ext}."\n" ;
    }
    close($fhReport);
    return($reportFilename);
  }

}  #--- End listExtReportTXT

#--------------------------#
sub copyMove
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift; # If 0, preview mode
  my $dstFolder    = $win->tfDestinationDir->Text();
  my $logging      = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    if ($winConfig->chUseDestDirCM->Checked() and -d $dstFolder) { $logFile = $dstFolder; }
    else {
      if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
        $logFile = $winConfig->tfLoggingDir->Text();
      } else { $logFile = $USERDIR; }
    }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  if ($dstFolder) {
    # Local variales
    my $nbrFiles     = scalar(keys %{$refListFiles});
    my $optCopyTree  = $win->chCopyTree->Checked();
    my $optDuplicate = $win->chCopyRemDouble->Checked();
    my $selFuncCopy  = $win->TabFuncCopy->SelectedItem();
    my $dir          = $win->tfInput->Text();
    my $nbrCopyMove  = 0;
    my $count        = 0;
    my $srcDriveLetter;
    my $sameVolume   = 1;
    my $totalSize;
    my %listMD5;
    my %resListFiles;
    my %listSubFolders;
    my %movedDirs;
    # Show progress
    if ($execute) {
      $win->pb->SetRange(0, $nbrFiles);
      $win->pb->SetPos(0);
      $win->pb->SetStep(1);
      $win->lblPbCount->Text("0 / $nbrFiles");
      $win->lblPbCurr->Text($STR{'PreProcessing'}.'...');
    } else { # Preview mode
      $winPb->pbWinPb->SetRange(0, $nbrFiles);
      $winPb->pbWinPb->SetPos(0);
      $winPb->pbWinPb->SetStep(1);
      $winPb->lblCount->Text("0 / $nbrFiles");
      $winPb->lblPbCurr->Text($STR{'PreProcessing'}.'...');
    }
    # Pre-process list of files
    #   - Remove folders from the list (folders)
    #   - If Exclude duplicates option is checked, calculate MD5 hash for each file and remove duplicate
    #   - Calculate total size to be copied or moved
    #   - Set destination path
    #   - Note source drive letter
    foreach my $file (keys %{$refListFiles}) {
      # It's a directory, remove it
      if (-d $file) {
        my $dstPath;
        if ($optCopyTree) { # If we duplicate tree structure
          $dstPath = $file =~ s/\Q$dir//r;
          $dstPath = $dstFolder . $dstPath;
          $listSubFolders{$dstPath} = 1;
        }
        delete($$refListFiles{$file});
        # If moving, remember moved dir
        $movedDirs{$file} = 1 if $selFuncCopy and $file ne "$dir\\" and !exists($movedDirs{$file});
        next;
      } else {
        # It's a file and we must exclude duplicates
        if ($optDuplicate and my $digestMD5 = file_md5_hex($file)) {
          if (exists($listMD5{$digestMD5})) { # Duplicate, remove it
            delete($$refListFiles{$file});
            if ($execute) { print $fhLog "$STR{'Duplicate'} $STR{'Removed'}: $file\n" if $logging; }
            else { # For preview, mark this file as removed-duplicate
              if ($optCopyTree and $dir) { # Duplicate tree structure
                my $dstPath = $file =~ s/\Q$dir//r;
                $dstPath = $dstFolder . $dstPath;
                $resListFiles{$dstPath} = 3;
              } else {                     # Files only
                my $filename = (split(/\\/, $file))[-1];
                my $dstPath  = $dstFolder . "\\" . $filename;
                $resListFiles{$dstPath} = 3;
              }
            }
            next;
          } else { $listMD5{$digestMD5} = 1; }
        }
        # Calculate size
        $totalSize += (stat($file))[7];
        # Set destination path
        if ($optCopyTree and $dir) {              # Duplicate tree structure
          my $dstPath = $file =~ s/\Q$dir//r;
          $dstPath    = $dstFolder . $dstPath;
          $$refListFiles{$file} = $dstPath;
        } else {                                  # Files only
          my $filename = (split(/\\/, $file))[-1];
          my $dstPath  = $dstFolder . "\\" . $filename;
          $$refListFiles{$file} = $dstPath;
        }
        # Note source drive letter
        $srcDriveLetter = $1 if !$srcDriveLetter and $file =~ /^([a-zA-Z])\:/i;
      }
      $count++;
      if ($execute) {
        $win->lblPbCount->Text("$count / $nbrFiles");
        $win->pb->StepIt();
      } else { # Preview mode
        $winPb->lblCount->Text("$count / $nbrFiles");
        $winPb->pbWinPb->StepIt();
      }
    }
    # Check if there is enough space on destination volume
    # Not important if we move file on the same volume
    if ($dstFolder =~ /^([a-zA-Z])\:/i) {
      my $dstDriveLetter = $1;
      if (!$selFuncCopy or ($selFuncCopy and $dstDriveLetter ne $srcDriveLetter)) {
        $sameVolume = 0; # Destination is on another volume
        my $freeSpace = (Win32::DriveInfo::DriveSpace("$dstDriveLetter:"))[6];
        # Not enough space
        if ($totalSize and $totalSize >= $freeSpace) {
          # Show an error message and quit
          Win32::GUI::MessageBox($win, $STR{'errSpace'}, $STR{'Error'}, 0x40010);
          if ($execute and $logging) {
            print $fhLog "$STR{'Error'}: $STR{'errSpace'}\n";
            close($fhLog);
          }
          return;
        }
      }
      # Enough space, we continue
      $nbrFiles = scalar(keys %{$refListFiles});
      # Show progress
      if ($execute) {
        $win->pb->SetRange(0, $nbrFiles);
        $win->pb->SetPos(0);
        $win->pb->SetStep(1);
        $win->lblPbCount->Text("0 / $nbrFiles");
        $win->lblPbCurr->Text($STR{'Processing'}.'...');
      } else { # Preview mode
        $winPb->pbWinPb->SetRange(0, $nbrFiles);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        $winPb->lblCount->Text("0 / $nbrFiles");
        $winPb->lblPbCurr->Text($STR{'Processing'}.'...');
      }
      $count = 0;
      # Copy or move file
      foreach my $file (keys %{$refListFiles}) {
        # Copy file
        if (!$selFuncCopy) {
          if ($execute) {
            $win->lblPbCurr->Text($STR{'Copy'}.': '.$file.'...');
            if (fcopy($file, $$refListFiles{$file})) {
              $nbrCopyMove++;
              print $fhLog "$STR{'Copied'} $file -> $$refListFiles{$file}\n" if $logging;
            } else {
              $nbrError++;
              print $fhLog "$STR{'Error'} $STR{'Copying'} $file\n" if $logging;
            }
          } else { # Preview mode
            $winPb->lblPbCurr->Text($STR{'Copy'}.': '.$file.'...');
            $resListFiles{$$refListFiles{$file}} = 1 if !-d $file;
          }
        # Move file
        } else {
          if ($execute) {
            $win->lblPbCurr->Text($STR{'Move'}.': '.$file.'...');
            if ($optCopyTree) {
              # Create destination directory if doesn't exist
              my @pathParts = split(/\\/, $$refListFiles{$file});
              pop(@pathParts);
              my $dstPath   = join("\\", @pathParts);
              if (-d $dstPath or (!-d $dstPath and File::Copy::Recursive::pathmk($dstPath))) {
                if ($sameVolume and rename($file, $$refListFiles{$file})) { # Rename if same volume
                  $nbrCopyMove++;
                  print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n" if $logging;
                } elsif (!$sameVolume and fmove($file, $$refListFiles{$file})) { # Use Move if different volume
                  $nbrCopyMove++;
                  print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n" if $logging;
                } elsif ($execute) {
                  $nbrError++;
                  print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n" if $logging;
                }
              } else {
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n"  if $logging;
              }
            } else {
              if ($sameVolume and rename($file, $$refListFiles{$file})) {
                $nbrCopyMove++;
                print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n" if $execute and $logging;
              } elsif (!$sameVolume and fmove($file, $$refListFiles{$file})) { # Use Move if different volume
                $nbrCopyMove++;
                print $fhLog "$STR{'Moved'} $file -> $$refListFiles{$file}\n" if $logging;
              } elsif ($execute) {
                $nbrError++;
                print $fhLog "$STR{'Error'} $STR{'Moving'} $file\n" if $logging;
              }
            }
          } else { # Preview mode
            $winPb->lblPbCurr->Text($STR{'Move'}.': '.$file.'...');
            $resListFiles{$$refListFiles{$file}} = 1  if !-d $file;
          }
        }
        $count++;
        if ($execute) {
          $win->lblPbCount->Text("$count / $nbrFiles");
          $win->pb->StepIt();
        } else { # Preview mode
          $winPb->lblCount->Text("$count / $nbrFiles");
          $winPb->pbWinPb->StepIt();
        }
      }
      # Create empty folders if we duplicate tree structure
      if ($optCopyTree) {
        foreach my $subfolder (sort keys %listSubFolders) {
          if ($execute and !-d $subfolder) { # Folder doesn't exist, create it
            if (File::Copy::Recursive::pathmk($subfolder)) { $nbrCopyMove++; }
            else {
              $nbrError++;
              print $fhLog "$STR{'Error'} $STR{'Creating'} $subfolder\n" if $logging;
            }
          }
        }
      }
      # Delete moved dir (if empty)
      foreach my $movedDir (reverse sort keys %movedDirs) { rmdir($movedDir); }
    }
    if ($execute) {
      # Open destination folder
      if ($win->chOpenDstDir->Checked() and -d $dstFolder) {
        # Open Window Explorer
        Win32::Process::Create(my $ProcessObj                 ,
                               "$ENV{'WINDIR'}\\explorer.exe" ,
                               "explorer $dstFolder"          ,
                               0                              ,
                               NORMAL_PRIORITY_CLASS          ,
                               ".");
      }
      # Final popup
      my $endMsg  = "$STR{'Renaming'} $STR{'Finished'}!\n";
      if (!$selFuncCopy) { $endMsg .= "$nbrCopyMove $STR{'Copied2'}\n"; }
      else               { $endMsg .= "$nbrCopyMove $STR{'Moved2'}\n";  }
      $endMsg    .= "$nbrError $STR{'EndErrors'}\n";
      if ($logging) {
        close($fhLog);
        if ($nbrCopyMove or $nbrError) { # If copied/moved files or errors, open the log ?
          $endMsg .= "\n$STR{'OpenLog'} ?";
          my $answer = Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40024);
          $win->ShellExecute('open', $logFile,'','',1) if $answer == 6; # Open the log
        } else { Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040); }
      } else { Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040); }
    } else { return(\%resListFiles, \%listSubFolders); } # Preview
  }

}  #--- End copyMove

#--------------------------#
sub renameFiles
#--------------------------#
{
  # Local variables
  my $refListFiles = shift;
  my $execute      = shift; # If 0, preview mode
  my $dirReport    = $win->tfReportDir->Text();
  my $logging      = 0;
  my $nbrError     = 0;
  my $logFile;
  my $fhLog;
  # Enable logging ?
  if ($winConfig->chEnableLogging->Checked()) {
    $logging = 1;
    if ($winConfig->rbLoggingDir->Checked() and -d $winConfig->tfLoggingDir->Text()) {
      $logFile = $winConfig->tfLoggingDir->Text();
    } else { $logFile = $USERDIR; }
    $logFile .= "\\XL-FileTools.log";
    if (open($fhLog, '>', $logFile)) { flock($fhLog, 2); $logging = 1; }
  }
  if ($dirReport) {
    # Local variales
    my $nbrFiles   = scalar(keys %{$refListFiles});
    my $dir        = $win->tfInput->Text();
    my $nbrRenamed = 0;
    my $refResListFiles;
    my $refListSubFolders;
    # Show progress
    $win->ChangeCursor($HOURGLASS);
    if ($execute) { $win->lblPbCurr->Text($STR{'PreProcessing'}.'...');   }
    else          { $winPb->lblPbCurr->Text($STR{'PreProcessing'}.'...'); } # Preview mode
    # Call the right rename function
    if (!$win->TabFuncRen->SelectedItem()) {
      ($nbrRenamed, $refResListFiles, $nbrError)                     = &renameByHash(   $refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    } elsif ($win->TabFuncRen->SelectedItem() == 1) {
      ($nbrRenamed, $refResListFiles, $nbrError)                     = &renameBySort(   $refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    } else {
      ($nbrRenamed, $refResListFiles, $refListSubFolders, $nbrError) = &renameReplaceBy($refListFiles, $nbrFiles, $fhLog, $execute, $logging);
    }
    if ($execute) {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $win->lblPbCurr->Text('');
      $win->lblPbCurr->Hide();
      $win->lblPbCount->Text('');
      $win->lblPbCount->Hide();
      $win->pb->SetPos(0);
      $win->pb->Hide();
      $win->btnStop->Hide();
      $win->btnProcess->Show();
      # Final popup
      my $endMsg  = "$STR{'Renaming'} $STR{'Finished'}!\n";
      $endMsg    .= "$nbrRenamed $STR{'Renamed2'}\n";
      $endMsg    .= "$nbrError $STR{'EndErrors'}\n";
      if ($logging) {
        close($fhLog);
        if ($nbrRenamed or $nbrError) { # If renamed files or errors, open the log ?
          $endMsg .= "\n$STR{'OpenLog'}?";
          my $answer = Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40024);
          $win->ShellExecute('open', $logFile,'','',1) if $answer == 6; # Open the log
        } else { Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040); }
      } else { Win32::GUI::MessageBox($win, $endMsg, "XL-FileTools $VERSION", 0x40040); }
    } else { return($refResListFiles, $refListSubFolders); } # Preview mode
  }

}  #--- End renameFiles

#--------------------------#
sub renameByHash
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $hashAlgo    = $win->cbRenByHash->SelectedItem();
  my $excludeDupl = $win->chRenByHashNoDupl->Checked();
  my $removeExt   = $win->chRenByHashRemExt->Checked();
  my $nbrRenamed  = 0;
  my $count       = 0;
  my $nbrError    = 0;
  my %resListFiles;
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  # My current message
  my $hashCurMsg;
  if    (!$hashAlgo    ) { $hashCurMsg = $STR{'HashingMD5'};    }
  elsif ($hashAlgo == 1) { $hashCurMsg = $STR{'HashingSHA1'};   }
  elsif ($hashAlgo == 2) { $hashCurMsg = $STR{'HashingSHA256'}; }
  else                   { $hashCurMsg = $STR{'HashingSHA512'}; }
  # Browse list of files, calculate hash and rename
  foreach my $file (keys %{$refListFiles}) {
    my $duplRenamed = 0;
    my $duplRemoved = 0;
    # It's a directory, remove it
    if (-d $file) { delete($$refListFiles{$file}); }
    else {
      if ($execute) { $win->lblPbCurr->Text("$hashCurMsg: $file...");   }
      else          { $winPb->lblPbCurr->Text("$hashCurMsg: $file..."); }
      # Split path and filename
      my $extension;
      my @pathParts = split(/\\/, $file);
      my $filename  = pop(@pathParts);
      my $dstPath   = join("\\", @pathParts);
      $extension    = (split(/\./, $filename))[-1] if $filename and $filename =~ /\./;
      # Calculate hash
      my $hashFilename;
      if    (!$hashAlgo     and $hashFilename = file_md5_hex($file)                                 ) { }
      elsif ($hashAlgo == 1 and $hashFilename = Digest::SHA->new(1)->addfile($file,"b")->hexdigest  ) { }
      elsif ($hashAlgo == 2 and $hashFilename = Digest::SHA->new(256)->addfile($file,"b")->hexdigest) { }
      elsif ($hashAlgo == 3 and $hashFilename = Digest::SHA->new(512)->addfile($file,"b")->hexdigest) { }
      # Rename file
      if ($hashFilename) {
        # Lowercases or uppercases?
        if ($winConfig->chHashLowercase->Checked()) { $hashFilename = lc($hashFilename); }
        else                                        { $hashFilename = uc($hashFilename); }
        my $dstFilename = "$dstPath\\$hashFilename";
        $dstFilename   .= '.'.$extension if $extension and !$removeExt; # Add extension or not
        # File already exists
        if (-e $dstFilename or exists($resListFiles{$dstFilename})) {
          my $i;
          while (-e $dstFilename or exists($resListFiles{$dstFilename})) {
            $i++;
            $dstFilename = "$dstPath\\$hashFilename".'_'.$i;
            $dstFilename .= '.'.$extension if $extension and !$removeExt; # Add extension or not
          }
          if (!$excludeDupl) { $duplRenamed = 1; } # Rename duplicate
          else               { $duplRemoved = 1; } # Remove duplicate
        }
        # Rename
        if ($execute) {
          if (!$duplRemoved and rename($file, $dstFilename)) {
            $nbrRenamed++;
            print $fhLog "$STR{'Renamed'} $file -> $dstFilename\n" if $logging;
          } elsif ($duplRemoved) {
            print $fhLog "$STR{'Duplicate'} $STR{'Removed'} $file\n" if $logging;
          } else {
            $nbrError++;
            print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n" if $logging;
          }
        }
        elsif ($duplRenamed) { $resListFiles{$dstFilename} = 4; }
        elsif ($duplRemoved) { $resListFiles{$dstFilename} = 3; }
        else                 { $resListFiles{$dstFilename} = 1; }
      } elsif ($execute) { # problem hashing
        $nbrError++;
        print $fhLog "$STR{'Error'} $hashCurMsg $file\n" if $logging;
      }
    }
    $count++;
    if ($execute) {
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  return($nbrRenamed, \%resListFiles, $nbrError);

}  #--- End renameByHash

#--------------------------#
sub renameBySort
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $removeExt   = $win->chBySortRenRemExt->Checked();
  my $incrValType = $win->cbBySortRenIncrValType->GetCurSel();
  my $length      = $win->tfBySortRenLength->Text();
  my $initVal     = $win->tfBySortRenInitVal->Text();
  my $stepVal     = $win->tfBySortRenStepVal->Text();
  my $prefix      = $win->tfBySortRenPrefix->Text();
  my $suffix      = $win->tfBySortRenSuffix->Text();
  my $nbrRenamed  = 0;
  my $count       = 0;
  my $nbrError    = 0;
  my %resListFiles;
  # Sort list of files
  if ($execute) { $win->lblPbCurr->Text($STR{'SortFiles'}.'...');   }
  else          { $winPb->lblPbCurr->Text($STR{'SortFiles'}.'...'); }
  my $sortType = $win->cbRenBySortType->GetCurSel();
  my $order    = $win->rbRenBySortAsc->Checked();
  # Divide by subfolders
  my %subFolders;
  foreach my $file (keys %{$refListFiles}) {
    if (!-d $file) {
      my @pathParts = split(/\\/, $file);
      pop(@pathParts);
      my $subFolder = join("\\", @pathParts);
      push(@{$subFolders{$subFolder}}, $file);
    } else { delete($$refListFiles{$file}); } # Remove folder from the list
  }
  # Sort by folder
  foreach my $subFolder (keys %subFolders) {
    my @sortedFiles;
    if      (!$sortType     and  $order) { @sortedFiles = sort {uc($a) cmp uc($b)} @{$subFolders{$subFolder}};               } # Ascending
    elsif   (!$sortType     and !$order) { @sortedFiles = sort {uc($b) cmp uc($a)} @{$subFolders{$subFolder}};               } # Descending
    # File Size
    elsif   ($sortType == 1 and  $order) { @sortedFiles = sort {(stat($a))[7] <=> (stat($b))[7]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 1 and !$order) { @sortedFiles = sort {(stat($b))[7] <=> (stat($a))[7]} @{$subFolders{$subFolder}}; } # Descending
    # Last accessed
    elsif   ($sortType == 2 and  $order) { @sortedFiles = sort {(stat($a))[8] <=> (stat($b))[8]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 2 and !$order) { @sortedFiles = sort {(stat($b))[8] <=> (stat($a))[8]} @{$subFolders{$subFolder}}; } # Descending
    # Last modified
    elsif   ($sortType == 3 and  $order) { @sortedFiles = sort {(stat($a))[9] <=> (stat($b))[9]} @{$subFolders{$subFolder}}; } # Ascending
    elsif   ($sortType == 3 and !$order) { @sortedFiles = sort {(stat($b))[9] <=> (stat($a))[9]} @{$subFolders{$subFolder}}; } # Descending
    my $i = &convertInitVal($incrValType, $initVal);
    # Store position of each file
    foreach my $file (@sortedFiles) { $$refListFiles{$file} = $i; $i++; }
  }
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  # Rename file
  if ($execute) { $win->lblPbCurr->Text($STR{'RenameFiles'}.'...');   }
  else          { $winPb->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  foreach my $file (sort {$$refListFiles{$a} <=> $$refListFiles{$b}} keys %{$refListFiles}) {
    my $renamed = 0;
    # Set the destination filename
    my $posVal = $$refListFiles{$file};
    my $dstFilename;
    my $extension;
    $dstFilename   .= $prefix if $prefix;
    my $formatedVal = &formatVal($incrValType, $posVal, $length);
    $dstFilename   .= $formatedVal;            
    $dstFilename   .= $suffix if $suffix;
    my @pathParts   = split(/\\/, $file);
    my $srcFilename = pop(@pathParts);
    $extension      = (split(/\./, $srcFilename))[-1] if $srcFilename =~ /\./;
    my $dstFile     = join("\\", @pathParts);
    $dstFile       .= "\\$dstFilename";
    $dstFile       .= "\.$extension" if $extension and !$removeExt; # Add extension or not
    # File already exists
    if (-e $dstFile or exists($resListFiles{$dstFile})) {
      my $i;
      while (-e $dstFile or exists($resListFiles{$dstFile})) {
        $i++;
        $dstFile        = join("\\", @pathParts);
        $dstFile       .= "\\$dstFilename".'_'.$i;
        $dstFile .= '.'.$extension if $extension and !$removeExt; # Add extension or not
      }
      $renamed = 1;
    }
    # Rename
    if ($execute) {
      if (rename($file, $dstFile)) {
        $nbrRenamed++;
        print $fhLog "$STR{'Renamed'} $file -> $dstFile\n" if $logging;
      } else {
        $nbrError++;
        print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n" if $logging;
      }
    }
    elsif ($renamed) { $resListFiles{$dstFile} = 4; } # Renamed file existed, renamed
    else             { $resListFiles{$dstFile} = 1; }
    $count++;
    if ($execute) { 
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  return($nbrRenamed, \%resListFiles, $nbrError);

}  #--- End renameBySort

#--------------------------#
sub renameReplaceBy
#--------------------------#
{
  # Local variables
  my ($refListFiles, $nbrFiles, $fhLog, $execute, $logging) = @_;
  my $srcExpr       = $win->tfRenReplace->Text();
  my $srcExprCase   = $win->chRenReplaceCase->Checked();
  my $srcExprRegex  = $win->chRenReplaceRegex->Checked();
  my $srcExprFolder = $win->chRenReplaceFolder->Checked();
  my $dstExpr       = $win->tfRenReplaceBy->Text();
  my $dstExprEval   = $win->chRenReplaceByEval->Checked();
  my $nbrRenamed    = 0;
  my $count         = 0;
  my $nbrError      = 0;
  my %renamedDirs;
  my %resListFiles;
  my %listSubFolders;
  # Escape replace expresion if not regex
  if    (!$srcExprRegex)                      { $srcExpr = quotemeta($srcExpr);  }
  elsif ($dstExpr =~ /\$1/ and !$dstExprEval) { $dstExpr = '"' . $dstExpr . '"'; }
  # Base dir
  my $dir = $win->tfInput->Text();
  my $inputIsNotDir = 0;
  if (!-d $dir) { # Input is not a dir
    my $filesStr = $dir;
    if ($filesStr) {
      $inputIsNotDir = 1;
      # Multiple files
      if ($filesStr =~ /" "/) {
        $dir = (split(/" "/, $filesStr))[0];
        $dir =~ s/\"//g;
      # Single file
      } else {
        my @pathParts = split(/\\/, $filesStr);
        pop(@pathParts);
        $dir = join("\\", @pathParts);
      }
    }
  }
  # Update progress
  $nbrFiles = scalar(keys %{$refListFiles});
  if ($execute) {
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCount->Text("0 / $nbrFiles");
  } else { # Preview mode
    $winPb->pbWinPb->SetRange(0, $nbrFiles);
    $winPb->pbWinPb->SetPos(0);
    $winPb->pbWinPb->SetStep(1);
    $winPb->lblCount->Text("0 / $nbrFiles");
  }
  # Browse list of files and rename file that contains expression
  if ($execute) { $win->lblPbCurr->Text($STR{'RenameFiles'}.'...');   }
  else          { $winPb->lblPbCurr->Text($STR{'RenameFiles'}.'...'); }
  foreach my $file (sort {length($a) <=> length($b)} keys %{$refListFiles}) {
    my $relPath;
    my $dstFile;
    my $isDir;
    my $invalidDir;
    my $noMatch;
    my $renamed = 0;
    # Remove basedir from filename if input is dir
    $relPath = $file =~ s/\Q$dir//r if $dir;
    # If input is not dir, only filename can be renamed
    $relPath = (split(/\\/, $file))[-1] if $inputIsNotDir;
    # If $file is a subfolder
    if (-d $file) {
      $isDir = 1;
      # If $file is basedir or if we only rename filenames, step to next file
      if (!$srcExprFolder or $relPath eq "\\") {
        $count++;
        if ($execute) {
          $win->lblPbCount->Text("$count / $nbrFiles");
          $win->pb->StepIt();
        } else { # Preview mode
          $winPb->lblCount->Text("$count / $nbrFiles");
          $winPb->pbWinPb->StepIt();
        }
        next;
      }
    }
    # If source file contains expression
    if ($relPath and ($srcExprCase and $relPath =~ /$srcExpr/) or (!$srcExprCase and $relPath =~ /$srcExpr/i)) {
      my @pathParts  = split(/\\/, $relPath);
      my $filename;
      $filename = pop(@pathParts) if !$isDir;
      my $relDstPath = join("\\", @pathParts);
      # Expression match a directory
      if ($srcExprFolder and $relDstPath and (($srcExprCase and $relDstPath =~ /$srcExpr/) or (!$srcExprCase and $relDstPath =~ /$srcExpr/i))) {
        my $relSrcPath = join("\\", @pathParts);
        # Create the destination dir
        if ($srcExprCase) {
          if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
            $relDstPath =~ s/$srcExpr/$dstExpr/eeg;
          } else { $relDstPath =~ s/$srcExpr/$dstExpr/g; } # Keyword
        } else {
          if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
            $relDstPath =~ s/$srcExpr/$dstExpr/eegi;
          } else { $relDstPath =~ s/$srcExpr/$dstExpr/gi; } # Keyword
        }
        $invalidDir = 1 if $@; # Error with replace
        # Valid destination folder name
        if (!$invalidDir and $relDstPath =~ /\\([^\\]+)$/ and &validName($1)) {
          my $newDir = $dir . $relDstPath;
          if ($execute) {
            if    (!File::Copy::Recursive::pathmk($newDir)) { $relPath = ''; } # Error renaming dir
            elsif (!exists($renamedDirs{$relSrcPath})     ) { $renamedDirs{$relSrcPath} = 1; }
          }
        } else { $invalidDir = 1; }
      # Expression match filename
      } elsif (!$srcExprFolder and !$isDir) {
        if ($filename and ($srcExprCase and $filename =~ /$srcExpr/) or (!$srcExprCase and $filename =~ /$srcExpr/i)) {
          # Rename file
          if ($srcExprCase) {
            if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
              $filename =~ s/$srcExpr/$dstExpr/eeg;
            } else { $filename =~ s/$srcExpr/$dstExpr/g; } # Keyword
          } else {
            if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
              $filename =~ s/$srcExpr/$dstExpr/eegi;
            } else { $filename =~ s/$srcExpr/$dstExpr/gi; } # Keyword
          }
          $filename = '' if $@; # Error with replace
        }
        # Valid destination filename
        $filename = '' if !&validName($filename);
      }
      # No match
      else { $noMatch = 1; }
      # Set the new filename
      if (!$noMatch) {
        if    ($relDstPath and $filename) { $dstFile = $dir . $relDstPath . "\\" . $filename; }
        elsif ($filename)                 { $dstFile = $dir               . "\\" . $filename; }
        elsif ($isDir) { # Subfolder
          $dstFile = $dir . $relDstPath;
          $listSubFolders{$dstFile} = 1;
          # If directory has the same name, but case are different, rename
          # Otherwise, remove from list
          $dstFile = '' if $file ne $dstFile and uc($file) ne uc($dstFile);
        }
      }
      # Rename the file
      if ($dstFile) {
        # File or directory already exists
        if (-e $dstFile or exists($resListFiles{$dstFile})) {
          my @filenameParts = split(/\./, $filename);
          my $extension;
          my $dstFilename;
          $extension = pop(@filenameParts) if scalar(@filenameParts) > 1;
          $dstFilename = join('.', @filenameParts);
          my $i;
          while (-e $dstFile or exists($resListFiles{$dstFile})) {
            $i++;
            $dstFile = $dir . "$relDstPath\\$dstFilename".'_'.$i;
            $dstFile .= '.'.$extension if $extension; # Add extension
          }
          $renamed = 1;
        }
        if ($execute) {
          if (rename($file, $dstFile)) {
            $nbrRenamed++;
            print $fhLog "$STR{'Renamed'} $file -> $dstFile\n" if $logging;
          } else {
            $nbrError++;
            print $fhLog "$STR{'Error'} $STR{'lblFunctions3T'} $file\n" if $logging;
          }
        } else {
          # Illegal characters
          if ($filename and $filename =~ /[\<\>\:\"\/\\\|\?\*]/ or $invalidDir) { $resListFiles{$dstFile} = 2; }
          elsif ($renamed) { $resListFiles{$dstFile} = 4; } # Renamed file existed, renamed
          else             { $resListFiles{$dstFile} = 1; }
        }
      }
    }
    $count++;
    if ($execute) { 
      $win->lblPbCount->Text("$count / $nbrFiles");
      $win->pb->StepIt();
    } else { # Preview mode
      $winPb->lblCount->Text("$count / $nbrFiles");
      $winPb->pbWinPb->StepIt();
    }
  }
  # Delete renamed dir (if empty)
  foreach my $renamedDir (reverse sort keys %renamedDirs) {
    my $renamedDirPath = $dir . $renamedDir;
    rmdir($renamedDirPath);
  }
  return($nbrRenamed, \%resListFiles, \%listSubFolders, $nbrError);

}  #--- End renameReplaceBy

#--------------------------#
sub lblNotReady_Click { &isProcessReady(1); }
#--------------------------#

#--------------------------#
sub isProcessReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  my $input = $win->tfInput->Text();
  # Check Input
  if (!$win->tfInput->Text()) {
    $nextStep = $STR{'selectInput'};
    $win->btnPreview->Disable();
  } else {
    my $dir;
    if ($input =~ /" "/) { $input =~ s/"//g; $dir = (split(/ /, $input))[0]; }
    else { $dir = $input; }
    if (-d $dir or -e $dir) { $win->btnPreview->Enable(); }
    else {
      $nextStep = $STR{'selectInput'};
      $win->btnPreview->Disable();
    }
  }
  # Is Function Ready?
  $nextStep = &isFunctionsReady() if !$nextStep;
  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnProcess->Disable();
    $win->lblNotReady->Show();
    Win32::GUI::MessageBox($win, "$STR{'notReady'}?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040) if $confirm;
  } else {
    $win->btnProcess->Enable();
    $win->lblNotReady->Hide();
  }

}  #--- End isProcessReady

#--------------------------#
sub isFunctionsReady
#--------------------------#
{
  # Lists
  if (!$win->TabFunctions->SelectedItem()   and !$win->TabFuncLists->SelectedItem()   and !$win->chListFilesOptFP->Checked()    and
      !$win->chListFilesOptP->Checked()     and !$win->chListFilesOptFN->Checked()    and !$win->chListFilesOptFE->Checked()    and
      !$win->chListFilesOptCount->Checked() and !$win->chListFilesOptLM->Checked()    and !$win->chListFilesOptHV->Checked()    and
      !$win->chListFilesOptFD->Checked()    and !$win->chListFilesOptNbrF->Checked()  and !$win->chListFilesOptNbrL->Checked()  and
      !$win->chListFilesOptNbrP->Checked()) {
    $win->btnPreview->Enable();
    return($STR{'setListFilesOpt'});
  } elsif (!$win->TabFunctions->SelectedItem() and !$win->TabFuncLists->SelectedItem() and !-d $win->tfReportDir->Text()) {
    $win->btnPreview->Enable();
    return($STR{'selectReportDir'});
  }
  # No preview for List extension
  if (!$win->TabFunctions->SelectedItem() and $win->TabFuncLists->SelectedItem()) { $win->btnPreview->Disable(); }
  else                                                                            { $win->btnPreview->Enable(); }
  # Copy or move
  return($STR{'selectDstDir'}) if $win->TabFunctions->SelectedItem() == 1 and !$win->tfDestinationDir->Text();
  # Rename By Sort
  if ($win->TabFunctions->SelectedItem() == 2 and $win->TabFuncRen->SelectedItem() == 1) {
    my $length      = $win->tfBySortRenLength->Text();
    my $initVal     = $win->tfBySortRenInitVal->Text();
    my $stepVal     = $win->tfBySortRenStepVal->Text();
    return($STR{'setRenReplaceBy'}) if !$length and !$initVal and !$stepVal;
  }
  # Rename Replace
  if ($win->TabFunctions->SelectedItem() == 2 and $win->TabFuncRen->SelectedItem() == 2 and !$win->tfRenReplace->Text()) {
    return($STR{'setRenBySortOpt'});
  } elsif ($win->TabFunctions->SelectedItem() == 2 and $win->TabFuncRen->SelectedItem() == 2 and
           ($win->chRenReplaceRegex->Checked() or $win->chRenReplaceByEval->Checked())) { # Valid regex
    # Regex is valid ?
    if ($win->chRenReplaceRegex->Checked()) {
      if ($win->tfRenReplace->Text()) {
        my ($status, $msg) = &validRegex($win->tfRenReplace->Text());
        if ($status and $status == 1) {
          my $errorMsg = $STR{'errRegex'} . ' ' . $STR{'errRegexReplace'} . ":\n\n";
          $errorMsg .= $msg if $msg;
          return($errorMsg);
        }
      }
      # Replacement expression is valid ?
      if ($win->tfRenReplaceBy->Text()) {
        my ($status, $msg) = &validReplacement;
        if ($status and $status == 1) {
          my $errorMsg = $STR{'errBy'} . ' ' . $STR{'errRegexReplaceBy'} . ":\n\n";
          $errorMsg .= $msg if $msg;
          return($errorMsg);
        }
      }
    }
  }
  
}  #--- End isFunctionsReady
  
#--------------------------#
sub validRegex
#--------------------------#
{
  # Local variables
  my $regex = shift;
  if ($regex) {
    eval { if ('test' =~ /$regex/) { } };
    if ($@) {
      my $errRegex = (split(/ at /,$@))[0];
      return(1, $errRegex);
    } else { # Valid but senseless regex
      if ($regex =~ /^\||\|\||(?:[^\\]\|$)/ or $regex =~ /^\(\.\*\)$/) { return(2, undef); }
      else { return(0, undef); }
    }
  }
  
}  #--- End validRegex

#--------------------------#
sub validName
#--------------------------#
{
  # Local variables
  my $name = shift;
  # Contains illegal characters (in a window filename or folder) ?
  if ($name =~ /[\<\>\:\"\/\\\|\?\*]/) { return(0); }
  else                                 { return(1); }
  
}  #--- End validName

#--------------------------#
sub validReplacement
#--------------------------#
{
  # Local variables
  my $expr = $win->tfRenReplaceBy->Text();
  my $test = 'test';
  $expr    = '"' . $expr . '"' if $expr =~ /\$1/ and !$win->chRenReplaceByEval->Checked();     # Capture with Eval not checked
  if ($win->chRenReplaceByEval->Checked() or $expr =~ /\$1/)   { $test =~ s/(.+)/$expr/eegi; } # Regex
  else                                                         { $test =~ s/(.+)/$expr/gi;   } # Keyword
  if ($@) { # Error
    my $err = (split(/ at /,$@))[0];
    return(1, $err);
  } else {
    return(2, undef) if $expr =~ /[\<\>\:\"\/\\\|\?\*]/; # Warning for illegal characters
    return(0, undef); # Replacement ok
  }  
  
}  #--- End validReplacement

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  $winConfig->Center($win);
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if (!$winConfig->configTab->SelectedItem()) {
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->btnOpenUserDir->Show();
    $winConfig->lblFuncShadowT->Show();
    $winConfig->lblFuncT->Show();
    $winConfig->lblLocalTZ->Show();
    $winConfig->cbLocalTZ->Show();
    $winConfig->chFormatFileSize->Show();
    $winConfig->chHashLowercase->Show();
    # Hide logging tab
    $winConfig->chEnableLogging->Hide();
    $winConfig->btnOpenLog->Hide();
    $winConfig->rbUseDefaultDir->Hide();
    $winConfig->rbLoggingDir->Hide();
    $winConfig->tfLoggingDir->Hide();
    $winConfig->btnLoggingDir->Hide();
    $winConfig->chUseDestDirCM->Hide();
  # Show Logging tab
  } else {
    $winConfig->chEnableLogging->Show();
    $winConfig->btnOpenLog->Show();
    my $logFile;
    my $loggingDir = $winConfig->tfLoggingDir->Text();
    if ($winConfig->rbLoggingDir->Checked() and $loggingDir and -d $loggingDir) {
      $logFile = $loggingDir;
    } else { $logFile = $USERDIR; }
    $logFile .= '\XL-FileTools.log';
    if ($logFile and -T $logFile) { $winConfig->btnOpenLog->Enable();  }
    else                          { $winConfig->btnOpenLog->Disable(); }
    # Show options
    if ($winConfig->chEnableLogging->Checked()) {
      # Enable options
      $winConfig->rbUseDefaultDir->Show();
      $winConfig->rbLoggingDir->Show();
      $winConfig->chUseDestDirCM->Show();
      $winConfig->tfLoggingDir->Show();
      $winConfig->btnLoggingDir->Show();
      if ($winConfig->rbUseDefaultDir->Checked()) {
        $winConfig->tfLoggingDir->Disable();
        $winConfig->btnLoggingDir->Disable();
        $winConfig->chUseDestDirCM->Disable();
      } else {
        $winConfig->tfLoggingDir->Enable();
        $winConfig->btnLoggingDir->Enable();
        $winConfig->chUseDestDirCM->Enable();
      }
    } else {
      # Disable options
      $winConfig->rbUseDefaultDir->Hide();
      $winConfig->rbLoggingDir->Hide();
      $winConfig->tfLoggingDir->Hide();
      $winConfig->btnLoggingDir->Hide();
      $winConfig->chUseDestDirCM->Hide();
    }
    # Hide general tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnOpenUserDir->Hide();
    $winConfig->lblFuncShadowT->Hide();
    $winConfig->lblFuncT->Hide();
    $winConfig->lblLocalTZ->Hide();
    $winConfig->cbLocalTZ->Hide();
    $winConfig->chFormatFileSize->Hide();
    $winConfig->chHashLowercase->Hide();
  }

}  #--- End configTab_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnOpenUserDir_Click
#--------------------------#
{
  # Open Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $USERDIR", 0, NORMAL_PRIORITY_CLASS, ".") if -d $USERDIR;

}  #--- End btnOpenUserDir_Click

#--------------------------#
sub btnCheckUpdate_Click { &updateTool(1); }
#--------------------------#

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub updateTool
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent("XL-FileTools Update $VERSION");
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    $currVer = $1 if $content =~ /([\d\.]+)/i;
    # No update available
    if ($currVer le $VERSION) {
      Win32::GUI::MessageBox($winConfig, $STR{'update1'}, $STR{'update2'}, 0x40040) if $confirm; # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'Version'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open XL-FileTools page with default browser
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
        Win32::GUI::MessageBox($winConfig, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-FileTools",0x40010);
      }
    }
  }
  # Error 
  else { Win32::GUI::MessageBox($winConfig, $STR{'errorConnection'}.': '.$res->status_line, "$STR{'update3'} XL-FileTools",0x40010) if $confirm; }

}  #--- End updateTool

#--------------------------#
sub cbLocalTZ_Change
#--------------------------#
{
  # Remember
  $CONFIG{'LOCAL_TIMEZONE'} = $winConfig->cbLocalTZ->GetCurSel();
  &saveConfig(\%CONFIG);
  
}  #--- End cbLocalTZ_Change

#--------------------------#
sub chFormatFileSize_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chFormatFileSize->Checked()) {
    $CONFIG{'FORMAT_FILESIZE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'FORMAT_FILESIZE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chFormatFileSize_Click

#--------------------------#
sub chHashLowercase_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chHashLowercase->Checked()) {
    $CONFIG{'HASH_LOWERCASE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'HASH_LOWERCASE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chHashLowercase_Click

#--------------------------#
sub chEnableLogging_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chEnableLogging->Checked()) {
    $CONFIG{'ENABLE_LOGGING'} = 1;
    &saveConfig(\%CONFIG);
    # Enable options
    $winConfig->rbUseDefaultDir->Show();
    $winConfig->rbLoggingDir->Show();
    $winConfig->tfLoggingDir->Show();
    $winConfig->btnLoggingDir->Show();
    $winConfig->chUseDestDirCM->Show();
  } else {
    $CONFIG{'ENABLE_LOGGING'} = 0;
    &saveConfig(\%CONFIG);
    # Disable options
    $winConfig->rbUseDefaultDir->Hide();
    $winConfig->rbLoggingDir->Hide();
    $winConfig->tfLoggingDir->Hide();
    $winConfig->btnLoggingDir->Hide();
    $winConfig->chUseDestDirCM->Hide();
  }

}  #--- End chEnableLogging_Click

#--------------------------#
sub btnOpenLog_Click
#--------------------------#
{
  # Local variables
  my $logFile;
  my $loggingDir = $winConfig->tfLoggingDir->Text();
  if ($winConfig->rbLoggingDir->Checked() and $loggingDir and -d $loggingDir) {
    $logFile = $loggingDir;
  } else { $logFile = $USERDIR; }
  $logFile .= '\XL-FileTools.log';
  # Open file with default program
  if ($logFile and -T $logFile) {
    $win->ShellExecute('open', $logFile,'','',1) or
    Win32::GUI::MessageBox($win, "$STR{'errorOpening'}: ".Win32::FormatMessage(Win32::GetLastError()), $STR{'error'}, 0x40010);
  }
  return(1);

}  #--- End btnOpenLog_Click

#--------------------------#
sub rbUseDefaultDir_Click
#--------------------------#
{
  # Save the choice
  $CONFIG{'LOG_USE_DEFAULT_DIR'} = 1;
  &saveConfig(\%CONFIG);
  $winConfig->tfLoggingDir->Disable();
  $winConfig->btnLoggingDir->Disable();
  $winConfig->chUseDestDirCM->Disable();

}  #--- End rbUseDefaultDir_Click

#--------------------------#
sub rbLoggingDir_Click
#--------------------------#
{
  # Save the choice
  $CONFIG{'LOG_USE_DEFAULT_DIR'} = 0;
  &saveConfig(\%CONFIG);
  $winConfig->tfLoggingDir->Enable();
  $winConfig->btnLoggingDir->Enable();
  $winConfig->chUseDestDirCM->Enable();

}  #--- End rbLoggingDir_Click

#--------------------------#
sub tfLoggingDir_Change
#--------------------------#
{
  # Local variables
  my $loggingDir = $winConfig->tfLoggingDir->Text();
  # Remember
  if ($loggingDir and -d $loggingDir) {
    $CONFIG{'LOGGING_DIR'} = $loggingDir;
    &saveConfig(\%CONFIG);
  } else { # Invalid file or no file
    delete($CONFIG{'LOGGING_DIR'});
    &saveConfig(\%CONFIG);
    if ($loggingDir) {
      $win->tfLoggingDir->Text('');
      Win32::GUI::MessageBox($winConfig, $STR{'errNoValidFile'}, $STR{'Error'}, 0x40010) if $START;
    }
  }

}  #--- End tfLoggingDir_Change

#--------------------------#
sub btnLoggingDir_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfLoggingDir->Text();
  my $dir;
  # Show BrowseForFolder dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder( -owner => $winConfig, -title => $STR{'selDir'}.':', -folderonly => 1, -newui => 1, -directory => $lastDir);
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner => $winConfig, -title => $STR{'selDir'}.':', -folderonly => 1, -newui => 1);
  }
  # Selected folder
  if ($dir and -d $dir) {
    chop($dir) if $dir =~ /\\$/;
    $winConfig->tfLoggingDir->Text($dir);
  }
  return(1);
  
}  #--- End btnLoggingDir_Click

#--------------------------#
sub chUseDestDirCM_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chUseDestDirCM->Checked()) {
    $CONFIG{'LOG_USE_DST_DIR'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'LOG_USE_DST_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chUseDestDirCM_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  # Open XL-FileTools documentation page with default browser
  $win->ShellExecute('open', $URL_DOC,'','',1) or
  Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-FileTools",0x40010);

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                    ,
                                              -parent      => $win                          ,
                                              -text        => $STR{'About'}.' XL-FileTools' ,
                                              -pos         => [$winPosX, $winPosY]          ,
                                              -size        => [520, 170]                    ,
                                              -background  => [255, 255, 255]               ,
                                              -hasmaximize => 0                             ,
                                              -hasminimize => 1                             ,
                                              -helpbutton  => 0                             ,
                                              -resizable   => 0                             ,
                                              -dialogui    => 1                             , );
  $winAbout->SetIcon($winICO);
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'Version'}:\n$STR{'Website'}:\n$STR{'Author'}:\n$STR{'TranslatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10b                ,
                        -foreground  => [250, 195,  27]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'TranslatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2016-2018 Alain Rioux', );
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  # Open and load config values
  if (-e $refConfig) {
    open(CONFIG, $CONFIG_FILE);
    my @tab = <CONFIG>;
    close(CONFIG);
    foreach (@tab) {
      chomp($_);
      my ($key, $value) = split(/ = /, $_);
      $$refConfig{$key} = $value if $key;
    }
  } else { # Create one
    open(CONFIG, ">$CONFIG_FILE");
    close(CONFIG);
  }
  # General tab
  if (exists($$refConfig{'TOOL_AUTO_UPDATE'})) { $winConfig->chAutoUpdate->Checked($$refConfig{'TOOL_AUTO_UPDATE'});  }
  else                                         { $winConfig->chAutoUpdate->Checked(1);                                } # Default is checked
  if (exists($$refConfig{'LOCAL_TIMEZONE'}))   { $winConfig->cbLocalTZ->SetCurSel($$refConfig{'LOCAL_TIMEZONE'});     }
  else { # Try to find local timezone, if not found, set to America/New_York
    my $index = 0;
    my $localTZ;
    eval     { $localTZ = DateTime::TimeZone->new(name => 'local'); };
    if (!$@) { $index   = $winConfig->cbLocalTZ->FindStringExact($localTZ->{name}); }
		else     { $index   = 107; } # Default is America/New_York
    $winConfig->cbLocalTZ->SetCurSel($index);
    $$refConfig{'LOCAL_TIMEZONE'} = $index;
  }
  if (exists($$refConfig{'FORMAT_FILESIZE'}))  { $winConfig->chFormatFileSize->Checked($$refConfig{'FORMAT_FILESIZE'});   }
  else                                         { $winConfig->chFormatFileSize->Checked(1);                                } # Default is checked
  if (exists($$refConfig{'HASH_LOWERCASE'}))   { $winConfig->chHashLowercase->Checked($$refConfig{'HASH_LOWERCASE'});     }
  else                                         { $winConfig->chHashLowercase->Checked(1);                                 } # Default is checked
  # Logging
  if (exists($$refConfig{'ENABLE_LOGGING'}))   { $winConfig->chEnableLogging->Checked($$refConfig{'ENABLE_LOGGING'});     }
  else                                         { $winConfig->chEnableLogging->Checked(1);                                 } # Default is checked
  if (exists($$refConfig{'LOGGING_DIR'}) and -d $$refConfig{'LOGGING_DIR'}) { # Use defined logging dir
    $winConfig->tfLoggingDir->Text($$refConfig{'LOGGING_DIR'});
    $winConfig->rbLoggingDir->Checked(1);
    $winConfig->rbUseDefaultDir->Checked(0);
    $winConfig->tfLoggingDir->Enable();
    $winConfig->btnLoggingDir->Enable();
    $winConfig->chUseDestDirCM->Enable();
  } else {                                                                    # Use default dir
    $winConfig->rbUseDefaultDir->Checked(1);
    $winConfig->rbLoggingDir->Checked(0);
    $winConfig->tfLoggingDir->Disable();
    $winConfig->btnLoggingDir->Disable();
    $winConfig->chUseDestDirCM->Disable();
  }
  if (exists($$refConfig{'LOG_USE_DST_DIR'}))  { $winConfig->chUseDestDirCM->Checked($$refConfig{'LOG_USE_DST_DIR'}); }
  else                                         { $winConfig->chUseDestDirCM->Checked(0);                              } # Default is not checked
  # Folder for report
  if (exists($$refConfig{'DIR_REPORT'}) and
      -d $$refConfig{'DIR_REPORT'})            { $win->tfReportDir->Text($$refConfig{'DIR_REPORT'});                  }
  else { # Default dir
    mkdir("$USERDIR\\Reports") if !-d "$USERDIR\\Reports";
    $win->tfReportDir->Text("$USERDIR\\Reports");
    $$refConfig{'DIR_REPORT'} = "$USERDIR\\Reports";
  }
  if (exists($$refConfig{'FORMAT_REPORT'}))    { $win->cbReportFormat->SetCurSel($$refConfig{'FORMAT_REPORT'});       }
  else                                         { $win->cbReportFormat->SetCurSel(0);                                  } # Default is TXT
  if (exists($$refConfig{'AUTO_OPEN_REPORT'})) { $win->chOpenReport->Checked($$refConfig{'AUTO_OPEN_REPORT'});        }
  else                                         { $win->chOpenReport->Checked(1);                                      } # Default is checked
  &saveConfig($refConfig);

}  #--- End loadConfig

#--------------------------#
sub date
#--------------------------#
{
  my $time = shift;
  $time    = time if !$time;
  my $currDateTime = DateTime->from_epoch(epoch => $time);
  $currDateTime->set_time_zone($winConfig->cbLocalTZ->GetString($CONFIG{'LOCAL_TIMEZONE'}));
  return($currDateTime->strftime('%F %T %z'));

}  #--- End date

#------------------------------------------------------------------------------#
sub formatFileSize
#------------------------------------------------------------------------------#
{
  # Local variables
  my $size = shift; # Size in bytes
  my $sizeUnit = $STR{'b2'};
  # Round to the biggest unit
  if ($size > 1024) {
    $size = int($size/1024);
    if ($size > 1024) {
      $size = int($size/1024);
      if ($size > 1024) {
        $size = int($size/1024);
        $sizeUnit = $STR{'Gb2'};
      } else { $sizeUnit = $STR{'Mb2'}; }
    } else { $sizeUnit = $STR{'Kb2'}; }
  }
  return("$size $sizeUnit");
  
}  #--- End formatFileSize